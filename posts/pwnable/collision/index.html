<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="One of my objective in 2020 is to level up in Reverse Engineering. Since I am starting from zero I got few people recommend http:&#x2F;&#x2F;pwnable.kr which appear to have a reasonable curve of difficulty mak">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwnable.kr - Collision">
<meta property="og:url" content="https://hg8.sh/posts/pwnable/collision/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="One of my objective in 2020 is to level up in Reverse Engineering. Since I am starting from zero I got few people recommend http:&#x2F;&#x2F;pwnable.kr which appear to have a reasonable curve of difficulty mak">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/86539110-6f804480-befa-11ea-8939-900e8e97bbad.png">
<meta property="article:published_time" content="2020-07-07T22:00:00.000Z">
<meta property="article:modified_time" content="2020-07-08T18:56:17.972Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="re">
<meta property="article:tag" content="collision">
<meta property="article:tag" content="pwn">
<meta property="article:tag" content="dynamic analysis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/86539110-6f804480-befa-11ea-8939-900e8e97bbad.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>Pwnable.kr - Collision :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/book/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/forwardslash/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Description"><span class="toc-number">1.</span> <span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash-Collision"><span class="toc-number">2.</span> <span class="toc-text">Hash Collision</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-amp-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Test &amp; Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">3.1.</span> <span class="toc-text">Dynamic Analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-Code-Analysis"><span class="toc-number">3.2.</span> <span class="toc-text">Source Code Analysis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">4.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Manual-exploitation"><span class="toc-number">4.1.</span> <span class="toc-text">Manual exploitation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-pwntools"><span class="toc-number">4.2.</span> <span class="toc-text">Using pwntools</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Pwnable.kr - Collision
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-07-07T22:00:00.000Z" itemprop="datePublished">08-07-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      10 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://user-images.githubusercontent.com/9076747/86539110-6f804480-befa-11ea-8939-900e8e97bbad.png" alt="collision"></p>
<p>One of my objective in 2020 is to level up in Reverse Engineering. Since I am starting from zero I got few people recommend <a href="http://pwnable.kr" target="_blank" rel="noopener">http://pwnable.kr</a> which appear to have a reasonable curve of difficulty making it ideal for learning. </p>
<p>If you have other recommandations for good ressources to learn and practices Reverse Engineering feels free to let me know below in a comment or <a href="https://hg8.sh/about/">contact me</a> ;)</p>
<p>That being said, here is my write-up for the second challenge of pwnable.kr: Collision. </p>
<p>Let’s go!</p>
<hr>
<h2 id="Challenge-Description"><a href="#Challenge-Description" class="headerlink" title="Challenge Description"></a>Challenge Description</h2><blockquote>
<p><strong>Collision</strong></p>
<p>Daddy told me about cool MD5 hash collision today.<br>I wanna do something like that too!</p>
<p>ssh <a href="mailto:col@pwnable.kr">col@pwnable.kr</a> -p2222 (pw:guest)</p>
</blockquote>
<p>This gives us an SSH access to a box with a hint that this challenge seems to be about MD5 Collision.</p>
<h2 id="Hash-Collision"><a href="#Hash-Collision" class="headerlink" title="Hash Collision"></a>Hash Collision</h2><p>In order to get the right context, here is a definition of Hash Collision:</p>
<blockquote>
<p>A Hash Collision Attack is an attempt to find two input strings of a  hash function that produce the same hash result. Because hash functions  have infinite input length and a predefined output length, there is  inevitably going to be the possibility of two different inputs that  produce the same output hash. If two separate inputs produce the same  hash output, it is called a collision. This collision can then be  exploited by any application that compares two hashes together – such as password hashes, file integrity checks, etc.</p>
<p><a href="https://privacycanada.net/hash-functions/hash-collision-attack/" target="_blank" rel="noopener">https://privacycanada.net/hash-functions/hash-collision-attack/</a></p>
</blockquote>
<h2 id="Test-amp-Analysis"><a href="#Test-amp-Analysis" class="headerlink" title="Test &amp; Analysis"></a>Test &amp; Analysis</h2><p>Once connected on the box we find both a <code>col</code> bin and its source code:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh col@pwnable.kr -p2222</span><br><span class="line">col@pwnable.kr<span class="string">'s password:</span></span><br><span class="line"><span class="string"> ____  __    __  ____    ____  ____   _        ___      __  _  ____</span></span><br><span class="line"><span class="string">|    \|  |__|  ||    \  /    ||    \ | |      /  _]    |  |/ ]|    \</span></span><br><span class="line"><span class="string">|  o  )  |  |  ||  _  ||  o  ||  o  )| |     /  [_     |  '</span> / |  D  )</span><br><span class="line">|   _/|  |  |  ||  |  ||     ||     || |___ |    _]    |    \ |    /</span><br><span class="line">|  |  |  `  <span class="string">'  ||  |  ||  _  ||  O  ||     ||   [_  __ |     \|    \</span></span><br><span class="line"><span class="string">|  |   \      / |  |  ||  |  ||     ||     ||     ||  ||  .  ||  .  \</span></span><br><span class="line"><span class="string">|__|    \_/\_/  |__|__||__|__||_____||_____||_____||__||__|\_||__|\_|</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Last login: Sun Jul  5 13:05:36 2020 from 10.10.10.10</span></span><br><span class="line"><span class="string">col@pwnable:~$ ls -l</span></span><br><span class="line"><span class="string">total 16</span></span><br><span class="line"><span class="string">-r-sr-x--- 1 col_pwn col     7341 Jun 11  2014 col</span></span><br><span class="line"><span class="string">-rw-r--r-- 1 root    root     555 Jun 12  2014 col.c</span></span><br><span class="line"><span class="string">-r--r----- 1 col_pwn col_pwn   52 Jun 11  2014 flag</span></span><br><span class="line"><span class="string">col@pwnable:~$</span></span><br></pre></td></tr></table></figure>

<p>Let’s pull everything to work on it locally:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ scp -P2222 col@pwnable.kr:col.c .</span><br></pre></td></tr></table></figure>

<p>The programs takes a 20 bytes long passcode and do some kind of check on it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ./col A</span><br><span class="line">passcode length should be 20 bytes</span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$ ./col AAAAAAAAAAAAAAAAAAAA</span><br><span class="line">wrong passcode.</span><br></pre></td></tr></table></figure>

<h3 id="Dynamic-Analysis"><a href="#Dynamic-Analysis" class="headerlink" title="Dynamic Analysis"></a>Dynamic Analysis</h3><p>I always like to start off with Dynamic Analysis in order to get a quick understanding of what the program is doing “behind the hood”. </p>
<p>To do so I will use GDB with the <a href="https://github.com/hugsy/gef" target="_blank" rel="noopener">excellent GEF plugin</a> to help in the task.</p>
<p>First let’s open the executable, set a break point to <code>main</code> function, give a 20 char string as argument  and see what’s going on:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gdb col</span><br><span class="line">GNU gdb (GDB) 9.2</span><br><span class="line">  </span><br><span class="line">gef➤  <span class="built_in">break</span> main</span><br><span class="line">Breakpoint 1 at 0x11b7</span><br><span class="line">gef➤   r <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br></pre></td></tr></table></figure>

<p>The program immediately break and we get a bunch of informations:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint <span class="number">1</span>, <span class="number">0x00005555555551b7</span> <span class="function">in <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0x00005555555551b3</span>  →  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x00007ffff7fae578</span>  →  <span class="number">0x00007ffff7fb0960</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line">$rdx   : <span class="number">0x00007fffffffe1b0</span>  →  <span class="number">0x00007fffffffe496</span>  →  <span class="string">"USER=hg8"</span></span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe0a0</span>  →  <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$rbp   : <span class="number">0x00007fffffffe0a0</span>  →  <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$rsi   : <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span></span><br><span class="line">$rdi   : <span class="number">0x2</span></span><br><span class="line">$rip   : <span class="number">0x00005555555551b7</span>  →  &lt;main+<span class="number">4</span>&gt; sub rsp, <span class="number">0x10</span></span><br><span class="line">$r8    : <span class="number">0x0</span></span><br><span class="line">$r9    : <span class="number">0x00007ffff7fe22c0</span>  →  &lt;_dl_fini+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r10   : <span class="number">0x0</span></span><br><span class="line">$r11   : <span class="number">0x0</span></span><br><span class="line">$r12   : <span class="number">0x0000555555555070</span>  →  &lt;_start+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r13   : <span class="number">0x0</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [ZERO carry PARITY adjust sign trap INTERRUPT direction <span class="built_in">overflow</span> resume virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe0a0</span>│+<span class="number">0x0000</span>: <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64   ← $rsp, $rbp</span><br><span class="line"><span class="number">0x00007fffffffe0a8</span>│+<span class="number">0x0008</span>: <span class="number">0x00007ffff7e15002</span>  →  &lt;__libc_start_main+<span class="number">242</span>&gt; mov edi, eax</span><br><span class="line"><span class="number">0x00007fffffffe0b0</span>│+<span class="number">0x0010</span>: <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span></span><br><span class="line"><span class="number">0x00007fffffffe0b8</span>│+<span class="number">0x0018</span>: <span class="number">0x0000000200000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0c0</span>│+<span class="number">0x0020</span>: <span class="number">0x00005555555551b3</span>  →  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line"><span class="number">0x00007fffffffe0c8</span>│+<span class="number">0x0028</span>: <span class="number">0x00007ffff7e14afd</span>  →  &lt;init_cacheinfo+<span class="number">301</span>&gt; mov rbp, rax</span><br><span class="line"><span class="number">0x00007fffffffe0d0</span>│+<span class="number">0x0030</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0d8</span>│+<span class="number">0x0038</span>: <span class="number">0xa7393fcc1a757ccd</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">64</span> ────</span><br><span class="line">   <span class="number">0x5555555551b2</span> &lt;check_password+<span class="number">73</span>&gt; ret</span><br><span class="line">   <span class="number">0x5555555551b3</span> &lt;main+<span class="number">0</span>&gt;         push   rbp</span><br><span class="line">   <span class="number">0x5555555551b4</span> &lt;main+<span class="number">1</span>&gt;         mov    rbp, rsp</span><br><span class="line"> → <span class="number">0x5555555551b7</span> &lt;main+<span class="number">4</span>&gt;         sub    rsp, <span class="number">0x10</span></span><br><span class="line">   <span class="number">0x5555555551bb</span> &lt;main+<span class="number">8</span>&gt;         mov    DWORD PTR [rbp<span class="number">-0x4</span>], edi</span><br><span class="line">   <span class="number">0x5555555551be</span> &lt;main+<span class="number">11</span>&gt;        mov    QWORD PTR [rbp<span class="number">-0x10</span>], rsi</span><br><span class="line">   <span class="number">0x5555555551c2</span> &lt;main+<span class="number">15</span>&gt;        cmp    DWORD PTR [rbp<span class="number">-0x4</span>], <span class="number">0x1</span></span><br><span class="line">   <span class="number">0x5555555551c6</span> &lt;main+<span class="number">19</span>&gt;        jg     <span class="number">0x5555555551ea</span> &lt;main+<span class="number">55</span>&gt;</span><br><span class="line">   <span class="number">0x5555555551c8</span> &lt;main+<span class="number">21</span>&gt;        mov    rax, QWORD PTR [rbp<span class="number">-0x10</span>]</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: "col", stopped 0x5555555551b7 in main (), reason: BREAKPOINT</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x5555555551b7</span> → main()</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>We notice a function called <code>check_password</code>, that’s very probably where the magic happen. Let’s use <code>ni</code> to jump a bunch of time until we arrive to the said function:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">gef➤  ni</span><br><span class="line"><span class="number">0x0000555555555224</span> <span class="function">in <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0x00007fffffffe481</span>  →  <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x1</span></span><br><span class="line">$rdx   : <span class="number">0x00007fffffffe481</span>  →  <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe090</span>  →  <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hugo/pwnable.kr/collision/col"</span></span><br><span class="line">$rbp   : <span class="number">0x00007fffffffe0a0</span>  →  <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$rsi   : <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span></span><br><span class="line">$rdi   : <span class="number">0x00007fffffffe481</span>  →  <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">$rip   : <span class="number">0x0000555555555224</span>  →  &lt;main+<span class="number">113</span>&gt; call <span class="number">0x555555555169</span> &lt;check_password&gt;</span><br><span class="line">$r8    : <span class="number">0x0</span></span><br><span class="line">$r9    : <span class="number">0x00007ffff7fe22c0</span>  →  &lt;_dl_fini+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r10   : <span class="number">0x000055555555442f</span>  →  <span class="number">0x73006e656c727473</span> (<span class="string">"strlen"</span>?)</span><br><span class="line">$r11   : <span class="number">0x00007ffff7f504a0</span>  →  &lt;__strlen_avx2+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r12   : <span class="number">0x0000555555555070</span>  →  &lt;_start+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r13   : <span class="number">0x0</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [zero carry PARITY ADJUST sign trap INTERRUPT direction <span class="built_in">overflow</span> resume virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe090</span>│+<span class="number">0x0000</span>: <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hugo/pwnable.kr/collision/col"</span> ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe098</span>│+<span class="number">0x0008</span>: <span class="number">0x0000000200000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0a0</span>│+<span class="number">0x0010</span>: <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64   ← $rbp</span><br><span class="line"><span class="number">0x00007fffffffe0a8</span>│+<span class="number">0x0018</span>: <span class="number">0x00007ffff7e15002</span>  →  &lt;__libc_start_main+<span class="number">242</span>&gt; mov edi, eax</span><br><span class="line"><span class="number">0x00007fffffffe0b0</span>│+<span class="number">0x0020</span>: <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hugo/pwnable.kr/collision/col"</span></span><br><span class="line"><span class="number">0x00007fffffffe0b8</span>│+<span class="number">0x0028</span>: <span class="number">0x0000000200000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0c0</span>│+<span class="number">0x0030</span>: <span class="number">0x00005555555551b3</span>  →  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line"><span class="number">0x00007fffffffe0c8</span>│+<span class="number">0x0038</span>: <span class="number">0x00007ffff7e14afd</span>  →  &lt;init_cacheinfo+<span class="number">301</span>&gt; mov rbp, rax</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">64</span> ────</span><br><span class="line">   <span class="number">0x555555555219</span> &lt;main+<span class="number">102</span>&gt;       lock   add rax, <span class="number">0x8</span></span><br><span class="line">   <span class="number">0x55555555521e</span> &lt;main+<span class="number">107</span>&gt;       mov    rax, QWORD PTR [rax]</span><br><span class="line">   <span class="number">0x555555555221</span> &lt;main+<span class="number">110</span>&gt;       mov    rdi, rax</span><br><span class="line"> → <span class="number">0x555555555224</span> &lt;main+<span class="number">113</span>&gt;       call   <span class="number">0x555555555169</span> &lt;check_password&gt;</span><br><span class="line">   ↳  <span class="number">0x555555555169</span> &lt;check_password+<span class="number">0</span>&gt; push   rbp</span><br><span class="line">      <span class="number">0x55555555516a</span> &lt;check_password+<span class="number">1</span>&gt; mov    rbp, rsp</span><br><span class="line">      <span class="number">0x55555555516d</span> &lt;check_password+<span class="number">4</span>&gt; mov    QWORD PTR [rbp<span class="number">-0x18</span>], rdi</span><br><span class="line">      <span class="number">0x555555555171</span> &lt;check_password+<span class="number">8</span>&gt; mov    rax, QWORD PTR [rbp<span class="number">-0x18</span>]</span><br><span class="line">      <span class="number">0x555555555175</span> &lt;check_password+<span class="number">12</span>&gt; mov    QWORD PTR [rbp<span class="number">-0x8</span>], rax</span><br><span class="line">      <span class="number">0x555555555179</span> &lt;check_password+<span class="number">16</span>&gt; mov    DWORD PTR [rbp<span class="number">-0xc</span>], <span class="number">0x0</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────── arguments (guessed) ────</span><br><span class="line">check_password (</span><br><span class="line">   $rdi = <span class="number">0x00007fffffffe481</span> → <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span>,</span><br><span class="line">   $rsi = <span class="number">0x00007fffffffe198</span> → <span class="number">0x00007fffffffe45d</span> → <span class="string">"/home/hg8/pwnable.kr/collision/col"</span>,</span><br><span class="line">   $rdx = <span class="number">0x00007fffffffe481</span> → <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">)</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: "col", stopped 0x555555555224 in main (), reason: SINGLE STEP</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x555555555224</span> → main()</span><br><span class="line">──────────────────</span><br></pre></td></tr></table></figure>

<p>We can see that our password got set in <code>$rdi</code> and <code>$rdx</code> registers. At this point I put up a breakpoint on <code>check_password</code> function but doesn’t quite understood what exactly was going on (except some loop and calculations).<br>Let’s continue to see what happen in <code>main</code> once <code>check_password</code> return something:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000555555555229</span> <span class="function">in <span class="title">main</span> <span class="params">()</span></span></span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────── registers ────</span><br><span class="line">$rax   : <span class="number">0x46464645</span></span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x1</span></span><br><span class="line">$rdx   : <span class="number">0x10</span></span><br><span class="line">$rsp   : <span class="number">0x00007fffffffe090</span>  →  <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hugo/pwnable.kr/collision/col"</span></span><br><span class="line">$rbp   : <span class="number">0x00007fffffffe0a0</span>  →  <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$rsi   : <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span></span><br><span class="line">$rdi   : <span class="number">0x00007fffffffe481</span>  →  <span class="string">"AAAAAAAAAAAAAAAAAAAA"</span></span><br><span class="line">$rip   : <span class="number">0x0000555555555229</span>  →  &lt;main+<span class="number">118</span>&gt; mov rdx, QWORD PTR [rip+<span class="number">0x2e18</span>]        # <span class="number">0x555555558048</span> &lt;hashcode&gt;</span><br><span class="line">$r8    : <span class="number">0x0</span></span><br><span class="line">$r9    : <span class="number">0x00007ffff7fe22c0</span>  →  &lt;_dl_fini+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r10   : <span class="number">0x000055555555442f</span>  →  <span class="number">0x73006e656c727473</span> (<span class="string">"strlen"</span>?)</span><br><span class="line">$r11   : <span class="number">0x00007ffff7f504a0</span>  →  &lt;__strlen_avx2+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r12   : <span class="number">0x0000555555555070</span>  →  &lt;_start+<span class="number">0</span>&gt; endbr64</span><br><span class="line">$r13   : <span class="number">0x0</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [zero carry parity adjust sign trap INTERRUPT direction <span class="built_in">overflow</span> resume virtualx86 identification]</span><br><span class="line">$cs: <span class="number">0x0033</span> $ss: <span class="number">0x002b</span> $ds: <span class="number">0x0000</span> $es: <span class="number">0x0000</span> $fs: <span class="number">0x0000</span> $gs: <span class="number">0x0000</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── <span class="built_in">stack</span> ────</span><br><span class="line"><span class="number">0x00007fffffffe090</span>│+<span class="number">0x0000</span>: <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span> ← $rsp</span><br><span class="line"><span class="number">0x00007fffffffe098</span>│+<span class="number">0x0008</span>: <span class="number">0x0000000200000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0a0</span>│+<span class="number">0x0010</span>: <span class="number">0x0000555555555260</span>  →  &lt;__libc_csu_init+<span class="number">0</span>&gt; endbr64   ← $rbp</span><br><span class="line"><span class="number">0x00007fffffffe0a8</span>│+<span class="number">0x0018</span>: <span class="number">0x00007ffff7e15002</span>  →  &lt;__libc_start_main+<span class="number">242</span>&gt; mov edi, eax</span><br><span class="line"><span class="number">0x00007fffffffe0b0</span>│+<span class="number">0x0020</span>: <span class="number">0x00007fffffffe198</span>  →  <span class="number">0x00007fffffffe45d</span>  →  <span class="string">"/home/hg8/pwnable.kr/collision/col"</span></span><br><span class="line"><span class="number">0x00007fffffffe0b8</span>│+<span class="number">0x0028</span>: <span class="number">0x0000000200000000</span></span><br><span class="line"><span class="number">0x00007fffffffe0c0</span>│+<span class="number">0x0030</span>: <span class="number">0x00005555555551b3</span>  →  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line"><span class="number">0x00007fffffffe0c8</span>│+<span class="number">0x0038</span>: <span class="number">0x00007ffff7e14afd</span>  →  &lt;init_cacheinfo+<span class="number">301</span>&gt; mov rbp, rax</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────── code:x86:<span class="number">64</span> ────</span><br><span class="line">   <span class="number">0x55555555521e</span> &lt;main+<span class="number">107</span>&gt;       mov    rax, QWORD PTR [rax]</span><br><span class="line">   <span class="number">0x555555555221</span> &lt;main+<span class="number">110</span>&gt;       mov    rdi, rax</span><br><span class="line">   <span class="number">0x555555555224</span> &lt;main+<span class="number">113</span>&gt;       call   <span class="number">0x555555555169</span> &lt;check_password&gt;</span><br><span class="line"> → <span class="number">0x555555555229</span> &lt;main+<span class="number">118</span>&gt;       mov    rdx, QWORD PTR [rip+<span class="number">0x2e18</span>]        # <span class="number">0x555555558048</span> &lt;hashcode&gt;</span><br><span class="line">   <span class="number">0x555555555230</span> &lt;main+<span class="number">125</span>&gt;       cmp    rax, rdx</span><br><span class="line">   <span class="number">0x555555555233</span> &lt;main+<span class="number">128</span>&gt;       jne    <span class="number">0x55555555524d</span> &lt;main+<span class="number">154</span>&gt;</span><br><span class="line">   <span class="number">0x555555555235</span> &lt;main+<span class="number">130</span>&gt;       lea    rdi, [rip+<span class="number">0xe07</span>]        # <span class="number">0x555555556043</span></span><br><span class="line">   <span class="number">0x55555555523c</span> &lt;main+<span class="number">137</span>&gt;       mov    eax, <span class="number">0x0</span></span><br><span class="line">   <span class="number">0x555555555241</span> &lt;main+<span class="number">142</span>&gt;       call   <span class="number">0x555555555050</span> &lt;system@plt&gt;</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────── threads ────</span><br><span class="line">[#0] Id 1, Name: "col", stopped 0x555555555229 in main (), reason: SINGLE STEP</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────── trace ────</span><br><span class="line">[#<span class="number">0</span>] <span class="number">0x555555555229</span> → main()</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>

<p>The returns value get stored in <code>$rax</code> :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">→ <span class="number">0x5555555551ac</span> &lt;check_password+<span class="number">67</span>&gt; mov    eax, DWORD PTR [rbp<span class="number">-0xc</span>]</span><br></pre></td></tr></table></figure>

<p>Then a comparaison between the returned value of <code>check_password</code> and <code>0x21dd09ec</code> is being done:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">→ <span class="number">0x555555555229</span> &lt;main+<span class="number">118</span>&gt;   mov  rdx, QWORD PTR [rip+<span class="number">0x2e18</span>]   # <span class="number">0x555555558048</span> &lt;hashcode&gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rdx   : <span class="number">0x21dd09ec</span></span><br></pre></td></tr></table></figure>

<p>Let’s edit the value we have in <code>$rax</code> to match <code>0x21dd09ec</code> (568134124):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gef➤  <span class="built_in">print</span> $rax</span><br><span class="line">$<span class="number">2</span> = <span class="number">0x46464645</span></span><br><span class="line">gef➤  <span class="built_in">set</span> $rax=<span class="number">568134124</span></span><br></pre></td></tr></table></figure>

<p>We continue the execution and we can see the bin trying to display the flag:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gef➤  c</span><br><span class="line">Continuing.</span><br><span class="line">[Detaching after vfork from child process 986]</span><br><span class="line">/bin/cat: flag: No such file or directory</span><br><span class="line">[Inferior 1 (process 916) exited normally]</span><br><span class="line">gef➤</span><br></pre></td></tr></table></figure>

<p>Alright! We now understood the big picture of what’s going on behind the hood and what kind of check is being made by the bin. Let’s now take a look at the source code to find a proper way to exploit the <code>check_password</code> function without using a debugger.</p>
<h3 id="Source-Code-Analysis"><a href="#Source-Code-Analysis" class="headerlink" title="Source Code Analysis"></a>Source Code Analysis</h3><p>Let’s a take a look at the source now:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">		res += ip[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(argc&lt;<span class="number">2</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"usage : %s [passcode]\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">20</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"passcode length should be 20 bytes\n"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</span><br><span class="line">		system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">"wrong passcode.\n"</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let’s break things down. First the check of our password:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> hashcode = <span class="number">0x21DD09EC</span>;</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(hashcode == check_password( argv[<span class="number">1</span>] ))&#123;</span><br><span class="line">    system(<span class="string">"/bin/cat flag"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The function <code>check_password()</code> take our password as argument and should return <code>0x21DD09EC</code> in order to have the flag displayed. In decimal this gives:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; int(<span class="string">"0x21DD09EC"</span>, 16)</span><br><span class="line">568134124</span><br></pre></td></tr></table></figure>

<p>Let’s now focus on the <code>check_password()</code> function since the magic is happening here.<br>We know it needs to returns <code>568134124</code> in order to pass the check and displays the flag.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">check_password</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* p)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>* ip = (<span class="keyword">int</span>*)p;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> res=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">		res += ip[i];</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The function is quite short but no so straightforward. </p>
<p>Let’s decompose line by line to understand what’s going on.</p>
<ol>
<li><p>The char pointer passed as parameter is cast to an int pointer: <code>(int*)p;</code>. <code>ip</code> is an array of pointers starting with the pointer to <code>p</code>.<br>Example: <code>char* p = &quot;ABCD&quot; = &quot;\\x41\\x42\\x43\\x44&quot;, int* ip = 0x44434241</code></p>
</li>
<li><p>The char array is iterated 4 bytes at a time (4 * 5 = 20 bytes of the passcode), then summed up into <code>res</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">5</span>; i++)&#123;</span><br><span class="line">  res += ip[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>The sum results get returned.</p>
</li>
</ol>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><h3 id="Manual-exploitation"><a href="#Manual-exploitation" class="headerlink" title="Manual exploitation"></a>Manual exploitation</h3><p>So we understood we need our passcode 5 parts sum to be equal to <code>0x21DD09EC</code>. Now it’s math time!</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">0x21DD09EC</span></span><br><span class="line"><span class="number">568134124</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">568134124</span> / <span class="number">5</span></span><br><span class="line"><span class="number">113626824</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">568134124</span> - <span class="number">4</span> * <span class="number">113626824</span></span><br><span class="line"><span class="number">113626828</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4</span> * <span class="number">113626824</span> + <span class="number">113626828</span></span><br><span class="line"><span class="number">568134124</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">113626824</span>)</span><br><span class="line"><span class="string">'0x6c5cec8'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>hex(<span class="number">113626828</span>)</span><br><span class="line"><span class="string">'0x6c5cecc'</span></span><br></pre></td></tr></table></figure>

<p>Alright, we have all the 4 parts of our password. Since we are working with C, integers are stored in little-endian format. Therefore the byte order of the integers need to be reversed. </p>
<p>Using Python this gives:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -c <span class="string">'print "\xc8\xce\xc5\x06" * 4 + "\xcc\xce\xc5\x06"'</span></span><br><span class="line"></span><br><span class="line">[hg8@archbook ~]$</span><br></pre></td></tr></table></figure>

<p>Nothing gets printed since those are non-printable chars. </p>
<p>Let’s now use it to solve the challenge:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">col@pwnable:~$ ./col $(python -c <span class="string">'print "\xc8\xce\xc5\x06" * 4 + "\xcc\xce\xc5\x06"'</span>)</span><br><span class="line">daddy! I just managed to create a <span class="built_in">hash</span> collision :)</span><br></pre></td></tr></table></figure>

<h3 id="Using-pwntools"><a href="#Using-pwntools" class="headerlink" title="Using pwntools"></a>Using pwntools</h3><p>A simple challenge like this one is a good occasion to try our hand on <a href="https://github.com/Gallopsled/pwntools" target="_blank" rel="noopener"><code>pwntools</code></a> which can probably comes very useful in the future for more complex challenges.</p>
<blockquote>
<p>Pwntools is a CTF framework and exploit development library. Written in Python, it is designed for rapid prototyping and development, and intended to make exploit writing as simple as possible.</p>
</blockquote>
<p>After installing the tool let’s create a simple script to solve the challenge. </p>
<p>First let’s connect to the server:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">server = ssh(<span class="string">'col'</span>, <span class="string">'pwnable.kr'</span>, <span class="number">2222</span>, <span class="string">'guest'</span>)</span><br></pre></td></tr></table></figure>

<p>Pop a shell and run <code>./col</code> process with our payload as argument. Here we use the very useful pack function from pwnlib in order to convert our hex values to little endian:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shell = server.process([<span class="string">'./col'</span>, p32(<span class="number">0x6c5cec8</span>) * <span class="number">4</span> + p32(<span class="number">0x6c5cecc</span>)])</span><br></pre></td></tr></table></figure>

<p>After closing the connection and printing the result the final script looks like this:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">server = ssh(<span class="string">'col'</span>, <span class="string">'pwnable.kr'</span>, <span class="number">2222</span>, <span class="string">'guest'</span>)</span><br><span class="line">shell = server.process([<span class="string">'./col'</span>, p32(<span class="number">0x6c5cec8</span>) * <span class="number">4</span> + p32(<span class="number">0x6c5cecc</span>)])</span><br><span class="line">result = shell.recvall()</span><br><span class="line">shell.close()</span><br><span class="line">server.close()</span><br><span class="line"></span><br><span class="line">print(<span class="string">"Flag: &#123;&#125;"</span>.format(result.decode(<span class="string">"utf-8"</span>)))</span><br></pre></td></tr></table></figure>

<p>Running it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python pwntools-exp.py</span><br><span class="line">[+] Connecting to pwnable.kr on port 2222: Done</span><br><span class="line">[*] col@pwnable.kr:</span><br><span class="line">    Distro    Ubuntu 16.04</span><br><span class="line">    OS:       linux</span><br><span class="line">    Arch:     amd64</span><br><span class="line">    Version:  4.4.179</span><br><span class="line">    ASLR:     Enabled</span><br><span class="line">[+] Starting remote process <span class="string">'./col'</span> on pwnable.kr: pid 82641</span><br><span class="line">[+] Receiving all data: Done (52B)</span><br><span class="line">[*] Stopped remote process <span class="string">'col'</span> on pwnable.kr (pid 82641)</span><br><span class="line">[*] Closed connection to <span class="string">'pwnable.kr'</span></span><br><span class="line"></span><br><span class="line">Flag: daddy! I just managed to create a <span class="built_in">hash</span> collision :)</span><br></pre></td></tr></table></figure>



<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedbacks!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/pwnable/">pwnable</a> › <a class="category-link" href="/categories/CTF/pwnable/Toddler-s-Bottle/">Toddler's Bottle</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/collision/" rel="tag">collision</a>, <a class="tag-link" href="/tags/dynamic-analysis/" rel="tag">dynamic analysis</a>, <a class="tag-link" href="/tags/pwn/" rel="tag">pwn</a>, <a class="tag-link" href="/tags/re/" rel="tag">re</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Challenge-Description"><span class="toc-number">1.</span> <span class="toc-text">Challenge Description</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hash-Collision"><span class="toc-number">2.</span> <span class="toc-text">Hash Collision</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-amp-Analysis"><span class="toc-number">3.</span> <span class="toc-text">Test &amp; Analysis</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dynamic-Analysis"><span class="toc-number">3.1.</span> <span class="toc-text">Dynamic Analysis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-Code-Analysis"><span class="toc-number">3.2.</span> <span class="toc-text">Source Code Analysis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation"><span class="toc-number">4.</span> <span class="toc-text">Exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Manual-exploitation"><span class="toc-number">4.1.</span> <span class="toc-text">Manual exploitation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Using-pwntools"><span class="toc-number">4.2.</span> <span class="toc-text">Using pwntools</span></a></li></ol></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2021
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
